<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misorteos</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M21.99 2H2.01C.9 2 .01 2.9.01 4L0 20c0 1.1.89 2 1.99 2H22c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM4 4h16v16H4V4zM16 11H8V8h8v3zm-3 5h-3v-3h3v3z' fill='%23f7d468'/%3E%3Cpath d='M12 1.5L9.24 7.76 2.5 8.24l5.09 4.67L5.76 20.5 12 17.27l6.24 3.23-1.83-7.59 5.09-4.67-6.74-.48L12 1.5z' fill='%23eab308'/%3E%3C/svg%3E" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chewy&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- KEYFRAMES --- */
        @keyframes twinkle { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        @keyframes move-star { from { transform: translateY(0); } to { transform: translateY(-200px); } }
        @keyframes letter-reveal-sparkle { 0% { transform: scale(0); opacity: 0; } 50% { opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        @keyframes sparkle-fountain { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-40px) scale(0); opacity: 0; } }
        @keyframes shooting-star-anim {
            0% { transform: translate(-20%, 120%) scale(0.5); opacity: 1; }
            100% { transform: translate(120%, -20%) scale(0.5); opacity: 0; }
        }
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 5px #fbd38d, 0 0 10px #fbd38d; }
            50% { text-shadow: 0 0 10px #fbd38d, 0 0 20px #fbd38d, 0 0 30px #fbd38d; }
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes vortex {
            from { transform: rotate(0deg) scale(1); }
            to { transform: rotate(360deg) scale(0); }
        }

        /* --- ESTILOS GENERALES --- */
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Chewy', cursive;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #f0e6d2;
            display: flex;
            flex-direction: column;
        }
        main {
            flex-grow: 1;
        }

        /* Clase para usar el gradiente del fondo */
        .bg-web-gradient {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        }
        
        /* --- FONDO ESTRELLADO --- */
        #magic-stars-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .star { position: absolute; background: white; border-radius: 50%; box-shadow: 0 0 5px white, 0 0 10px white; animation: twinkle 2s infinite ease-in-out; }
        .moving-star { animation: move-star linear infinite, twinkle 2s infinite ease-in-out; }

        /* --- T√çTULO --- */
        .title-container { position: relative; text-align: center; padding-top: 1rem; margin-bottom: 2rem; flex-shrink: 0; }
        .magic-title { font-size: clamp(3.5rem, 12vw, 6rem); color: #f7d468; text-shadow: 0 0 10px #d4af37, 0 0 20px #d4af37; letter-spacing: 10px; display: inline-block; position: relative; white-space: nowrap; }
        .magic-title .letter { display: inline-block; opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease, transform 0.5s ease; position: relative; }
        .sparkle, .fountain-sparkle { position: absolute; background: #f7d468; border-radius: 50%; box-shadow: 0 0 15px #f7d468; }
        .sparkle { width: 8px; height: 8px; opacity: 0; }
        .fountain-sparkle { width: 5px; height: 5px; animation: sparkle-fountain 1.5s ease-out forwards; }

        /* --- CALENDARIO --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { transition: all 0.3s ease-in-out; border: 1px solid transparent; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; border-radius: 8px; color: #f0e6d2; height: 80px; padding-top: 8px; }
        .day-number { font-size: 1.5rem; line-height: 1; }
        .calendar-day.has-giveaway { background-color: rgba(212, 175, 55, 0.2); cursor: pointer; border-color: #d4af37; }
        .calendar-day.has-giveaway:hover { transform: scale(1.05); box-shadow: 0 0 20px #f7d468; z-index: 10; }
        .calendar-day.all-done { background-color: rgba(34, 197, 94, 0.3); border-color: #22c55e; }
        .calendar-day.all-done .giveaway-count { display: none; }
        .giveaway-count { font-size: 0.7rem; color: #78350f; background-color: #f7d468; border: 1px solid #b45309; padding: 1px 5px; margin-top: 4px; }
        
        /* --- MODAL --- */
        .modal {
            z-index: 50;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            opacity: 0;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal.is-visible {
            pointer-events: auto;
            opacity: 1;
        }
        .modal-content {
            font-family: 'Chewy', cursive;
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            transform: scale(0.95);
            background-size: cover;
            background-position: center;
            border: 3px solid #d4af37;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .modal.is-visible .modal-content {
            transform: scale(1);
        }
        .modal-default-bg { background-color: #fffbef; }
        .modal-travel-bg { background-image: linear-gradient(rgba(255, 251, 235, 0.85), rgba(255, 251, 235, 0.85)), url('https://images.unsplash.com/photo-1507525428034-b723a9ce6890?q=80&w=1170&auto=format&fit=crop'); }
        .modal-padel-bg { background-image: linear-gradient(rgba(255, 251, 235, 0.85), rgba(255, 251, 235, 0.85)), url('https://images.unsplash.com/photo-1621288228964-67ac723a9b8a?q=80&w=1170&auto=format&fit=crop'); }
        #modal-body, #add-giveaway-form-body, #search-modal-body, #trash-modal-body, #discarded-modal-body, #duplicate-giveaway-info, #foreign-accounts-modal-body, #trophy-modal-body, #stats-modal-body, #ai-modal-content-wrapper, #history-modal-body, #achievements-modal-body, .nav-menu { overflow-y: auto; }

        /* --- CORRECCI√ìN UI MODAL IA --- */
        #ai-image-queue {
            max-height: 160px; /* 10rem */
            overflow-y: auto;
        }

        /* --- ANIMACI√ìN ESTRELLA FUGAZ --- */
        .giveaway-item { position: relative; overflow: hidden; }
        .giveaway-item .text-content { transition: opacity 0.3s ease-in-out; }
        .giveaway-item.completed .text-content { opacity: 0.5; text-decoration: line-through; }
        .shooting-star {
            position: absolute; top: 0; left: 0; width: 8px; height: 8px;
            background: radial-gradient(circle, #fff, #f7d468);
            border-radius: 50%;
            box-shadow: 0 0 10px #f7d468, 0 0 20px #fff;
            animation: shooting-star-anim 0.6s ease-in forwards;
            pointer-events: none;
        }
        .shooting-star::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 150px; height: 2px;
            background: linear-gradient(to left, transparent, #f7d468);
            transform-origin: right;
            transform: rotate(-45deg) translate(75px);
        }

        /* --- CONFIRMATION MODAL --- */
        #confirmation-modal .modal-content { padding: 2rem; text-align: center; }

        /* --- ESTILOS DEL MEN√ö Y NAVEGACI√ìN --- */
        .nav-btn {
            background-color: transparent;
            color: #f7d468;
            font-weight: bold;
            border-radius: 9999px; /* full rounded */
            border: 2px solid #d4af37;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease-in-out;
        }
        .nav-btn:hover {
            background-color: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 20px #f7d468;
        }
        .action-btn {
            border-color: #ef4444;
            color: #fca5a5;
        }
        .action-btn:hover {
             background-color: rgba(239, 68, 68, 0.2);
             box-shadow: 0 0 15px #f87171;
        }
        .nav-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 60;
            padding: 1.5rem;
            border-right: 2px solid #d4af37;
        }

        .nav-menu.is-open {
            transform: translateX(0);
        }
        
        .nav-menu-btn {
             background-color: transparent;
             color: #f7d468;
             font-weight: bold;
             border: 2px solid #d4af37;
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
             transition: all 0.3s ease-in-out;
             width: 48px;
             height: 48px;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 55;
            display: none;
        }


        .shooting-star-line::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 150%;
            height: 1px;
            background: linear-gradient(to right, transparent, #fbd38d, #fbd38d);
            transform-origin: left;
            transform: scaleX(0);
            transition: transform 0.5s ease-in-out;
            z-index: -1;
        }
        .shooting-star-line:hover::before {
            transform: scaleX(1);
        }
        .menu-link {
            font-size: 1rem;
            padding: 0.5rem 1rem;
        }
        
        /* Estilos del agujero negro */
        .vortex-btn {
            background-color: transparent;
            border: 2px solid #302b63;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease-in-out;
        }
        .vortex-btn:hover {
             box-shadow: 0 0 20px #0f0c29;
        }

        .vortex-btn .vortex {
            background: conic-gradient(from 0deg, transparent 0%, #000 10%, #fff 50%, #000 90%, transparent 100%);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .calendar-nav-btn {
             height: 48px;
        }
        
        .giveaway-item-discarded.duplicate-item {
             cursor: pointer;
        }
        
        .giveaway-item-discarded.duplicate-item:hover {
             background-color: rgba(255, 0, 0, 0.2);
             box-shadow: 0 0 10px #f87171;
        }

        .discarded-item-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
        }
        
        /* Estilos para el modal de duplicados */
        #duplicate-modal .modal-content {
             max-width: 90%;
        }

        #duplicate-giveaway-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }
        
        /* Estilos para el nuevo contador */
        #total-giveaways-container {
            padding: 0.5rem 1rem;
            background-color: #302b63;
            border-radius: 9999px;
            color: #f7d468;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid #d4af37;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* --- NUEVA PALETA DE COLORES (VERSI√ìN 2) --- */
        .modal-content {
            color: #422006; /* Color de texto base oscuro */
        }
        /* Estilo para el texto principal del premio */
        .giveaway-item .text-yellow-900 {
            color: #4e342e !important; 
        }
        /* NUEVO: Color m√°s oscuro para cuentas y precio */
        .giveaway-item a,
        .giveaway-item .text-amber-600, 
        .giveaway-item .text-yellow-700 {
            color: #6a3805 !important; /* Marr√≥n oscuro para m√°xima legibilidad */
            font-weight: bold; /* A√±adimos negrita para que destaque m√°s */
        }
        .giveaway-item a:hover {
            color: #8c5a15 !important; /* Un tono m√°s claro al pasar el rat√≥n */
        }

        /* NUEVO: Estilos para los botones de acci√≥n (mover, eliminar) */
        .win-giveaway-btn, .move-giveaway-btn, .delete-giveaway-btn {
            background-color: #fdecc8 !important; /* Fondo s√≥lido y visible */
            color: #78350f !important; /* Icono en marr√≥n muy oscuro */
        }
        .win-giveaway-btn:hover, .move-giveaway-btn:hover, .delete-giveaway-btn:hover {
            background-color: #f7d468 !important; /* Fondo m√°s intenso al pasar el rat√≥n */
        }
        .win-giveaway-btn {
            color: #ca8a04 !important; /* Icono dorado para ganar */
            margin-top: 4px;
            padding: 2px;
            width: 28px;
            height: 28px;
            border-radius: 9999px;
        }
        .delete-giveaway-foreign-btn {
            background-color: #fecaca !important; /* Fondo rojo claro para el bot√≥n de extranjero */
            color: #991b1b !important; /* Icono en rojo oscuro */
        }
        .delete-giveaway-foreign-btn:hover {
            background-color: #f87171 !important;
        }

        /* T√≠tulos de los modales */
        #modal-title, #add-giveaway-modal-title, #search-modal h2, #ai-modal-title, #trash-modal h2, #discarded-modal h2, #duplicate-modal h2, #move-giveaway-modal h2, #foreign-accounts-modal h2, #trophy-modal h2, #stats-modal h2, #history-modal h2, #achievements-modal h2 {
            color: #8c5a15; 
        }
        
        /* --- ESTILOS PARA EL NUEVO RESUMEN DETALLADO DE IA --- */
        #ai-summary-results h3, #ai-summary-results h4, #history-modal h3, #history-modal h4 {
            color: #8c5a15; /* Usar el mismo color dorado intenso para los t√≠tulos */
        }
        #ai-summary-results details, #history-modal details {
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background-color: rgba(255, 251, 235, 0.05);
        }
        #ai-summary-results summary, #history-modal summary {
            font-weight: bold;
            cursor: pointer;
            color: #d4af37;
        }
        #ai-summary-results ul, #history-modal ul {
            list-style-type: none;
            padding-left: 1rem;
            margin-top: 0.5rem;
        }
        #ai-summary-results li, #history-modal li {
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        }
        #ai-summary-results li:last-child, #history-modal li:last-child {
            border-bottom: none;
        }
        #ai-summary-results .view-original-duplicate {
            text-decoration: underline;
            cursor: pointer;
            color: #6a3805;
        }
        #ai-summary-results .view-original-duplicate:hover {
            color: #8c5a15;
        }
        
        /* --- ESTILOS VITRINA, ESTAD√çSTICAS Y LOGROS --- */
        #trophy-modal-body {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
        }
        .trophy-card {
            background: linear-gradient(135deg, #fefce8, #fef3c7);
            border: 2px solid #fde047;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(253, 224, 71, 0.2);
            color: #78350f; /* Color de texto oscuro para el trofeo */
            position: relative; /* Para posicionar el bot√≥n de eliminar */
        }
        .trophy-card h3 {
            font-size: 1.25rem;
            color: #b45309; /* Color dorado m√°s intenso para el t√≠tulo */
        }
        /* Estilo para el nuevo bot√≥n de eliminar */
        .trophy-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.1);
            color: #991b1b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .trophy-delete-btn:hover {
            background-color: rgba(255, 0, 0, 0.3);
            transform: scale(1.1);
        }
        #stats-modal-body ul, #stats-modal-body ol {
            list-style: none;
            padding: 0;
        }
        #stats-modal-body li {
            font-size: 1.2rem;
            padding: 0.5rem;
            border-bottom: 1px solid rgba(140, 90, 21, 0.2);
        }
        #stats-modal-body li strong {
            color: #b45309;
        }
        #stats-modal-body ol {
            padding-left: 1rem;
            list-style-type: decimal;
        }
         #stats-modal-body ol li {
            font-size: 1rem;
            padding: 0.25rem 0;
         }
        
        #charts-modal-body {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            padding: 1rem;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* --- ESTILOS MODAL DE LOGROS --- */
        .achievement-tabs button {
            transition: all 0.2s ease-in-out;
            border-bottom: 3px solid transparent;
        }
        .achievement-tabs button.active {
            color: #f7d468;
            border-bottom-color: #f7d468;
        }
        .achievement-item {
            transition: all 0.3s ease;
            border-left: 5px solid #ca8a04;
        }
        .achievement-item.locked {
            opacity: 0.6;
            filter: grayscale(80%);
            border-left-color: #a1a1aa;
        }
        .achievement-item .ach-icon {
            font-size: 2.5rem;
        }
        .goal-progress-bar {
            background-color: #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
        }
        .goal-progress-fill {
            background-color: #4ade80; /* Verde para completado */
            transition: width 0.5s ease;
        }
        .title-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .title-item:hover {
            background-color: #fef3c7;
        }
        .title-item.selected {
            border-color: #f59e0b;
            background-color: #fef3c7;
            box-shadow: 0 0 10px #f59e0b;
        }
        .title-item.locked {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* --- ESTILOS PARA LAS NUEVAS TARJETAS DE SORTEO --- */
        .giveaway-card {
            border: 1px solid #d4af37;
            border-radius: 12px;
            padding: 1rem;
            background-color: #fffbef;
            color: #4e342e;
        }
        .giveaway-card h3 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
            color: #8c5a15;
        }
        .giveaway-card-details {
            display: grid;
            gap: 0.5rem;
        }
        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
        }
        .detail-item i {
            width: 20px;
            text-align: center;
            color: #b45309;
        }
        .status-tag {
            padding: 2px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: capitalize;
        }
        .status-duplicate { background-color: #fef3c7; color: #b45309; border: 1px solid #fde68a; }
        .status-expired { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }
        .status-foreign { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .status-no_date { background-color: #f3e8ff; color: #6b21a8; border: 1px solid #d8b4fe; }
    </style>
</head>
<body class="p-4">
    <input type="file" id="zip-upload" class="hidden" accept=".zip">
    <div id="magic-stars-container"></div>
    
    <div id="nav-menu" class="nav-menu flex flex-col items-start gap-4">
        <button id="close-nav-menu" class="text-yellow-600 hover:text-yellow-800 text-4xl self-end">&times;</button>
        <a href="#" id="add-manual-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
            <span class="text-xl sm:text-2xl">üìù</span>
            <span>A√±adir</span>
        </a>
        <a href="#" id="add-ai-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
            <span class="text-xl sm:text-2xl">üß†‚ú®</span>
            <span>A√±adir IA</span>
        </a>
        <a href="#" id="search-menu-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
            <span class="text-xl sm:text-2xl">üî≠</span>
            <span>B√∫squeda</span>
        </a>
        <a href="#" id="achievements-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
            <span class="text-xl sm:text-2xl">üèÖ</span>
            <span>Logros</span>
        </a>
        <a href="#" id="stats-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
            <span class="text-xl sm:text-2xl">üìä</span>
            <span>Estad√≠sticas</span>
        </a>
        <a href="#" id="history-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
            <span class="text-xl sm:text-2xl">üïí</span>
            <span>Historial</span>
        </a>
        <a href="#" id="trophy-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
             <span class="text-xl sm:text-2xl">üèÜ</span>
             <span>Vitrina</span>
        </a>
        <a href="#" id="upload-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
            <span class="text-xl sm:text-2xl">üì§</span>
            <span>Cargar Copia</span>
        </a>
        <a href="#" id="download-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
            <span class="text-xl sm:text-2xl">üíæ</span>
            <span>Descargar</span>
        </a>
    </div>
    <div id="menu-overlay" class="menu-overlay"></div>
    
    <main class="w-full flex flex-col items-center">
        <div class="title-container">
            <h1 id="main-title" class="magic-title"></h1>
        </div>
        
        <header class="flex flex-col items-center justify-between p-4 mb-4 flex-shrink-0 w-full max-w-4xl">
            <div class="flex items-center w-full justify-between mb-4">
                 <button id="open-nav-menu" class="nav-menu-btn rounded-full mr-4">
                     <i class="fa-solid fa-bars text-xl"></i>
                 </button>
                 <div class="flex-1 text-center flex items-center justify-center gap-2 sm:gap-4">
                     <h2 id="user-title" class="text-xl sm:text-2xl font-bold text-yellow-500"></h2>
                     <div id="total-ps-container" class="bg-yellow-500/20 text-yellow-300 font-bold px-3 sm:px-4 py-0.5 sm:py-1 rounded-full text-sm sm:text-lg border border-yellow-500/30">
                        <span id="total-ps-count">0</span> PS ‚ú®
                    </div>
                 </div>
                 <div class="w-12"></div>
            </div>
        </header>

        <div class="w-full max-w-4xl mx-auto flex items-center justify-between mb-4 flex-shrink-0 px-4">
            <button id="prev-month" class="px-3 py-1 sm:px-4 sm:py-2 nav-btn calendar-nav-btn">&lt;</button>
            <h2 id="month-year" class="text-xl sm:text-3xl md:text-4xl font-bold text-center text-[#f0e6d2]"></h2>
            <button id="next-month" class="px-3 py-1 sm:px-4 sm:py-2 nav-btn calendar-nav-btn">&gt;</button>
        </div>

        <div class="w-full max-w-4xl mx-auto flex flex-col items-center">
            <div id="calendar-days" class="calendar-grid w-full"></div>
        </div>
    </main>
    
    <footer class="w-full max-w-4xl mx-auto p-4 flex justify-between items-center">
        <button id="trash-btn" class="nav-btn p-2 sm:p-4 rounded-full shadow-lg transition-transform duration-300 transform hover:scale-110">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 sm:w-8 sm:h-8"><path d="M3 6h18m-2 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2m-6 5v6m4-6v6" stroke="#f7d468" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <div id="total-giveaways-container">
            <span id="total-giveaways-count">0</span>
        </div>
        <button id="discarded-btn" class="nav-btn p-2 sm:p-4 flex items-center shadow-lg transition-transform duration-300 transform hover:scale-110">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 sm:w-8 sm:h-8">
                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="#f7d468" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="2" y1="12" x2="22" y2="12" stroke="#f7d468" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>
    </footer>
    
    <div id="trash-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">Papelera de Sorteos</h2>
                <button id="close-trash-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div id="trash-modal-body" class="space-y-4 max-h-[60vh]"></div>
            <button id="delete-all-trash-btn" class="mt-4 bg-red-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-red-400 transition-colors">Vaciar papelera</button>
        </div>
    </div>
    
    <div id="discarded-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 id="discarded-modal-title" class="text-2xl sm:text-3xl">Sorteos Descartados</h2>
                <button id="close-discarded-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
             <div class="flex justify-between items-center flex-wrap gap-2 mb-4">
                <div>
                    <button data-filter="all" class="filter-btn text-xs font-bold bg-yellow-300 px-2 py-1 rounded-full hover:bg-yellow-400">Todos</button>
                    <button data-filter="duplicate" class="filter-btn text-xs font-bold bg-red-300 px-2 py-1 rounded-full hover:bg-red-400">Duplicados</button>
                    <button data-filter="expired" class="filter-btn text-xs font-bold bg-gray-300 px-2 py-1 rounded-full hover:bg-gray-400">Caducados</button>
                    <button data-filter="foreign" class="filter-btn text-xs font-bold bg-blue-300 px-2 py-1 rounded-full hover:bg-blue-400">Extranjeros</button>
                    <button data-filter="no_date" class="filter-btn text-xs font-bold bg-purple-300 px-2 py-1 rounded-full hover:bg-purple-400">Sin Fecha</button>
                </div>
                <button id="manage-foreign-accounts-btn" class="text-xs font-bold bg-indigo-300 px-2 py-1 rounded-full hover:bg-indigo-400">Gestionar Cuentas</button>
            </div>
            <div id="discarded-modal-body" class="space-y-4 max-h-[60vh]"></div>
            <button id="delete-all-discarded-btn" class="mt-4 bg-red-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-red-400 transition-colors">Eliminar todos los descartados</button>
        </div>
    </div>
    
    <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div id="modal-content" class="w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg flex-col">
             <div class="flex-shrink-0 p-4 sm:p-6 pb-0">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modal-title" class="text-2xl sm:text-3xl">Sorteos del D√≠a</h2>
                    <button id="close-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
                </div>
            </div>
            <div class="p-4 sm:p-6 pt-0">
                <div class="flex justify-between items-center mb-4 text-yellow-900">
                    <button id="select-all-btn" class="text-sm font-bold bg-yellow-300 px-3 py-1 rounded-full hover:bg-yellow-400">Seleccionar todo</button>
                    <button id="deselect-all-btn" class="text-sm font-bold bg-yellow-300 px-3 py-1 rounded-full hover:bg-yellow-400">Deseleccionar todo</button>
                </div>
                <div id="modal-body" class="space-y-4 max-h-[60vh]"></div>
            </div>
        </div>
    </div>

    <div id="add-giveaway-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="add-giveaway-modal-title" class="text-2xl sm:text-3xl">A√±adir Nuevo Sorteo</h2>
                <button id="close-add-giveaway-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div id="add-giveaway-form-body">
                <form id="add-giveaway-form" class="space-y-4">
                    <div>
                        <label for="giveaway-date" class="block font-bold">Fecha del Sorteo:</label>
                        <input type="date" id="giveaway-date" required class="w-full p-2 mt-1 rounded-lg bg-white border border-yellow-400">
                    </div>
                    <div>
                        <label for="giveaway-prize" class="block font-bold">Premio:</label>
                        <input type="text" id="giveaway-prize" placeholder="Ej: Vuelos a capital europea üõ©Ô∏è" required class="w-full p-2 mt-1 rounded-lg bg-white border border-yellow-400">
                    </div>
                    <div>
                        <label for="giveaway-accounts" class="block font-bold">Cuentas:</label>
                        <input type="text" id="giveaway-accounts" placeholder="Ej: @iberia, @travel_spain" class="w-full p-2 mt-1 rounded-lg bg-white border border-yellow-400">
                        <small class="text-gray-500 text-xs">Separar por comas (sin espacios).</small>
                    </div>
                    <div>
                        <label for="giveaway-price" class="block font-bold">Valor (aprox):</label>
                        <input type="text" id="giveaway-price" placeholder="Ej: 50‚Ç¨, 1300‚Ç¨ üí≤" class="w-full p-2 mt-1 rounded-lg bg-white border border-yellow-400">
                    </div>
                    <button type="submit" class="w-full bg-yellow-500 text-yellow-900 py-2 px-4 rounded-lg font-bold hover:bg-yellow-400 transition-colors shadow-lg">Guardar Sorteo</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="search-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">B√∫squeda y Filtros</h2>
                <button id="close-search-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div class="p-4 sm:p-6 pt-0">
                <div class="mb-8">
                    <input type="text" id="search-input-modal" placeholder="Buscar sorteos..." class="w-full p-4 rounded-full bg-web-gradient text-[#f0e6d2] placeholder-[#f0e6d2] border border-yellow-500/20 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <a href="#" onclick="setFilterAndRender('padel'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10 text-[#f0e6d2]">P√°del ü•é</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('travel'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10 text-[#f0e6d2]">Escapadas ‚úàÔ∏è</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('price'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10 text-[#f0e6d2]">+500‚Ç¨ üí≤</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('frikis'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10 text-[#f0e6d2]">Frikis üÉè</span>
                    </a>
                </div>
                <div class="flex justify-center">
                    <a href="#" onclick="setFilterAndRender('all'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10 text-[#f7d468]">Todos ‚ú®</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="add-ai-giveaway-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg text-center">
            <div class="flex justify-between items-center p-6 pb-0">
                <h2 class="text-2xl sm:text-3xl font-bold" id="ai-modal-title">A√±adir Sorteos con IA</h2>
                <button id="close-add-ai-giveaway-modal" class="text-yellow-400 hover:text-yellow-600 text-5xl font-bold">&times;</button>
            </div>
            <div id="ai-modal-content-wrapper">
                <p class="mt-4 font-semibold" id="ai-modal-info">Selecciona hasta 100 im√°genes del sorteo.</p>
                <input type="file" id="ai-image-upload" accept="image/*" multiple class="hidden">
                <button id="select-ai-images-btn" class="mt-6 bg-yellow-500 text-yellow-900 font-bold py-3 px-6 rounded-lg shadow-md hover:bg-yellow-400 transition-colors w-full">
                    üåü Haz tu magia üåü
                </button>
                <div id="ai-queue-container" class="mt-6 text-left" style="display: none;">
                    <h3 class="text-lg font-semibold mb-2">Im√°genes en cola: <span id="ai-queue-count">0</span></h3>
                    <ul id="ai-image-queue" class="bg-yellow-100/20 p-4 rounded-lg border border-yellow-500/30"></ul>
                </div>
                <button id="start-ai-button" class="mt-6 bg-yellow-500 text-yellow-900 font-bold py-3 px-6 rounded-lg shadow-md hover:bg-yellow-400 transition-colors w-full" style="display: none;">
                    Empezar An√°lisis
                </button>
                <div id="ai-status-container" class="mt-8 text-left p-4 rounded-xl border border-yellow-500/20" style="display: none;">
                    <p id="ai-status-message" class="font-semibold text-lg mb-2"></p>
                    <div id="ai-progress-bar" class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mt-2">
                      <div id="ai-progress" class="bg-yellow-400 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div id="ai-summary-results" class="mt-8 text-left p-4 rounded-xl" style="display: none;">
                </div>
                <button id="ai-summary-close-btn" class="mt-6 bg-yellow-500 text-yellow-900 font-bold py-3 px-6 rounded-lg shadow-md hover:bg-yellow-400 transition-colors w-full" style="display: none;">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <div id="notification-modal" class="modal fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
        <div id="notification-modal-content" class="bg-gray-800/80 text-yellow-300 p-6 rounded-xl shadow-xl max-w-lg w-full text-center border-2 border-yellow-500/50">
            <h3 id="notification-title" class="text-xl font-bold mb-2"></h3>
            <div id="notification-content" class="text-sm font-mono overflow-x-auto text-left"></div>
        </div>
    </div>
    
    <div id="duplicate-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">Sorteo Duplicado Detectado</h2>
                <button id="close-duplicate-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <p class="mb-4">Este sorteo ya existe en tu calendario. ¬øQuieres a√±adirlo de nuevo?</p>
            <div id="duplicate-giveaway-info" class="flex flex-col gap-4 text-left mb-4">
                </div>
            <div class="flex justify-center space-x-4">
                <button id="confirm-restore-btn" class="bg-green-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-green-400 transition-colors">A√±adir de nuevo</button>
                <button id="cancel-restore-btn" class="bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-400 transition-colors">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="duplicate-comparison-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-3xl rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">Comparar Sorteos Duplicados</h2>
                <button id="close-duplicate-comparison-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1 p-4 bg-yellow-100/50 rounded-lg border border-yellow-600/20 text-left">
                    <h3 class="text-xl font-bold mb-2">Sorteo Original</h3>
                    <div id="original-giveaway-details"></div>
                </div>
                <div class="flex-1 p-4 bg-red-100/50 rounded-lg border border-red-600/20 text-left">
                    <h3 class="text-xl font-bold mb-2">Sorteo Descartado</h3>
                    <div id="discarded-giveaway-details"></div>
                </div>
            </div>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="merge-giveaway-btn" class="bg-green-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-green-400 transition-colors">Fusionar</button>
                <button id="add-as-new-btn" class="bg-blue-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-400 transition-colors">A√±adir como nuevo</button>
            </div>
        </div>
    </div>

    <div id="move-giveaway-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">Mover Sorteo</h2>
                <button id="close-move-giveaway-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <form id="move-giveaway-form" class="space-y-4">
                <div>
                    <label for="new-giveaway-date" class="block font-bold">Selecciona la nueva fecha:</label>
                    <input type="date" id="new-giveaway-date" required class="w-full p-2 mt-1 rounded-lg bg-white border border-yellow-400">
                </div>
                <button type="submit" class="w-full bg-yellow-500 text-yellow-900 py-2 px-4 rounded-lg font-bold hover:bg-yellow-400 transition-colors shadow-lg">Mover</button>
            </form>
        </div>
    </div>
    
    <div id="history-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-3xl rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">üïí Historial de An√°lisis</h2>
                <button id="close-history-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div id="history-modal-body" class="max-h-[60vh] text-left"></div>
        </div>
    </div>
    
    <div id="foreign-accounts-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">Gestionar Cuentas Extranjeras</h2>
                <button id="close-foreign-accounts-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <p class="mb-4 text-sm">Aqu√≠ puedes ver y eliminar las cuentas que has marcado como extranjeras.</p>
            <div id="foreign-accounts-modal-body" class="space-y-2 max-h-[60vh]"></div>
        </div>
    </div>
    
    <div id="trophy-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-3xl rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">üèÜ Vitrina de Trofeos üèÜ</h2>
                <button id="close-trophy-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div id="trophy-modal-body" class="max-h-[60vh]"></div>
        </div>
    </div>
    
    <div id="stats-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">üìä Estad√≠sticas de Sorteos</h2>
                <button id="close-stats-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div id="stats-modal-body" class="text-left"></div>
            <hr class="border-yellow-600/20 my-4">
            <div class="flex justify-center items-center flex-wrap gap-2 sm:gap-4">
                <button id="manage-blocks-btn" class="bg-purple-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-purple-400 transition-colors">Gestionar Bloqueos</button>
                <button id="share-stats-btn" class="bg-blue-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-400 transition-colors">üì≤ Compartir Resumen</button>
                <button id="open-charts-modal" class="bg-yellow-500 text-yellow-900 py-2 px-4 rounded-lg font-bold hover:bg-yellow-400 transition-colors">Ver Gr√°ficos üìà</button>
            </div>
        </div>
    </div>
    
    <div id="block-management-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">Gesti√≥n de Cuentas Bloqueadas</h2>
                <button id="close-block-management-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div class="flex justify-center items-center flex-wrap gap-2 sm:gap-4 mb-4">
                <button id="block-like-btn" class="nav-btn p-2 sm:p-4 rounded-full shadow-lg transition-transform duration-300 transform hover:scale-110">
                    <span class="text-xl sm:text-2xl mr-2">üëçüö´</span>
                    <span class="hidden sm:inline">Bloquear 'Me gusta'</span>
                </button>
                <button id="block-comment-btn" class="nav-btn p-2 sm:p-4 rounded-full shadow-lg transition-transform duration-300 transform hover:scale-110">
                    <span class="text-xl sm:text-2xl mr-2">üí¨üö´</span>
                    <span class="hidden sm:inline">Bloquear Comentarios</span>
                </button>
            </div>
            <div id="block-stats-container" class="text-left"></div>
        </div>
    </div>

    <div id="charts-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-4xl rounded-2xl shadow-2xl modal-default-bg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">Gr√°ficos de Estad√≠sticas</h2>
                <button id="close-charts-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div id="charts-modal-body">
                <div class="chart-container">
                    <h3 class="text-lg font-bold mb-2 text-center text-yellow-700">Victorias por Categor√≠a</h3>
                    <canvas id="category-pie-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="text-lg font-bold mb-2 text-center text-yellow-700">Valor de Premios Ganados por Mes</h3>
                    <canvas id="monthly-value-bar-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="achievements-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-3xl rounded-2xl shadow-2xl modal-default-bg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">üèÖ Logros y Metas</h2>
                <button id="close-achievements-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div id="achievements-modal-body" class="max-h-[60vh] text-left">
                </div>
        </div>
    </div>


    <script id="animations-script">
        function animateStarryBackground() {
            const starsContainer = document.getElementById('magic-stars-container');
            if (!starsContainer) return;
            for (let i = 0; i < 100; i++) {
                let star = document.createElement('div');
                star.classList.add('star');
                let size = Math.random() * 3;
                star.style.width = `${size}px`; star.style.height = `${size}px`;
                star.style.top = `${Math.random() * 100}%`; star.style.left = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 4}s`;
                if(Math.random() > 0.8) {
                    star.classList.add('moving-star');
                    star.style.animationDuration = `${Math.random() * 50 + 50}s`;
                }
                starsContainer.appendChild(star);
            }
        }

        function animateTitle() {
            const titleEl = document.getElementById('main-title');
            if (!titleEl) return;
            const titleText = "Misorteos";
            titleEl.innerHTML = titleText.split('').map(char => `<span class="letter" style="position: relative;">${char === ' ' ? '&nbsp;' : char}</span>`).join('');
            const letters = Array.from(titleEl.children);
            const revealDuration = letters.length * 150;

            letters.forEach((letter, index) => {
                setTimeout(() => {
                    letter.style.opacity = '1'; letter.style.transform = 'translateY(0)';
                    for(let i = 0; i < 3; i++) {
                        const sparkle = document.createElement('span');
                        sparkle.classList.add('sparkle');
                        sparkle.style.top = `${Math.random()*80-40}%`; sparkle.style.left = `${Math.random()*80-40}%`;
                        sparkle.style.animation = `letter-reveal-sparkle 0.5s ${i * 0.1}s ease-out forwards`;
                        letter.appendChild(sparkle);
                        setTimeout(() => sparkle.remove(), 1000);
                    }
                }, index * 150);
            });
            
            setTimeout(() => {
                setInterval(() => {
                    const randomLetter = letters[Math.floor(Math.random() * letters.length)];
                    if (randomLetter.innerText.trim() === '') return;
                    const sparkle = document.createElement('span');
                    sparkle.classList.add('fountain-sparkle');
                    sparkle.style.left = `${Math.random() * 80 + 10}%`;
                    randomLetter.appendChild(sparkle);
                    setTimeout(() => sparkle.remove(), 1500);
                }, 100);
            }, revealDuration);
        }

        function animateShootingStar(itemContainer, callback) {
            const star = document.createElement('div');
            star.className = 'shooting-star';
            itemContainer.appendChild(star);
            
            star.addEventListener('animationend', () => {
                star.remove();
                if (callback) callback();
            }, { once: true });
        }
    </script>
    
    <script src="giveaways_new.js"></script>
    <script src="discardedGiveaways_new.js"></script>
    <script>
        // Carga de datos desde localStorage o valores por defecto
        let giveaways;
        const savedGiveaways = localStorage.getItem('giveaways');
        if (savedGiveaways) {
            giveaways = JSON.parse(savedGiveaways);
        } else {
            giveaways = window.giveaways || {};
        }

        let completedGiveaways = JSON.parse(localStorage.getItem(`completedGiveaways`)) || {};
        let wonGiveaways = JSON.parse(localStorage.getItem('wonGiveaways')) || [];
        let analysisHistory = JSON.parse(localStorage.getItem('analysisHistory')) || [];
        let userPoints = JSON.parse(localStorage.getItem('userPoints')) || { total: 0, monthly: 0, lastUpdatedMonth: new Date().getMonth() };
        
        // --- DATABASE DE LOGROS (NUEVA Y EXPANDIDA) ---
        const achievementList = {
            bronze: [
                { id: 'b_add_1', name: 'El Primer Paso', icon: 'üå±', desc: 'A√±ade tu primer sorteo manualmente.', ps: 5, condition: (c) => c.totalManualAdds >= 1 },
                { id: 'b_add_ia_1', name: 'Mirando al Futuro', icon: 'ü§ñ', desc: 'A√±ade tu primer sorteo usando la IA.', ps: 5, condition: (c) => c.totalGiveawaysAddedAI >= 1 },
                { id: 'b_complete_1', name: '¬°Manos a la Obra!', icon: '‚úÖ', desc: 'Marca tu primer sorteo como completado.', ps: 5, condition: (c) => c.totalGiveawaysCompleted >= 1 },
                { id: 'b_move_1', name: 'El Organizador', icon: 'üóìÔ∏è', desc: 'Mueve un sorteo de d√≠a por primera vez.', ps: 5, condition: (c) => c.firstMove },
                { id: 'b_restore_1', name: 'Segunda Oportunidad', icon: '‚ôªÔ∏è', desc: 'Restaura un sorteo desde la papelera.', ps: 10, condition: (c) => c.restoredFromTrash >= 1 },
                { id: 'b_search_1', name: 'El Detective', icon: 'üïµÔ∏è', desc: 'Usa la b√∫squeda o un filtro por primera vez.', ps: 5, condition: (c) => c.searchesMade >= 1 },
                { id: 'b_win_1', name: '¬°Estoy en racha!', icon: 'üéâ', desc: 'Gana tu primer sorteo (de cualquier valor).', ps: 20, condition: (c) => c.totalGiveawaysWon >= 1 },
            ],
            silver: [
                { id: 's_add_100', name: 'Coleccionista Amateur', icon: 'üì¶', desc: 'Registra un total de 100 sorteos.', ps: 10, condition: (c) => c.totalGiveawaysAdded >= 100 },
                { id: 's_add_ia_50', name: 'Asistente de la IA', icon: 'üß†', desc: 'A√±ade 50 sorteos usando la IA.', ps: 15, condition: (c) => c.totalGiveawaysAddedAI >= 50 },
                { id: 's_complete_250', name: 'El Finalizador', icon: '‚úîÔ∏è', desc: 'Completa un total de 250 sorteos.', ps: 10, condition: (c) => c.totalGiveawaysCompleted >= 250 },
                { id: 's_firewall_1', name: 'El Inmun√≥logo', icon: 'üõ°Ô∏è', desc: 'A√±ade tu primera cuenta al cortafuegos de extranjeras.', ps: 15, condition: (c) => c.foreignAccountsBlocked >= 1 },
                { id: 's_win_value_100', name: 'Cazador de Tesoros', icon: 'üíé', desc: 'Gana un premio valorado en m√°s de 100‚Ç¨.', ps: 25, condition: (c) => c.winsOver100 >= 1 },
                { id: 's_win_5', name: 'Lluvia de Victorias', icon: 'üå¶Ô∏è', desc: 'Gana 5 sorteos en total.', ps: 25, condition: (c) => c.totalGiveawaysWon >= 5 },
                { id: 's_specialist_3', name: 'El Especialista', icon: '‚≠ê', desc: 'Gana 3 sorteos de la misma categor√≠a.', ps: 30, condition: (c) => Object.values(c.categoryWins).some(val => val >= 3) },
            ],
            gold: [
                { id: 'g_add_500', name: 'Archivista Profesional', icon: 'üóÑÔ∏è', desc: 'Registra un total de 500 sorteos.', ps: 20, condition: (c) => c.totalGiveawaysAdded >= 500 },
                { id: 'g_ia_process_500', name: 'Conexi√≥n Neuronal', icon: 'üì°', desc: 'Procesa un total de 500 im√°genes con la IA.', ps: 25, condition: (c) => c.totalImagesProcessedAI >= 500 },
                { id: 'g_win_25', name: 'El Conquistador', icon: 'üè∞', desc: 'Gana 25 sorteos en total.', ps: 50, condition: (c) => c.totalGiveawaysWon >= 25 },
                { id: 'g_win_double', name: 'Doble Suerte', icon: '‚úåÔ∏è', desc: 'Gana dos sorteos en el mismo d√≠a.', ps: 75, condition: (c) => Object.values(c.sameDayWins).some(val => val >= 2) },
                { id: 'g_value_2500', name: 'Acaparador', icon: 'üí∞', desc: 'Supera los 2.500‚Ç¨ en valor total de premios.', ps: 50, condition: (c) => c.totalValueWon >= 2500 },
                { id: 'g_merge_1', name: 'El Fusionador', icon: 'üß¨', desc: 'Fusiona un sorteo duplicado con su original.', ps: 20, condition: (c) => c.mergedDuplicates >= 1 },
            ],
            platinum: [
                { id: 'p_add_2000', name: 'Biblioteca de Sorteos', icon: 'üèõÔ∏è', desc: 'Registra 2.000 sorteos.', ps: 50, condition: (c) => c.totalGiveawaysAdded >= 2000 },
                { id: 'p_complete_1500', name: 'M√°quina de Completar', icon: 'üíØ', desc: 'Completa 1.500 sorteos.', ps: 40, condition: (c) => c.totalGiveawaysCompleted >= 1500 },
                { id: 'p_win_value_2000', name: 'El Toque de Midas', icon: '‚ú®', desc: 'Gana un premio valorado en m√°s de 2.000‚Ç¨.', ps: 100, condition: (c) => c.winsOver2000 >= 1 },
                { id: 'p_win_50', name: 'Im√°n de Premios', icon: 'üß≤', desc: 'Gana 50 sorteos en total.', ps: 100, condition: (c) => c.totalGiveawaysWon >= 50 },
                { id: 'p_talisman', name: 'Talism√°n Dorado', icon: 'üçÄ', desc: 'Gana 3 premios de la misma cuenta de Instagram.', ps: 75, condition: (c) => Object.values(c.winsFromSameAccount).some(val => val >= 3) },
            ],
            diamond: [
                { id: 'd_win_100', name: 'Coleccionista Legendario', icon: 'üëë', desc: 'Gana 100 sorteos en total.', ps: 200, condition: (c) => c.totalGiveawaysWon >= 100 },
                { id: 'd_value_25000', name: 'Toque de Midas', icon: 'üëë', desc: 'Acumula 25.000‚Ç¨ en premios ganados.', ps: 250, condition: (c) => c.totalValueWon >= 25000 },
                { id: 'd_nostradamus', name: 'El Nostradamus', icon: 'üìú', desc: 'Gana un sorteo que a√±adiste m√°s de 6 meses antes.', ps: 150, condition: (c) => c.nostradamusWins >= 1 },
                { id: 'd_win_triple', name: 'Tr√©bol de Doce Hojas', icon: 'üçÄ', desc: 'Gana 3 sorteos en un mismo d√≠a.', ps: 200, condition: (c) => Object.values(c.sameDayWins).some(val => val >= 3) },
            ],
            merits: [ 
                { id: 'm_photo', name: 'Victoria Fotogr√°fica', icon: 'üì∏', desc: 'Gana un sorteo cuyo premio sea una c√°mara.', ps: 20, condition: (c, u, p) => p && /c√°mara|instax/i.test(p.prize) },
                { id: 'm_sweet', name: 'El Dulce Sabor de la Victoria', icon: 'üç¨', desc: 'Gana un sorteo de comida o dulces.', ps: 20, condition: (c, u, p) => p && /comida|dulces|jam√≥n|chocolate|tarta|lote de productos/i.test(p.prize) },
                { id: 'm_tech', name: 'Victoria Tecnol√≥gica', icon: 'üíª', desc: 'Gana un premio de tecnolog√≠a (m√≥vil, tablet, consola, etc).', ps: 25, condition: (c, u, p) => p && /m√≥vil|consola|auriculares|tablet|port√°til|pc|ps5|nintendo|xbox/i.test(p.prize) },
                { id: 'm_fashion', name: 'Icono de la Moda', icon: 'üë†', desc: 'Gana un premio de moda (ropa, zapatillas, bolso).', ps: 20, condition: (c, u, p) => p && /ropa|zapatillas|bolso|camiseta|sudadera|gafas de sol/i.test(p.prize) },
                { id: 'm_beauty', name: 'Gur√∫ de Belleza', icon: 'üíÑ', desc: 'Gana un lote de productos de cosm√©tica o maquillaje.', ps: 20, condition: (c, u, p) => p && /belleza|maquillaje|cosm√©tica|perfume|lote de productos/i.test(p.prize) },
                { id: 'm_experience', name: 'Coleccionista de Experiencias', icon: 'üé´', desc: 'Gana entradas, una cena o una experiencia.', ps: 30, condition: (c, u, p) => p && /entradas|cena|experiencia|abono|festival/i.test(p.prize) },
                { id: 'm_fast', name: 'A Contrarreloj', icon: '‚è±Ô∏è', desc: 'A√±ade y completa un sorteo el mismo d√≠a que finaliza.', ps: 15, condition: (c) => c.lastMinuteCompletes >= 1 },
                { id: 'm_seer', name: 'El Adivino', icon: 'üëÅÔ∏è', desc: 'Gana un sorteo que previamente hab√≠as movido de fecha.', ps: 25, condition: (c) => c.movedGiveawayWins >= 1 },
                { id: 'm_repeat', name: 'El Reincidente', icon: 'üîÅ', desc: 'Gana un sorteo de una cuenta de la que ya ganaste antes.', ps: 30, condition: (c) => Object.values(c.winsFromSameAccount).some(val => val >= 2) },
                { id: 'm_rival', name: 'Rival Eterno', icon: 'ü§∫', desc: 'Participa en m√°s de 50 sorteos de una misma cuenta sin ganar.', ps: 10, condition: (c) => Object.values(c.playsOnSameAccount).some(val => val >= 50) },
            ],
            prestige: [
                { id: 't_padel', title: 'Maestro/a de la Pala', req: 'Gana 15 sorteos de P√°del.', condition: (c) => c.categoryWins.padel >= 15 },
                { id: 't_travel', title: 'N√≥mada Legendario/a', req: 'Gana 15 sorteos de Viajes.', condition: (c) => c.categoryWins.viajes >= 15 },
                { id: 't_friki', title: 'Se√±or/a de los Funkos', req: 'Gana 15 sorteos Frikis.', condition: (c) => c.categoryWins.frikis >= 15 },
                { id: 't_polymath', title: 'El/La Pol√≠mata', req: 'Consigue los 3 t√≠tulos de especialista (P√°del, Viajes, Frikis).', condition: (c, u) => u.includes('t_padel') && u.includes('t_travel') && u.includes('t_friki') },
                { id: 't_oracle', title: 'Or√°culo de la IA', req: 'A√±ade 500 sorteos con la IA.', condition: (c) => c.totalGiveawaysAddedAI >= 500 },
                { id: 't_magnate', title: 'Fortuna Personificada', req: 'Supera los 10.000‚Ç¨ en premios.', condition: (c) => c.totalValueWon >= 10000 },
                { id: 't_consistency', title: 'El Metr√≥nomo', req: 'Gana al menos un sorteo al mes durante 12 meses seguidos.', condition: (c) => c.monthlyWinStreak >= 12 },
                { id: 't_allrounder', title: 'El/La Todoterreno', req: 'Gana al menos 5 premios en cada una de las 4 categor√≠as.', condition: (c) => c.categoryWins.padel >= 5 && c.categoryWins.viajes >= 5 && c.categoryWins.frikis >= 5 && c.categoryWins.otros >= 5 },
                { id: 't_monopolist', title: 'El/La Monopolista', req: 'Gana premios de 50 cuentas organizadoras diferentes.', condition: (c) => Object.keys(c.winsFromSameAccount).length >= 50 },
                { id: 't_perfectionist', title: 'El/La Perfeccionista', req: 'Completa todos los logros de Bronce, Plata y Oro.', condition: (c, u) => [...achievementList.bronze, ...achievementList.silver, ...achievementList.gold].every(ach => u.includes(ach.id)) },
                { id: 't_legend', title: 'Leyenda Viva', req: 'Desbloquea 10 T√≠tulos de Prestigio.', condition: (c, u) => u.filter(id => id.startsWith('t_')).length >= 10 },
            ]
        };

        const initialAchievements = {
            unlocked: [],
            title: 'Buscador/a de Tr√©boles üçÄ',
            counters: {
                totalGiveawaysAdded: 0,
                totalManualAdds: 0,
                totalGiveawaysAddedAI: 0,
                totalGiveawaysCompleted: 0,
                totalGiveawaysWon: 0,
                totalValueWon: 0,
                categoryWins: { padel: 0, viajes: 0, frikis: 0, otros: 0 },
                firstMove: false,
                restoredFromTrash: 0,
                searchesMade: 0,
                winsOver100: 0,
                winsOver2000: 0,
                foreignAccountsBlocked: 0,
                sniperWins: 0,
                sameDayWins: {},
                mergedDuplicates: 0,
                totalImagesProcessedAI: 0,
                winsFromSameAccount: {},
                playsOnSameAccount: {},
                nostradamusWins: 0,
                monthlyWinStreak: 0,
                lastWinMonthYear: null,
                movedGiveawayWins: 0,
                lastMinuteCompletes: 0,
            }
        };
        
        let userAchievements = JSON.parse(localStorage.getItem('userAchievements')) || initialAchievements;
        
        let blockHistory = JSON.parse(localStorage.getItem('blockHistory')) || [];
        let completedGiveawayCount = Object.keys(completedGiveaways).length;
        let currentDate = new Date();
        let currentFilter = 'all';
        let searchQuery = '';
        const MAX_IMAGES = 100;
        let discardedFilter = 'all';
        let totalCaptures = 0;
        let addedGiveawaysCount = 0;
        let duplicateGiveawaysCount = 0;
        let expiredGiveawaysCount = 0;
        let foreignGiveawaysCount = 0;
        let noDateGiveawaysCount = 0;
        let addedGiveawaysDetails = [];
        let duplicateGiveawaysDetails = [];
        let expiredGiveawaysDetails = [];
        let foreignGiveawaysDetails = [];
        let noDateGiveawaysDetails = [];
        let failedFilesDetails = [];
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let trashGiveaways = JSON.parse(localStorage.getItem('trashGiveaways')) || [];
        let foreignAccounts = JSON.parse(localStorage.getItem('foreignAccounts')) || [];
        let discardedGiveaways;
        const savedDiscarded = localStorage.getItem('discardedGiveaways');
        if (savedDiscarded) {
             discardedGiveaways = JSON.parse(savedDiscarded);
        } else {
             discardedGiveaways = window.discardedGiveaways || [];
        }

        // --- Referencias a elementos del DOM ---
        const monthYearEl = document.getElementById('month-year');
        const calendarDaysEl = document.getElementById('calendar-days');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const modal = document.getElementById('modal');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal');
        const addManualBtn = document.getElementById('add-manual-btn');
        const addGiveawayModal = document.getElementById('add-giveaway-modal');
        const closeAddGiveawayModalBtn = document.getElementById('close-add-giveaway-modal');
        const addGiveawayForm = document.getElementById('add-giveaway-form');
        const giveawayDateInput = document.getElementById('giveaway-date');
        const giveawayPrizeInput = document.getElementById('giveaway-prize');
        const giveawayAccountsInput = document.getElementById('giveaway-accounts');
        const giveawayPriceInput = document.getElementById('giveaway-price');
        const totalGiveawaysEl = document.getElementById('total-giveaways-count');
        const searchMenuBtn = document.getElementById('search-menu-btn');
        const searchModal = document.getElementById('search-modal');
        const closeSearchModalBtn = document.getElementById('close-search-modal');
        const searchInputModal = document.getElementById('search-input-modal');
        const selectAllBtn = document.getElementById('select-all-btn');
        const deselectAllBtn = document.getElementById('deselect-all-btn');
        const addAIBtn = document.getElementById('add-ai-btn');
        const addAIGiveawayModal = document.getElementById('add-ai-giveaway-modal');
        const closeAddAIGiveawayModalBtn = document.getElementById('close-add-ai-giveaway-modal');
        const selectAiImagesBtn = document.getElementById('select-ai-images-btn');
        const aiImageInput = document.getElementById('ai-image-upload');
        const aiQueueContainer = document.getElementById('ai-queue-container');
        const aiQueueList = document.getElementById('ai-image-queue');
        const aiQueueCount = document.getElementById('ai-queue-count');
        const startAiButton = document.getElementById('start-ai-button');
        const aiStatusContainer = document.getElementById('ai-status-container');
        const aiStatusMessage = document.getElementById('ai-status-message');
        const aiProgressBar = document.getElementById('ai-progress');
        const aiSummaryResults = document.getElementById('ai-summary-results');
        const aiSummaryCloseBtn = document.getElementById('ai-summary-close-btn');
        const trashBtn = document.getElementById('trash-btn');
        const discardedBtn = document.getElementById('discarded-btn');
        const statsBtn = document.getElementById('stats-btn');
        const historyBtn = document.getElementById('history-btn');
        const trophyBtn = document.getElementById('trophy-btn');
        const achievementsBtn = document.getElementById('achievements-btn');
        const navMenu = document.getElementById('nav-menu');
        const openNavMenuBtn = document.getElementById('open-nav-menu');
        const closeNavMenuBtn = document.getElementById('close-nav-menu');
        const menuOverlay = document.getElementById('menu-overlay');
        const userTitleEl = document.getElementById('user-title');
        const totalPsCountEl = document.getElementById('total-ps-count');
        const statsModal = document.getElementById('stats-modal');
        const historyModal = document.getElementById('history-modal');
        const trophyModal = document.getElementById('trophy-modal');
        const achievementsModal = document.getElementById('achievements-modal');
        const trophyModalBody = document.getElementById('trophy-modal-body');
        const historyModalBody = document.getElementById('history-modal-body');
        const achievementsModalBody = document.getElementById('achievements-modal-body');
        const closeStatsModalBtn = document.getElementById('close-stats-modal');
        const closeHistoryModalBtn = document.getElementById('close-history-modal');
        const closeTrophyModalBtn = document.getElementById('close-trophy-modal');
        const closeAchievementsModalBtn = document.getElementById('close-achievements-modal');
        const trashModal = document.getElementById('trash-modal');
        const closeTrashModalBtn = document.getElementById('close-trash-modal');
        const trashModalBody = document.getElementById('trash-modal-body');
        const deleteAllTrashBtn = document.getElementById('delete-all-trash-btn');
        const discardedModal = document.getElementById('discarded-modal');
        const closeDiscardedModalBtn = document.getElementById('close-discarded-modal');
        const discardedModalBody = document.getElementById('discarded-modal-body');
        const deleteAllDiscardedBtn = document.getElementById('delete-all-discarded-btn');
        const duplicateModal = document.getElementById('duplicate-modal');
        const closeDuplicateModalBtn = document.getElementById('close-duplicate-modal');
        const duplicateGiveawayInfo = document.getElementById('duplicate-giveaway-info');
        const confirmRestoreBtn = document.getElementById('confirm-restore-btn');
        const cancelRestoreBtn = document.getElementById('cancel-restore-btn');
        const moveGiveawayModal = document.getElementById('move-giveaway-modal');
        const closeMoveGiveawayModalBtn = document.getElementById('close-move-giveaway-modal');
        const moveGiveawayForm = document.getElementById('move-giveaway-form');
        const newGiveawayDateInput = document.getElementById('new-giveaway-date');
        const openChartsModalBtn = document.getElementById('open-charts-modal');
        const chartsModal = document.getElementById('charts-modal');
        const closeChartsModalBtn = document.getElementById('close-charts-modal');
        const duplicateComparisonModal = document.getElementById('duplicate-comparison-modal');
        const closeDuplicateComparisonModalBtn = document.getElementById('close-duplicate-comparison-modal');
        const originalGiveawayDetails = document.getElementById('original-giveaway-details');
        const discardedGiveawayDetails = document.getElementById('discarded-giveaway-details');
        const mergeGiveawayBtn = document.getElementById('merge-giveaway-btn');
        const addAsNewBtn = document.getElementById('add-as-new-btn');
        const manageForeignAccountsBtn = document.getElementById('manage-foreign-accounts-btn');
        const foreignAccountsModal = document.getElementById('foreign-accounts-modal');
        const closeForeignAccountsModalBtn = document.getElementById('close-foreign-accounts-modal');
        const foreignAccountsModalBody = document.getElementById('foreign-accounts-modal-body');
        const manageBlocksBtn = document.getElementById('manage-blocks-btn');
        const blockManagementModal = document.getElementById('block-management-modal');
        const closeBlockManagementModalBtn = document.getElementById('close-block-management-modal');
        const blockLikeBtn = document.getElementById('block-like-btn');
        const blockCommentBtn = document.getElementById('block-comment-btn');
        const blockStatsContainer = document.getElementById('block-stats-container');
        
        let giveawayToMove = null;
        let originalDateOfGiveaway = null;
        let imageQueue = [];
        let isProcessing = false;
        let currentIndex = 0;
        
        // --- FUNCIONES DE LA APLICACI√ìN ---
        
        const showNotification = (title, message) => {
            const notificationModal = document.getElementById('notification-modal');
            const notificationTitle = document.getElementById('notification-title');
            const notificationContent = document.getElementById('notification-content');
            notificationTitle.textContent = title;
            notificationContent.textContent = message;
            notificationModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                notificationModal.classList.add('is-visible');
            });
            setTimeout(() => {
                notificationModal.classList.remove('is-visible');
                setTimeout(() => {
                    notificationModal.classList.add('hidden');
                }, 300);
            }, 4000);
        };

        const saveGiveaways = () => localStorage.setItem('giveaways', JSON.stringify(giveaways));
        const saveCompletedGiveaways = () => localStorage.setItem(`completedGiveaways`, JSON.stringify(completedGiveaways));
        const saveTrashGiveaways = () => localStorage.setItem('trashGiveaways', JSON.stringify(trashGiveaways));
        const saveDiscardedGiveaways = () => localStorage.setItem('discardedGiveaways', JSON.stringify(discardedGiveaways));
        const saveForeignAccounts = () => localStorage.setItem('foreignAccounts', JSON.stringify(foreignAccounts));
        const saveWonGiveaways = () => localStorage.setItem('wonGiveaways', JSON.stringify(wonGiveaways));
        const saveAnalysisHistory = () => localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
        const saveUserPoints = () => localStorage.setItem('userPoints', JSON.stringify(userPoints));
        const saveUserAchievements = () => localStorage.setItem('userAchievements', JSON.stringify(userAchievements));
        const saveBlockHistory = () => localStorage.setItem('blockHistory', JSON.stringify(blockHistory));
        
        const updatePointsDisplay = () => {
            if (totalPsCountEl) {
                totalPsCountEl.textContent = userPoints.total;
            }
        };

        const addPoints = (pointsToAdd) => {
            userPoints.total += pointsToAdd;
            saveUserPoints();
            updatePointsDisplay();
        };

        const parsePrice = (priceString) => {
            if (!priceString || typeof priceString !== 'string') return 0;
            const cleanedString = priceString.replace(/[^0-9,.]/g, '').replace(',', '.');
            const numericValue = parseFloat(cleanedString);
            return isNaN(numericValue) ? 0 : numericValue;
        };

        const checkAchievements = (action, data = null) => {
            const today = new Date().toISOString().slice(0, 10);
            const counters = userAchievements.counters;

            counters.totalGiveawaysAdded = Object.values(giveaways).flat().length + wonGiveaways.length;
            counters.totalGiveawaysCompleted = Object.keys(completedGiveaways).length;
            counters.totalGiveawaysWon = wonGiveaways.length;
            counters.totalValueWon = wonGiveaways.reduce((sum, g) => sum + parsePrice(g.price), 0);

            if (action === 'add-manual') counters.totalManualAdds = (counters.totalManualAdds || 0) + 1;
            if (action === 'add-ai') counters.totalGiveawaysAddedAI = (counters.totalGiveawaysAddedAI || 0) + 1;
            if (action === 'move') counters.firstMove = true;
            if (action === 'restore') counters.restoredFromTrash = (counters.restoredFromTrash || 0) + 1;
            if (action === 'search') counters.searchesMade = (counters.searchesMade || 0) + 1;
            if (action === 'block-foreign') counters.foreignAccountsBlocked = (counters.foreignAccountsBlocked || 0) + 1;
            if (action === 'merge') counters.mergedDuplicates = (counters.mergedDuplicates || 0) + 1;
            if (action === 'complete' && data.giveawayDate === today) counters.lastMinuteCompletes = (counters.lastMinuteCompletes || 0) + 1;

            if (action === 'win') {
                const prizeValue = parsePrice(data.price);
                if (prizeValue > 100) counters.winsOver100 = (counters.winsOver100 || 0) + 1;
                if (prizeValue > 2000) counters.winsOver2000 = (counters.winsOver2000 || 0) + 1;
                
                const categoryMap = { 'ü•é': 'padel', 'üõ©Ô∏è': 'viajes', 'üÉè': 'frikis' };
                let prizeCategory = 'otros';
                for (const emoji in categoryMap) {
                    if (data.prize.includes(emoji)) { prizeCategory = categoryMap[emoji]; break; }
                }
                counters.categoryWins[prizeCategory]++;
                
                counters.sameDayWins[today] = (counters.sameDayWins[today] || 0) + 1;

                data.accounts.forEach(acc => {
                    counters.winsFromSameAccount[acc] = (counters.winsFromSameAccount[acc] || 0) + 1;
                });

                if(data.moved) counters.movedGiveawayWins = (counters.movedGiveawayWins || 0) + 1;

                if (data.addDate) {
                    const addDate = new Date(data.addDate);
                    const winDate = new Date(data.wonDate);
                    const diffMonths = (winDate.getFullYear() - addDate.getFullYear()) * 12 + (winDate.getMonth() - addDate.getMonth());
                    if (diffMonths >= 6) counters.nostradamusWins = (counters.nostradamusWins || 0) + 1;
                }
            }
            
            const allAchievementTypes = [...achievementList.bronze, ...achievementList.silver, ...achievementList.gold, ...achievementList.platinum, ...achievementList.diamond, ...achievementList.merits, ...achievementList.prestige];
            allAchievementTypes.forEach(ach => {
                if (!userAchievements.unlocked.includes(ach.id)) {
                    const conditionData = action === 'win' ? data : null;
                    if (ach.condition(counters, userAchievements.unlocked, conditionData)) {
                        userAchievements.unlocked.push(ach.id);
                        const title = ach.title || ach.name;
                        const isPrestige = ach.id.startsWith('t_');
                        showNotification(`üèÜ ${isPrestige ? 'T√≠tulo Desbloqueado' : 'Logro Desbloqueado'}!`, title);
                        if (ach.ps) addPoints(ach.ps);
                        if (isPrestige) {
                            userAchievements.title = ach.title;
                        }
                    }
                }
            });

            saveUserAchievements();
            userTitleEl.textContent = userAchievements.title;
        };

        const isDuplicateGiveaway = (newGiveaway) => {
            return Object.values(giveaways).flat().find(g => 
                g.prize === newGiveaway.prize && 
                (g.accounts || []).join() === (newGiveaway.accounts || []).map(acc => `@${acc}`).join()
            ) || null;
        };
        
        const renderCalendar = () => {
            calendarDaysEl.innerHTML = '';
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            monthYearEl.textContent = `${currentDate.toLocaleDateString('es-ES', { month: 'long' }).toUpperCase()}`;
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayOffset = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;
            let totalGiveawaysCount = 0;
            for (let i = 0; i < dayOffset; i++) { calendarDaysEl.innerHTML += `<div></div>`; }
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayGiveaways = (giveaways[dateStr] || []).filter(g => {
                    const prize = g.prize ? g.prize.toLowerCase() : '';
                    const searchText = searchQuery.toLowerCase();
                    let isMatch = true;
                    if(currentFilter !== 'all') {
                         isMatch = (currentFilter === 'padel' && prize.includes('ü•é')) ||
                                   (currentFilter === 'travel' && prize.includes('üõ©Ô∏è')) ||
                                   (currentFilter === 'price' && prize.includes('üí≤')) ||
                                   (currentFilter === 'frikis' && prize.includes('üÉè'));
                    }
                    if (searchQuery && !prize.includes(searchText)) isMatch = false;
                    return isMatch;
                });
                totalGiveawaysCount += dayGiveaways.length;
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.draggable = true;
                dayEl.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', dateStr);
                    e.dataTransfer.effectAllowed = 'move';
                });
                let dayNumberHTML = `<span class="day-number">${day}</span>`;
                if (dayGiveaways.length > 0) {
                    dayEl.classList.add('has-giveaway');
                    dayEl.dataset.date = dateStr;
                    const remainingCount = dayGiveaways.filter(g => !completedGiveaways[g.id]).length;
                    if (remainingCount > 0) {
                        dayNumberHTML += `<span class="giveaway-count rounded-full">${remainingCount}</span>`;
                    } else {
                        dayEl.classList.add('all-done');
                        dayNumberHTML += `<span class="text-2xl mt-1">‚ú®</span>`;
                    }
                }
                dayEl.innerHTML = dayNumberHTML;
                calendarDaysEl.appendChild(dayEl);
            }
            if (totalGiveawaysEl) totalGiveawaysEl.textContent = totalGiveawaysCount;
        };

        const buildModal = (dateStr) => {
            let dayGiveaways = (giveaways[dateStr] || []).filter(g => {
                const prize = g.prize ? g.prize.toLowerCase() : '';
                const searchText = searchQuery.toLowerCase();
                let isMatch = true;
                if(currentFilter !== 'all') {
                         isMatch = (currentFilter === 'padel' && prize.includes('ü•é')) ||
                                   (currentFilter === 'travel' && prize.includes('üõ©Ô∏è')) ||
                                   (currentFilter === 'price' && prize.includes('üí≤')) ||
                                   (currentFilter === 'frikis' && prize.includes('üÉè'));
                }
                if (searchQuery && !prize.includes(searchText)) isMatch = false;
                return isMatch;
            });
            
            // --- NUEVA L√ìGICA DE ORDENACI√ìN ---
            dayGiveaways.sort((a, b) => {
                const aCompleted = completedGiveaways[a.id];
                const bCompleted = completedGiveaways[b.id];
                const aHasTime = a.ends_at_time != null;
                const bHasTime = b.ends_at_time != null;

                if (aCompleted !== bCompleted) {
                    return aCompleted ? 1 : -1; // Mover completados al final
                }
                if (aHasTime !== bHasTime) {
                    return aHasTime ? -1 : 1; // Mover con hora al principio
                }
                return 0; // Mantener el orden original para el resto
            });

            document.getElementById('modal-title').textContent = `Sorteos del ${new Date(dateStr+'T00:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })}`;
            modalBody.innerHTML = '';
            let hasPadel = false, hasTravel = false;
            dayGiveaways.forEach(giveaway => {
                const itemContainer = document.createElement('div');
                itemContainer.className = `giveaway-item p-3 rounded-lg shadow-inner flex justify-between items-center border border-yellow-600/20 relative ${completedGiveaways[giveaway.id] ? 'bg-green-100/30' : 'bg-yellow-100/50'}`;
                
                const leftSideContainer = document.createElement('div');
                leftSideContainer.className = 'flex items-center flex-1 overflow-hidden';

                const controlsContainer = document.createElement('div');
                controlsContainer.className = 'flex flex-col items-center mr-3 flex-shrink-0';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.giveawayId = giveaway.id;
                checkbox.className = 'h-5 w-5 sm:h-6 sm:w-6 rounded-md border-2 border-yellow-600 text-yellow-500 focus:ring-yellow-500';
                checkbox.checked = completedGiveaways[giveaway.id];
                controlsContainer.appendChild(checkbox);
                
                const winBtn = document.createElement('button');
                winBtn.className = 'win-giveaway-btn';
                winBtn.innerHTML = `üèÜ`;
                winBtn.dataset.giveawayId = giveaway.id;
                winBtn.dataset.giveawayDate = dateStr;
                controlsContainer.appendChild(winBtn);

                const prizeContainer = document.createElement('div');
                prizeContainer.className = 'overflow-hidden';

                let accountsHTML = (giveaway.accounts || []).map(acc => `<a href="https://instagram.com/${acc.replace('‚ö†Ô∏è','').substring(1)}" target="_blank" class="underline">${acc}</a>`).join(', ');
                const timeEmoji = giveaway.ends_at_time ? '‚è∞' : ''; // A√±adir emoji si hay hora
                prizeContainer.innerHTML = `<p class="text-base sm:text-lg text-yellow-900 truncate">${giveaway.prize} ${timeEmoji}</p><p class="text-sm truncate">${accountsHTML}</p>`;

                leftSideContainer.appendChild(controlsContainer);
                leftSideContainer.appendChild(prizeContainer);

                const detailsContainer = document.createElement('div');
                detailsContainer.className = 'text-right flex-shrink-0 ml-2';
                if (giveaway.price) {
                    detailsContainer.innerHTML = `<a href="https://www.google.com/search?q=${encodeURIComponent(giveaway.prize)}" target="_blank" class="block font-bold">${giveaway.price}</a><span class="text-xs">Valor aprox.</span>`;
                }

                itemContainer.appendChild(leftSideContainer);
                itemContainer.appendChild(detailsContainer);

                const actionsContainer = document.createElement('div');
                actionsContainer.className = 'flex flex-col items-center ml-2 space-y-2';
                const moveBtn = document.createElement('button');
                moveBtn.className = 'move-giveaway-btn p-1 rounded-full';
                moveBtn.innerHTML = `<i class="fa-solid fa-calendar-alt"></i>`;
                moveBtn.dataset.giveawayId = giveaway.id;
                moveBtn.dataset.giveawayDate = dateStr;
                actionsContainer.appendChild(moveBtn);
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-giveaway-btn p-1 rounded-full';
                deleteBtn.innerHTML = `<i class="fa-solid fa-trash-can"></i>`;
                deleteBtn.dataset.giveawayId = giveaway.id;
                deleteBtn.dataset.giveawayDate = dateStr;
                actionsContainer.appendChild(deleteBtn);
                const deleteForeignBtn = document.createElement('button');
                deleteForeignBtn.className = 'delete-giveaway-foreign-btn p-1 rounded-full';
                deleteForeignBtn.innerHTML = `<i class="fa-solid fa-earth-americas"></i>`;
                deleteForeignBtn.dataset.giveawayId = giveaway.id;
                deleteForeignBtn.dataset.giveawayDate = dateStr;
                actionsContainer.appendChild(deleteForeignBtn);
                
                itemContainer.appendChild(actionsContainer);
                modalBody.appendChild(itemContainer);

                if (giveaway.prize.includes('ü•é')) hasPadel = true;
                if (giveaway.prize.includes('üõ©Ô∏è')) hasTravel = true;
            });
            const modalContent = document.getElementById('modal-content');
            modalContent.classList.remove('modal-default-bg', 'modal-padel-bg', 'modal-travel-bg');
            if (hasPadel) modalContent.classList.add('modal-padel-bg');
            else if (hasTravel) modalContent.classList.add('modal-travel-bg');
            else modalContent.classList.add('modal-default-bg');
            modal.dataset.date = dateStr;
        };
        
        const openModal = (dateStr) => { buildModal(dateStr); modal.classList.remove('hidden'); requestAnimationFrame(() => modal.classList.add('is-visible')); };
        const closeModal = () => { modal.classList.remove('is-visible'); setTimeout(() => { modal.classList.add('hidden'); }, 300); };
        
        const openAddGiveawayModal = (data = {}) => {
            addGiveawayForm.reset();
            addGiveawayModal.classList.remove('hidden');
            if (data.prize) giveawayPrizeInput.value = data.prize;
            if (data.accounts) giveawayAccountsInput.value = data.accounts;
            if (data.price) giveawayPriceInput.value = data.price;
            if (data.date) giveawayDateInput.value = data.date;
            requestAnimationFrame(() => addGiveawayModal.classList.add('is-visible'));
        };
        const closeAddGiveawayModal = () => { addGiveawayModal.classList.remove('is-visible'); setTimeout(() => addGiveawayModal.classList.add('hidden'), 300); };
        
        const openSearchModal = () => { searchModal.classList.remove('hidden'); requestAnimationFrame(() => searchModal.classList.add('is-visible')); };
        const closeSearchModal = () => { searchModal.classList.remove('is-visible'); setTimeout(() => searchModal.classList.add('hidden'), 300); };
        
        const openMoveGiveawayModal = (giveaway, originalDate) => {
             giveawayToMove = giveaway;
             originalDateOfGiveaway = originalDate;
             newGiveawayDateInput.value = originalDate;
             moveGiveawayModal.classList.remove('hidden');
             requestAnimationFrame(() => moveGiveawayModal.classList.add('is-visible'));
        }
        const closeMoveGiveawayModal = () => { moveGiveawayModal.classList.remove('is-visible'); setTimeout(() => moveGiveawayModal.classList.add('hidden'), 300); }

        const addGiveaway = (newGiveaway) => {
            const dateStr = newGiveaway.date;
            if (!giveaways[dateStr]) giveaways[dateStr] = [];
            giveaways[dateStr].push(newGiveaway);
            saveGiveaways();
            renderCalendar();
            addPoints(1);
            checkAchievements('add-manual');
        };
        
        const moveGiveaway = (giveawayId, oldDate, newDate) => {
            if (giveaways[oldDate]) {
                const giveawayToMove = giveaways[oldDate].find(g => g.id === giveawayId);
                if (giveawayToMove) {
                    if(!giveawayToMove.date) giveawayToMove.date = newDate;
                    if(!giveawayToMove.moved) giveawayToMove.moved = true; // Mark as moved
                    giveaways[oldDate] = giveaways[oldDate].filter(g => g.id !== giveawayId);
                    if (giveaways[oldDate].length === 0) delete giveaways[oldDate];
                    if (!giveaways[newDate]) giveaways[newDate] = [];
                    giveaways[newDate].push(giveawayToMove);
                    saveGiveaways();
                    renderCalendar();
                    closeModal();
                    showNotification('Sorteo movido', `El sorteo se ha movido al ${newDate}.`);
                    checkAchievements('move');
                }
            }
        };

        const setFilterAndRender = (filter) => { currentFilter = filter; renderCalendar(); checkAchievements('search'); }

        const markAsWon = (giveawayId, dateStr) => {
            if (!giveaways[dateStr]) return;
            const giveawayIndex = giveaways[dateStr].findIndex(g => g.id === giveawayId);
            if (giveawayIndex === -1) return;
            const [wonGiveaway] = giveaways[dateStr].splice(giveawayIndex, 1);
            
            let points = 100;
            if (wonGiveaway.prize.includes('ü•é') || wonGiveaway.prize.includes('üõ©Ô∏è') || wonGiveaway.prize.includes('üÉè')) points += 25;
            if (parsePrice(wonGiveaway.price) > 500) points += 250;
            addPoints(points);

            wonGiveaway.wonDate = new Date().toISOString().slice(0, 10);
            wonGiveaways.push(wonGiveaway);
            if (!completedGiveaways[giveawayId]) {
                completedGiveaways[giveawayId] = true;
                completedGiveawayCount++;
                addPoints(2);
                saveCompletedGiveaways();
            }
            if (giveaways[dateStr].length === 0) {
                delete giveaways[dateStr];
            }
            saveGiveaways();
            saveWonGiveaways();
            closeModal();
            renderCalendar();
            showNotification('¬°Enhorabuena!', `Has a√±adido "${wonGiveaway.prize}" a tu vitrina de trofeos.`);
            checkAchievements('win', wonGiveaway);
        };

        const deleteWonGiveaway = (giveawayId) => {
            if (confirm("¬øEst√°s seguro de que quieres eliminar este sorteo de la vitrina?")) {
                const wonGiveaway = wonGiveaways.find(g => g.id === giveawayId);
                if (wonGiveaway) {
                    if (completedGiveaways[wonGiveaway.id]) {
                         delete completedGiveaways[wonGiveaway.id];
                         completedGiveawayCount--;
                         saveCompletedGiveaways();
                    }
                }
                wonGiveaways = wonGiveaways.filter(g => g.id !== giveawayId);
                saveWonGiveaways();
                renderTrophyModal();
                showNotification('Sorteo eliminado', 'El sorteo se ha eliminado de tu vitrina.');
            }
        };

        const renderTrophyModal = () => {
            trophyModalBody.innerHTML = '';
            if (wonGiveaways.length === 0) {
                trophyModalBody.innerHTML = '<p class="text-center col-span-full">A√∫n no has ganado ning√∫n sorteo. ¬°Sigue participando!</p>';
                return;
            }
            wonGiveaways.sort((a, b) => new Date(b.wonDate) - new Date(a.wonDate)).forEach(giveaway => {
                const card = document.createElement('div');
                card.className = 'trophy-card';
                card.innerHTML = `
                    <h3 class="font-bold">${giveaway.prize}</h3>
                    <p class="text-sm">Valor: ${giveaway.price || 'No especificado'}</p>
                    <p class="text-xs mt-2">Ganado el: ${new Date(giveaway.wonDate + 'T00:00:00').toLocaleDateString('es-ES')}</p>
                    <button class="trophy-delete-btn" data-giveaway-id="${giveaway.id}"><i class="fa-solid fa-trash-can"></i></button>
                `;
                trophyModalBody.appendChild(card);
            });
        };

        const calculateStats = () => {
            const allGiveaways = Object.values(giveaways).flat();
            const totalRegistered = allGiveaways.length + wonGiveaways.length;
            const completedCount = Object.keys(completedGiveaways).length;
            const pendingCount = allGiveaways.length;
            const wonCount = wonGiveaways.length;
            const winRate = totalRegistered > 0 ? (completedCount > 0 ? (wonCount / completedCount) * 100 : 0) : 0;
            const participationRate = totalRegistered > 0 ? (completedCount / totalRegistered) * 100 : 0;
            const totalWonValue = wonGiveaways.reduce((sum, g) => sum + parsePrice(g.price), 0);
            const averageWonValue = wonCount > 0 ? totalWonValue / wonCount : 0;
            const categoryCounts = { 'padel': 0, 'viajes': 0, 'frikis': 0, 'otros': 0 };
            wonGiveaways.forEach(g => {
                if (g.prize.includes('ü•é')) categoryCounts.padel++;
                else if (g.prize.includes('üõ©Ô∏è')) categoryCounts.viajes++;
                else if (g.prize.includes('üÉè')) categoryCounts.frikis++;
                else categoryCounts.otros++;
            });

            const accountCounts = {};
            [...allGiveaways, ...wonGiveaways].forEach(g => {
                (g.accounts || []).forEach(acc => {
                    accountCounts[acc] = (accountCounts[acc] || 0) + 1;
                });
            });
            const topAccounts = Object.entries(accountCounts).sort(([,a],[,b]) => b-a).slice(0, 5);

            const wonAccountCounts = {};
            wonGiveaways.forEach(g => {
                (g.accounts || []).forEach(acc => {
                    wonAccountCounts[acc] = (wonAccountCounts[acc] || 0) + 1;
                });
            });
            const talismanAccounts = Object.entries(wonAccountCounts).filter(([,count]) => count > 1);

            const discardCounts = { duplicate: 0, expired: 0, foreign: 0, no_date: 0 };
            discardedGiveaways.forEach(g => {
                if (g.status && discardCounts.hasOwnProperty(g.status)) {
                    discardCounts[g.status]++;
                }
            });

            const anticipationDays = [];
            [...allGiveaways, ...wonGiveaways].forEach(g => {
                if(g.addDate && g.date) {
                    const add = new Date(g.addDate);
                    const end = new Date(g.date);
                    const diffTime = Math.abs(end - add);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    anticipationDays.push(diffDays);
                }
            });
            const averageAnticipation = anticipationDays.length > 0 
                ? (anticipationDays.reduce((a, b) => a + b, 0) / anticipationDays.length) 
                : 0;
            
            const mostValuablePrize = wonGiveaways.length > 0 
                ? wonGiveaways.reduce((max, g) => parsePrice(g.price) > parsePrice(max.price) ? g : max, wonGiveaways[0]) 
                : null;

            const sortedWins = [...wonGiveaways].sort((a, b) => new Date(a.wonDate) - new Date(b.wonDate));
            let bestStreak = null;
            let longestDrySpell = null;
            let averageWinInterval = null;

            if (sortedWins.length >= 2) {
                const winIntervals = [];
                for(let i = 1; i < sortedWins.length; i++) {
                    const diff = (new Date(sortedWins[i].wonDate) - new Date(sortedWins[i-1].wonDate)) / (1000 * 3600 * 24);
                    winIntervals.push(diff);
                }
                if(winIntervals.length > 0){
                    bestStreak = Math.min(...winIntervals);
                    longestDrySpell = Math.max(...winIntervals);
                    averageWinInterval = winIntervals.reduce((a, b) => a + b, 0) / winIntervals.length;
                }
            }

            const blockCounts = { like: 0, comment: 0 };
            blockHistory.forEach(block => {
                blockCounts[block.type]++;
            });

            const completedPerBlock = blockHistory.length > 0 ? (completedGiveawayCount / blockHistory.length).toFixed(1) : 'N/A';

            return {
                totalRegistered, completedCount, pendingCount, wonCount, winRate: winRate.toFixed(1),
                totalWonValue: totalWonValue.toFixed(2), averageWonValue: averageWonValue.toFixed(2),
                categoryCounts, topAccounts, talismanAccounts, discardCounts,
                averageAnticipation: averageAnticipation.toFixed(1), participationRate: participationRate.toFixed(1),
                mostValuablePrize, bestStreak, longestDrySpell,
                lastWinDate: sortedWins.length > 0 ? new Date(sortedWins[sortedWins.length - 1].wonDate) : null,
                averageWinInterval, blockCounts, completedPerBlock
            };
        };

        const renderStatsModal = () => {
            const stats = calculateStats();
            const statsBody = document.getElementById('stats-modal-body');
            const blockStatsContainer = document.getElementById('block-stats-container');

            let topAccountsHTML = '<p>A√∫n no hay datos.</p>';
            if(stats.topAccounts.length > 0) {
                topAccountsHTML = `<ol>${stats.topAccounts.map(([acc, count]) => `<li>${acc} (${count} sorteos)</li>`).join('')}</ol>`;
            }

            let talismanAccountsHTML = '<p>A√∫n no hay cuentas con m√∫ltiples victorias.</p>';
            if(stats.talismanAccounts.length > 0) {
                talismanAccountsHTML = `<ul>${stats.talismanAccounts.map(([acc, count]) => `<li>${acc} (${count} victorias)</li>`).join('')}</ul>`;
            }
            
            const totalDiscards = stats.discardCounts.duplicate + stats.discardCounts.expired + stats.discardCounts.foreign + stats.discardCounts.no_date;
            const discardDuplicatePercent = totalDiscards > 0 ? ((stats.discardCounts.duplicate / totalDiscards) * 100).toFixed(0) : 0;
            const discardExpiredPercent = totalDiscards > 0 ? ((stats.discardCounts.expired / totalDiscards) * 100).toFixed(0) : 0;
            const discardForeignPercent = totalDiscards > 0 ? ((stats.discardCounts.foreign / totalDiscards) * 100).toFixed(0) : 0;

            let recordsHTML = '';
            if (stats.mostValuablePrize) {
                recordsHTML += `<li><strong>üíé Premio M√°s Valioso:</strong> ${stats.mostValuablePrize.prize} (${stats.mostValuablePrize.price})</li>`;
            }
            if (stats.bestStreak !== null) {
                recordsHTML += `<li><strong>üöÄ Mejor Racha:</strong> ${stats.bestStreak} d√≠as entre victorias.</li>`;
            }
            if (stats.longestDrySpell !== null) {
                recordsHTML += `<li><strong>‚è≥ Periodo de Sequ√≠a:</strong> ${stats.longestDrySpell} d√≠as entre victorias.</li>`;
            }
            if (stats.lastWinDate && stats.averageWinInterval !== null) {
                const nextWinDate = new Date(stats.lastWinDate.setDate(stats.lastWinDate.getDate() + stats.averageWinInterval));
                recordsHTML += `<li><strong>üîÆ Or√°culo de Victorias:</strong> Tu pr√≥xima victoria podr√≠a ser alrededor del ${nextWinDate.toLocaleDateString('es-ES')}.</li>`;
            }
            
            statsBody.innerHTML = `
                <h3 class="text-xl font-bold mb-2 text-yellow-700">Resumen General</h3>
                <ul class="space-y-2 mb-4">
                    <li><strong>Sorteos Totales Registrados:</strong> ${stats.totalRegistered}</li>
                    <li><strong>Participaciones Completadas:</strong> ${stats.completedCount}</li>
                    <li><strong>Sorteos Pendientes:</strong> ${stats.pendingCount}</li>
                </ul>
                <hr class="border-yellow-600/20 my-4">
                <h3 class="text-xl font-bold mb-2 text-yellow-700">An√°lisis de Comportamiento üìà</h3>
                <ul class="space-y-2 mb-4">
                    <li><strong>Anticipaci√≥n Media:</strong> A√±ades sorteos con ${stats.averageAnticipation} d√≠as de antelaci√≥n.</li>
                    <li><strong>Tasa de Participaci√≥n Real:</strong> Participas en el ${stats.participationRate}% de los sorteos que guardas.</li>
                </ul>
                <hr class="border-yellow-600/20 my-4">
                <h3 class="text-xl font-bold mb-2 text-yellow-700">Resumen de Victorias üèÜ</h3>
                <ul class="space-y-2 mb-4">
                    <li><strong>Sorteos Ganados:</strong> ${stats.wonCount}</li>
                    <li><strong>Tasa de Victoria:</strong> ${stats.winRate}% (sobre participaciones completadas)</li>
                </ul>
                 <hr class="border-yellow-600/20 my-4">
                <h3 class="text-xl font-bold mb-2 text-yellow-700">R√©cords y Rachas üöÄ</h3>
                <ul class="space-y-2 mb-4">
                    ${recordsHTML || '<p>Gana al menos dos premios para ver tus r√©cords.</p>'}
                </ul>
                <hr class="border-yellow-600/20 my-4">
                <h3 class="text-xl font-bold mb-2 text-yellow-700">An√°lisis por Cuentas üçÄ</h3>
                <div class="mb-4">
                    <h4 class="font-bold mb-1">Top 5 Cuentas Organizadoras:</h4>
                    ${topAccountsHTML}
                </div>
                <div>
                    <h4 class="font-bold mb-1">Tus Cuentas "Talism√°n":</h4>
                    ${talismanAccountsHTML}
                </div>
                <hr class="border-yellow-600/20 my-4">
                 <h3 class="text-xl font-bold mb-2 text-yellow-700">An√°lisis de la App ‚öôÔ∏è</h3>
                <ul class="space-y-2 mb-4">
                    <li><strong>Efectividad del Cortafuegos:</strong> ${stats.discardCounts.foreign} sorteos extranjeros bloqueados.</li>
                    <li><strong>Informe de Descarte (Total: ${totalDiscards}):</strong>
                        <ul class="text-sm pl-4">
                            <li>üìã Duplicados: ${stats.discardCounts.duplicate} (${discardDuplicatePercent}%)</li>
                            <li>üìÖ Caducados: ${stats.discardCounts.expired} (${discardExpiredPercent}%)</li>
                            <li>üåê Extranjeros: ${stats.discardCounts.foreign} (${discardForeignPercent}%)</li>
                        </ul>
                    </li>
                </ul>
                <hr class="border-yellow-600/20 my-4">
                <h3 class="text-xl font-bold mb-2 text-yellow-700">An√°lisis de Premios üí∞</h3>
                <ul class="space-y-2 mb-4">
                    <li><strong>Valor Total de Premios Ganados:</strong> ${stats.totalWonValue}‚Ç¨</li>
                    <li><strong>Valor Medio por Premio:</strong> ${stats.averageWonValue}‚Ç¨</li>
                </ul>
                <hr class="border-yellow-600/20 my-4">
                <h3 class="text-xl font-bold mb-2 text-yellow-700">Categor√≠as Ganadas</h3>
                <ul class="space-y-2 mb-4">
                    <li>ü•é <strong>P√°del:</strong> ${stats.categoryCounts.padel}</li>
                    <li>üõ©Ô∏è <strong>Viajes:</strong> ${stats.categoryCounts.viajes}</li>
                    <li>üÉè <strong>Frikis:</strong> ${stats.categoryCounts.frikis}</li>
                    <li>‚ú® <strong>Otros:</strong> ${stats.categoryCounts.otros}</li>
                </ul>
            `;
            
            blockStatsContainer.innerHTML = `
                <h4 class="font-bold mb-1">Estad√≠sticas de Bloqueos:</h4>
                <ul class="space-y-2 mb-4">
                    <li><strong>Bloqueos de 'Me gusta' totales:</strong> ${stats.blockCounts.like}</li>
                    <li><strong>Bloqueos de Comentarios totales:</strong> ${stats.blockCounts.comment}</li>
                    <li><strong>Sorteos completados por bloqueo (media):</strong> ${stats.completedPerBlock}</li>
                </ul>
            `;
        };
        
        const generateShareableSummary = () => {
            const stats = calculateStats();
            const monthName = new Date().toLocaleDateString('es-ES', { month: 'long' });
            const summaryText = `Resumen de ${monthName} en #Misorteos:\nüèÜ ${stats.wonCount} premios ganados\nüí∞ Valor total: ${stats.totalWonValue}‚Ç¨\n‚úÖ ${stats.completedCount} participaciones completadas\nüìà Tasa de victoria: ${stats.winRate}%`;
            
            navigator.clipboard.writeText(summaryText).then(() => {
                showNotification('¬°Copiado!', 'El resumen se ha copiado a tu portapapeles.');
            }).catch(err => {
                console.error('Error al copiar: ', err);
                showNotification('Error', 'No se pudo copiar el resumen.');
            });
        };

        const generateGiveawayHTML = (giveaway, isDiscarded = false) => {
             const accountsHtml = (giveaway.accounts || []).map(acc => `<a href="https://instagram.com/${acc.replace('‚ö†Ô∏è','').replace('@','')}" target="_blank" class="underline">${acc}</a>`).join(', ');
             const prizeCategory = giveaway.prize_category ? giveaway.prize_category.charAt(0).toUpperCase() + giveaway.prize_category.slice(1) : 'Otros';
             const prizeEmoji = giveaway.prize ? (giveaway.prize.includes('ü•é') ? 'ü•é' : giveaway.prize.includes('üõ©Ô∏è') ? 'üõ©Ô∏è' : giveaway.prize.includes('üÉè') ? 'üÉè' : '') : '';
             const timeEmoji = giveaway.ends_at_time ? '‚è∞' : '';
             return `
                 <p class="text-base sm:text-lg font-bold">${giveaway.prize || 'No especificado'} ${prizeEmoji} ${timeEmoji}</p>
                 <p class="text-sm"><strong>Cuentas:</strong> ${accountsHtml || 'No especificado'}</p>
                 <p class="text-sm"><strong>Fecha:</strong> ${giveaway.date || 'No especificada'}</p>
                 <p class="text-sm"><strong>Valor:</strong> ${giveaway.price || 'No especificado'}</p>
                 <p class="text-sm"><strong>Categor√≠a:</strong> ${prizeCategory}</p>
                 ${isDiscarded ? `<p class="text-sm mt-2"><strong>Motivo:</strong> ${giveaway.status || 'No especificado'}</p>` : ''}
             `;
        };

        const generateGiveawayCardHTML = (giveaway) => {
            if (!giveaway) return '<p>No hay informaci√≥n del sorteo.</p>';

            const formattedDate = giveaway.date 
                ? new Date(giveaway.date + 'T00:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' }) 
                : 'No especificada';

            const accountsHtml = (giveaway.accounts && giveaway.accounts.length > 0)
                ? giveaway.accounts.map(acc => `<a href="https://instagram.com/${acc.replace('@','')}" target="_blank" class="underline hover:text-amber-700">${acc}</a>`).join(', ')
                : 'No especificadas';
            
            const statusMap = {
                duplicate: 'Duplicado',
                expired: 'Caducado',
                foreign: 'Extranjero',
                no_date: 'Sin Fecha'
            };

            return `
                <div class="giveaway-card">
                    <h3>${giveaway.prize || 'Premio no especificado'}</h3>
                    <div class="giveaway-card-details">
                        <div class="detail-item">
                            <i class="fa-solid fa-calendar-days"></i>
                            <span>${formattedDate}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fa-solid fa-at"></i>
                            <span>${accountsHtml}</span>
                        </div>
                        ${giveaway.price ? `
                        <div class="detail-item">
                            <i class="fa-solid fa-sack-dollar"></i>
                            <span>${giveaway.price}</span>
                        </div>` : ''}
                        ${giveaway.status ? `
                        <div class="detail-item">
                             <i class="fa-solid fa-circle-info"></i>
                             <span class="status-tag status-${giveaway.status}">${statusMap[giveaway.status] || giveaway.status}</span>
                        </div>` : ''}
                    </div>
                </div>
            `;
        };
        
        const openAddAIGiveawayModal = () => { addAIGiveawayModal.classList.remove('hidden'); requestAnimationFrame(() => addAIGiveawayModal.classList.add('is-visible')); };
        const closeAddAIGiveawayModal = () => { addAIGiveawayModal.classList.remove('is-visible'); aiImageInput.value = null; imageQueue = []; aiQueueContainer.style.display = 'none'; aiQueueList.innerHTML = ''; startAiButton.style.display = 'none'; aiStatusContainer.style.display = 'none'; aiSummaryResults.style.display = 'none'; aiSummaryCloseBtn.style.display = 'none'; setTimeout(() => addAIGiveawayModal.classList.add('hidden'), 300); };
        
        function handleFileSelection(event) {
            imageQueue = [];
            aiQueueList.innerHTML = '';
            const files = event.target.files;
            if (files.length > 0) {
                const filesToAdd = Array.from(files).slice(0, MAX_IMAGES);
                for (const file of filesToAdd) {
                    if (file.type.startsWith('image/')) {
                        imageQueue.push(file);
                        const listItem = document.createElement('li');
                        listItem.textContent = file.name;
                        listItem.classList.add('p-2', 'border-b', 'border-yellow-500/10', 'last:border-b-0');
                        aiQueueList.appendChild(listItem);
                    }
                }
                aiQueueContainer.style.display = 'block';
                aiQueueCount.textContent = imageQueue.length;
                startAiButton.style.display = 'block';
            } else {
                startAiButton.style.display = 'none';
                aiQueueContainer.style.display = 'none';
            }
        }
        
        async function startAnalysis() {
            if (imageQueue.length === 0 || isProcessing) return;
            isProcessing = true;
            currentIndex = 0;
            totalCaptures = imageQueue.length;
            addedGiveawaysCount = 0;
            duplicateGiveawaysCount = 0;
            expiredGiveawaysCount = 0;
            foreignGiveawaysCount = 0;
            noDateGiveawaysCount = 0;
            addedGiveawaysDetails = [];
            duplicateGiveawaysDetails = [];
            expiredGiveawaysDetails = [];
            foreignGiveawaysDetails = [];
            noDateGiveawaysDetails = [];
            failedFilesDetails = [];
            startAiButton.disabled = true;
            startAiButton.textContent = "Procesando...";
            aiStatusContainer.style.display = 'block';
            aiSummaryResults.style.display = 'none';
            aiSummaryCloseBtn.style.display = 'none';
            await processNextImage();
        }
        
        function processNextImage() {
            if (currentIndex >= imageQueue.length) {
                showAISummary();
                isProcessing = false;
                startAiButton.disabled = false;
                startAiButton.textContent = "Empezar de nuevo";
                return;
            }

            // A√±adimos un retardo, excepto para la primera imagen
            const delay = currentIndex === 0 ? 0 : 2000; // 2000 ms = 2 segundos

            setTimeout(() => {
                const file = imageQueue[currentIndex];
                aiStatusMessage.textContent = `Analizando imagen ${currentIndex + 1} de ${imageQueue.length}: ${file.name}`;
                aiProgressBar.style.width = `${((currentIndex + 1) / imageQueue.length) * 100}%`;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    handleImageProcessing(event.target.result, file);
                };
                reader.readAsDataURL(file);
            }, delay);
        }

        async function handleImageProcessing(base64Data, file) {
            const hoy = new Date();
            const fechaFormateada = hoy.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
            const dynamicPrompt = `<ROL_Y_CONTEXTO>Actuar√°s como un Analista de Datos experto y extremadamente meticuloso. Tu √∫nica funci√≥n es analizar im√°genes de sorteos de redes sociales y extraer informaci√≥n en un formato JSON estricto. CONTEXTO CR√çTICO: La fecha actual es ${fechaFormateada}. Usa esta fecha como referencia para todas las evaluaciones de tiempo.</ROL_Y_CONTEXTO><TAREA_PRINCIPAL>Analiza la imagen proporcionada y extrae la informaci√≥n solicitada. Tu respuesta debe ser √öNICAMENTE un objeto JSON v√°lido, sin ning√∫n texto, explicaci√≥n o markdown adicional como \`\`\`json.</TAREA_PRINCIPAL><DEFINICION_FORMATO_JSON>El objeto JSON debe tener la siguiente estructura y reglas:{"prize": "string | null","accounts": ["string"],"date": "string | null","ends_at_time": "string | null", "status": "string","is_spanish": boolean,"prize_category": "string"}**REGLA DE ORO PARA LA FECHA:** Si el texto menciona "anuncio de ganadores el d√≠a X", la fecha de finalizaci√≥n del sorteo ("date") es el d√≠a ANTERIOR (X-1). Esta regla tiene m√°xima prioridad.</REGLAS_CRITICAS_FINALES>`;

            try {
                const aiData = await callGeminiAPI(base64Data, dynamicPrompt);
                
                if (aiData.status === 'discard_no_date') {
                    noDateGiveawaysCount++;
                    noDateGiveawaysDetails.push({ prize: aiData.prize });
                    discardedGiveaways.push({ ...aiData, id: Date.now().toString() + 'nd', status: 'no_date' });
                } else {
                    const accounts = aiData.accounts || [];
                    const isForeign = accounts.some(acc => foreignAccounts.includes(`@${acc}`));
                    const isExpired = aiData.date && new Date(aiData.date) < new Date(new Date().toDateString());
                    const existingGiveaway = isDuplicateGiveaway(aiData);

                    if (isForeign) {
                        foreignGiveawaysCount++;
                        foreignGiveawaysDetails.push({ prize: aiData.prize, accounts: accounts.join(', ') });
                        discardedGiveaways.push({...aiData, status: 'foreign', id: Date.now().toString() + 'f'});
                    } else if (existingGiveaway) {
                        duplicateGiveawaysCount++;
                        duplicateGiveawaysDetails.push({ prize: aiData.prize });
                        discardedGiveaways.push({ ...aiData, id: Date.now().toString() + 'd', status: 'duplicate', originalGiveaway: existingGiveaway });
                    } else if (isExpired) {
                        expiredGiveawaysCount++;
                        expiredGiveawaysDetails.push({ prize: aiData.prize, date: aiData.date });
                        discardedGiveaways.push({...aiData, status: 'expired', id: Date.now().toString() + 'e'});
                    } else {
                        const priceInfo = await searchPrizeValue(aiData);
                        const newGiveaway = { 
                            id: Date.now().toString(), 
                            date: aiData.date, 
                            prize: priceInfo.prize, 
                            accounts: aiData.accounts.map(acc => `@${acc}`), 
                            price: priceInfo.value, 
                            url: priceInfo.url, 
                            addDate: new Date().toISOString().slice(0, 10),
                            ends_at_time: aiData.ends_at_time 
                        };
                        addGiveaway(newGiveaway);
                        
                        // --- INICIO DE LA CORRECCI√ìN ---
                        // Primero, registramos el √©xito para el resumen.
                        addedGiveawaysCount++;
                        addedGiveawaysDetails.push({ prize: newGiveaway.prize, date: newGiveaway.date });
                        
                        // Despu√©s, realizamos las otras operaciones (puntos, logros).
                        // Si alguna de estas falla, se registrar√° un error, pero el sorteo ya constar√° como a√±adido.
                        addPoints(5);
                        checkAchievements('add-ai');
                        // --- FIN DE LA CORRECCI√ìN ---
                    }
                }
                saveDiscardedGiveaways();
            } catch (error) {
                console.error(`Error al analizar la imagen ${file.name}:`, error);
                failedFilesDetails.push({ filename: file.name, error: error.message });
            }
            currentIndex++;
            processNextImage();
        }
        
        const showAISummary = () => {
            const summaryData = {
                analysisDate: new Date().toISOString(),
                totalCaptures, addedGiveawaysCount, duplicateGiveawaysCount, expiredGiveawaysCount, foreignGiveawaysCount, noDateGiveawaysCount,
                addedGiveawaysDetails, duplicateGiveawaysDetails, expiredGiveawaysDetails, foreignGiveawaysDetails, noDateGiveawaysDetails, failedFilesDetails
            };
            analysisHistory.push(summaryData);
            analysisHistory = analysisHistory.slice(-20);
            saveAnalysisHistory();

            document.getElementById('ai-modal-title').textContent = 'An√°lisis de Sorteos Finalizado';
            document.getElementById('ai-modal-info').style.display = 'none';
            aiQueueContainer.style.display = 'none';
            startAiButton.style.display = 'none';
            aiStatusContainer.style.display = 'none';
            const summaryContainer = document.getElementById('ai-summary-results');
            summaryContainer.innerHTML = ''; 
            let summaryHTML = `<h3 class="text-xl font-bold mb-4">‚ú® Resumen General</h3><ul><li>Im√°genes Enviadas: <strong>${totalCaptures}</strong></li><li>‚úÖ Sorteos A√±adidos: <strong>${addedGiveawaysCount}</strong></li><li>‚ùå Sorteos Descartados: <strong>${duplicateGiveawaysCount + expiredGiveawaysCount + foreignGiveawaysCount + noDateGiveawaysCount}</strong></li><li>‚ö†Ô∏è Errores de An√°lisis: <strong>${failedFilesDetails.length}</strong></li></ul><hr class="border-yellow-500/20 my-4">`;
            if (addedGiveawaysDetails.length > 0) {
                summaryHTML += `<h4 class="text-lg font-bold mb-2">‚úÖ Sorteos A√±adidos al Calendario</h4><ul>${addedGiveawaysDetails.map(g => `<li><strong>${g.prize}</strong> (para el ${new Date(g.date+'T00:00:00').toLocaleDateString('es-ES')})</li>`).join('')}</ul><hr class="border-yellow-500/20 my-4">`;
            }
            if (duplicateGiveawaysCount > 0 || expiredGiveawaysCount > 0 || foreignGiveawaysCount > 0 || noDateGiveawaysCount > 0) {
                summaryHTML += `<h4 class="text-lg font-bold mb-2">‚ùå Desglose de Sorteos Descartados</h4>`;
                if (duplicateGiveawaysCount > 0) { summaryHTML += `<details><summary>üìã Duplicados (${duplicateGiveawaysCount})</summary><ul>${duplicateGiveawaysDetails.map(g => `<li>${g.prize}</li>`).join('')}</ul></details>`; }
                if (expiredGiveawaysCount > 0) { summaryHTML += `<details><summary>üìÖ Caducados (${expiredGiveawaysCount})</summary><ul>${expiredGiveawaysDetails.map(g => `<li>${g.prize} (fecha: ${new Date(g.date+'T00:00:00').toLocaleDateString('es-ES')})</li>`).join('')}</ul></details>`; }
                if (foreignGiveawaysCount > 0) { summaryHTML += `<details><summary>üåê Extranjeros (${foreignGiveawaysCount})</summary><ul>${foreignGiveawaysDetails.map(g => `<li>${g.prize} (cuenta: ${g.accounts})</li>`).join('')}</ul></details>`; }
                if (noDateGiveawaysCount > 0) { summaryHTML += `<details><summary>‚ùì Sin Fecha (${noDateGiveawaysCount})</summary><ul>${noDateGiveawaysDetails.map(g => `<li>${g.prize}</li>`).join('')}</ul></details>`; }
                summaryHTML += `<hr class="border-yellow-500/20 my-4">`;
            }
            if (failedFilesDetails.length > 0) {
                summaryHTML += `<h4 class="text-lg font-bold mb-2">‚ö†Ô∏è Informe de Errores</h4><details><summary>Im√°genes no procesadas (${failedFilesDetails.length})</summary><ul>${failedFilesDetails.map(f => `<li><strong>${f.filename}</strong></li>`).join('')}</ul></details>`;
            }
            summaryContainer.innerHTML = summaryHTML;
            summaryContainer.style.display = 'block';
            aiSummaryCloseBtn.style.display = 'block';
        };

        const renderHistoryModal = () => {
            historyModalBody.innerHTML = '';
            if (analysisHistory.length === 0) {
                historyModalBody.innerHTML = '<p class="text-center">No hay an√°lisis guardados en el historial.</p>';
                return;
            }

            [...analysisHistory].reverse().forEach(summary => {
                const date = new Date(summary.analysisDate);
                const formattedDate = date.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                let summaryHTML = `<details class="mb-4"><summary class="font-bold text-lg cursor-pointer">An√°lisis del ${formattedDate}</summary>`;
                summaryHTML += `<div class="p-2 border-t border-yellow-600/20 mt-2">`;
                summaryHTML += `<h3 class="text-lg font-bold mb-2">‚ú® Resumen General</h3><ul><li>Im√°genes Enviadas: <strong>${summary.totalCaptures}</strong></li><li>‚úÖ Sorteos A√±adidos: <strong>${summary.addedGiveawaysCount}</strong></li><li>‚ùå Sorteos Descartados: <strong>${summary.duplicateGiveawaysCount + summary.expiredGiveawaysCount + summary.foreignGiveawaysCount + (summary.noDateGiveawaysCount || 0)}</strong></li><li>‚ö†Ô∏è Errores de An√°lisis: <strong>${summary.failedFilesDetails.length}</strong></li></ul><hr class="border-yellow-500/20 my-4">`;
                if (summary.addedGiveawaysDetails.length > 0) {
                    summaryHTML += `<h4 class="text-md font-bold mb-2">‚úÖ Sorteos A√±adidos</h4><ul>${summary.addedGiveawaysDetails.map(g => `<li><strong>${g.prize}</strong></li>`).join('')}</ul><hr class="border-yellow-500/20 my-4">`;
                }
                 if (summary.duplicateGiveawaysCount > 0 || summary.expiredGiveawaysCount > 0 || summary.foreignGiveawaysCount > 0 || (summary.noDateGiveawaysCount || 0) > 0) {
                    summaryHTML += `<h4 class="text-md font-bold mb-2">‚ùå Desglose de Descartados</h4>`;
                    if (summary.duplicateGiveawaysCount > 0) { summaryHTML += `<p><strong>üìã Duplicados:</strong> ${summary.duplicateGiveawaysCount}</p>`; }
                    if (summary.expiredGiveawaysCount > 0) { summaryHTML += `<p><strong>üìÖ Caducados:</strong> ${summary.expiredGiveawaysCount}</p>`; }
                    if (summary.foreignGiveawaysCount > 0) { summaryHTML += `<p><strong>üåê Extranjeros:</strong> ${summary.foreignGiveawaysCount}</p>`; }
                    if ((summary.noDateGiveawaysCount || 0) > 0) { summaryHTML += `<p><strong>‚ùì Sin Fecha:</strong> ${summary.noDateGiveawaysCount}</p>`; }
                }
                summaryHTML += `</div></details>`;
                historyModalBody.innerHTML += summaryHTML;
            });
        };

        async function callGeminiAPI(base64Data, dynamicPrompt) {
            const functionUrl = '/.netlify/functions/gemini';
            const payload = { base64Data, dynamicPrompt };
            try {
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error en la funci√≥n de Netlify');
                }
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const text = result.candidates[0].content.parts[0].text;
                    return JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());
                } else {
                    console.error("Respuesta inv√°lida de la API de Visi√≥n:", result);
                    throw new Error("Respuesta incompleta o inv√°lida de la API de Visi√≥n.");
                }
            } catch (error) {
                console.error("Error al llamar a la funci√≥n de Netlify:", error);
                showNotification('Error de An√°lisis', 'No se pudo conectar con el servicio de IA. Int√©ntalo de nuevo.');
                throw error;
            }
        }

        async function searchPrizeValue(aiData) {
            const cleanedPrize = aiData.prize ? aiData.prize.trim() : '';
            if (!cleanedPrize) return { prize: aiData.prize, value: "No encontrado", url: null };
            const query = `valor aproximado ${cleanedPrize}`;
            const functionUrl = '/.netlify/functions/search';
            try {
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                if (!response.ok) {
                    throw new Error('La respuesta de la funci√≥n de b√∫squeda no fue OK');
                }
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const text = result.candidates[0].content.parts[0].text;
                    const parsedResult = JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());
                    let prizeWithEmoji = aiData.prize;
                    let numericValue = null;
                    if (parsedResult.value && parsedResult.value !== "No encontrado") {
                        numericValue = parseFloat(parsedResult.value.replace(/[^0-9,.]/g, '').replace(',', '.'));
                    }
                    if (aiData.prize_category === 'padel') prizeWithEmoji += ' ü•é';
                    if (aiData.prize_category === 'viajes') prizeWithEmoji += ' üõ©Ô∏è';
                    if (aiData.prize_category === 'frikis') prizeWithEmoji += ' üÉè';
                    if (!isNaN(numericValue) && numericValue > 500) prizeWithEmoji += ' üí≤';
                    return { prize: prizeWithEmoji, value: parsedResult.value, url: parsedResult.url };
                } else {
                    throw new Error("Respuesta incompleta de la API de texto.");
                }
            } catch (error) {
                console.error("Error en la b√∫squeda del valor:", error);
                return { prize: aiData.prize, value: "No encontrado", url: null };
            }
        }
        
        const deleteGiveawayFromCalendar = (dateStr, giveawayId) => { if (giveaways[dateStr]) { const giveawayToTrash = giveaways[dateStr].find(g => g.id === giveawayId); if (giveawayToTrash) { trashGiveaways.push({...giveawayToTrash, originalDate: dateStr}); saveTrashGiveaways(); giveaways[dateStr] = giveaways[dateStr].filter(g => g.id !== giveawayId); if (giveaways[dateStr].length === 0) delete giveaways[dateStr]; saveGiveaways(); renderCalendar(); closeModal(); } } };
        
        const deleteForeignGiveaway = (dateStr, giveawayId) => {
            if (giveaways[dateStr]) {
                const giveawayToDiscard = giveaways[dateStr].find(g => g.id === giveawayId);
                if (giveawayToDiscard) {
                    discardedGiveaways.push({...giveawayToDiscard, status: 'foreign', originalDate: dateStr});
                    const accountsToBlock = giveawayToDiscard.accounts;
                    accountsToBlock.forEach(acc => {
                        if (!foreignAccounts.includes(acc)) {
                            foreignAccounts.push(acc);
                        }
                    });
                    saveDiscardedGiveaways();
                    saveForeignAccounts();
                    giveaways[dateStr] = giveaways[dateStr].filter(g => g.id !== giveawayId);
                    if (giveaways[dateStr].length === 0) {
                        delete giveaways[dateStr];
                    }
                    saveGiveaways();
                    renderCalendar();
                    closeModal();
                    showNotification('Sorteo marcado como extranjero', 'Las cuentas asociadas se han a√±adido al cortafuegos.');
                    checkAchievements('block-foreign');
                }
            }
        };

        const renderTrashModal = () => { trashModalBody.innerHTML = ''; if (trashGiveaways.length === 0) { trashModalBody.innerHTML = '<p>No hay sorteos en la papelera.</p>'; return; } trashGiveaways.forEach(giveaway => { const itemContainer = document.createElement('div'); itemContainer.className = 'p-3 bg-yellow-100/50 rounded-lg shadow-inner flex justify-between items-center border border-yellow-600/20'; itemContainer.innerHTML = `<div class="w-full"><p class="text-base sm:text-lg">${giveaway.prize}</p><p class="text-sm">Fecha original: ${giveaway.originalDate}</p></div><button class="restore-btn ml-4 bg-yellow-500 text-yellow-900 p-2 rounded-full hover:bg-yellow-400" data-giveaway-id="${giveaway.id}"><i class="fa-solid fa-rotate-left"></i></button>`; trashModalBody.appendChild(itemContainer); }); };
        const restoreGiveawayFromTrash = (giveawayId) => { const giveawayToRestore = trashGiveaways.find(g => g.id === giveawayId); if (giveawayToRestore) { trashGiveaways = trashGiveaways.filter(g => g.id !== giveawayId); openAddGiveawayModal({ date: giveawayToRestore.originalDate, prize: giveawayToRestore.prize, accounts: giveawayToRestore.accounts.join(', '), price: giveawayToRestore.price }); saveTrashGiveaways(); renderTrashModal(); checkAchievements('restore'); } };
        const deleteAllTrash = () => { if(confirm("¬øEst√°s seguro de que quieres vaciar la papelera? Esta acci√≥n no se puede deshacer.")) { trashGiveaways = []; saveTrashGiveaways(); renderTrashModal(); showNotification('Papelera vaciada', 'Se han eliminado todos los sorteos de la papelera.'); } }
        const deleteAllDiscarded = () => { if(confirm("¬øEst√°s seguro de que quieres eliminar todos los sorteos descartados?")) { discardedGiveaways = []; saveDiscardedGiveaways(); renderDiscardedModal(); showNotification('Sorteos descartados eliminados', 'Se han eliminado todos los sorteos de la lista de descartados.'); } }
        const deleteDiscardedGiveaway = (giveawayId) => { discardedGiveaways = discardedGiveaways.filter(g => g.id !== giveawayId); saveDiscardedGiveaways(); renderDiscardedModal(); }

        const showDuplicateComparisonModal = (discardedGiveaway) => {
            const originalGiveawayData = discardedGiveaways.find(g => g.id === discardedGiveaway.id)?.originalGiveaway;
            if (!originalGiveawayData) {
                console.error("No se encontr√≥ el sorteo original para comparar.");
                return;
            }

            let originalDate = null;
            for (const date in giveaways) {
                if (giveaways[date].find(g => g.id === originalGiveawayData.id)) {
                    originalDate = date;
                    break;
                }
            }
            
            const originalGiveawayWithDate = { ...originalGiveawayData, date: originalDate };

            originalGiveawayDetails.innerHTML = generateGiveawayHTML(originalGiveawayWithDate);
            discardedGiveawayDetails.innerHTML = generateGiveawayHTML(discardedGiveaway);
            
            mergeGiveawayBtn.dataset.giveawayId = discardedGiveaway.id;
            addAsNewBtn.dataset.giveawayId = discardedGiveaway.id;
            
            duplicateComparisonModal.classList.remove('hidden');
            requestAnimationFrame(() => duplicateComparisonModal.classList.add('is-visible'));
        };

        const renderDiscardedModal = () => { 
            const discardedModalBody = document.getElementById('discarded-modal-body');
            discardedModalBody.innerHTML = ''; 
            const filteredGiveaways = discardedGiveaways.filter(g => discardedFilter === 'all' || g.status === discardedFilter); 
            if (filteredGiveaways.length === 0) { 
                discardedModalBody.innerHTML = '<p>No hay sorteos descartados con este filtro.</p>'; 
                return; 
            } 
            filteredGiveaways.forEach(giveaway => { 
                const cardHTML = generateGiveawayCardHTML(giveaway);
                const itemContainer = document.createElement('div');
                // Mantenemos la clase para la funcionalidad de clic
                itemContainer.className = `giveaway-item-discarded ${giveaway.status === 'duplicate' ? 'duplicate-item' : ''} mb-4`;
                itemContainer.dataset.giveawayId = giveaway.id;
                itemContainer.innerHTML = cardHTML;
                discardedModalBody.appendChild(itemContainer);
            }); 
        };

        const openDuplicateModal = (discardedGiveaway, originalGiveaway) => {
            const previewContainer = document.getElementById('duplicate-giveaway-info');
            
            const originalCardHTML = generateGiveawayCardHTML({ ...originalGiveaway, date: originalGiveaway.date });
            const discardedCardHTML = generateGiveawayCardHTML(discardedGiveaway);

            previewContainer.innerHTML = `
                <div>
                    <h4 class="font-bold text-lg mb-2 text-gray-700">Sorteo Original (Ya guardado)</h4>
                    ${originalCardHTML}
                </div>
                <div>
                    <h4 class="font-bold text-lg mb-2 text-red-800">Sorteo Descartado (Nuevo)</h4>
                    ${discardedCardHTML}
                </div>
            `;
            
            confirmRestoreBtn.dataset.giveawayId = discardedGiveaway.id;
            duplicateModal.classList.remove('hidden');
            requestAnimationFrame(() => duplicateModal.classList.add('is-visible'));
        };
        const closeDuplicateModal = () => { duplicateModal.classList.remove('is-visible'); setTimeout(() => duplicateModal.classList.add('hidden'), 300); };
        const addDiscardedToCalendar = (giveawayId) => { const giveawayToAdd = discardedGiveaways.find(g => g.id === giveawayId); if (giveawayToAdd) { discardedGiveaways = discardedGiveaways.filter(g => g.id !== giveawayId); saveDiscardedGiveaways(); renderDiscardedModal(); openAddGiveawayModal({ date: giveawayToAdd.date, prize: giveawayToAdd.prize, accounts: giveawayToAdd.accounts.join(', '), price: giveawayToAdd.price }); } };

        const renderAchievementsModal = (activeTab = 'logros') => {
            const unlockedIds = userAchievements.unlocked;
            
            const achievementGroups = {
                'Logros de Bronce ü•â': achievementList.bronze,
                'Logros de Plata ü•à': achievementList.silver,
                'Logros de Oro ü•á': achievementList.gold,
                'Logros de Platino üíé': achievementList.platinum,
                'Logros M√≠ticos üèÜ': achievementList.diamond,
            };
            let achievementsHTML = '';
            for (const groupName in achievementGroups) {
                achievementsHTML += `<h3 class="text-xl font-bold text-yellow-700 mt-4 mb-2">${groupName}</h3>`;
                achievementsHTML += '<div class="space-y-3">';
                achievementsHTML += achievementGroups[groupName].map(ach => {
                    const isUnlocked = unlockedIds.includes(ach.id);
                    return `
                    <div class="achievement-item ${isUnlocked ? '' : 'locked'} bg-yellow-100/50 p-4 rounded-lg flex items-center gap-4">
                        <div class="ach-icon text-4xl">${ach.icon}</div>
                        <div class="flex-grow">
                            <h4 class="font-bold text-lg">${ach.name}</h4>
                            <p class="text-sm">${ach.desc}</p>
                        </div>
                        ${isUnlocked ? `<div class="text-right flex-shrink-0"><span class="font-bold text-green-600">+${ach.ps} PS</span></div>` : ''}
                    </div>`;
                }).join('');
                achievementsHTML += '</div>';
            }

            const titlesHTML = achievementList.prestige.map(item => {
                const isUnlocked = unlockedIds.includes(item.id);
                const isSelected = userAchievements.title === item.title;
                return `
                    <div class="title-item ${isUnlocked ? '' : 'locked'} ${isSelected ? 'selected' : ''} border-2 border-transparent p-4 rounded-lg flex flex-col items-center justify-center text-center gap-2 bg-yellow-100/50">
                        <div class="text-5xl">üëë</div>
                        <h4 class="font-bold text-lg">${item.title}</h4>
                        <p class="text-xs italic text-gray-600">${item.req}</p>
                        ${isUnlocked ? `<button data-title="${item.title}" class="select-title-btn mt-2 py-1 px-3 rounded-full text-xs font-bold ${isSelected ? 'bg-green-500 text-white cursor-default' : 'bg-yellow-500 text-yellow-900'}">${isSelected ? 'Seleccionado' : 'Seleccionar'}</button>` : ''}
                    </div>
                `;
            }).join('');

            let meritsHTML = achievementList.merits.map(ach => {
                 const isUnlocked = unlockedIds.includes(ach.id);
                 return `
                    <div class="achievement-item ${isUnlocked ? '' : 'locked'} bg-blue-100/50 p-4 rounded-lg flex items-center gap-4 border-l-4 border-blue-400">
                        <div class="ach-icon text-4xl">${ach.icon}</div>
                        <div class="flex-grow">
                            <h4 class="font-bold text-lg">${ach.name}</h4>
                            <p class="text-sm">${ach.desc}</p>
                        </div>
                        ${isUnlocked ? `<div class="text-right flex-shrink-0"><span class="font-bold text-green-600">+${ach.ps} PS</span></div>` : ''}
                    </div>`;
            }).join('');

            const psInfoHTML = `
                <div class="p-4 bg-yellow-100/50 rounded-lg space-y-3">
                    <h3 class="text-xl font-bold text-yellow-800">¬øC√≥mo funcionan los Puntos de Sorteo (PS)?</h3>
                    <p class="text-sm">Los PS miden tu progreso y dedicaci√≥n. ¬°Acum√∫lalos para desbloquear t√≠tulos y demostrar tu maestr√≠a!</p>
                    <ul class="list-disc list-inside text-sm space-y-2">
                        <li><strong>+1 PS</strong> por cada sorteo a√±adido manualmente.</li>
                        <li><strong>+2 PS</strong> por cada sorteo completado.</li>
                        <li><strong>+5 PS</strong> por cada sorteo a√±adido con la IA.</li>
                        <li><strong>+5 a 250 PS</strong> al desbloquear un logro, m√©rito o t√≠tulo.</li>
                        <li><strong>+100 PS</strong> por ganar un sorteo.</li>
                        <li><strong>+25 PS (Bonus)</strong> si el premio ganado es de categor√≠a (P√°del, Viajes o Friki).</li>
                        <li><strong>+250 PS (Bonus)</strong> si el premio ganado supera los 500‚Ç¨ de valor.</li>
                    </ul>
                </div>
            `;

            achievementsModalBody.innerHTML = `
                <div class="achievement-tabs flex flex-wrap gap-x-4 border-b border-yellow-600/20 mb-4">
                    <button data-tab="logros" class="py-2 px-4 font-bold ${activeTab === 'logros' ? 'active' : ''}">Logros</button>
                    <button data-tab="titulos" class="py-2 px-4 font-bold ${activeTab === 'titulos' ? 'active' : ''}">T√≠tulos de Prestigio</button>
                    <button data-tab="meritos" class="py-2 px-4 font-bold ${activeTab === 'meritos' ? 'active' : ''}">M√©ritos √önicos</button>
                    <button data-tab="ps_info" class="py-2 px-4 font-bold ${activeTab === 'ps_info' ? 'active' : ''}">Sistema de Puntos</button>
                </div>
                <div id="achievements-content" class="space-y-3">
                    <div class="tab-content ${activeTab === 'logros' ? '' : 'hidden'}" data-tab-content="logros">${achievementsHTML}</div>
                    <div class="tab-content ${activeTab === 'titulos' ? '' : 'hidden'}" data-tab-content="titulos"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${titlesHTML}</div></div>
                    <div class="tab-content ${activeTab === 'meritos' ? '' : 'hidden'}" data-tab-content="meritos"><div class="space-y-3">${meritsHTML}</div></div>
                    <div class="tab-content ${activeTab === 'ps_info' ? '' : 'hidden'}" data-tab-content="ps_info">${psInfoHTML}</div>
                </div>
            `;

            achievementsModalBody.querySelectorAll('.achievement-tabs button').forEach(button => {
                button.addEventListener('click', () => {
                    renderAchievementsModal(button.dataset.tab);
                });
            });

            achievementsModalBody.querySelectorAll('.select-title-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userAchievements.title = button.dataset.title;
                    saveUserAchievements();
                    userTitleEl.textContent = userAchievements.title;
                    renderAchievementsModal('titulos');
                });
            });
        };

        const downloadSourceCode = () => {
            showNotification('Preparando descarga...', 'Se est√° generando el archivo .zip con tus datos actualizados.');
            const zip = new JSZip();

            // --- Contenido de los Archivos de Datos (Din√°micos) ---
            const giveawaysContent = `window.giveaways = ${JSON.stringify(giveaways, null, 4)};`;
            const discardedGiveawaysContent = `const initialDiscardedGiveaways = ${JSON.stringify(discardedGiveaways, null, 4)};\n\nif (localStorage.getItem('discardedGiveaways') === null) {\n    localStorage.setItem('discardedGiveaways', JSON.stringify(initialDiscardedGiveaways));\n}\n\nwindow.discardedGiveaways = JSON.parse(localStorage.getItem('discardedGiveaways')) || [];`;
            
            // --- Contenido de los Archivos de Configuraci√≥n y Backend (Est√°ticos) ---
            const indexHtmlContent = document.documentElement.outerHTML;

            const netlifyTomlContent = `[build]
              command = "npm install"
              functions = "netlify/functions"`;

            const packageJsonContent = `{
              "name": "misorteos-functions",
              "version": "1.0.0",
              "description": "Dependencias para las funciones de Netlify",
              "dependencies": {
                "node-fetch": "^3.3.2"
              }
            }`;

            const geminiJsContent = `// netlify/functions/gemini.js
            exports.handler = async function (event, context) {
                const fetch = (await import('node-fetch')).default;
                const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
                const body = JSON.parse(event.body);
                const { base64Data, dynamicPrompt } = body;
                if (!base64Data || !dynamicPrompt) {
                    return {
                        statusCode: 400,
                        body: JSON.stringify({ error: 'Faltan datos en la petici√≥n.' })
                    };
                }
                const apiUrl = \\\`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=\\\${GEMINI_API_KEY}\\\`;
                const payload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: dynamicPrompt },
                            { inlineData: { mimeType: "image/jpeg", data: base64Data.split(',')[1] } }
                        ]
                    }]
                };
                try {
                    const geminiResponse = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!geminiResponse.ok) {
                        const errorBody = await geminiResponse.json();
                        console.error("Error desde la API de Gemini:", errorBody);
                        return {
                            statusCode: geminiResponse.status,
                            body: JSON.stringify({ error: 'La API de Gemini devolvi√≥ un error.', details: errorBody })
                        };
                    }
                    const data = await geminiResponse.json();
                    return {
                        statusCode: 200,
                        body: JSON.stringify(data)
                    };
                } catch (error) {
                    console.error("Error en la funci√≥n de Netlify:", error);
                    return {
                        statusCode: 500,
                        body: JSON.stringify({ error: 'Error al contactar la API de Gemini.' })
                    };
                }
            };`;

            const searchJsContent = `// netlify/functions/search.js
            exports.handler = async function (event, context) {
                const fetch = (await import('node-fetch')).default;
                const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
                const { query } = JSON.parse(event.body);
                if (!query) {
                    return {
                        statusCode: 400,
                        body: JSON.stringify({ error: 'Falta la consulta (query).' })
                    };
                }
                const apiUrl = \\\`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=\\\${GEMINI_API_KEY}\\\`;
                const prompt = \\\`Busca en internet el precio aproximado del siguiente producto: "\\\${query}". Devu√©lveme el precio encontrado y la URL de la fuente en un objeto JSON. Por ejemplo: {"value": "150‚Ç¨", "url": "https://example.com"}. Si no encuentras un precio, usa "No encontrado" para la clave "value" y null para "url". Tu respuesta debe ser √∫nicamente el objeto JSON, sin texto adicional ni markdown.\\\`;
                const payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: prompt }]
                    }]
                };
                try {
                    const geminiResponse = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!geminiResponse.ok) {
                        const errorBody = await geminiResponse.json();
                        console.error("Error desde la API de Gemini (en search.js):", errorBody);
                        return {
                            statusCode: geminiResponse.status,
                            body: JSON.stringify({ error: 'La API de Gemini devolvi√≥ un error en la b√∫squeda.', details: errorBody })
                        };
                    }
                    const data = await geminiResponse.json();
                    return {
                        statusCode: 200,
                        body: JSON.stringify(data)
                    };
                } catch (error) {
                    console.error("Error en la funci√≥n search.js:", error);
                    return {
                        statusCode: 500,
                        body: JSON.stringify({ error: 'Error al contactar la API de Gemini.' })
                    };
                }
            };`;

            // --- Creaci√≥n del Archivo .ZIP ---
            zip.file("index.html", indexHtmlContent);
            zip.file("giveaways_new.js", giveawaysContent);
            zip.file("discardedGiveaways_new.js", discardedGiveawaysContent);
            zip.file("netlify.toml", netlifyTomlContent);
            zip.file("package.json", packageJsonContent);

            const functionsFolder = zip.folder("netlify").folder("functions");
            functionsFolder.file("gemini.js", geminiJsContent);
            functionsFolder.file("search.js", searchJsContent);

            zip.generateAsync({ type: "blob" }).then(function(content) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                const today = new Date().toISOString().slice(0, 10);
                link.download = `Misorteos-Backup-Completo-${today}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        };
        
        const restoreFromBackup = (file) => { if (!file) return; const reader = new FileReader(); reader.onload = (e) => { JSZip.loadAsync(e.target.result).then(zip => { const giveawaysFile = zip.file("giveaways_new.js"); const discardedFile = zip.file("discardedGiveaways_new.js"); const foreignFile = zip.file("foreignAccounts.js"); if (!giveawaysFile || !discardedFile || !foreignFile) { showNotification('Error', 'El archivo .zip no parece una copia de seguridad v√°lida.'); return; } Promise.all([giveawaysFile.async("string"), discardedFile.async("string"), foreignFile.async("string")]) .then(contents => { try { const giveawaysContent = contents[0].replace('window.giveaways = ', '').slice(0, -1); const discardedContent = contents[1].replace('window.discardedGiveaways = ', '').slice(0, -1); const foreignContent = contents[2].replace('window.foreignAccounts = ', '').slice(0, -1); const parsedGiveaways = JSON.parse(giveawaysContent); const parsedDiscarded = JSON.parse(discardedContent); const parsedForeign = JSON.parse(foreignContent); if (confirm("¬øSeguro que quieres restaurar esta copia? Se borrar√°n todos los datos actuales y se reemplazar√°n por los del archivo.")) { giveaways = parsedGiveaways; discardedGiveaways = parsedDiscarded; foreignAccounts = parsedForeign; saveGiveaways(); saveDiscardedGiveaways(); saveForeignAccounts(); renderCalendar(); showNotification('¬°√âxito!', 'La copia de seguridad se ha restaurado correctamente.'); } } catch (error) { showNotification('Error de formato', 'No se pudo leer el contenido del archivo .zip.'); console.error("Error al parsear la copia de seguridad:", error); } }); }); }; reader.readAsArrayBuffer(file); };

        const toggleNavMenu = () => {
            navMenu.classList.toggle('is-open');
            menuOverlay.style.display = navMenu.classList.contains('is-open') ? 'block' : 'none';
        };

        const renderForeignAccountsModal = () => {
             foreignAccountsModalBody.innerHTML = '';
             if (foreignAccounts.length === 0) {
                 foreignAccountsModalBody.innerHTML = '<p class="text-center">No hay cuentas extranjeras bloqueadas.</p>';
                 return;
             }
             foreignAccounts.forEach(account => {
                 const itemContainer = document.createElement('div');
                 itemContainer.className = 'flex justify-between items-center p-3 bg-red-100/50 rounded-lg shadow-inner border border-red-600/20';
                 itemContainer.innerHTML = `
                     <span class="font-bold">${account}</span>
                     <button class="remove-foreign-account-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-400" data-account-name="${account}"><i class="fa-solid fa-trash-can"></i></button>
                 `;
                 foreignAccountsModalBody.appendChild(itemContainer);
             });
        };

        const removeForeignAccount = (accountName) => {
             foreignAccounts = foreignAccounts.filter(acc => acc !== accountName);
             saveForeignAccounts();
             renderForeignAccountsModal();
             showNotification('Cuenta eliminada', `La cuenta ${accountName} se ha eliminado de la lista de extranjeras.`);
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            animateStarryBackground();
            animateTitle();
            renderCalendar();
            updatePointsDisplay();
            userTitleEl.textContent = userAchievements.title;

            const setupModal = (button, modal, closeButton, onOpenCallback) => {
                if (button) button.addEventListener('click', (e) => { e.preventDefault(); if (onOpenCallback) onOpenCallback(); modal.classList.remove('hidden'); requestAnimationFrame(() => modal.classList.add('is-visible')); });
                if (closeButton) closeButton.addEventListener('click', () => { modal.classList.remove('is-visible'); setTimeout(() => modal.classList.add('hidden'), 300); });
                if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) { modal.classList.remove('is-visible'); setTimeout(() => modal.classList.add('hidden'), 300); } });
            };

            setupModal(statsBtn, statsModal, closeStatsModalBtn, renderStatsModal);
            setupModal(historyBtn, historyModal, closeHistoryModalBtn, renderHistoryModal);
            setupModal(trophyBtn, trophyModal, closeTrophyModalBtn, renderTrophyModal);
            setupModal(achievementsBtn, achievementsModal, closeAchievementsModalBtn, () => renderAchievementsModal('logros'));
            setupModal(addManualBtn, addGiveawayModal, closeAddGiveawayModalBtn);
            setupModal(addAIBtn, addAIGiveawayModal, closeAddAIGiveawayModalBtn);
            setupModal(searchMenuBtn, searchModal, closeSearchModalBtn);
            setupModal(trashBtn, trashModal, closeTrashModalBtn, renderTrashModal);
            setupModal(discardedBtn, discardedModal, closeDiscardedModalBtn, renderDiscardedModal);
            setupModal(null, foreignAccountsModal, closeForeignAccountsModalBtn);
            setupModal(manageBlocksBtn, blockManagementModal, closeBlockManagementModalBtn);
            setupModal(null, duplicateComparisonModal, closeDuplicateComparisonModalBtn);
            
            openNavMenuBtn.addEventListener('click', toggleNavMenu);
            closeNavMenuBtn.addEventListener('click', toggleNavMenu);
            menuOverlay.addEventListener('click', toggleNavMenu);

            prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
            calendarDaysEl.addEventListener('click', (e) => { const dayEl = e.target.closest('.has-giveaway'); if (dayEl) openModal(dayEl.dataset.date); });

            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

            modalBody.addEventListener('click', (e) => {
                const giveawayId = e.target.dataset.giveawayId || e.target.closest('[data-giveaway-id]')?.dataset.giveawayId;
                if (!giveawayId) return;
                const dateStr = modal.dataset.date;
                const giveaway = giveaways[dateStr].find(g => g.id === giveawayId);

                if (e.target.type === 'checkbox') {
                    const itemContainer = e.target.closest('.giveaway-item');
                    if (e.target.checked) {
                        completedGiveaways[giveawayId] = true;
                        animateShootingStar(itemContainer, () => {
                            itemContainer.classList.add('completed');
                            buildModal(dateStr); // Re-render to reorder
                            renderCalendar();
                        });
                        addPoints(2);
                    } else {
                        delete completedGiveaways[giveawayId];
                        itemContainer.classList.remove('completed');
                        buildModal(dateStr); // Re-render to reorder
                        renderCalendar();
                    }
                    saveCompletedGiveaways();
                    checkAchievements('complete', { giveawayDate: dateStr });
                } else if (e.target.closest('.win-giveaway-btn')) {
                    markAsWon(giveawayId, dateStr);
                } else if (e.target.closest('.move-giveaway-btn')) {
                    openMoveGiveawayModal(giveaway, dateStr);
                } else if (e.target.closest('.delete-giveaway-btn')) {
                    if (confirm('¬øSeguro que quieres mover este sorteo a la papelera?')) {
                        deleteGiveawayFromCalendar(dateStr, giveawayId);
                    }
                } else if (e.target.closest('.delete-giveaway-foreign-btn')) {
                    if (confirm('¬øMarcar como sorteo extranjero? Las cuentas se a√±adir√°n al cortafuegos.')) {
                        deleteForeignGiveaway(dateStr, giveawayId);
                    }
                }
            });

            trashModalBody.addEventListener('click', (e) => { const restoreBtn = e.target.closest('.restore-btn'); if (restoreBtn) { restoreGiveawayFromTrash(restoreBtn.dataset.giveawayId); } });
            manageForeignAccountsBtn.addEventListener('click', (e) => { e.preventDefault(); renderForeignAccountsModal(); foreignAccountsModal.classList.remove('hidden'); requestAnimationFrame(() => foreignAccountsModal.classList.add('is-visible')); });

            discardedModal.addEventListener('click', (e) => {
                const filterBtn = e.target.closest('.filter-btn');
                if (filterBtn) {
                    discardedFilter = filterBtn.dataset.filter;
                    renderDiscardedModal();
                }
            });

            discardedModalBody.addEventListener('click', (e) => { 
                const item = e.target.closest('.giveaway-item-discarded'); 
                if (!item) return;
                const giveawayId = item.dataset.giveawayId;
                const giveaway = discardedGiveaways.find(g => g.id === giveawayId);
                if (!giveaway) return;
                if (e.target.closest('.add-discarded-btn')) {
                    e.stopPropagation();
                    openAddGiveawayModal({ date: giveaway.date || giveaway.originalDate, prize: giveaway.prize, accounts: (giveaway.accounts || []).join(', '), price: giveaway.price });
                    deleteDiscardedGiveaway(giveawayId);
                    closeDiscardedModalBtn.click();
                } else if (e.target.closest('.delete-discarded-btn')) {
                    e.stopPropagation(); 
                    deleteDiscardedGiveaway(giveawayId); 
                } else if (giveaway.status === 'duplicate' && giveaway.originalGiveaway) { 
                    showDuplicateComparisonModal(giveaway); 
                } else {
                    openAddGiveawayModal({ date: giveaway.date || giveaway.originalDate, prize: giveaway.prize, accounts: (giveaway.accounts || []).join(', '), price: giveaway.price });
                }
            });

            trophyModalBody.addEventListener('click', (e) => { const deleteBtn = e.target.closest('.trophy-delete-btn'); if (deleteBtn) { deleteWonGiveaway(deleteBtn.dataset.giveawayId); } });
            selectAiImagesBtn.addEventListener('click', () => { aiImageInput.click(); });
            aiImageInput.addEventListener('change', handleFileSelection);
            startAiButton.addEventListener('click', startAnalysis);
            aiSummaryCloseBtn.addEventListener('click', closeAddAIGiveawayModal);

            blockLikeBtn.addEventListener('click', (e) => { e.preventDefault(); blockHistory.push({ type: 'like', date: new Date().toISOString() }); saveBlockHistory(); showNotification('Bloqueo registrado', 'Se ha a√±adido un nuevo bloqueo de "Me gusta".'); renderStatsModal(); });
            blockCommentBtn.addEventListener('click', (e) => { e.preventDefault(); blockHistory.push({ type: 'comment', date: new Date().toISOString() }); saveBlockHistory(); showNotification('Bloqueo registrado', 'Se ha a√±adido un nuevo bloqueo de comentarios.'); renderStatsModal(); });

            addAsNewBtn.addEventListener('click', (e) => {
                const giveawayId = e.target.dataset.giveawayId;
                if (!giveawayId) return;
                const giveawayToAdd = discardedGiveaways.find(g => g.id === giveawayId);
                if (giveawayToAdd) {
                    deleteDiscardedGiveaway(giveawayId);
                    openAddGiveawayModal({ date: giveawayToAdd.date || giveawayToAdd.originalDate, prize: giveawayToAdd.prize, accounts: (giveawayToAdd.accounts || []).join(', '), price: giveawayToAdd.price });
                    duplicateComparisonModal.classList.remove('is-visible');
                    setTimeout(() => duplicateComparisonModal.classList.add('hidden'), 300);
                }
            });

            mergeGiveawayBtn.addEventListener('click', (e) => {
                const giveawayId = e.target.dataset.giveawayId;
                if (!giveawayId) return;
                const discarded = discardedGiveaways.find(g => g.id === giveawayId);
                if (discarded && discarded.originalGiveaway) {
                    let original = null;
                    for (const date in giveaways) {
                        const found = giveaways[date].find(g => g.id === discarded.originalGiveaway.id);
                        if (found) { original = found; break; }
                    }
                    if (original) {
                        if (!original.price && discarded.price) original.price = discarded.price;
                        if (!original.date && discarded.date) original.date = discarded.date;
                        deleteDiscardedGiveaway(giveawayId);
                        saveGiveaways();
                        renderCalendar();
                        showNotification('Sorteo Fusionado', 'Se han actualizado los datos del sorteo original.');
                        checkAchievements('merge');
                        duplicateComparisonModal.classList.remove('is-visible');
                        setTimeout(() => duplicateComparisonModal.classList.add('hidden'), 300);
                    } else {
                        showNotification('Error', 'No se encontr√≥ el sorteo original para fusionar.');
                    }
                }
            });

            addGiveawayForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newGiveaway = { id: Date.now().toString(), date: giveawayDateInput.value, prize: giveawayPrizeInput.value, accounts: giveawayAccountsInput.value.split(',').map(acc => acc.trim()), price: giveawayPriceInput.value, addDate: new Date().toISOString().slice(0, 10) };
                addGiveaway(newGiveaway);
                closeAddGiveawayModal();
            });

            moveGiveawayForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (giveawayToMove && originalDateOfGiveaway) {
                    moveGiveaway(giveawayToMove.id, originalDateOfGiveaway, newGiveawayDateInput.value);
                    closeMoveGiveawayModal();
                }
            });

            const allNavButtons = document.querySelectorAll('#nav-menu a');
            allNavButtons.forEach(btn => { btn.addEventListener('click', () => toggleNavMenu()); });

            const downloadBtn = document.getElementById('download-btn');
            const uploadBtn = document.getElementById('upload-btn');
            const zipUploadInput = document.getElementById('zip-upload');
            if(downloadBtn) downloadBtn.addEventListener('click', (e) => { e.preventDefault(); downloadSourceCode(); });
            if(uploadBtn) uploadBtn.addEventListener('click', (e) => { e.preventDefault(); if(zipUploadInput) zipUploadInput.click(); });
            if(zipUploadInput) zipUploadInput.addEventListener('change', (e) => { restoreFromBackup(e.target.files[0]); });
        });
    </script>
</body>
</html>