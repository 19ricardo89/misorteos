<!DOCTYPE html>
<html lang="es">
<head>
    <meta property="og:type" content="website" />
<meta property="og:url" content="https://misorteos.es/" />
<meta property="og:title" content="Misorteos - Expertos en el Arte de Participar" />
<meta property="og:description" content="Para los que tenemos el pulgar desgastado de dar 'like' y etiquetar amigos. Aqu√≠ tienes tu recompensa: los mejores sorteos y mucha mierda üí©" />
<meta property="og:image" content="https://misorteos.es/assets/img/Misorteos.png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:type" content="image/png" />

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="https://misorteos.es/">
<meta name="twitter:title" content="Misorteos - Expertos en el Arte de Participar">
<meta name="twitter:description" content="Para los que tenemos el pulgar desgastado de dar 'like' y etiquetar amigos. Aqu√≠ tienes tu recompensa: los mejores sorteos y mucha mierda üí©">
<meta name="twitter:image" content="https://misorteos.es/assets/img/Misorteos.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misorteos</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M21.99 2H2.01C.9 2 .01 2.9.01 4L0 20c0 1.1.89 2 1.99 2H22c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM4 4h16v16H4V4zM16 11H8V8h8v3zm-3 5h-3v-3h3v3z' fill='%23f7d468'/%3E%3Cpath d='M12 1.5L9.24 7.76 2.5 8.24l5.09 4.67L5.76 20.5 12 17.27l6.24 3.23-1.83-7.59 5.09-4.67-6.74-.48L12 1.5z' fill='%23eab308'/%3E%3C/svg%3E" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chewy&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- KEYFRAMES --- */
        @keyframes twinkle { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        @keyframes move-star { from { transform: translateY(0); } to { transform: translateY(-200px); } }
        @keyframes letter-reveal-sparkle { 0% { transform: scale(0); opacity: 0; } 50% { opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        @keyframes sparkle-fountain { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-40px) scale(0); opacity: 0; } }
        @keyframes shooting-star-anim {
            0% { transform: translate(-20%, 120%) scale(0.5); opacity: 1; }
            100% { transform: translate(120%, -20%) scale(0.5); opacity: 0; }
        }
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 5px #fbd38d, 0 0 10px #fbd38d; }
            50% { text-shadow: 0 0 10px #fbd38d, 0 0 20px #fbd38d, 0 0 30px #fbd38d; }
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes vortex {
            from { transform: rotate(0deg) scale(1); }
            to { transform: rotate(360deg) scale(0); }
        }
        @keyframes pulse-help {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(253, 224, 71, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 10px 5px rgba(253, 224, 71, 0); }
        }

        /* --- ESTILOS NOTIFICACI√ìN TOAST --- */
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 200;
            background-color: #302b63;
            color: #f7d468;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 2px solid #d4af37;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
            animation-duration: 0.5s;
            animation-fill-mode: forwards;
        }
        .notification-toast.show {
            display: block;
            animation-name: slideInRight;
        }
        .notification-toast.hide {
            animation-name: slideOutRight;
        }

        /* --- ESTILOS GENERALES --- */
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Chewy', cursive;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #f0e6d2;
            display: flex;
            flex-direction: column;
        }
        main {
            flex-grow: 1;
        }

        /* Clase para usar el gradiente del fondo */
        .bg-web-gradient {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        }

        /* --- FONDO ESTRELLADO --- */
        #magic-stars-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .star { position: absolute; background: white; border-radius: 50%; box-shadow: 0 0 5px white, 0 0 10px white; animation: twinkle 2s infinite ease-in-out; }
        .moving-star { animation: move-star linear infinite, twinkle 2s infinite ease-in-out; }

        /* --- T√çTULO --- */
        .title-container { position: relative; text-align: center; padding-top: 1rem; margin-bottom: 1rem; flex-shrink: 0; }
        .magic-title { font-size: clamp(3.5rem, 12vw, 6rem); color: #f7d468; text-shadow: 0 0 10px #d4af37, 0 0 20px #d4af37; letter-spacing: 10px; display: inline-block; position: relative; white-space: nowrap; }
        .magic-title .letter { display: inline-block; opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease, transform 0.5s ease; position: relative; }
        .sparkle, .fountain-sparkle { position: absolute; background: #f7d468; border-radius: 50%; box-shadow: 0 0 15px #f7d468; }
        .sparkle { width: 8px; height: 8px; opacity: 0; }
        .fountain-sparkle { width: 5px; height: 5px; animation: sparkle-fountain 1.5s ease-out forwards; }

        /* --- CALENDARIO --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { transition: all 0.3s ease-in-out; border: 1px solid transparent; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; border-radius: 8px; color: #f0e6d2; height: 80px; padding-top: 8px; }
        .day-number { font-size: 1.5rem; line-height: 1; }
        .calendar-day.has-giveaway { background-color: rgba(212, 175, 55, 0.2); cursor: pointer; border-color: #d4af37; }
        .calendar-day.has-giveaway:hover { transform: scale(1.05); box-shadow: 0 0 20px #f7d468; z-index: 10; }
        .calendar-day.all-done { background-color: rgba(34, 197, 94, 0.3); border-color: #22c55e; }
        .calendar-day.all-done .giveaway-count { display: none; }
        .giveaway-count { font-size: 0.7rem; color: #78350f; background-color: #f7d468; border: 1px solid #b45309; padding: 1px 5px; margin-top: 4px; }

        /* --- MODAL --- */
        .modal {
            z-index: 50;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            opacity: 0;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #modal-search-input::placeholder {
            color: #a16207;
            opacity: 0.8;
        }
        .modal.is-visible {
            pointer-events: auto;
            opacity: 1;
        }
        .modal-content {
            font-family: 'Chewy', cursive;
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            transform: scale(0.95);
            background-size: cover;
            background-position: center;
            border: 3px solid #d4af37;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .modal.is-visible .modal-content {
            transform: scale(1);
        }
        .modal-default-bg { background-color: #fffbef; }
        .modal-travel-bg { background-image: linear-gradient(rgba(255, 251, 235, 0.85), rgba(255, 251, 235, 0.85)), url('https://images.unsplash.com/photo-1507525428034-b723a9ce6890?q=80&w=1170&auto=format&fit=crop'); }
        .modal-padel-bg { background-image: linear-gradient(rgba(255, 251, 235, 0.85), rgba(255, 251, 235, 0.85)), url('https://images.unsplash.com/photo-1621288228964-67ac723a9b8a?q=80&w=1170&auto=format&fit=crop'); }
        #modal-body, #add-giveaway-form-body, #search-modal-body, #trash-modal-body, #discarded-modal-body, #duplicate-giveaway-info, #foreign-accounts-modal-body, #trophy-modal-body, #stats-modal-body, #history-modal-body, #achievements-modal-body, #ps-summary-modal-body, #recent-adds-modal-body, #vis-modal-body, .nav-menu, #new-additions-modal-body { overflow-y: auto; }

        /* --- ESTILOS PARA EL NUEVO FILTRO DE CATEGOR√çAS --- */
        #category-filter-button.placeholder #category-filter-selected-text {
            color: #a16207;
            opacity: 0.8;
        }
        .custom-dropdown-option {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid #fef3c7;
            border-radius: 4px;
        }
        .custom-dropdown-option:hover {
            background-color: #fef3c7;
        }
        .custom-dropdown-option .category-name {
            font-weight: bold;
            color: #78350f;
        }
        .custom-dropdown-option .category-desc {
            font-size: 0.6rem;
            color: #92400e;
            text-align: left;
            padding-left: 0;
            white-space: normal;
            line-height: 1.3;
        }

        /* --- CORRECCI√ìN UI MODAL IA --- */
        #ai-image-queue {
            max-height: 160px;
            overflow-y: auto;
        }
        #ai-summary-results-container {
             max-height: 60vh;
             overflow-y: auto;
        }

        /* --- ANIMACI√ìN ESTRELLA FUGAZ --- */
        .giveaway-item { position: relative; overflow: hidden; }
        .giveaway-item .text-content { transition: opacity 0.3s ease-in-out; }
        .giveaway-item.completed .text-content { opacity: 0.5; text-decoration: line-through; }
        .shooting-star {
            position: absolute; top: 0; left: 0; width: 8px; height: 8px;
            background: radial-gradient(circle, #fff, #f7d468);
            border-radius: 50%;
            box-shadow: 0 0 10px #f7d468, 0 0 20px #fff;
            animation: shooting-star-anim 0.6s ease-in forwards;
            pointer-events: none;
        }
        .shooting-star::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 150px; height: 2px;
            background: linear-gradient(to left, transparent, #f7d468);
            transform-origin: right;
            transform: rotate(-45deg) translate(75px);
        }

        /* --- CONFIRMATION MODAL --- */
        #confirmation-modal .modal-content { padding: 2rem; text-align: center; }

        /* --- ESTILOS DEL MEN√ö Y NAVEG√ÅCI√ìn --- */
        .nav-btn {
            background-color: transparent;
            color: #f7d468;
            font-weight: bold;
            border-radius: 9999px; /* full rounded */
            border: 2px solid #d4af37;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease-in-out;
        }
        .nav-btn:hover {
            background-color: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 20px #f7d468;
        }
        .action-btn {
            border-color: #ef4444;
            color: #fca5a5;
        }
        .action-btn:hover {
             background-color: rgba(239, 68, 68, 0.2);
             box-shadow: 0 0 15px #f87171;
        }
        .nav-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 60;
            padding: 1.5rem;
            border-right: 2px solid #d4af37;
        }

        .nav-menu.is-open {
            transform: translateX(0);
        }

        .nav-menu-btn {
             background-color: transparent;
             color: #f7d468;
             font-weight: bold;
             border: 2px solid #d4af37;
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
             transition: all 0.3s ease-in-out;
             width: 48px;
             height: 48px;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 55;
            display: none;
        }


        .shooting-star-line::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 150%;
            height: 1px;
            background: linear-gradient(to right, transparent, #fbd38d, #fbd38d);
            transform-origin: left;
            transform: scaleX(0);
            transition: transform 0.5s ease-in-out;
            z-index: -1;
        }
        .shooting-star-line:hover::before {
            transform: scaleX(1);
        }
        .shooting-star-line .relative.z-10 {
            color: #6a3805; /* Marr√≥n oscuro para mejor contraste */
            font-weight: bold;
        }
        .menu-link {
            font-size: 1rem;
            padding: 0.5rem 1rem;
        }

        /* Estilos del agujero negro */
        .vortex-btn {
            background-color: transparent;
            border: 2px solid #302b63;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease-in-out;
        }
        .vortex-btn:hover {
             box-shadow: 0 0 20px #0f0c29;
        }

        .vortex-btn .vortex {
            background: conic-gradient(from 0deg, transparent 0%, #000 10%, #fff 50%, #000 90%, transparent 100%);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .calendar-nav-btn {
             height: 48px;
        }

        .giveaway-item-discarded.duplicate-item {
             cursor: pointer;
        }

        .giveaway-item-discarded.duplicate-item:hover {
             background-color: rgba(255, 0, 0, 0.2);
             box-shadow: 0 0 10px #f87171;
        }

        .discarded-item-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
        }

        /* Estilos para el modal de duplicados */
        #duplicate-modal .modal-content {
             max-width: 90%;
        }

        #duplicate-giveaway-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }

        /* --- AJUSTES RESPONSIVE PARA EL HEADER --- */
        #user-title {
            font-size: 1.1rem; /* M√°s peque√±o en m√≥vil */
            color: #d1d5db; /* Un tono de plata/gris claro */
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.3), 0 0 10px rgba(0, 0, 0, 0.5); /* Efecto de realce sutil */
        }
        #total-ps-container {
            padding: 0.25rem 0.75rem;
            font-size: 1rem; /* M√°s peque√±o en m√≥vil */
        }
        @media (min-width: 640px) { /* sm: */
            #user-title {
                font-size: 1.5rem; /* Tama√±o original para pantallas m√°s grandes */
            }
            #total-ps-container {
                padding: 0.5rem 1rem;
                font-size: 1.5rem; /* Tama√±o original */
            }
        }
        #total-giveaways-container {
            padding: 0.5rem 1rem;
            background-color: #302b63;
            border-radius: 9999px;
            color: #f7d468;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid #d4af37;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        #total-giveaways-container:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #f7d468;
        }

        /* --- NUEVA PALETA DE COLORES (VERSI√ìN 2) --- */
        .modal-content, .ai-fullscreen-view {
            color: #422006; /* Color de texto base oscuro */
        }
        /* Estilo para el texto principal del premio */
        .giveaway-item .text-yellow-900 {
            color: #4e342e !important;
        }
        /* NUEVO: Color m√°s oscuro para cuentas y precio */
        .giveaway-item a,
        .giveaway-item .text-amber-600,
        .giveaway-item .text-yellow-700 {
            color: #6a3805 !important; /* Marr√≥n oscuro para m√°xima legibilidad */
            font-weight: bold; /* A√±adimos negrita para que destaque m√°s */
        }
        .giveaway-item a:hover {
            color: #8c5a15 !important; /* Un tono m√°s claro al pasar el rat√≥n */
        }

        /* --- NUEVO: Estilos para los botones de acci√≥n con colores --- */
        .move-giveaway-btn {
            background-color: #fdecc8 !important;
            color: #78350f !important;
        }
        .move-giveaway-btn:hover {
             background-color: #f7d468 !important;
        }
        .delete-giveaway-btn { /* Bot√≥n Papelera - ROJO */
            background-color: #fee2e2 !important;
            color: #b91c1c !important;
        }
        .delete-giveaway-btn:hover {
            background-color: #fca5a5 !important;
        }
        .delete-giveaway-foreign-btn { /* Bot√≥n Extranjero - AZUL */
            background-color: #dbeafe !important;
            color: #1e40af !important;
        }
        .delete-giveaway-foreign-btn:hover {
            background-color: #93c5fd !important;
        }
        .win-giveaway-btn { /* Bot√≥n Ganado - ORO */
            background-color: #fef3c7 !important;
            color: #b45309 !important;
            border: 1px solid #fde047;
        }
        .win-giveaway-btn:hover {
            background-color: #fde68a !important;
        }
        .vis-giveaway-btn { /* Bot√≥n VIS - PLATA */
            background-color: #e5e7eb !important;
            color: #4b5563 !important;
            border: 1px solid #d1d5db;
        }
        .vis-giveaway-btn:hover {
            background-color: #d1d5db !important;
        }
        
        /* [NUEVO] Bot√≥n de Ayuda */
        .help-btn {
            background-color: #fde047;
            color: #78350f;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.25rem;
            cursor: pointer;
            border: 1px solid #facc15;
            transition: all 0.2s ease-in-out;
            animation: pulse-help 2.5s infinite;
        }
        .help-btn:hover {
            transform: scale(1.1);
            background-color: #facc15;
        }


        /* T√≠tulos de los modales */
        #modal-title, #add-giveaway-modal-title, #search-modal h2, #trash-modal h2, #discarded-modal h2, #duplicate-modal h2, #move-giveaway-modal h2, #foreign-accounts-modal h2, #trophy-modal h2, #stats-modal h2, #history-modal h2, #achievements-modal h2, #ps-summary-modal h2, #recent-adds-modal h2, #new-additions-modal h2, #admin-modal h2 {
            color: #8c5a15;
        }

        /* --- ESTILOS PARA EL NUEVO RESUMEN DETALLADO DE IA --- */
        #ai-summary-results h3, #ai-summary-results h4, #history-modal h3, #history-modal h4 {
            color: #8c5a15; /* Usar el mismo color dorado intenso para los t√≠tulos */
        }
        #ai-summary-results details, #history-modal details {
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background-color: rgba(255, 251, 235, 0.05);
        }
        #ai-summary-results summary, #history-modal summary {
            font-weight: bold;
            cursor: pointer;
            color: #d4af37;
        }
        #ai-summary-results ul, #history-modal ul {
            list-style-type: none;
            padding-left: 1rem;
            margin-top: 0.5rem;
        }
        #ai-summary-results li, #history-modal li {
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        }
        #ai-summary-results li:last-child, #history-modal li:last-child {
            border-bottom: none;
        }
        #ai-summary-results .view-original-duplicate {
            text-decoration: underline;
            cursor: pointer;
            color: #6a3805;
        }
        #ai-summary-results .view-original-duplicate:hover {
            color: #8c5a15;
        }

        /* --- ESTILOS VITRINA, ESTAD√çSTICAS Y LOGROS --- */
        #trophy-modal-body {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
        }
        .trophy-card {
            background: linear-gradient(135deg, #fefce8, #fef3c7);
            border: 2px solid #fde047;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(253, 224, 71, 0.2);
            color: #78350f; /* Color de texto oscuro para el trofeo */
            position: relative; /* Para posicionar el bot√≥n de eliminar */
        }
        .trophy-card h3 {
            font-size: 1.25rem;
            color: #b45309; /* Color dorado m√°s intenso para el t√≠tulo */
        }
        /* Estilo para el nuevo bot√≥n de eliminar */
        .trophy-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.1);
            color: #991b1b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .trophy-delete-btn:hover {
            background-color: rgba(255, 0, 0, 0.3);
            transform: scale(1.1);
        }
        #stats-modal-body ul, #stats-modal-body ol {
            list-style: none;
            padding: 0;
        }
        #stats-modal-body li {
            font-size: 1.2rem;
            padding: 0.5rem;
            border-bottom: 1px solid rgba(140, 90, 21, 0.2);
        }
        #stats-modal-body li strong {
            color: #b45309;
        }
        #stats-modal-body ol {
            padding-left: 1rem;
            list-style-type: decimal;
        }
         #stats-modal-body ol li {
            font-size: 1rem;
            padding: 0.25rem 0;
         }

        #charts-modal-body {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            padding: 1rem;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* --- ESTILOS MODAL DE LOGROS --- */
        .achievement-tabs button {
            transition: all 0.2s ease-in-out;
            border-bottom: 3px solid transparent;
        }
        .achievement-tabs button.active {
            color: #f7d468;
            border-bottom-color: #f7d468;
        }
        .achievement-item {
            transition: all 0.3s ease;
            border-left: 5px solid #ca8a04;
        }
        .achievement-item.locked {
            opacity: 0.6;
            filter: grayscale(80%);
            border-left-color: #a1a1aa;
        }
        .achievement-item .ach-icon {
            font-size: 2.5rem;
        }
        .goal-progress-bar {
            background-color: #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
        }
        .goal-progress-fill {
            background-color: #4ade80; /* Verde para completado */
            transition: width 0.5s ease;
        }
        .title-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .title-item:hover {
            background-color: #fef3c7;
        }
        .title-item.selected {
            border-color: #f59e0b;
            background-color: #fef3c7;
            box-shadow: 0 0 10px #f59e0b;
        }
        .title-item.locked {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* --- ESTILOS PARA LAS NUEVAS TARJETAS DE SORTEO --- */
        .giveaway-card {
            border: 2px solid #d4af37;
            border-radius: 12px;
            padding: 1rem;
            background-color: #fffbef;
            color: #4e342e;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .giveaway-card h3 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
            color: #8c5a15;
        }
        .giveaway-card-details {
            display: grid;
            gap: 0.5rem;
        }
        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
        }
        .detail-item i {
            width: 20px;
            text-align: center;
            color: #b45309;
        }
        .status-tag {
            padding: 2px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: capitalize;
        }
        .status-duplicate { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }
        .status-expired { background-color: #fef3c7; color: #b45309; border: 1px solid #fde68a; }
        .status-foreign { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .status-no_date { background-color: #f3e8ff; color: #6b21a8; border: 1px solid #d8b4fe; }
        .status-not_a_giveaway, .status-api_error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        /* --- NUEVOS ESTILOS PARA LA VISTA DE AN√ÅLISIS A PANTALLA COMPLETA --- */
        .ai-fullscreen-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            padding: 1rem;
            gap: 1rem;
        }
        .ai-fullscreen-view.is-visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        #analysis-legend-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            flex-shrink: 0;
            padding-top: 2rem; /* Espacio para el bot√≥n de cerrar */
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: bold;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            background-color: rgba(0,0,0,0.2);
        }
        .legend-item .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        #analysis-image-preview-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            aspect-ratio: 16 / 9;
            border: 3px solid #f7d468;
            border-radius: 12px;
            background-color: rgba(0,0,0,0.2);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #analysis-image-preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            cursor: zoom-in;
        }

        #live-results-container {
            width: 100%;
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 0.5rem;
        }

        .live-card-placeholder {
            min-height: 250px;
            background: rgba(255, 251, 235, 0.1);
            border: 2px dashed #f7d468;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: rgba(247, 212, 104, 0.5);
            animation: pulse 1.5s infinite;
        }
        .interactive-card {
            animation: fadeInScale 0.5s ease-out forwards;
            background-color: #fffbef;
            border-radius: 12px;
            padding: 1rem;
            border: 3px solid transparent; /* Borde base para la animaci√≥n de color */
        }
        .interactive-card .card-title {
             font-size: 1.25rem;
             font-weight: bold;
             margin-bottom: 1rem;
             text-align: center;
        }
        .interactive-card-form label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        .interactive-card-form input, .interactive-card-form textarea, .interactive-card-form select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid #d4af37;
            background-color: white;
            color: #4e342e;
        }
        .interactive-card-form input:disabled, .interactive-card-form textarea:disabled, .interactive-card-form select:disabled {
            background-color: #fef3c7;
        }

        /* Efectos de brillo para las tarjetas interactivas */
        .card-status-valid { box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.5); border-color: #22c55e; }
        .card-status-duplicate { box-shadow: 0 0 15px 5px rgba(107, 114, 128, 0.5); border-color: #6b7280; }
        .card-status-expired { box-shadow: 0 0 15px 5px rgba(212, 175, 55, 0.5); border-color: #d4af37; }
        .card-status-foreign { box-shadow: 0 0 15px 5px rgba(59, 130, 246, 0.5); border-color: #3b82f6; }
        .card-status-error, .card-status-not_a_giveaway, .card-status-no_date { box-shadow: 0 0 15px 5px rgba(239, 68, 68, 0.5); border-color: #ef4444; }

        .interactive-card-actions {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(212, 175, 55, 0.3);
        }

        .interactive-card-actions button {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .btn-save { background-color: #22c55e; color: white; }
        .btn-save:hover { background-color: #16a34a; }
        .btn-edit { background-color: #f59e0b; color: #422006; }
        .btn-edit:hover { background-color: #d97706; }
        .btn-trash { background-color: #ef4444; color: white; }
        .btn-trash:hover { background-color: #dc2626; }
        .btn-foreign { background-color: #3b82f6; color: white; }
        .btn-foreign:hover { background-color: #2563eb; }
        .btn-merge { background-color: #8b5cf6; color: white; }
        .btn-merge:hover { background-color: #7c3aed; }
        .btn-discard { background-color: #6b7280; color: white; }
        .btn-discard:hover { background-color: #4b5563; }

        /* Estilos para el nuevo modal de zoom */
        #zoom-modal {
            z-index: 200; /* Por encima de la vista de IA */
        }
        #zoom-modal-content {
            background: transparent;
            border: none;
            width: auto;
            height: auto;
            max-width: 90vw;
            max-height: 90vh;
        }
        #zoomed-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            cursor: zoom-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.7; }
        }

        /* --- NUEVOS ESTILOS PARA PESTA√ëAS Y GR√ÅFICOS --- */
        .stats-tabs button {
            transition: all 0.2s ease-in-out;
            border-bottom: 3px solid transparent;
            padding: 0.5rem 1rem;
            font-weight: bold;
            color: #b45309; /* Un color menos intenso para las inactivas */
        }
        .stats-tabs button.active {
            color: #f7d468; /* Dorado brillante para la activa */
            background-color: rgba(247, 212, 104, 0.1);
            border-bottom-color: #f7d468;
        }
        .stats-tab-content {
            display: none; /* Ocultar todos los paneles por defecto */
        }
        .stats-tab-content.active {
            display: block; /* Mostrar solo el panel activo */
            animation: fadeInScale 0.4s ease-out;
        }
        .heatmap-container {
            width: 100%;
            overflow-x: auto; /* Para calendarios anchos en m√≥viles */
        }
        .heatmap {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            font-size: 0.7rem;
        }
        .heatmap-day {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            background-color: #fef3c7; /* Color base para d√≠as sin victorias */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .heatmap-header {
            font-weight: bold;
            text-align: center;
        }

        /* --- [NUEVO] ESTILOS PARA EL AVISO DE ACTUALIZACI√ìN --- */
        #refreshOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000; /* Fondo completamente negro */
            z-index: 1000;
            opacity: 0; /* Empieza transparente */
            pointer-events: none; /* No se puede hacer clic cuando est√° oculto */
            transition: opacity 1s ease-in-out; /* Transici√≥n de 1 segundo */
            display: flex; /* Usamos flex para el layout */
            flex-direction: column;
            justify-content: space-between; /* Espacio entre los elementos */
            align-items: center;
            padding: 2rem;
            cursor: pointer;
        }
        #refreshOverlay.is-visible {
            opacity: 1;
            pointer-events: auto;
        }
        /* Animaci√≥n de la estrella fugaz para el aviso */
       @keyframes shoot-right-to-left {
    0% {
        opacity: 0;
        transform: translate(0, 0) rotate(0deg); /* Aplicamos la rotaci√≥n desde el inicio */
        left: 110%; 
        top: 25%;
    }
    20% {
        opacity: 1;
    }
    80% {
        opacity: 1;
    }
    100% {
        opacity: 0;
        transform: translate(-150vw, 50vh) rotate(0deg); /* Mantenemos la rotaci√≥n */
        left: 110%; 
        top: 25%;
    }
}

#shootingStarRefresh {
    position: absolute;
    width: 300px;
    height: auto;
    opacity: 0;
    animation-name: shoot-right-to-left;
    animation-duration: 5s;
    animation-timing-function: ease-in;
    animation-iteration-count: infinite;
    animation-delay: 1.5s;
    pointer-events: none;
    transform: rotate(0deg); /* Inclinaci√≥n base de la imagen */
}
        @keyframes zoom-in-3d {
            from {
                opacity: 0;
                transform: perspective(400px) scale3d(0.5, 0.5, 0.5) rotate3d(1, 0, 0, -90deg);
            }
            to {
                opacity: 1;
                transform: perspective(400px) scale3d(1, 1, 1) rotate3d(0, 0, 0, 0);
            }
        }
        .dynamic-headline {
            opacity: 0;
            animation-fill-mode: forwards;
            animation-duration: 0.8s;
            animation-name: zoom-in-3d;
            color: #E0E0E0; /* Letras plateadas */
        }
        /* --- FIN DE NUEVOS ESTILOS --- */
        /* --- [NUEVO] ESTILOS PARA FILTROS GLOBALES DEL MEN√ö --- */
#global-search-input, #global-category-filter {
    background-color: rgba(0, 0, 0, 0.3);
    border: 1px solid #d4af37;
    color: #f0e6d2;
    -webkit-appearance: none; /* Quita estilos por defecto en Safari/Chrome */
    -moz-appearance: none;    /* Quita estilos por defecto en Firefox */
    appearance: none;
}

#global-search-input::placeholder {
    color: #b45309;
    opacity: 0.8;
}

#global-category-filter option {
    background-color: #302b63;
    color: #f0e6d2;
}
        /* --- ESTILOS PARA PESTA√ëAS DEL MODAL DIARIO --- */
        .modal-tabs {
            display: flex;
            border-bottom: 2px solid #fde68a;
        }
        .modal-tab-btn {
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-weight: bold;
            color: #b45309;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .modal-tab-btn.active {
            color: #78350f;
            border-bottom-color: #f59e0b;
        }
        .modal-tab-content {
            display: none;
        }
        .modal-tab-content.active {
            display: block;
        }
        .giveaway-item.not-interested {
            opacity: 0.6;
            filter: grayscale(80%);
        }
    </style>
</head>
<body class="p-4">
    <div id="notification-modal" class="notification-toast">
        <h3 id="notification-title" class="font-bold text-lg"></h3>
        <p id="notification-content"></p>
    </div>
    <input type="file" id="zip-upload" class="hidden" accept=".zip">
    <div id="magic-stars-container"></div>

    <div id="nav-menu" class="nav-menu flex flex-col items-start gap-4">
        <div class="flex justify-between items-center w-full">
            <h3 class="text-xl font-bold text-yellow-400">Men√∫</h3>
            <button id="close-nav-menu" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
        </div>
        <div class="w-full px-1 py-2 border-b border-t border-yellow-600/20 my-4">
            <input type="text" id="global-search-input" placeholder="Buscar en todo el calendario..." class="w-full p-2 rounded-lg text-sm mb-2">
            <select id="global-category-filter" class="w-full p-2 rounded-lg text-sm">
            </select>
        </div>
        <a href="#" id="add-manual-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
            <span class="text-xl sm:text-2xl">üìù</span>
            <span>A√±adir</span>
        </a>
        <a href="#" id="add-ai-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
            <span class="text-xl sm:text-2xl">üß†‚ú®</span>
            <span>A√±adir IA</span>
        </a>
        <a href="#" id="vis-review-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
            <span class="text-xl sm:text-2xl">üåü</span>
            <span>Revisi√≥n VIS</span>
        </a>
        <a href="#" id="achievements-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
            <span class="text-xl sm:text-2xl">üèÖ</span>
            <span>Logros</span>
        </a>
        <a href="#" id="stats-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
            <span class="text-xl sm:text-2xl">üìä</span>
            <span>Estad√≠sticas</span>
        </a>
        <a href="#" id="history-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
            <span class="text-xl sm:text-2xl">üïí</span>
            <span>Historial</span>
        </a>
        <a href="#" id="trophy-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2">
             <span class="text-xl sm:text-2xl">üèÜ</span>
             <span>Vitrina</span>
        </a>
        <a href="#" id="admin-panel-btn" class="w-full px-3 py-1 sm:px-4 sm:py-2 nav-btn flex items-center justify-start gap-2 mt-auto border-t border-yellow-600/20 pt-4">
            <span class="text-xl sm:text-2xl">üîë</span>
            <span>Admin</span>
        </a>
    </div>
    <div id="menu-overlay" class="menu-overlay"></div>

    <main class="w-full flex flex-col items-center">
        <div class="title-container">
            <h1 id="main-title" class="magic-title"></h1>
        </div>

        <header class="flex items-center justify-between p-4 mb-2 flex-shrink-0 w-full max-w-4xl">
            <button id="open-nav-menu" class="nav-menu-btn rounded-full">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
            <div class="flex-1 text-center">
                <h2 id="user-title" class="font-bold truncate"></h2>
            </div>
            <div id="total-ps-container">
               <span id="total-ps-count">0</span> PS ‚ú®
           </div>
        </header>
        
        <div id="filter-banner" class="w-full max-w-4xl mx-auto p-2 my-2 text-center text-yellow-800 bg-yellow-200 rounded-lg shadow-md" style="display: none;">
            <span id="filter-banner-text"></span>
            <button id="filter-banner-clear-btn" class="ml-2 font-bold underline hover:text-yellow-600">[Quitar filtro]</button>
        </div>

        <div class="w-full max-w-4xl mx-auto flex items-center justify-between mb-2 flex-shrink-0 px-4">
            <button id="prev-month" class="px-3 py-1 sm:px-4 sm:py-2 nav-btn calendar-nav-btn">&lt;</button>
            <h2 id="month-year" class="text-xl sm:text-3xl md:text-4xl font-bold text-center text-[#f0e6d2]"></h2>
            <button id="next-month" class="px-3 py-1 sm:px-4 sm:py-2 nav-btn calendar-nav-btn">&gt;</button>
        </div>

        <div class="w-full max-w-4xl mx-auto flex flex-col items-center">
            <div id="calendar-days" class="calendar-grid w-full"></div>
        </div>
    </main>

    <footer class="w-full max-w-4xl mx-auto p-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <button id="trash-btn" class="nav-btn p-2 sm:p-4 rounded-full shadow-lg transition-transform duration-300 transform hover:scale-110">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 sm:w-8 sm:h-8"><path d="M3 6h18m-2 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2m-6 5v6m4-6v6" stroke="#f7d468" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <button id="discarded-btn" class="nav-btn p-2 sm:p-4 flex items-center shadow-lg transition-transform duration-300 transform hover:scale-110">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 sm:w-8 sm:h-8">
                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="#f7d468" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="2" y1="12" x2="22" y2="12" stroke="#f7d468" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
        
        <div id="total-giveaways-container">
            <span id="total-giveaways-count">0</span>
        </div>
        
        <div class="flex items-center">
             <button id="new-additions-btn" class="nav-btn px-4 py-3 flex items-center shadow-lg transition-transform duration-300 transform hover:scale-110">
                <span class="text-lg sm:text-xl mr-2">‚ú®</span>
                <span class="font-bold text-sm sm:text-base">Nuevos</span>
            </button>
        </div>
    </footer>

    <div id="trash-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">Papelera de Sorteos</h2>
                <div class="flex items-center gap-2">
                    <button id="help-trash-modal" class="help-btn" data-modal-id="trash-modal">?</button>
                    <button id="close-trash-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
                </div>
            </div>
            <div id="trash-modal-body" class="space-y-4 max-h-[60vh]"></div>
            <button id="delete-all-trash-btn" class="mt-4 bg-red-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-red-400 transition-colors">Vaciar papelera</button>
        </div>
    </div>

    <div id="discarded-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 id="discarded-modal-title" class="text-2xl sm:text-3xl">Sorteos Descartados</h2>
                <div class="flex items-center gap-2">
                    <button id="help-discarded-modal" class="help-btn" data-modal-id="discarded-modal">?</button>
                    <button id="close-discarded-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
                </div>
            </div>
             <div class="flex justify-between items-center flex-wrap gap-2 mb-4">
                <div>
                    <button data-filter="all" class="filter-btn text-xs font-bold bg-yellow-300 px-2 py-1 rounded-full hover:bg-yellow-400">Todos</button>
                    <button data-filter="duplicate" class="filter-btn text-xs font-bold bg-red-300 px-2 py-1 rounded-full hover:bg-red-400">Duplicados</button>
                    <button data-filter="expired" class="filter-btn text-xs font-bold bg-gray-300 px-2 py-1 rounded-full hover:bg-gray-400">Caducados</button>
                    <button data-filter="foreign" class="filter-btn text-xs font-bold bg-blue-300 px-2 py-1 rounded-full hover:bg-blue-400">Extranjeros</button>
                    <button data-filter="no_date" class="filter-btn text-xs font-bold bg-purple-300 px-2 py-1 rounded-full hover:bg-purple-400">Sin Fecha</button>
                </div>
                <button id="manage-foreign-accounts-btn" class="text-xs font-bold bg-indigo-300 px-2 py-1 rounded-full hover:bg-indigo-400">Gestionar Cuentas</button>
            </div>
            <div id="discarded-modal-body" class="space-y-4 max-h-[60vh]"></div>
            <button id="delete-all-discarded-btn" class="mt-4 bg-red-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-red-400 transition-colors">Eliminar todos los descartados</button>
        </div>
    </div>

    <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div id="modal-content" class="w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg flex-col">
             <div class="flex-shrink-0 p-4 sm:p-6 pb-0">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modal-title" class="text-2xl sm:text-3xl">Sorteos del D√≠a</h2>
                    <div class="flex items-center gap-2">
                        <button id="help-daily-modal" class="help-btn" data-modal-id="modal">?</button>
                        <button id="close-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
                    </div>
                </div>
                <div id="modal-filters" class="flex flex-col sm:flex-row gap-2 mb-2">
                    <input type="text" id="modal-search-input" placeholder="Buscar por premio..." class="w-full p-2 rounded-lg bg-white border border-yellow-400 text-sm flex-grow">
                    <div id="custom-category-filter" class="relative w-full sm:w-auto">
                        <button id="category-filter-button" type="button" class="w-full p-2 rounded-lg bg-white border border-yellow-400 text-sm text-left flex justify-between items-center">
                            <span id="category-filter-selected-text"></span>
                            <i class="fa-solid fa-chevron-down text-xs text-gray-500"></i>
                        </button>
                        <ul id="category-filter-options" class="hidden absolute z-[55] mt-1 w-[90vw] max-w-[520px] bg-white border border-yellow-400 rounded-lg shadow-lg max-h-60 overflow-y-auto p-1 grid grid-cols-2 gap-1">
                        </ul>
                    </div>
                </div>
                </div>
            <div class="p-4 sm:p-6 pt-0 flex flex-col flex-grow overflow-hidden">
                <div class="modal-tabs flex-shrink-0">
                    <button class="modal-tab-btn active" data-tab="sorteos">Sorteos</button>
                    <button class="modal-tab-btn" data-tab="no-interesa">No me Interesa</button>
                </div>

                <div class="mt-4 flex-grow overflow-y-auto">
                    <div id="tab-content-sorteos" class="modal-tab-content active">
                        <div class="flex justify-between items-center mb-2 text-yellow-900">
                            <button id="select-all-btn" class="text-sm font-bold bg-yellow-300 px-3 py-1 rounded-full hover:bg-yellow-400">Seleccionar todo</button>
                            <button id="deselect-all-btn" class="text-sm font-bold bg-yellow-300 px-3 py-1 rounded-full hover:bg-yellow-400">Deseleccionar todo</button>
                        </div>
                        <div id="insta-hint" class="p-2 my-3 rounded-lg bg-blue-100/50 border border-blue-400 text-center text-sm text-blue-900 font-bold">
                            üëâ <strong>¬°Atajo a la vista!</strong> Toca en las <code>@cuentas</code> y salta a su Instagram sin teclear.
                        </div>
                        <div id="modal-body" class="space-y-4 max-h-[50vh]"></div>
                    </div>

                    <div id="tab-content-no-interesa" class="modal-tab-content">
                        <div id="not-interested-body" class="space-y-4 max-h-[60vh]">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="add-giveaway-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="add-giveaway-modal-title" class="text-2xl sm:text-3xl">A√±adir Nuevo Sorteo</h2>
                 <div class="flex items-center gap-2">
                    <button id="help-add-manual-modal" class="help-btn" data-modal-id="add-giveaway-modal">?</button>
                    <button id="close-add-giveaway-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
                </div>
            </div>
            <div id="add-giveaway-form-body">
                <form id="add-giveaway-form" class="space-y-4">
                    <div>
                        <label for="giveaway-date" class="block font-bold">Fecha del Sorteo:</label>
                        <input type="date" id="giveaway-date" required class="w-full p-2 mt-1 rounded-lg bg-white border border-yellow-400">
                    </div>
                    <div>
                        <label for="giveaway-prize" class="block font-bold">Premio:</label>
                        <input type="text" id="giveaway-prize" placeholder="Ej: Vuelos a capital europea üõ©Ô∏è" required class="w-full p-2 mt-1 rounded-lg bg-white border border-yellow-400">
                    </div>
                    <div>
                        <label for="giveaway-accounts" class="block font-bold">Cuentas:</label>
                        <input type="text" id="giveaway-accounts" placeholder="Ej: @iberia, @travel_spain" class="w-full p-2 mt-1 rounded-lg bg-white border border-yellow-400">
                        <small class="text-gray-500 text-xs">Separar por comas (sin espacios).</small>
                    </div>
                    <div>
                        <label for="giveaway-price" class="block font-bold">Valor (aprox):</label>
                        <input type="text" id="giveaway-price" placeholder="Ej: 50‚Ç¨, 1300‚Ç¨ üí≤" class="w-full p-2 mt-1 rounded-lg bg-white border border-yellow-400">
                    </div>
                    <div>
                        <label for="giveaway-category" class="block font-bold">Categor√≠a:</label>
                        <select id="giveaway-category" required class="w-full p-2 mt-1 rounded-lg bg-white border border-yellow-400">
                            </select>
                    </div>
                    <button type="submit" class="w-full bg-yellow-500 text-yellow-900 py-2 px-4 rounded-lg font-bold hover:bg-yellow-400 transition-colors shadow-lg">Guardar Sorteo</button>
                </form>
            </div>
        </div>
    </div>

    <div id="search-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">B√∫squeda y Filtros</h2>
                <button id="close-search-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div class="p-4 sm:p-6 pt-0">
                <div class="mb-8">
                    <input type="text" id="search-input-modal" placeholder="Buscar sorteos..." class="w-full p-4 rounded-full bg-web-gradient text-[#f0e6d2] placeholder-[#f0e6d2] border border-yellow-500/20 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <a href="#" onclick="setFilterAndRender('padel'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">P√°del ü•é</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('travel'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">Escapadas ‚úàÔ∏è</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('price'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">+500‚Ç¨ üí≤</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('frikis'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">Frikis üÉè</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('moda'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">Moda üë†</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('belleza'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">Belleza üíÑ</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('hogar'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">Hogar üè†</span>
                    </a>
                     <a href="#" onclick="setFilterAndRender('tecnologia'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">Tecnolog√≠a üíª</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('comida'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">Comida üçî</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('ocio'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">Ocio üéüÔ∏è</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('deporte'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">Deporte üí™</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('infantil'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">Infantil üß∏</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('mascotas'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">Mascotas üêæ</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('dinero'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">Dinero üí∞</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('libros'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">Libros üìö</span>
                    </a>
                    <a href="#" onclick="setFilterAndRender('motor'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10">Motor üöó</span>
                    </a>
                </div>
                <div class="flex justify-center">
                    <a href="#" onclick="setFilterAndRender('all'); closeSearchModal();" class="shooting-star-line relative block text-center text-xl font-bold p-4 rounded-full nav-btn overflow-hidden">
                        <span class="relative z-10 text-[#f7d468]">Todos ‚ú®</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="duplicate-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">Sorteo Duplicado Detectado</h2>
                <button id="close-duplicate-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <p class="mb-4">Este sorteo ya existe en tu calendario. ¬øQuieres a√±adirlo de nuevo?</p>
            <div id="duplicate-giveaway-info" class="flex flex-col gap-4 text-left mb-4">
                </div>
            <div class="flex justify-center space-x-4">
                <button id="confirm-restore-btn" class="bg-green-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-green-400 transition-colors">A√±adir de nuevo</button>
                <button id="cancel-restore-btn" class="bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-400 transition-colors">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="duplicate-comparison-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-3xl rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">Comparar Sorteos Duplicados</h2>
                <button id="close-duplicate-comparison-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1 p-4 bg-yellow-100/50 rounded-lg border border-yellow-600/20 text-left">
                    <h3 class="text-xl font-bold mb-2">Sorteo Original</h3>
                    <div id="original-giveaway-details"></div>
                </div>
                <div class="flex-1 p-4 bg-red-100/50 rounded-lg border border-red-600/20 text-left">
                    <h3 class="text-xl font-bold mb-2">Sorteo Descartado</h3>
                    <div id="discarded-giveaway-details"></div>
                </div>
            </div>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="merge-giveaway-btn" class="bg-green-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-green-400 transition-colors">Fusionar</button>
                <button id="add-as-new-btn" class="bg-blue-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-400 transition-colors">A√±adir como nuevo</button>
                <button id="delete-discarded-comp-btn" class="bg-red-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-red-400 transition-colors">Eliminar</button>
            </div>
        </div>
    </div>

    <div id="move-giveaway-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">Mover Sorteo</h2>
                <button id="close-move-giveaway-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <form id="move-giveaway-form" class="space-y-4">
                <div>
                    <label for="new-giveaway-date" class="block font-bold">Selecciona la nueva fecha:</label>
                    <input type="date" id="new-giveaway-date" required class="w-full p-2 mt-1 rounded-lg bg-white border border-yellow-400">
                </div>
                <button type="submit" class="w-full bg-yellow-500 text-yellow-900 py-2 px-4 rounded-lg font-bold hover:bg-yellow-400 transition-colors shadow-lg">Mover</button>
            </form>
        </div>
    </div>

    <div id="history-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-3xl rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">üïí Historial de An√°lisis</h2>
                <div class="flex items-center gap-2">
                    <button id="help-history-modal" class="help-btn" data-modal-id="history-modal">?</button>
                    <button id="close-history-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
                </div>
            </div>
            <div id="history-modal-body" class="max-h-[60vh] text-left"></div>
        </div>
    </div>

    <div id="foreign-accounts-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">Gestionar Cuentas Extranjeras</h2>
                <button id="close-foreign-accounts-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <p class="mb-4 text-sm">Aqu√≠ puedes ver y eliminar las cuentas que has marcado como extranjeras.</p>
            <div id="foreign-accounts-modal-body" class="space-y-2 max-h-[60vh]"></div>
        </div>
    </div>

    <div id="trophy-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-3xl rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">üèÜ Vitrina de Trofeos üèÜ</h2>
                <div class="flex items-center gap-2">
                    <button id="help-trophy-modal" class="help-btn" data-modal-id="trophy-modal">?</button>
                    <button id="close-trophy-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
                </div>
            </div>
            <div id="trophy-modal-body" class="max-h-[60vh]"></div>
        </div>
    </div>

    <div id="stats-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-4xl rounded-2xl shadow-2xl modal-default-bg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">üìä Estad√≠sticas y Estrategia</h2>
                <div class="flex items-center gap-2">
                    <button id="help-stats-modal" class="help-btn" data-modal-id="stats-modal">?</button>
                    <button id="close-stats-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
                </div>
            </div>

            <div class="stats-tabs flex flex-wrap border-b border-yellow-600/20 mb-4">
                <button data-tab="resumen" class="active">Resumen</button>
                <button data-tab="rendimiento">Rendimiento</button>
                <button data-tab="estrategia">Estrategia</button>
                <button data-tab="redes">Redes</button>
                <button data-tab="graficos">Gr√°ficos</button>
            </div>

            <div id="stats-modal-body" class="text-left max-h-[65vh] overflow-y-auto pr-2">
                <div id="tab-resumen" class="stats-tab-content active">
                    </div>

                <div id="tab-rendimiento" class="stats-tab-content">
                    </div>

                <div id="tab-estrategia" class="stats-tab-content">
                    </div>

                <div id="tab-redes" class="stats-tab-content">
                    </div>

                <div id="tab-graficos" class="stats-tab-content">
                    <div id="charts-modal-body" class="flex flex-col gap-8">
                        <div class="chart-container h-64 md:h-80">
                            <h3 class="text-lg font-bold mb-2 text-center text-yellow-700">Victorias por Categor√≠a</h3>
                            <canvas id="category-pie-chart"></canvas>
                        </div>
                        <div class="chart-container h-64 md:h-80">
                            <h3 class="text-lg font-bold mb-2 text-center text-yellow-700">Valor de Premios Ganados por Mes</h3>
                            <canvas id="monthly-value-bar-chart"></canvas>
                        </div>
                        <div class="chart-container h-64 md:h-80">
                            <h3 class="text-lg font-bold mb-2 text-center text-yellow-700">üìà Crecimiento de Victorias Acumuladas</h3>
                            <canvas id="wins-growth-line-chart"></canvas>
                        </div>
                        <div class="chart-container h-64 md:h-80">
                            <h3 class="text-lg font-bold mb-2 text-center text-yellow-700">üéØ Dispersi√≥n: Antelaci√≥n vs Valor del Premio</h3>
                            <canvas id="value-vs-anticipation-scatter-chart"></canvas>
                        </div>
                         <div class="chart-container h-64 md:h-80">
                            <h3 class="text-lg font-bold mb-2 text-center text-yellow-700">üï∏Ô∏è Radar: Tu Estilo de Cazador</h3>
                            <canvas id="hunter-style-radar-chart"></canvas>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold mb-2 text-center text-yellow-700">üóìÔ∏è Mapa de Calor: Tu Calendario de la Suerte</h3>
                            <div id="luck-heatmap-container" class="heatmap-container"></div>
                        </div>
                    </div>
                </div>
            </div>
             <hr class="border-yellow-600/20 my-4">
             <div class="flex justify-center items-center flex-wrap gap-2 sm:gap-4">
                 <button id="share-stats-btn" class="bg-blue-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-400 transition-colors">Compartir üì≤</button>
                 <button id="oracle-proximity-btn" class="bg-indigo-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-indigo-400 transition-colors">üîÆ Or√°culo de Proximidad</button>
                 <button id="oracle-prize-btn" class="bg-teal-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-teal-400 transition-colors">‚ú® Or√°culo del Premio</button>
            </div>
        </div>
    </div>

    <div id="block-management-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">üö´ Gesti√≥n de Bloqueos</h2>
                <button id="close-block-management-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <p class="text-sm mb-4">Registra aqu√≠ cuando recibes un bloqueo para llevar un seguimiento.</p>
            <div class="flex justify-center items-center flex-wrap gap-2 sm:gap-4 mb-4">
                <button id="block-like-btn" class="nav-btn p-3 sm:p-4 shadow-lg transition-transform duration-300 transform hover:scale-110 flex items-center gap-2">
                    <span class="text-xl sm:text-2xl">üëç</span>
                    <span>Registrar Bloqueo de 'Like'</span>
                </button>
                <button id="block-comment-btn" class="nav-btn p-3 sm:p-4 shadow-lg transition-transform duration-300 transform hover:scale-110 flex items-center gap-2">
                    <span class="text-xl sm:text-2xl">üí¨</span>
                    <span>Registrar Bloqueo de Comentario</span>
                </button>
            </div>
            <div id="block-stats-container" class="text-left mt-6"></div>
        </div>
    </div>

    <div id="achievements-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-3xl rounded-2xl shadow-2xl modal-default-bg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">üèÖ Logros y Metas</h2>
                <div class="flex items-center gap-2">
                    <button id="help-achievements-modal" class="help-btn" data-modal-id="achievements-modal">?</button>
                    <button id="close-achievements-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
                </div>
            </div>
            <div id="achievements-modal-body" class="max-h-[60vh] text-left">
            </div>
        </div>
    </div>

    <div id="zoom-modal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[200]">
        <div id="zoom-modal-content" class="modal-content">
            <img id="zoomed-image" src="" alt="Vista ampliada">
        </div>
    </div>

    <div id="ps-summary-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">‚ú® Historial de Puntos (PS)</h2>
                <button id="close-ps-summary-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div id="ps-summary-modal-body" class="space-y-2 max-h-[60vh] text-left"></div>
        </div>
    </div>

    <div id="recent-adds-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">üóìÔ∏è Historial de Capturas</h2>
                <button id="close-recent-adds-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div id="recent-adds-modal-body" class="space-y-4 max-h-[60vh]"></div>
        </div>
    </div>

    <div id="vis-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">Very Important Sorteos üí´</h2>
                <div class="flex items-center gap-2">
                    <button id="help-vis-modal" class="help-btn" data-modal-id="vis-modal">?</button>
                    <button id="close-vis-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
                </div>
            </div>
            <div id="vis-modal-body" class="space-y-4 max-h-[60vh]">
                </div>
        </div>
    </div>
    
    <div id="new-additions-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">‚ú® Historial de Capturas</h2>
                <button id="close-new-additions-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>
            <div id="new-additions-modal-body" class="space-y-4 max-h-[60vh] text-left">
                <p class="text-sm text-yellow-800 bg-yellow-100/50 p-3 rounded-lg border border-yellow-300">
                    Aqu√≠ se guardan los lotes de sorteos que has a√±adido con la IA. <strong>Pulsa sobre un lote para filtrar el calendario</strong> y ver √∫nicamente los sorteos de esa captura.
                </p>
                <div id="batch-history-list" class="space-y-2 mt-4">
                    </div>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-sm rounded-2xl shadow-2xl modal-default-bg p-6 text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl">üîë Panel de Admin</h2>
                <button id="close-admin-modal" class="text-yellow-600 hover:text-yellow-800 text-4xl">&times;</button>
            </div>

            <div id="admin-login-view">
                <form id="admin-login-form" class="space-y-4">
                    <div>
                        <label for="admin-username" class="block font-bold text-left">Usuario:</label>
                        <input type="text" id="admin-username" required class="w-full p-2 mt-1 rounded-lg bg-white border border-yellow-400">
                    </div>
                    <div>
                        <label for="admin-password" class="block font-bold text-left">Contrase√±a:</label>
                        <input type="password" id="admin-password" required class="w-full p-2 mt-1 rounded-lg bg-white border border-yellow-400">
                    </div>
                    <button type="submit" class="w-full bg-yellow-500 text-yellow-900 py-2 px-4 rounded-lg font-bold hover:bg-yellow-400 transition-colors shadow-lg">Entrar</button>
                </form>
            </div>

            <div id="admin-actions-view" class="hidden space-y-4">
                 <p class="text-sm text-yellow-800 bg-yellow-100/50 p-3 rounded-lg border border-yellow-300">
                    Acceso concedido. Aqu√≠ tienes tus herramientas de Hechicero Mayor.
                </p>
                <button id="admin-upload-btn" class="w-full px-3 py-2 nav-btn flex items-center justify-center gap-2">
                    <span class="text-xl">üì§</span>
                    <span>Cargar Copia</span>
                </button>
                <button id="admin-download-btn" class="w-full px-3 py-2 nav-btn flex items-center justify-center gap-2">
                    <span class="text-xl">üíæ</span>
                    <span>Descargar Copia</span>
                </button>
            </div>
        </div>
    </div>

    <section id="ai-fullscreen-view" class="ai-fullscreen-view">
        <div class="flex justify-between items-center w-full absolute top-2 right-4 z-10">
            <div></div> <div class="flex items-center gap-2">
                <button id="help-ai-modal" class="help-btn" data-modal-id="ai-fullscreen-view">?</button>
                <button id="close-ai-view" class="text-yellow-400 hover:text-yellow-600 text-5xl font-bold">&times;</button>
            </div>
        </div>

        <div id="ai-initial-view" class="w-full max-w-lg mx-auto flex flex-col items-center justify-center h-full">
            <p class="text-2xl font-semibold mb-6 text-center text-yellow-300">Selecciona hasta 100 im√°genes del sorteo.</p>
            <input type="file" id="ai-image-upload" accept="image/*" multiple class="hidden">
            <button id="select-ai-images-btn" class="mt-6 bg-yellow-500 text-yellow-900 font-bold py-3 px-6 rounded-lg shadow-md hover:bg-yellow-400 transition-colors w-full">
                üåü Seleccionar Im√°genes üåü
            </button>
            <div id="ai-queue-container" class="mt-6 text-left w-full" style="display: none;">
                <h3 class="text-lg font-semibold mb-2 text-yellow-300">Im√°genes en cola: <span id="ai-queue-count">0</span></h3>
                <ul id="ai-image-queue" class="bg-black/20 p-4 rounded-lg border border-yellow-500/30 max-h-40 overflow-y-auto"></ul>
            </div>
            <button id="start-ai-button" class="mt-6 bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-400 transition-colors w-full" style="display: none;">
                Empezar An√°lisis
            </button>
        </div>

        <div id="interactive-analysis-container" class="w-full h-full flex-col" style="display: none;">
             <div id="analysis-legend-container"></div>
             <div id="analysis-image-preview-container" class="my-2">
                 <img id="analysis-image-preview" src="" alt="Imagen en an√°lisis">
             </div>
             <div id="live-results-container">
                 <div id="live-card-placeholder" class="live-card-placeholder">Esperando an√°lisis...</div>
             </div>
        </div>

        <div id="ai-summary-view" class="w-full max-w-2xl mx-auto flex flex-col items-center justify-center h-full" style="display: none;">
             <div id="ai-summary-results-container" class="w-full text-left p-4 rounded-xl bg-black/20 overflow-y-auto">
             </div>
            <button id="retry-failed-btn" class="mt-4 bg-purple-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-purple-400 transition-colors w-full" style="display: none;">
                Reintentar An√°lisis de Errores
            </button>
            <button id="ai-summary-close-btn" class="mt-6 bg-yellow-500 text-yellow-900 font-bold py-3 px-6 rounded-lg shadow-md hover:bg-yellow-400 transition-colors w-full">
                Finalizar
            </button>
        </div>
    </section>

    <div id="refreshOverlay" class="fixed inset-0 bg-black bg-opacity-70 flex-col items-center justify-center p-4 z-[999] hidden">
        <div class="relative w-full h-full pointer-events-none">
            <img id="shootingStarRefresh" src="/assets/img/Fugaz.png" alt="Estrella Fugaz" class="absolute w-48 h-auto opacity-0" style="left: -200px; top: 20%;">
        </div>
        <div class="absolute text-center bg-black bg-opacity-60 p-6 rounded-lg shadow-2xl max-w-lg mx-auto">
            <h2 class="text-white text-3xl font-bold mb-4 animate-pulse">¬°Atenci√≥n, Cazador/a de Sorteos! üí´</h2>
            <p class="text-white text-lg mb-6 leading-relaxed">
                El cosmos de los premios nos ha enviado una se√±al... ¬°Hay nuevos sorteos reci√©n llegados!
                <br>
                <strong>Pulsa la estrella fugaz para que aparezcan en tu calendario.</strong>
            </p>
        </div>
    </div>


    <script src="giveaways_new.js"></script>
    <script src="discardedGiveaways_new.js"></script>
    <script src="foreignAccounts.js"></script>
    <script src="capture_batches.js"></script>
    <script id="animations-script">
        function animateStarryBackground() {
            const starsContainer = document.getElementById('magic-stars-container');
            if (!starsContainer) return;
            starsContainer.innerHTML = ''; // Limpiar estrellas viejas si se llama de nuevo
            for (let i = 0; i < 100; i++) {
                let star = document.createElement('div');
                star.classList.add('star');
                let size = Math.random() * 3;
                star.style.width = `${size}px`; star.style.height = `${size}px`;
                star.style.top = `${Math.random() * 100}%`; star.style.left = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 4}s`;
                if(Math.random() > 0.8) {
                    star.classList.add('moving-star');
                    star.style.animationDuration = `${Math.random() * 50 + 50}s`;
                }
                starsContainer.appendChild(star);
            }
        }

        function animateTitle() {
            const titleEl = document.getElementById('main-title');
            if (!titleEl || titleEl.textContent.length > 0) return; // No re-animar si ya tiene texto
            const titleText = "Misorteos";
            titleEl.innerHTML = titleText.split('').map(char => `<span class="letter" style="position: relative;">${char === ' ' ? '&nbsp;' : char}</span>`).join('');
            const letters = Array.from(titleEl.children);
            const revealDuration = letters.length * 150;

            letters.forEach((letter, index) => {
                setTimeout(() => {
                    letter.style.opacity = '1'; letter.style.transform = 'translateY(0)';
                    for(let i = 0; i < 3; i++) {
                        const sparkle = document.createElement('span');
                        sparkle.classList.add('sparkle');
                        sparkle.style.top = `${Math.random()*80-40}%`; sparkle.style.left = `${Math.random()*80-40}%`;
                        sparkle.style.animation = `letter-reveal-sparkle 0.5s ${i * 0.1}s ease-out forwards`;
                        letter.appendChild(sparkle);
                        setTimeout(() => sparkle.remove(), 1000);
                    }
                }, index * 150);
            });

            setTimeout(() => {
                setInterval(() => {
                    if (document.hidden) return; // No animar si la pesta√±a no est√° visible
                    const randomLetter = letters[Math.floor(Math.random() * letters.length)];
                    if (randomLetter.innerText.trim() === '') return;
                    const sparkle = document.createElement('span');
                    sparkle.classList.add('fountain-sparkle');
                    sparkle.style.left = `${Math.random() * 80 + 10}%`;
                    randomLetter.appendChild(sparkle);
                    setTimeout(() => sparkle.remove(), 1500);
                }, 200);
            }, revealDuration);
        }

        function animateShootingStar(itemContainer, callback) {
            const star = document.createElement('div');
            star.className = 'shooting-star';
            itemContainer.appendChild(star);

            star.addEventListener('animationend', () => {
                star.remove();
                if (callback) callback();
            }, { once: true });
        }
    </script>
    <script>
        // --- COMIENZO DEL SCRIPT PRINCIPAL DE LA APLICACI√ìN ---

    // Carga de datos desde localStorage o valores por defecto
    let giveaways;
    const savedGiveaways = localStorage.getItem('giveaways');
    if (savedGiveaways) {
        giveaways = JSON.parse(savedGiveaways);
    } else {
        giveaways = window.giveaways || {};
    }

    let completedGiveaways = JSON.parse(localStorage.getItem(`completedGiveaways`)) || {};
    let notInterestedGiveaways = JSON.parse(localStorage.getItem('notInterestedGiveaways')) || {};
    let wonGiveaways = JSON.parse(localStorage.getItem('wonGiveaways')) || [];
    let analysisHistory = JSON.parse(localStorage.getItem('analysisHistory')) || [];
    let userPoints = JSON.parse(localStorage.getItem('userPoints')) || { total: 0, log: [] };

    const CATEGORY_INFO = {
        'all': { name: 'Todas', emoji: '‚ú®', desc: 'Muestra todos los sorteos.' },
        'padel': { name: 'P√°del', emoji: 'ü•é', desc: 'Palas, ropa y accesorios de p√°del.' },
        'motor': { name: 'Motor', emoji: 'üèéÔ∏è', desc: 'Coches, motos, F1, MotoGP.' },
        'mascotas': { name: 'Mascotas', emoji: 'üêæ', desc: 'Productos para animales.' },
        'bebes': { name: 'Beb√©s', emoji: 'üë∂', desc: 'Sillas, pa√±ales, productos infantiles.' },
        'bodas': { name: 'Bodas', emoji: 'üíç', desc: 'Relacionado con bodas y novios.' },
        'dinero': { name: 'Dinero y Vales', emoji: 'üí∞', desc: 'Tarjetas regalo, cupones, efectivo.' },
        'viajes': { name: 'Viajes', emoji: '‚úàÔ∏è', desc: 'Estancias, vuelos, hoteles, escapadas.' },
        'ocio': { name: 'Ocio', emoji: 'üéüÔ∏è', desc: 'Entradas, cine, teatro, parques, cenas.' },
        'aventura': { name: 'Aventura', emoji: 'üßó', desc: 'Experiencias de adrenalina.' },
        'suscripciones': { name: 'Suscripciones', emoji: 'üíª', desc: 'Servicios digitales, Netflix, cursos online.' },
        'gaming': { name: 'Gaming', emoji: 'üéÆ', desc: 'Consolas, videojuegos, accesorios.' },
        'foto': { name: 'Fotograf√≠a', emoji: 'üì∏', desc: 'C√°maras, drones, objetivos.' },
        'musica': { name: 'M√∫sica', emoji: 'üéµ', desc: 'Auriculares, altavoces, instrumentos.' },
        'deporte': { name: 'Deporte', emoji: 'üí™', desc: 'Equipamiento y ropa deportiva general.' },
        'libros': { name: 'Libros', emoji: 'üìö', desc: 'Libros, c√≥mics y material de lectura.' },
        'frikis': { name: 'Frikis', emoji: 'üÉè', desc: 'Funkos, juegos de mesa, merchandising.' },
        'joyeria': { name: 'Joyer√≠a', emoji: 'üíé', desc: 'Relojes, pulseras, collares, gafas de sol.' },
        'accesorios': { name: 'Accesorios', emoji: 'üëú', desc: 'Bolsos, mochilas, maletas, neceseres.' },
        'moda': { name: 'Moda', emoji: 'üë†', desc: 'Ropa y calzado de uso casual.' },
        'belleza': { name: 'Belleza', emoji: 'üíÑ', desc: 'Cosm√©tica, maquillaje, perfumes.' },
        'salud': { name: 'Salud', emoji: 'üåø', desc: 'Farmacia, cuidado personal, bienestar.' },
        'electrodomesticos': { name: 'Electrodom√©sticos', emoji: 'üì∫', desc: 'TV, robots, lavadoras, etc.' },
        'cocina': { name: 'Cocina', emoji: 'üç≥', desc: 'Peque√±os electrodom√©sticos y menaje.' },
        'bricolaje': { name: 'Bricolaje', emoji: 'üõ†Ô∏è', desc: 'Herramientas y material de bricolaje.' },
        'jardineria': { name: 'Jardiner√≠a', emoji: 'üå±', desc: 'Plantas, macetas y herramientas.' },
        'papeleria': { name: 'Papeler√≠a', emoji: '‚úèÔ∏è', desc: 'Agendas, cuadernos, material de oficina.' },
        'arte': { name: 'Arte', emoji: 'üé®', desc: 'Materiales para pintura, manualidades.' },
        'eco': { name: 'Sostenible', emoji: '‚ôªÔ∏è', desc: 'Productos ecol√≥gicos o sostenibles.' },
        'gourmet': { name: 'Gourmet', emoji: 'üç∑', desc: 'Jam√≥n, vinos, aceites premium.' },
        'comida': { name: 'Comida', emoji: 'üçî', desc: 'Alimentaci√≥n general no gourmet.' },
        'hogar': { name: 'Hogar', emoji: 'üè†', desc: 'Decoraci√≥n y textiles para el hogar.' },
        'otros': { name: 'Otros', emoji: '‚≠ê', desc: 'Sorteos que no encajan en otra categor√≠a.' }
    };
    const achievementList = {
        bronze: [
            { id: 'b_add_1', name: 'El Primer Paso', icon: 'üå±', desc: 'A√±ade tu primer sorteo manualmente.', ps: 5, condition: (c) => c.totalManualAdds >= 1 },
            { id: 'b_add_ia_1', name: 'Mirando al Futuro', icon: 'ü§ñ', desc: 'A√±ade tu primer sorteo usando la IA.', ps: 5, condition: (c) => c.totalGiveawaysAddedAI >= 1 },
            { id: 'b_complete_1', name: '¬°Manos a la Obra!', icon: '‚úÖ', desc: 'Marca tu primer sorteo como completado.', ps: 5, condition: (c) => c.totalGiveawaysCompleted >= 1 },
            { id: 'b_move_1', name: 'El Organizador', icon: 'üóìÔ∏è', desc: 'Mueve un sorteo de d√≠a por primera vez.', ps: 5, condition: (c) => c.firstMove },
            { id: 'b_restore_1', name: 'Segunda Oportunidad', icon: '‚ôªÔ∏è', desc: 'Restaura un sorteo desde la papelera.', ps: 10, condition: (c) => c.restoredFromTrash >= 1 },
            { id: 'b_search_1', name: 'El Detective', icon: 'üïµÔ∏è', desc: 'Usa la b√∫squeda o un filtro por primera vez.', ps: 5, condition: (c) => c.searchesMade >= 1 },
            { id: 'b_win_1', name: '¬°Estoy en racha!', icon: 'üéâ', desc: 'Gana tu primer sorteo (de cualquier valor).', ps: 20, condition: (c) => c.totalGiveawaysWon >= 1 },
        ],
        silver: [
            { id: 's_add_100', name: 'Coleccionista Amateur', icon: 'üì¶', desc: 'Registra un total de 100 sorteos.', ps: 10, condition: (c) => c.totalGiveawaysAdded >= 100 },
            { id: 's_add_ia_50', name: 'Asistente de la IA', icon: 'üß†', desc: 'A√±ade 50 sorteos usando la IA.', ps: 15, condition: (c) => c.totalGiveawaysAddedAI >= 50 },
            { id: 's_complete_250', name: 'El Finalizador', icon: '‚úîÔ∏è', desc: 'Completa un total de 250 sorteos.', ps: 10, condition: (c) => c.totalGiveawaysCompleted >= 250 },
            { id: 's_firewall_1', name: 'El Inmun√≥logo', icon: 'üõ°Ô∏è', desc: 'A√±ade tu primera cuenta al cortafuegos de extranjeras.', ps: 15, condition: (c) => c.foreignAccountsBlocked >= 1 },
            { id: 's_win_value_100', name: 'Cazador de Tesoros', icon: 'üíé', desc: 'Gana un premio valorado en m√°s de 100‚Ç¨.', ps: 25, condition: (c) => c.winsOver100 >= 1 },
            { id: 's_win_5', name: 'Lluvia de Victorias', icon: 'üå¶Ô∏è', desc: 'Gana 5 sorteos en total.', ps: 25, condition: (c) => c.totalGiveawaysWon >= 5 },
            { id: 's_specialist_3', name: 'El Especialista', icon: '‚≠ê', desc: 'Gana 3 sorteos de la misma categor√≠a.', ps: 30, condition: (c) => Object.values(c.categoryWins).some(val => val >= 3) },
        ],
        gold: [
            { id: 'g_add_500', name: 'Archivista Profesional', icon: 'üóÑÔ∏è', desc: 'Registra un total de 500 sorteos.', ps: 20, condition: (c) => c.totalGiveawaysAdded >= 500 },
            { id: 'g_ia_process_500', name: 'Conexi√≥n Neuronal', icon: 'üì°', desc: 'Procesa un total de 500 im√°genes com a IA.', ps: 25, condition: (c) => c.totalImagesProcessedAI >= 500 },
            { id: 'g_win_25', name: 'El Conquistador', icon: 'üè∞', desc: 'Gana 25 sorteos en total.', ps: 50, condition: (c) => c.totalGiveawaysWon >= 25 },
            { id: 'g_win_double', name: 'Doble Suerte', icon: '‚úåÔ∏è', desc: 'Gana dos sorteos en el mismo d√≠a.', ps: 75, condition: (c) => Object.values(c.sameDayWins).some(val => val >= 2) },
            { id: 'g_value_2500', name: 'Acaparador', icon: 'üí∞', desc: 'Supera los 2.500‚Ç¨ en valor total de premios.', ps: 50, condition: (c) => c.totalValueWon >= 2500 },
            { id: 'g_merge_1', name: 'El Fusionador', icon: 'üß¨', desc: 'Fusiona un sorteo duplicado con su original.', ps: 20, condition: (c) => c.mergedDuplicates >= 1 },
        ],
        platinum: [
            { id: 'p_add_2000', name: 'Biblioteca de Sorteos', icon: 'üèõÔ∏è', desc: 'Registra 2.000 sorteos.', ps: 50, condition: (c) => c.totalGiveawaysAdded >= 2000 },
            { id: 'p_complete_1500', name: 'M√°quina de Completar', icon: 'üíØ', desc: 'Completa 1.500 sorteos.', ps: 40, condition: (c) => c.totalGiveawaysCompleted >= 1500 },
            { id: 'p_win_value_2000', name: 'El Toque de Midas', icon: '‚ú®', desc: 'Gana un premio valorado en m√°s de 2.000‚Ç¨.', ps: 100, condition: (c) => c.winsOver2000 >= 1 },
            { id: 'p_win_50', name: 'Im√°n de Premios', icon: 'üß≤', desc: 'Gana 50 sorteos en total.', ps: 100, condition: (c) => c.totalGiveawaysWon >= 50 },
            { id: 'p_talisman', name: 'Talism√°n Dorado', icon: 'üçÄ', desc: 'Gana 3 premios de la misma cuenta de Instagram.', ps: 75, condition: (c) => Object.values(c.winsFromSameAccount).some(val => val >= 3) },
        ],
        diamond: [
            { id: 'd_win_100', name: 'Coleccionista Legendario', icon: 'üëë', desc: 'Gana 100 sorteos en total.', ps: 200, condition: (c) => c.totalGiveawaysWon >= 100 },
            { id: 'd_value_25000', name: 'Toque de Midas', icon: 'üëë', desc: 'Acumula 25.000‚Ç¨ en premios ganados.', ps: 250, condition: (c) => c.totalValueWon >= 25000 },
            { id: 'd_nostradamus', name: 'El Nostradamus', icon: 'üìú', desc: 'Gana un sorteo que a√±adiste m√°s de 6 meses antes.', ps: 150, condition: (c) => c.nostradamusWins >= 1 },
            { id: 'd_win_triple', name: 'Tr√©bol de Doce Hojas', icon: 'üçÄ', desc: 'Gana 3 sorteos en un mismo d√≠a.', ps: 200, condition: (c) => Object.values(c.sameDayWins).some(val => val >= 3) },
        ],
        merits: [ 
            { id: 'm_photo', name: 'Victoria Fotogr√°fica', icon: 'üì∏', desc: 'Gana un sorteo cuyo premio sea una c√°mara.', ps: 20, condition: (c, u, p) => p && /c√°mara|instax/i.test(p.prize) },
            { id: 'm_sweet', name: 'El Dulce Sabor de la Victoria', icon: 'üç¨', desc: 'Gana un sorteo de comida o dulces.', ps: 20, condition: (c, u, p) => p && /comida|dulces|jam√≥n|chocolate|tarta|lote de productos/i.test(p.prize) },
            { id: 'm_tech', name: 'Victoria Tecnol√≥gica', icon: 'üíª', desc: 'Gana un premio de tecnolog√≠a (m√≥vil, tablet, consola, etc).', ps: 25, condition: (c, u, p) => p && /m√≥vil|consola|auriculares|tablet|port√°til|pc|ps5|nintendo|xbox/i.test(p.prize) },
            { id: 'm_fashion', name: 'Icono de la Moda', icon: 'üë†', desc: 'Gana un premio de moda (ropa, zapatillas, bolso).', ps: 20, condition: (c, u, p) => p && /ropa|zapatillas|bolso|camiseta|sudadera|gafas de sol/i.test(p.prize) },
            { id: 'm_beauty', name: 'Gur√∫ de Belleza', icon: 'üíÑ', desc: 'Gana un lote de productos de cosm√©tica o maquillaje.', ps: 20, condition: (c, u, p) => p && /belleza|maquillaje|cosm√©tica|perfume|lote de productos/i.test(p.prize) },
            { id: 'm_experience', name: 'Coleccionista de Experiencias', icon: 'üé´', desc: 'Gana entradas, una cena o una experiencia.', ps: 30, condition: (c, u, p) => p && /entradas|cena|experiencia|abono|festival/i.test(p.prize) },
            { id: 'm_fast', name: 'A Contrarreloj', icon: '‚è±Ô∏è', desc: 'A√±ade y completa un sorteo el mismo d√≠a que finaliza.', ps: 15, condition: (c) => c.lastMinuteCompletes >= 1 },
            { id: 'm_seer', name: 'El Adivino', icon: 'üëÅÔ∏è', desc: 'Gana un sorteo que previamente hab√≠as movido de fecha.', ps: 25, condition: (c) => c.movedGiveawayWins >= 1 },
            { id: 'm_repeat', name: 'El Reincidente', icon: 'üîÅ', desc: 'Gana un sorteo de una cuenta de la que ya ganaste antes.', ps: 30, condition: (c) => Object.values(c.winsFromSameAccount).some(val => val >= 2) },
            { id: 'm_rival', name: 'Rival Eterno', icon: 'ü§∫', desc: 'Participa en m√°s de 50 sorteos de una misma cuenta sin ganar.', ps: 10, condition: (c) => Object.values(c.playsOnSameAccount).some(val => val >= 50) },
        ],
        prestige: [
            { id: 't_padel', title: 'Maestro/a de la Pala', req: 'Gana 15 sorteos de P√°del.', condition: (c) => c.categoryWins.padel >= 15 },
            { id: 't_travel', title: 'N√≥mada Legendario/a', req: 'Gana 15 sorteos de Viajes.', condition: (c) => c.categoryWins.viajes >= 15 },
            { id: 't_friki', title: 'Se√±or/a de los Funkos', req: 'Gana 15 sorteos Frikis.', condition: (c) => c.categoryWins.frikis >= 15 },
            { id: 't_polymath', title: 'El/La Pol√≠mata', req: 'Consigue los 3 t√≠tulos de especialista (P√°del, Viajes, Frikis).', condition: (c, u) => u.includes('t_padel') && u.includes('t_travel') && u.includes('t_friki') },
            { id: 't_oracle', title: 'Or√°culo de la IA', req: 'A√±ade 500 sorteos con la IA.', condition: (c) => c.totalGiveawaysAddedAI >= 500 },
            { id: 't_magnate', title: 'Fortuna Personificada', req: 'Supera los 10.000‚Ç¨ en premios.', condition: (c) => c.totalValueWon >= 10000 },
            { id: 't_consistency', title: 'El Metr√≥nomo', req: 'Gana al menos un sorteo al mes durante 12 meses seguidos.', condition: (c) => c.monthlyWinStreak >= 12 },
            { id: 't_allrounder', title: 'El/La Todoterreno', req: 'Gana al menos 5 premios en cada una de las 4 categor√≠as.', condition: (c) => c.categoryWins.padel >= 5 && c.categoryWins.viajes >= 5 && c.categoryWins.frikis >= 5 && c.categoryWins.otros >= 5 },
            { id: 't_monopolist', title: 'El/La Monopolista', req: 'Gana premios de 50 cuentas organizadoras diferentes.', condition: (c) => Object.keys(c.winsFromSameAccount).length >= 50 },
            { id: 't_perfectionist', title: 'El/La Perfeccionista', req: 'Completa todos los logros de Bronce, Plata y Oro.', condition: (c, u) => [...achievementList.bronze, ...achievementList.silver, ...achievementList.gold].every(ach => u.includes(ach.id)) },
            { id: 't_legend', title: 'Leyenda Viva', req: 'Desbloquea 10 T√≠tulos de Prestigio.', condition: (c, u) => u.filter(id => id.startsWith('t_')).length >= 10 },
        ]
    };

    const initialAchievements = {
        unlocked: [],
        title: 'Buscador/a de Tr√©boles üçÄ',
        counters: {
            totalGiveawaysAdded: 0,
            totalManualAdds: 0,
            totalGiveawaysAddedAI: 0,
            totalGiveawaysCompleted: 0,
            totalGiveawaysWon: 0,
            totalValueWon: 0,
            categoryWins: { padel: 0, viajes: 0, frikis: 0, otros: 0 },
            firstMove: false,
            restoredFromTrash: 0,
            searchesMade: 0,
            winsOver100: 0,
            winsOver2000: 0,
            foreignAccountsBlocked: 0,
            sniperWins: 0,
            sameDayWins: {},
            mergedDuplicates: 0,
            totalImagesProcessedAI: 0,
            winsFromSameAccount: {},
            playsOnSameAccount: {},
            nostradamusWins: 0,
            monthlyWinStreak: 0,
            lastWinMonthYear: null,
            movedGiveawayWins: 0,
            lastMinuteCompletes: 0,
        }
    };
    
    let userAchievements = JSON.parse(localStorage.getItem('userAchievements')) || initialAchievements;
    
    let blockHistory = JSON.parse(localStorage.getItem('blockHistory')) || [];
    let completedGiveawayCount = Object.keys(completedGiveaways).length;
    let currentDate = new Date();
    let currentFilter = 'all';
    let searchQuery = '';
    const MAX_IMAGES = 100;
    let discardedFilter = 'all';
    let activeBatchFilterId = null; // null significa que no hay filtro activo
    
    // Variables para el estado del an√°lisis de IA
    let imageQueue = [];
    let isProcessing = false;
    let currentIndex = 0;
    let totalCaptures = 0;
    let giveawaysWithErrors = [];
    let analysisResults = {
        added: [],
        duplicate: [],
        expired: [],
        foreign: [],
        no_date: [],
        not_a_giveaway: [],
        api_error: []
    };
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    let trashGiveaways = JSON.parse(localStorage.getItem('trashGiveaways')) || [];
    let discardedGiveaways;
    const savedDiscarded = localStorage.getItem('discardedGiveaways');
    if (savedDiscarded) {
         discardedGiveaways = JSON.parse(savedDiscarded);
    } else {
         discardedGiveaways = window.discardedGiveaways || [];
    }

    let foreignAccounts = JSON.parse(localStorage.getItem('foreignAccounts')) || (window.foreignAccounts || []);
    let visGiveaways = JSON.parse(localStorage.getItem('visGiveaways')) || [];
    let captureBatches = JSON.parse(localStorage.getItem('captureBatches')) || [];
    // --- Referencias a elementos del DOM ---
    const monthYearEl = document.getElementById('month-year');
    const calendarDaysEl = document.getElementById('calendar-days');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modal-body');
    const closeModalBtn = document.getElementById('close-modal');
    const addManualBtn = document.getElementById('add-manual-btn');
    const addGiveawayModal = document.getElementById('add-giveaway-modal');
    const closeAddGiveawayModalBtn = document.getElementById('close-add-giveaway-modal');
    const addGiveawayForm = document.getElementById('add-giveaway-form');
    const giveawayDateInput = document.getElementById('giveaway-date');
    const giveawayPrizeInput = document.getElementById('giveaway-prize');
    const giveawayAccountsInput = document.getElementById('giveaway-accounts');
    const giveawayPriceInput = document.getElementById('giveaway-price');
    const totalGiveawaysEl = document.getElementById('total-giveaways-count');
    const searchModal = document.getElementById('search-modal');
    const closeSearchModalBtn = document.getElementById('close-search-modal');
    const searchInputModal = document.getElementById('search-input-modal');
    const selectAllBtn = document.getElementById('select-all-btn');
    const deselectAllBtn = document.getElementById('deselect-all-btn');
    const addAIBtn = document.getElementById('add-ai-btn');
    const aiFullscreenView = document.getElementById('ai-fullscreen-view');
    const closeAiViewBtn = document.getElementById('close-ai-view');
    const aiInitialView = document.getElementById('ai-initial-view');
    const interactiveAnalysisContainer = document.getElementById('interactive-analysis-container');
    const aiSummaryView = document.getElementById('ai-summary-view');
    const analysisLegendContainer = document.getElementById('analysis-legend-container');
    const selectAiImagesBtn = document.getElementById('select-ai-images-btn');
    const aiImageInput = document.getElementById('ai-image-upload');
    const aiQueueContainer = document.getElementById('ai-queue-container');
    const aiQueueList = document.getElementById('ai-image-queue');
    const aiQueueCount = document.getElementById('ai-queue-count');
    const startAiButton = document.getElementById('start-ai-button');
    const aiSummaryResultsContainer = document.getElementById('ai-summary-results-container');
    const aiSummaryCloseBtn = document.getElementById('ai-summary-close-btn');
    const trashBtn = document.getElementById('trash-btn');
    const discardedBtn = document.getElementById('discarded-btn');
    const statsBtn = document.getElementById('stats-btn');
    const historyBtn = document.getElementById('history-btn');
    const trophyBtn = document.getElementById('trophy-btn');
    const achievementsBtn = document.getElementById('achievements-btn');
    const navMenu = document.getElementById('nav-menu');
    const openNavMenuBtn = document.getElementById('open-nav-menu');
    const closeNavMenuBtn = document.getElementById('close-nav-menu');
    const menuOverlay = document.getElementById('menu-overlay');
    const userTitleEl = document.getElementById('user-title');
    const totalPsCountEl = document.getElementById('total-ps-count');
    const statsModal = document.getElementById('stats-modal');
    const statsModalBody = document.getElementById('stats-modal-body');
    const historyModal = document.getElementById('history-modal');
    const trophyModal = document.getElementById('trophy-modal');
    const achievementsModal = document.getElementById('achievements-modal');
    const trophyModalBody = document.getElementById('trophy-modal-body');
    const historyModalBody = document.getElementById('history-modal-body');
    const achievementsModalBody = document.getElementById('achievements-modal-body');
    const closeStatsModalBtn = document.getElementById('close-stats-modal');
    const closeHistoryModalBtn = document.getElementById('close-history-modal');
    const closeTrophyModalBtn = document.getElementById('close-trophy-modal');
    const closeAchievementsModalBtn = document.getElementById('close-achievements-modal');
    const trashModal = document.getElementById('trash-modal');
    const closeTrashModalBtn = document.getElementById('close-trash-modal');
    const trashModalBody = document.getElementById('trash-modal-body');
    const deleteAllTrashBtn = document.getElementById('delete-all-trash-btn');
    const discardedModal = document.getElementById('discarded-modal');
    const closeDiscardedModalBtn = document.getElementById('close-discarded-modal');
    const discardedModalBody = document.getElementById('discarded-modal-body');
    const deleteAllDiscardedBtn = document.getElementById('delete-all-discarded-btn');
    const duplicateModal = document.getElementById('duplicate-modal');
    const closeDuplicateModalBtn = document.getElementById('close-duplicate-modal');
    const duplicateGiveawayInfo = document.getElementById('duplicate-giveaway-info');
    const confirmRestoreBtn = document.getElementById('confirm-restore-btn');
    const cancelRestoreBtn = document.getElementById('cancel-restore-btn');
    const moveGiveawayModal = document.getElementById('move-giveaway-modal');
    const closeMoveGiveawayModalBtn = document.getElementById('close-move-giveaway-modal');
    const moveGiveawayForm = document.getElementById('move-giveaway-form');
    const newGiveawayDateInput = document.getElementById('new-giveaway-date');
    const duplicateComparisonModal = document.getElementById('duplicate-comparison-modal');
    const closeDuplicateComparisonModalBtn = document.getElementById('close-duplicate-comparison-modal');
    const originalGiveawayDetails = document.getElementById('original-giveaway-details');
    const discardedGiveawayDetails = document.getElementById('discarded-giveaway-details');
    const mergeGiveawayBtn = document.getElementById('merge-giveaway-btn');
    const addAsNewBtn = document.getElementById('add-as-new-btn');
    const manageForeignAccountsBtn = document.getElementById('manage-foreign-accounts-btn');
    const foreignAccountsModal = document.getElementById('foreign-accounts-modal');
    const closeForeignAccountsModalBtn = document.getElementById('close-foreign-accounts-modal');
    const foreignAccountsModalBody = document.getElementById('foreign-accounts-modal-body');
    const manageBlocksBtn = document.getElementById('manage-blocks-btn');
    const blockManagementModal = document.getElementById('block-management-modal');
    const closeBlockManagementModalBtn = document.getElementById('close-block-management-modal');
    const blockLikeBtn = document.getElementById('block-like-btn');
    const blockCommentBtn = document.getElementById('block-comment-btn');
    const blockStatsContainer = document.getElementById('block-stats-container');
    const retryFailedBtn = document.getElementById('retry-failed-btn');
    const analysisImagePreview = document.getElementById('analysis-image-preview');
    const liveResultsContainer = document.getElementById('live-results-container');
    const analysisStepText = document.getElementById('analysis-step-text');
    const zoomModal = document.getElementById('zoom-modal');
    const zoomedImage = document.getElementById('zoomed-image');
    const notificationModal = document.getElementById('notification-modal');
    const notificationTitle = document.getElementById('notification-title');
    const notificationContent = document.getElementById('notification-content');
    const totalPsContainer = document.getElementById('total-ps-container');
    const psSummaryModal = document.getElementById('ps-summary-modal');
    const closePsSummaryModalBtn = document.getElementById('close-ps-summary-modal');
    const psSummaryModalBody = document.getElementById('ps-summary-modal-body');
    const totalGiveawaysContainer = document.getElementById('total-giveaways-container');
    const recentAddsModal = document.getElementById('recent-adds-modal');
    const closeRecentAddsModalBtn = document.getElementById('close-recent-adds-modal');
    const recentAddsModalBody = document.getElementById('recent-adds-modal-body');
    const visReviewBtn = document.getElementById('vis-review-btn');
    const visModal = document.getElementById('vis-modal');
    const closeVisModalBtn = document.getElementById('close-vis-modal');
    const newAdditionsBtn = document.getElementById('new-additions-btn');
    const newAdditionsModal = document.getElementById('new-additions-modal');
    const closeNewAdditionsModalBtn = document.getElementById('close-new-additions-modal');

    let giveawayToMove = null;
    let originalDateOfGiveaway = null;
    // --- FUNCIONES DE LA APLICACI√ìN ---
    
    const populateCategoryDropdown = (selectElementId) => {
        const selectElement = document.getElementById(selectElementId);
        if (!selectElement) return;
        
        // Limpiamos opciones existentes y a√±adimos una por defecto
        selectElement.innerHTML = '<option value="" disabled selected>-- Selecciona una categor√≠a --</option>';

        for (const key in CATEGORY_INFO) {
            if (key === 'all') continue; // No incluimos la opci√≥n "Todas"
            
            const category = CATEGORY_INFO[key];
            const option = document.createElement('option');
            option.value = key;
            option.textContent = `${category.emoji} ${category.name}`;
            selectElement.appendChild(option);
        }
    };
    
    const clearAllFilters = () => {
        activeBatchFilterId = null;
        searchQuery = '';
        currentFilter = 'all';

        // Reseteamos los controles del men√∫
        if (document.getElementById('global-search-input')) {
            document.getElementById('global-search-input').value = '';
        }
        if (document.getElementById('global-category-filter')) {
            document.getElementById('global-category-filter').value = 'all';
        }

        renderCalendar();
        updateFilterBanner(); // Ocultar√° el banner
        showNotification('Filtros Limpiados', 'Mostrando todos los sorteos.');
    };

    const updateFilterBanner = () => {
        const banner = document.getElementById('filter-banner');
        const bannerText = document.getElementById('filter-banner-text');
        if (!banner || !bannerText) return;

        let filterIsActive = false;
        let bannerMessage = '';

        // Prioridad 1: Filtro de Lote de Capturas
        if (activeBatchFilterId) {
            const activeBatch = (captureBatches || []).find(b => b.id === activeBatchFilterId);
            if (activeBatch) {
                bannerMessage = `Mostrando solo el lote: <strong>${activeBatch.name}</strong> (${activeBatch.giveawayIds.length} sorteos).`;
                filterIsActive = true;
            }
        } 
        // Prioridad 2: Filtro de Categor√≠a Global
        else if (currentFilter && currentFilter !== 'all') {
            const category = CATEGORY_INFO[currentFilter];
            bannerMessage = `Mostrando categor√≠a: <strong>${category.emoji} ${category.name}</strong>.`;
            filterIsActive = true;
        }
        // Prioridad 3: B√∫squeda por Texto Global
        else if (searchQuery && searchQuery.trim() !== '') {
            bannerMessage = `Buscando: "<strong>${searchQuery}</strong>".`;
            filterIsActive = true;
        }

        if (filterIsActive) {
            bannerText.innerHTML = bannerMessage;
            banner.style.display = 'block';
        } else {
            banner.style.display = 'none';
        }
    };

    function setupCustomCategoryFilter() {
        const button = document.getElementById('category-filter-button');
        const selectedText = document.getElementById('category-filter-selected-text');
        const optionsContainer = document.getElementById('category-filter-options');
        if (!button || !selectedText || !optionsContainer) return;

        // Limpiar opciones existentes
        optionsContainer.innerHTML = '';

        // Llenar con las categor√≠as
        Object.keys(CATEGORY_INFO).forEach(key => {
            const category = CATEGORY_INFO[key];
            const li = document.createElement('li');
            li.className = 'custom-dropdown-option';
            li.dataset.value = key;
            li.innerHTML = `
                <span class="category-name">${category.emoji} ${category.name}</span>
                <span class="category-desc">${category.desc}</span>
            `;
            optionsContainer.appendChild(li);
        });

        // A√±adir el manejador de eventos al contenedor de opciones (m√°s eficiente)
        optionsContainer.addEventListener('click', (e) => {
            const selectedOption = e.target.closest('.custom-dropdown-option');
            if (!selectedOption) return;

            const selectedValue = selectedOption.dataset.value;
            const category = CATEGORY_INFO[selectedValue];
            
            button.dataset.value = selectedValue;
            selectedText.textContent = `${category.emoji} ${category.name}`;
            
            if (selectedValue === 'all') {
                button.classList.add('placeholder');
            } else {
                button.classList.remove('placeholder');
            }

            // Ocultar el men√∫ desplegable
            optionsContainer.classList.add('hidden');
            
            // Volver a renderizar el modal con el filtro aplicado
            const dateStr = modal.dataset.date;
            if (dateStr) {
                buildModal(dateStr);
            }
        });

        // Establecer el estado inicial del bot√≥n
        const initialCategory = CATEGORY_INFO['all'];
        selectedText.textContent = `${initialCategory.emoji} ${initialCategory.name}`;
        button.dataset.value = 'all';
        button.classList.add('placeholder');
    }

    const resetAIView = () => {
        // Resetear variables de estado
        imageQueue = [];
        isProcessing = false;
        currentIndex = 0;
        totalCaptures = 0;
        giveawaysWithErrors = [];
        analysisResults = {
            added: [],
            duplicate: [],
            expired: [],
            foreign: [],
            no_date: [],
            not_a_giveaway: [],
            api_error: []
        };

        // Resetear la visibilidad de las vistas
        if (aiInitialView) aiInitialView.style.display = 'flex';
        if (interactiveAnalysisContainer) interactiveAnalysisContainer.style.display = 'none';
        if (aiSummaryView) aiSummaryView.style.display = 'none';
        
        // Resetear los elementos de la interfaz de subida
        if (aiQueueList) aiQueueList.innerHTML = '';
        if (aiQueueCount) aiQueueCount.textContent = '0';
        if (aiQueueContainer) aiQueueContainer.style.display = 'none';
        if (startAiButton) startAiButton.style.display = 'none';
        if (retryFailedBtn) retryFailedBtn.style.display = 'none';
        
        // Limpiar el valor del input de archivos (muy importante)
        if (aiImageInput) aiImageInput.value = '';
    };

    let notificationTimeout;
    const showNotification = (title, message) => {
        if (notificationTitle && notificationContent && notificationModal) {
            clearTimeout(notificationTimeout);
            notificationModal.classList.remove('show', 'hide');
            void notificationModal.offsetWidth;
            notificationTitle.textContent = title;
            notificationContent.textContent = message;
            notificationModal.classList.add('show');
            notificationTimeout = setTimeout(() => {
                notificationModal.classList.remove('show');
                notificationModal.classList.add('hide');
            }, 4000);
        }
    };

    const saveGiveaways = () => localStorage.setItem('giveaways', JSON.stringify(giveaways));
    const saveCompletedGiveaways = () => localStorage.setItem(`completedGiveaways`, JSON.stringify(completedGiveaways));
    const saveNotInterestedGiveaways = () => localStorage.setItem('notInterestedGiveaways', JSON.stringify(notInterestedGiveaways));
    const saveTrashGiveaways = () => localStorage.setItem('trashGiveaways', JSON.stringify(trashGiveaways));
    const saveDiscardedGiveaways = () => localStorage.setItem('discardedGiveaways', JSON.stringify(discardedGiveaways));
    const saveForeignAccounts = () => localStorage.setItem('foreignAccounts', JSON.stringify(foreignAccounts));
    const saveWonGiveaways = () => localStorage.setItem('wonGiveaways', JSON.stringify(wonGiveaways));
    const saveAnalysisHistory = () => localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
    const saveUserPoints = () => localStorage.setItem('userPoints', JSON.stringify(userPoints));
    const saveUserAchievements = () => localStorage.setItem('userAchievements', JSON.stringify(userAchievements));
    const saveBlockHistory = () => localStorage.setItem('blockHistory', JSON.stringify(blockHistory));
    const saveVisGiveaways = () => localStorage.setItem('visGiveaways', JSON.stringify(visGiveaways));
    const saveCaptureBatches = () => localStorage.setItem('captureBatches', JSON.stringify(captureBatches));

    const getConfidenceEmoji = (score) => {
        if (score === null || score === undefined) return '‚ùî';
        if (score >= 0.95) return 'üéØ'; // Muy Alta
        if (score >= 0.8) return 'üëç';  // Alta
        if (score >= 0.6) return 'ü§î';  // Media
        return '‚ùì'; // Baja
    };

    const updatePointsDisplay = () => {
        if (totalPsCountEl) {
            totalPsCountEl.textContent = userPoints.total;
        }
    };

    const addPoints = (pointsToAdd, reason) => {
        userPoints.total += pointsToAdd;
        if (!userPoints.log) {
            userPoints.log = [];
        }
        userPoints.log.push({
            points: pointsToAdd,
            reason: reason,
            date: new Date().toISOString()
        });
        if (userPoints.log.length > 30) {
            userPoints.log = userPoints.log.slice(-30);
        }
        saveUserPoints();
        updatePointsDisplay();
    };

    const parsePrice = (priceString) => {
        if (!priceString || typeof priceString !== 'string') return 0;
        const cleanedString = priceString.replace(/[^0-9,.]/g, '').replace(',', '.');
        const numericValue = parseFloat(cleanedString);
        return isNaN(numericValue) ? 0 : numericValue;
    };

    const calculateSimilarity = (str1, str2) => {
        const lev = (s1, s2) => {
            const matrix = [];
            for (let i = 0; i <= s2.length; i++) { matrix[i] = [i]; }
            for (let j = 0; j <= s1.length; j++) { matrix[0][j] = j; }
            for (let i = 1; i <= s2.length; i++) {
                for (let j = 1; j <= s1.length; j++) {
                    const cost = s1[j - 1] === s2[i - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(matrix[i - 1][j] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j - 1] + cost);
                }
            }
            return matrix[s2.length][s1.length];
        };
        const longer = str1.length > str2.length ? str1 : str2;
        const shorter = str1.length > str2.length ? str2 : str1;
        const distance = lev(longer, shorter);
        return (longer.length - distance) / longer.length;
    };

    const checkAchievements = (action, data = null) => {
        const today = new Date().toISOString().slice(0, 10);
        const counters = userAchievements.counters;

        counters.totalGiveawaysAdded = Object.values(giveaways).flat().length + wonGiveaways.length;
        counters.totalGiveawaysCompleted = Object.keys(completedGiveaways).length;
        counters.totalGiveawaysWon = wonGiveaways.length;
        counters.totalValueWon = wonGiveaways.reduce((sum, g) => sum + parsePrice(g.price), 0);

        if (action === 'add-manual') counters.totalManualAdds = (counters.totalManualAdds || 0) + 1;
        if (action === 'add-ai') counters.totalGiveawaysAddedAI = (counters.totalGiveawaysAddedAI || 0) + 1;
        if (action === 'move') counters.firstMove = true;
        if (action === 'restore') counters.restoredFromTrash = (counters.restoredFromTrash || 0) + 1;
        if (action === 'search') counters.searchesMade = (counters.searchesMade || 0) + 1;
        if (action === 'block-foreign') counters.foreignAccountsBlocked = (counters.foreignAccountsBlocked || 0) + 1;
        if (action === 'merge') counters.mergedDuplicates = (counters.mergedDuplicates || 0) + 1;
        if (action === 'complete' && data.giveawayDate === today) counters.lastMinuteCompletes = (counters.lastMinuteCompletes || 0) + 1;

        if (action === 'win') {
            const prizeValue = parsePrice(data.price);
            if (prizeValue > 100) counters.winsOver100 = (counters.winsOver100 || 0) + 1;
            if (prizeValue > 2000) counters.winsOver2000 = (counters.winsOver2000 || 0) + 1;
            
            const categoryMap = { 'ü•é': 'padel', 'üõ©Ô∏è': 'viajes', 'üÉè': 'frikis' };
            let prizeCategory = 'otros';
            for (const emoji in categoryMap) {
                if (data.prize.includes(emoji)) { prizeCategory = categoryMap[emoji]; break; }
            }
            counters.categoryWins[prizeCategory]++;
            
            counters.sameDayWins[today] = (counters.sameDayWins[today] || 0) + 1;

            data.accounts.forEach(acc => {
                counters.winsFromSameAccount[acc] = (counters.winsFromSameAccount[acc] || 0) + 1;
            });

            if(data.moved) counters.movedGiveawayWins = (counters.movedGiveawayWins || 0) + 1;

            if (data.addDate) {
                const addDate = new Date(data.addDate);
                const winDate = new Date(data.wonDate);
                const diffMonths = (winDate.getFullYear() - addDate.getFullYear()) * 12 + (winDate.getMonth() - addDate.getMonth());
                if (diffMonths >= 6) counters.nostradamusWins = (counters.nostradamusWins || 0) + 1;
            }
        }
        
        const allAchievementTypes = [...achievementList.bronze, ...achievementList.silver, ...achievementList.gold, ...achievementList.platinum, ...achievementList.diamond, ...achievementList.merits, ...achievementList.prestige];
        allAchievementTypes.forEach(ach => {
            if (!userAchievements.unlocked.includes(ach.id)) {
                const conditionData = action === 'win' ? data : null;
                if (ach.condition(counters, userAchievements.unlocked, conditionData)) {
                    userAchievements.unlocked.push(ach.id);
                    const title = ach.title || ach.name;
                    const isPrestige = ach.id.startsWith('t_');
                    showNotification(isPrestige ? 'üèÜ T√≠tulo Desbloqueado' : 'üèÖ Logro Desbloqueado', title);
                    if (ach.ps) addPoints(ach.ps, `Logro: ${title}`);
                    if (isPrestige) {
                        userAchievements.title = ach.title;
                    }
                }
            }
        });

        saveUserAchievements();
        if (userTitleEl) {
            userTitleEl.textContent = userAchievements.title;
        }
    };

    const isDuplicateGiveaway = (newGiveaway) => {
        const newPrize = (newGiveaway.prize || '').toLowerCase();
        const newAccounts = (newGiveaway.accounts || []).map(acc => acc.toLowerCase().replace('@','')).sort().join(',');
        
        for (const date in giveaways) {
            const existing = giveaways[date].find(g => {
                const existingPrize = (g.prize || '').toLowerCase();
                const existingAccounts = (g.accounts || []).map(acc => acc.toLowerCase().replace('@','')).sort().join(',');
                const prizeSimilarity = calculateSimilarity(newPrize, existingPrize);
                const accountsMatch = newAccounts === existingAccounts;
                return prizeSimilarity > 0.7 && accountsMatch;
            });
            if (existing) {
                return existing;
            }
        }
        return null;
    };
    const renderCalendar = () => {
        if (!calendarDaysEl || !monthYearEl) return;
        calendarDaysEl.innerHTML = '';
        const month = currentDate.getMonth();
        const year = currentDate.getFullYear();
        monthYearEl.textContent = `${currentDate.toLocaleDateString('es-ES', { month: 'long' }).toUpperCase()}`;
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const dayOffset = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;
        let totalGiveawaysCount = 0;
        for (let i = 0; i < dayOffset; i++) { calendarDaysEl.innerHTML += `<div></div>`; }
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            // --- INICIO DE LA MODIFICACI√ìN PARA FILTRADO DE LOTE ---
            let giveawaysForDay = giveaways[dateStr] || [];

            if (activeBatchFilterId) {
                const activeBatch = (captureBatches || []).find(b => b.id === activeBatchFilterId);
                if (activeBatch) {
                    const batchGiveawayIds = new Set(activeBatch.giveawayIds);
                    giveawaysForDay = giveawaysForDay.filter(g => batchGiveawayIds.has(g.id));
                } else {
                    // Si el lote no se encuentra por alguna raz√≥n, no mostramos nada.
                    giveawaysForDay = []; 
                }
            }
            // --- FIN DE LA MODIFICACI√ìN ---

            const dayGiveaways = giveawaysForDay.filter(g => { // <-- MODIFICADO para usar la variable filtrada
                const prize = g.prize ? g.prize.toLowerCase() : '';
                const searchText = searchQuery.toLowerCase();

                let matchesSearch = !searchQuery || prize.includes(searchText);
                if (!matchesSearch) {
                    return false;
                }

                if (currentFilter === 'all') {
                    return true;
                }
                
                // L√≥gica de categor√≠a
                let prizeCategory = 'otros';
                for (const [key, value] of Object.entries(CATEGORY_INFO)) {
                    if (g.prize_category === key) {
                        prizeCategory = key;
                        break;
                    }
                }
                
                return currentFilter === prizeCategory;
            });
            totalGiveawaysCount += dayGiveaways.length;
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.draggable = true;
            dayEl.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', dateStr);
                e.dataTransfer.effectAllowed = 'move';
            });
            let dayNumberHTML = `<span class="day-number">${day}</span>`;
            if (dayGiveaways.length > 0) {
                dayEl.classList.add('has-giveaway');
                dayEl.dataset.date = dateStr;
                const remainingCount = dayGiveaways.filter(g => !completedGiveaways[g.id]).length;
                if (remainingCount > 0) {
                    dayNumberHTML += `<span class="giveaway-count rounded-full">${remainingCount}</span>`;
                } else {
                    dayEl.classList.add('all-done');
                    dayNumberHTML += `<span class="text-2xl mt-1">‚ú®</span>`;
                }
            }
            dayEl.innerHTML = dayNumberHTML;
            calendarDaysEl.appendChild(dayEl);
        }
        if (totalGiveawaysEl) totalGiveawaysEl.textContent = totalGiveawaysCount;
    };

    const getCategoryInfo = (categoryKey) => {
        return CATEGORY_INFO[categoryKey] || CATEGORY_INFO['otros'];
    };

    const buildModal = (dateStr) => {
        const modalBody = document.getElementById('modal-body');
        const notInterestedBody = document.getElementById('not-interested-body');
        modalBody.innerHTML = '';
        notInterestedBody.innerHTML = '';

        // Filtrado de listas (simplificado para claridad, tu l√≥gica de filtros se mantiene)
        let dayGiveaways = (giveaways[dateStr] || []);
        // --- INICIO DEL C√ìDIGO DE ORDENACI√ìN ---
dayGiveaways.sort((a, b) => {
    const isACompleted = !!completedGiveaways[a.id];
    const isBCompleted = !!completedGiveaways[b.id];

    // 1. Prioridad M√ÅXIMA: Sorteos completados siempre van al final.
    if (isACompleted && !isBCompleted) return 1; // 'a' (completado) va despu√©s de 'b'
    if (!isACompleted && isBCompleted) return -1; // 'b' (completado) va despu√©s de 'a'

    // Si ambos est√°n completados o ambos no lo est√°n, se aplican las siguientes reglas.

    // 2. Prioridad: Sorteos con hora espec√≠fica que no sea medianoche.
    const aHasPriorityTime = a.is_priority_time === true;
    const bHasPriorityTime = b.is_priority_time === true;

    if (aHasPriorityTime && !bHasPriorityTime) return -1; // 'a' (prioritario) va antes que 'b'
    if (!aHasPriorityTime && bHasPriorityTime) return 1; // 'b' (prioritario) va antes que 'a'

    // Si ambos tienen (o no tienen) hora prioritaria, se ordenan por valor.

    // 3. Prioridad: Valor del premio (de mayor a menor).
    const priceA = parsePrice(a.price);
    const priceB = parsePrice(b.price);

    return priceB - priceA; // Orden descendente
});
// --- FIN DEL C√ìDIGO DE ORDENACI√ìN ---
        const dayNotInterested = notInterestedGiveaways[dateStr] || [];

        // Renderizar Sorteos Principales
        dayGiveaways.forEach(giveaway => {
            const isCompleted = !!completedGiveaways[giveaway.id];
            const itemContainer = document.createElement('div');
            itemContainer.className = `giveaway-item p-3 rounded-lg shadow-inner flex justify-between items-center border border-yellow-600/20 relative ${isCompleted ? 'bg-green-100/30' : 'bg-yellow-100/50'}`;
            
            let accountsHTML = (giveaway.accounts || []).map(acc => `<div><a href="https://instagram.com/${acc.replace('@','')}" target="_blank" class="underline">${acc}</a></div>`).join('');
            const categoryInfo = getCategoryInfo(giveaway.prize_category);

            itemContainer.innerHTML = `
                <div class="flex items-start flex-1 overflow-hidden">
                    <div class="flex flex-col items-center mr-3 flex-shrink-0">
                        <input type="checkbox" data-giveaway-id="${giveaway.id}" class="h-6 w-6 rounded-md border-2 border-yellow-600 text-yellow-500 focus:ring-yellow-500" ${isCompleted ? 'checked' : ''}>
                        <button class="not-interested-btn p-1 rounded-full text-lg mt-1 text-gray-400 hover:text-red-500" data-giveaway-id="${giveaway.id}" data-giveaway-date="${dateStr}" style="display: ${isCompleted ? 'none' : 'block'};">
                            <i class="fa-solid fa-eye-slash"></i>
                        </button>
                        <div class="post-complete-actions flex flex-col items-center space-y-1 mt-1" style="display: ${isCompleted ? 'flex' : 'none'};">
                            <button class="win-giveaway-btn p-1 rounded-full text-lg" data-giveaway-id="${giveaway.id}" data-giveaway-date="${dateStr}">üèÜ</button>
                            <button class="vis-giveaway-btn p-1 rounded-full text-lg" data-giveaway-id="${giveaway.id}" data-giveaway-date="${dateStr}">üåü</button>
                        </div>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-base sm:text-lg text-yellow-900 truncate">${giveaway.prize}</p>
                        <div class="text-sm">${accountsHTML}</div>
                        <span class="text-xl mt-1 inline-block" title="Categor√≠a: ${categoryInfo.name}">${categoryInfo.emoji}</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="text-right flex-shrink-0 ml-2">
                        ${giveaway.price ? `<a href="https://www.google.com/search?q=${encodeURIComponent(giveaway.prize)}" target="_blank" class="block font-bold">${giveaway.price}</a><span class="text-xs">Valor aprox.</span>` : ''}
                    </div>
                    <div class="flex flex-col items-center ml-2 space-y-1">
                        <button class="move-giveaway-btn p-1 rounded-full text-sm" data-giveaway-id="${giveaway.id}" data-giveaway-date="${dateStr}"><i class="fa-solid fa-calendar-days"></i></button>
                        <button class="delete-giveaway-btn p-1 rounded-full text-sm" data-giveaway-id="${giveaway.id}" data-giveaway-date="${dateStr}"><i class="fa-solid fa-trash-can"></i></button>
                        <button class="delete-giveaway-foreign-btn p-1 rounded-full text-sm" data-giveaway-id="${giveaway.id}" data-giveaway-date="${dateStr}"><i class="fa-solid fa-globe"></i></button>
                    </div>
                </div>
            `;
            modalBody.appendChild(itemContainer);
        });

        // Renderizar Sorteos "No me Interesa"
        dayNotInterested.forEach(giveaway => {
            const itemContainer = document.createElement('div');
            itemContainer.className = 'giveaway-item not-interested p-3 rounded-lg shadow-inner flex justify-between items-center border border-gray-400/20 bg-gray-100/30';
            let accountsHTML = (giveaway.accounts || []).map(acc => `<div><a href="https://instagram.com/${acc.replace('@','')}" target="_blank" class="underline">${acc}</a></div>`).join('');
            itemContainer.innerHTML = `
                <div class="flex-1 overflow-hidden">
                    <p class="text-base sm:text-lg text-gray-700 truncate">${giveaway.prize}</p>
                    <div class="text-sm text-gray-600">${accountsHTML}</div>
                </div>
                <button class="restore-not-interested-btn p-2 rounded-full text-lg text-green-600 hover:bg-green-200" data-giveaway-id="${giveaway.id}" data-giveaway-date="${dateStr}">
                    <i class="fa-solid fa-eye"></i>
                </button>
            `;
            notInterestedBody.appendChild(itemContainer);
        });

        // Mensajes si las listas est√°n vac√≠as
        if (dayGiveaways.length === 0) {
            modalBody.innerHTML = '<p class="text-center text-gray-500">¬°No hay sorteos aqu√≠! Mueve alguno a este d√≠a o a√±ade uno nuevo.</p>';
        }
        if (dayNotInterested.length === 0) {
            notInterestedBody.innerHTML = '<p class="text-center text-gray-500">No has marcado ning√∫n sorteo como no interesante para hoy.</p>';
        }

        modal.dataset.date = dateStr;
    };

    const openModal = (dateStr) => { 
        if (navMenu.classList.contains('is-open')) {
            toggleNavMenu();
        }
        
        // 1. Pre-llenamos los filtros del modal con los filtros globales activos
        const modalSearchInput = document.getElementById('modal-search-input');
        if (modalSearchInput) {
            modalSearchInput.value = searchQuery; // Aplicamos el texto de b√∫squeda global
        }

        const catButton = document.getElementById('category-filter-button');
        const catText = document.getElementById('category-filter-selected-text');
        if (catButton && catText) {
            // Si hay un filtro de categor√≠a global activo, lo aplicamos
            if (currentFilter && currentFilter !== 'all') {
                catButton.dataset.value = currentFilter;
                const info = CATEGORY_INFO[currentFilter];
                catText.textContent = `${info.emoji} ${info.name}`;
                catButton.classList.remove('placeholder');
            } else { // Si no, lo reseteamos a "Todas"
                catButton.dataset.value = 'all';
                const info = CATEGORY_INFO['all'];
                catText.textContent = `${info.emoji} ${info.name}`;
                catButton.classList.add('placeholder');
            }
        }
        
        // 2. Ahora que los filtros del modal tienen los valores correctos, llamamos a buildModal
        buildModal(dateStr); 
        modal.classList.add('is-visible'); 
    };
    
    const closeModal = () => { 
        modal.classList.remove('is-visible'); 
    };
    
    const openAddGiveawayModal = (data = {}) => {
        addGiveawayForm.reset();
        if (data.prize) giveawayPrizeInput.value = data.prize;
        if (data.accounts) giveawayAccountsInput.value = data.accounts;
        if (data.price) giveawayPriceInput.value = data.price;
        if (data.date) giveawayDateInput.value = data.date;
        addGiveawayModal.classList.add('is-visible');
    };
    
    const closeAddGiveawayModal = () => { 
        addGiveawayModal.classList.remove('is-visible'); 
    };
    
    const openSearchModal = () => { searchModal.classList.add('is-visible'); };
    const closeSearchModal = () => { searchModal.classList.remove('is-visible'); };
    
    const openMoveGiveawayModal = (giveaway, originalDate) => {
         giveawayToMove = giveaway;
         originalDateOfGiveaway = originalDate;
         newGiveawayDateInput.value = originalDate;
         moveGiveawayModal.classList.add('is-visible');
    }
    const closeMoveGiveawayModal = () => { moveGiveawayModal.classList.remove('is-visible'); }

    const addGiveaway = (newGiveaway) => {
        const dateStr = newGiveaway.date;
        if (!dateStr) {
            alert('Por favor, selecciona una fecha para el sorteo.');
            return;
        }
        if (!giveaways[dateStr]) giveaways[dateStr] = [];
        newGiveaway.addDate = new Date().toISOString().slice(0, 10);
        giveaways[dateStr].push(newGiveaway);
        saveGiveaways();
        renderCalendar();
        addPoints(1, `Sorteo a√±adido: ${newGiveaway.prize.substring(0, 20)}...`);
        checkAchievements('add-manual');
    };
    
    const moveGiveaway = (giveawayId, oldDate, newDate) => {
        if (giveaways[oldDate]) {
            const giveawayToMove = giveaways[oldDate].find(g => g.id === giveawayId);
            if (giveawayToMove) {
                giveawayToMove.date = newDate;
                giveawayToMove.moved = true; 
                giveaways[oldDate] = giveaways[oldDate].filter(g => g.id !== giveawayId);
                if (giveaways[oldDate].length === 0) delete giveaways[oldDate];
                if (!giveaways[newDate]) giveaways[newDate] = [];
                giveaways[newDate].push(giveawayToMove);
                saveGiveaways();
                renderCalendar();
                closeModal();
                showNotification('Sorteo movido', `El sorteo se ha movido al ${newDate}.`);
                checkAchievements('move');
            }
        }
    };

    const setFilterAndRender = (filter) => { currentFilter = filter; renderCalendar(); checkAchievements('search'); }

    const markAsWon = (giveawayId, dateStr) => {
        if (!giveaways[dateStr]) return;
        const giveawayIndex = giveaways[dateStr].findIndex(g => g.id === giveawayId);
        if (giveawayIndex === -1) return;
        const [wonGiveaway] = giveaways[dateStr].splice(giveawayIndex, 1);
        
        let points = 100;
        let reason = `¬°Has ganado "${wonGiveaway.prize}"!`;
        if (wonGiveaway.prize.includes('ü•é') || wonGiveaway.prize.includes('üõ©Ô∏è') || wonGiveaway.prize.includes('üÉè')) points += 25;
        if (parsePrice(wonGiveaway.price) > 500) points += 250;
        addPoints(points, reason);

        wonGiveaway.wonDate = new Date().toISOString();
        wonGiveaways.push(wonGiveaway);
        if (!completedGiveaways[giveawayId]) {
            completedGiveaways[giveawayId] = true;
            completedGiveawayCount++;
            addPoints(2, `Completado: ${wonGiveaway.prize.substring(0, 20)}...`);
            saveCompletedGiveaways();
        }
        if (giveaways[dateStr].length === 0) {
            delete giveaways[dateStr];
        }
        saveGiveaways();
        saveWonGiveaways();
        closeModal();
        renderCalendar();
        renderTrophyModal();
        showNotification('¬°Enhorabuena!', `Has a√±adido "${wonGiveaway.prize}" a tu vitrina de trofeos.`);
        checkAchievements('win', wonGiveaway);
    };

    const deleteWonGiveaway = (giveawayId) => {
        if (confirm("¬øEst√°s seguro de que quieres eliminar este sorteo de la vitrina?")) {
            const wonGiveaway = wonGiveaways.find(g => g.id === giveawayId);
            if (wonGiveaway) {
                if (completedGiveaways[wonGiveaway.id]) {
                     delete completedGiveaways[wonGiveaway.id];
                     completedGiveawayCount--;
                     saveCompletedGiveaways();
                }
            }
            wonGiveaways = wonGiveaways.filter(g => g.id !== giveawayId);
            saveWonGiveaways();
            renderTrophyModal();
            showNotification('Sorteo eliminado', 'El sorteo se ha eliminado de tu vitrina.');
        }
    };

    const generateGiveawayDetailsHTML = (giveaway, title) => {
        const accountsHTML = (giveaway.accounts || []).map(acc => `<a href="https://instagram.com/${acc.replace('@', '')}" target="_blank" class="hover:underline">${acc}</a>`).join(', ');
        return `
            <div class="p-4 rounded-lg border border-yellow-600/20 text-left bg-yellow-100/30">
                <h4 class="text-lg font-bold mb-2 text-yellow-800">${title}</h4>
                <div class="text-sm space-y-1">
                    <p><strong>Premio:</strong> ${giveaway.prize || 'N/A'}</p>
                    <p><strong>Cuentas:</strong> ${accountsHTML || 'N/A'}</p>
                    <p><strong>Valor:</strong> ${giveaway.price || 'N/A'}</p>
                    <p><strong>Fecha del Sorteo:</strong> ${giveaway.date || 'No encontrada'}</p>
                </div>
            </div>
        `;
    };
    
    const handleFileSelection = (event) => {
        const files = event.target.files;
        if (!files || files.length === 0) return;

        const newFiles = Array.from(files);
        imageQueue.push(...newFiles);

        if (imageQueue.length > MAX_IMAGES) {
            imageQueue = imageQueue.slice(0, MAX_IMAGES);
            showNotification('L√≠mite alcanzado', `Solo se pueden analizar ${MAX_IMAGES} im√°genes a la vez.`);
        }

        aiQueueList.innerHTML = '';
        imageQueue.forEach(file => {
            const li = document.createElement('li');
            li.textContent = file.name;
            li.className = 'text-xs truncate text-white';
            aiQueueList.appendChild(li);
        });

        aiQueueCount.textContent = imageQueue.length;
        aiQueueContainer.style.display = 'block';
        startAiButton.style.display = 'block';
    };
    
    const updateAnalysisLegend = () => {
        const legendData = [
            { id: 'valid', color: '#22c55e', count: analysisResults.added.length },
            { id: 'duplicate', color: '#6b7280', count: analysisResults.duplicate.length },
            { id: 'expired', color: '#d4af37', count: analysisResults.expired.length },
            { id: 'foreign', color: '#3b82f6', count: analysisResults.foreign.length },
            { id: 'error', color: '#ef4444', count: analysisResults.api_error.length + analysisResults.no_date.length + analysisResults.not_a_giveaway.length }
        ];

        analysisLegendContainer.innerHTML = legendData.map(item => `
            <div class="legend-item text-yellow-300">
                <div class="color-dot" style="background-color: ${item.color};"></div>
                <span id="legend-count-${item.id}">${item.count}</span>
            </div>
        `).join('');
    };

    function startAnalysis(filesToProcess = imageQueue) {
        if (filesToProcess.length === 0 || isProcessing) return;
        
        isProcessing = true;
        currentIndex = 0;
        totalCaptures = filesToProcess.length;
        imageQueue = filesToProcess; 
        
        analysisResults = { added: [], duplicate: [], expired: [], foreign: [], no_date: [], not_a_giveaway: [], api_error: [] };
        giveawaysWithErrors = [];

        aiInitialView.style.display = 'none';
        interactiveAnalysisContainer.style.display = 'flex';
        aiSummaryView.style.display = 'none';
        
        updateAnalysisLegend();
        processNextImage();
    }

    function processNextImage() {
        if (currentIndex < totalCaptures) {
            liveResultsContainer.innerHTML = `<div id="live-card-placeholder" class="live-card-placeholder">Analizando imagen ${currentIndex + 1} de ${totalCaptures}...</div>`;
            processImage(imageQueue[currentIndex]);
        } else {
            isProcessing = false;
            showAISummary();
        }
    }

    function typewriterEffect(element, text = '', speed = 25) {
        let i = 0;
        if (!element) return;
        element.value = '';
        const timer = setInterval(() => {
            if (i < text.length) {
                element.value += text.charAt(i);
                i++;
            } else {
                clearInterval(timer);
            }
        }, speed);
    }
    async function processImage(file) {
        const reader = new FileReader();
        reader.onload = async (event) => {
            const base64Data = event.target.result;
            analysisImagePreview.src = base64Data;

            const hoy = new Date();
            const fechaFormateada = hoy.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
            const dynamicPrompt = `
<ROL_Y_OBJETIVO>
Actuar√°s como un Analista de Datos Experto en Extracci√≥n de Informaci√≥n Visual, especializado en sorteos de redes sociales. Tu √∫nica misi√≥n es analizar la imagen proporcionada y devolver un √∫nico objeto JSON v√°lido, sin ning√∫n texto, saludo o explicaci√≥n adicional. La precisi√≥n, el cumplimiento de las reglas y la consistencia son de m√°xima prioridad.
</ROL_Y_OBJETIVO>

<CONTEXTO_CRITICO>
La fecha de hoy es ${fechaFormateada}. Usa esta fecha como referencia inmutable para evaluar si un sorteo ha expirado y para interpretar fechas relativas (ej: "ma√±ana", "pr√≥ximo lunes").
</CONTEXTO_CRITICO>

<PROCESO_MENTAL_GUIADO>
1.  **An√°lisis Visual y OCR:** Realiza un reconocimiento √≥ptico de caracteres (OCR) exhaustivo para extraer todo el texto de la imagen.
2.  **Identificaci√≥n de Entidades:** Identifica las entidades clave: Premio, Cuentas de Instagram, Valor del premio y cualquier menci√≥n a fechas o plazos.
3.  **L√≥gica de Fechas:** Aplica las 'REGLAS_DE_FECHA_JERARQUICAS' en el orden estricto en que se presentan para determinar la fecha correcta.
4.  **Construcci√≥n del JSON:** Usa la informaci√≥n recopilada para construir el objeto JSON final, siguiendo la estructura y reglas de formato requeridas. Si la imagen NO es un sorteo, devuelve exclusivamente: {"status": "not_a_giveaway"}.
</PROCESO_MENTAL_GUIADO>
<REGLAS_DE_VALIDEZ_GEOGRAFICA>
Tu primera tarea es determinar si el sorteo es v√°lido para un usuario en Espa√±a y devolverlo en el campo \`is_spanish\`. Usa estas reglas en orden:

1.  **REGLA DE EXCLUSI√ìN (INV√ÅLIDO):** Si el texto menciona expl√≠citamente que el sorteo es solo para un pa√≠s de Latinoam√©rica (Argentina, Colombia, M√©xico, Paraguay, Uruguay, etc.) o para la regi√≥n "LATAM", establece \`is_spanish\` en \`false\`.
2.  **REGLA DE INCLUSI√ìN (V√ÅLIDO):** Si el texto menciona expl√≠citamente "Espa√±a", "Pen√≠nsula", "Baleares" O dice que es "Internacional" / "Worldwide", establece \`is_spanish\` en \`true\`.
3.  **REGLA POR DEFECTO (V√ÅLIDO):** Si ninguna de las reglas anteriores se cumple (el sorteo no especifica ninguna regi√≥n), asume que es v√°lido y establece \`is_spanish\` en \`true\`.
</REGLAS_DE_VALIDEZ_GEOGRAFICA>

<REGLAS_DE_FECHA_JERARQUICAS_V6_AI_Final>
**Instrucci√≥n: Eval√∫a estas reglas en orden descendente. La PRIMERA regla que se cumpla determina el resultado y finaliza el an√°lisis de fechas.**

**PRIORIDAD 1. PRIORIDAD M√ÅXIMA E INELUDIBLE: Fecha con Hora Espec√≠fica.**
-   **Condici√≥n Indispensable:** El texto DEBE contener AMBOS elementos: una fecha clara de finalizaci√≥n Y una hora espec√≠fica. Si esta regla se cumple, IGNORA TODAS LAS DEM√ÅS SIN EXCEPCI√ìN (ej: "hasta el 26 a las 14:00h", "finaliza el 30 a las 22:00", "v√°lido hasta el 15 a las 23:59h").
-   **Acci√≥n:**
    -   \`date\` = La fecha exacta mencionada (ej: "2025-08-26").
    -   \`ends_at_time\` = La hora exacta extra√≠da (ej: "14:00h").
    -   \`is_priority_time\` = \`true\` si la hora NO es "23:59", "00:00" o "medianoche". En caso contrario, \`false\`.

**PRIORIDAD 2: Conflicto de Fechas (Cierre vs. Anuncio).**
-   **Condici√≥n Indispensable:** El texto DEBE contener expl√≠citamente DOS fechas distintas: una para el FIN/CIERRE del sorteo y otra, posterior, para el ANUNCIO de ganadores (ej: "termina el 27 y el ganador se dir√° el 28").
-   **Acci√≥n:** La fecha de cierre tiene prioridad absoluta.
    -   \`date\` = La fecha de CIERRE mencionada (ej: "2025-08-27").
    -   \`ends_at_time\` = null.
    -   \`is_priority_time\` = \`false\`.

**PRIORIDAD 3: Regla de Fecha √önica (Sin Hora).**
-   **Condici√≥n:** El texto NO cumple las reglas anteriores y contiene UNA SOLA menci√≥n de fecha relevante (ya sea de fin o de anuncio de ganadores).
-   **Acci√≥n:** Se anota siempre el d√≠a anterior para asegurar la participaci√≥n.
    -   \`date\` = El d√≠a **ANTERIOR** al mencionado (ej: si dice 28 o 30, anota 27 o 29 respectivamente).
    -   \`ends_at_time\` = null.
    -   \`is_priority_time\` = \`false\`.

**PRIORIDAD 4: Sin Fecha V√°lida.**
-   **Condici√≥n:** Si ninguna de las reglas anteriores se puede aplicar.
-   **Acci√≥n:**
    -   \`date\` = null.
    -   \`status\` = "no_date".
</REGLAS_DE_FECHA_JERARQUICAS_V6_AI_Final>

<REGLAS_ADICIONALES_DE_EXTRACCION>
- **Cuentas (Extracci√≥n Inteligente y Completa):**
    1.  **Prioridad 1 (Cuenta Principal):** Identifica y extrae **siempre** el nombre de usuario de la cuenta que ha realizado la publicaci√≥n del sorteo. Generalmente se encuentra en la parte superior de la imagen, junto a la foto de perfil.
    2.  **Prioridad 2 (Cuentas Adicionales):** Adem√°s de la principal, extrae cualquier otra cuenta mencionada en el texto como requisito para participar (ej: "sigue a...", "en colaboraci√≥n con...").
    3.  **Reglas de Exclusi√≥n (MUY IMPORTANTE):** Ignora activamente cualquier nombre de usuario que provenga de la secci√≥n de comentarios o de la secci√≥n de "Me gusta".

- **REGLAS DE EXTRACCI√ìN Y S√çNTESIS DEL PREMIO:**
    1.  **Objetivo:** Tu objetivo es crear un campo \`prize\` que sea conciso (m√°ximo 15-20 palabras), descriptivo y de alto valor informativo. Debe caber en una sola l√≠nea.
    2.  **S√≠ntesis de Informaci√≥n:** Debes sintetizar la informaci√≥n del texto del post Y la informaci√≥n visual de la imagen (logos, empaques de productos, marcas visibles).
    3.  **Jerarqu√≠a de Resumen (si el texto es muy largo):**
        -   **Primero:** Menciona siempre los art√≠culos de alto valor de forma expl√≠cita (ej: "PS5", "iPhone 16", "Thermomix").
        -   **Segundo:** Usa las marcas importantes que identifiques en la imagen para describir lotes gen√©ricos (ej: "Lote de productos solares Nivea" en lugar de "lote de productos para el verano").
        -   **Tercero:** Agrupa elementos variados bajo un t√©rmino descriptivo (ej: "Lote de merchandising", "Pack de material escolar", "Cesta de productos gourmet").
        -   **Cuarto:** Describe experiencias de forma clara y breve (ej: "Estancia en hotel para dos", "Cena degustaci√≥n").
    4.  **Ejemplos Pr√°cticos:**
        -   *Si el texto dice "Sorteamos un s√∫per lote para que te cuides este verano bajo el sol" y la imagen muestra 5 botes de Nivea Sun:* \`prize\` debe ser "Lote de productos solares Nivea".
        -   *Si el texto dice "Gana una camiseta exclusiva, una gorra, una sudadera y una incre√≠ble PlayStation 5":* \`prize\` debe ser "Lote de merchandising y una PS5".
        -   *Si el texto dice "Un fin de semana con todos los gastos pagados en el maravilloso Hotel Palace de la Costa Brava para dos personas con acceso completo al spa y desayuno incluido":* \`prize\` debe ser "Estancia de fin de semana en hotel de lujo para dos".

- **Precio:** Si ves un valor monetario expl√≠cito en la imagen (ej: "valorado en 150‚Ç¨", "premio de 500‚Ç¨"), extr√°elo. Si no, d√©jalo como \`null\`.
- **Categor√≠a (Reglas Jer√°rquicas V3):** Debes seguir estas reglas en orden estricto. La primera regla que se cumpla define la categor√≠a y finaliza el proceso.

    **--- NIVEL 1: NICHOS MUY ESPEC√çFICOS ---**
    1.  **Regla de P√°del:** Si el premio es espec√≠fico de p√°del (palas, paleteros, pelotas, ropa de p√°del), clasif√≠calo como 'padel'.
    2.  **Regla de Motor:** Si est√° relacionado con coches o motos (accesorios, merchandising F1/MotoGP, experiencias en circuito), clasif√≠calo como 'motor'.
    3.  **Regla de Mascotas:** Si es para animales (comida, juguetes, accesorios), clasif√≠calo como 'mascotas'.
    4.  **Regla de Beb√©s y Maternidad:** Si es para beb√©s (sillas de paseo, pa√±ales, leche de f√≥rmula, productos NUK), clasif√≠calo como 'bebes'.
    5.  **Regla de Bodas:** Si es espec√≠fico para bodas (vestidos, fot√≥grafo, invitaciones), clasif√≠calo como 'bodas'.

    **--- NIVEL 2: NATURALEZA DEL PREMIO (NO F√çSICO) ---**
    6.  **Regla de Dinero y Vales:** Si es dinero, una tarjeta regalo, cup√≥n o vale de compra, clasif√≠calo como 'dinero'.
    7.  **Regla de Viajes vs. Ocio (Desempate):**
        * Si implica pernoctaci√≥n o un vuelo/tren (estancia en hotel, fin de semana, crucero), es 'viajes'.
        * Si es una experiencia local (entradas a conciertos, cine, teatro, parques tem√°ticos, cena), es 'ocio'.
    8.  **Regla de Aventura y Adrenalina:** Si es una experiencia de 'Ocio' que implica riesgo o adrenalina (salto paraca√≠das, puenting, conducci√≥n en circuito), clasif√≠calo como 'aventura'.
    9.  **Regla de Suscripciones y Servicios:** Si es un servicio digital (Netflix, Spotify, software, cursos online), clasif√≠calo como 'suscripciones'.

    **--- NIVEL 3: HOBBIES Y ART√çCULOS PERSONALES ---**
    10. **Regla de Gaming:** Si son consolas (PS5, Nintendo Switch), videojuegos o accesorios gaming (sillas, teclados), clasif√≠calo como 'gaming'.
    11. **Regla de Fotograf√≠a y V√≠deo:** Si son c√°maras (Instax), drones, objetivos o tr√≠podes, clasif√≠calo como 'foto'.
    12. **Regla de M√∫sica y Sonido:** Si son auriculares, altavoces o instrumentos musicales, clasif√≠calo como 'musica'.
    13. **Regla de Deporte (General):** Si es equipamiento o ropa para un deporte (que no sea p√°del), clasif√≠calo como 'deporte'.
    14. **Regla de Libros y Formaci√≥n:** Si el premio principal es un libro o un curso (que no sea online), clasif√≠calo como 'libros'.
    15. **Regla de Frikis:** Si son figuras coleccionables (Funko), juegos de mesa, c√≥mics o merchandising de cultura pop, clasif√≠calo como 'frikis'.
    16. **Regla de Joyer√≠a y Relojes:** Si son relojes, pulseras, collares o gafas de sol, clasif√≠calo como 'joyeria'.
    17. **Regla de Bolsos y Accesorios:** Si son bolsos, mochilas, maletas o neceseres, clasif√≠calo como 'accesorios'.
    18. **Regla de Moda:** Si es ropa o calzado de uso casual, clasif√≠calo como 'moda'.
    19. **Regla de Belleza:** Si son productos de cosm√©tica, maquillaje o perfumes, clasif√≠calo como 'belleza'.
    20. **Regla de Salud y Cuidado Personal:** Si son productos de farmacia, cuidado dental, vitaminas o servicios de bienestar (spa, masaje), clasif√≠calo como 'salud'.

    **--- NIVEL 4: ART√çCULOS PARA EL HOGAR Y OTROS ---**
    21. **Regla de Electrodom√©sticos:** Si es un electrodom√©stico grande (TV, lavadora, frigor√≠fico, robot aspirador), clasif√≠calo como 'electrodomesticos'.
    22. **Regla de Cocina y Menaje:** Si es un peque√±o electrodom√©stico (freidora de aire, cafetera) o menaje, clasif√≠calo como 'cocina'.
    23. **Regla de Bricolaje y Herramientas:** Si son herramientas o material de bricolaje, clasif√≠calo como 'bricolaje'.
    24. **Regla de Jardiner√≠a y Plantas:** Si son plantas, macetas o herramientas de jard√≠n, clasif√≠calo como 'jardineria'.
    25. **Regla de Papeler√≠a y Oficina:** Si son agendas, cuadernos, bol√≠grafos o material de oficina, clasif√≠calo como 'papeleria'.
    26. **Regla de Arte y Manualidades:** Si son materiales para hobbies creativos (pintura, arcilla, kits), clasif√≠calo como 'arte'.
    27. **Regla de Sostenible y Eco:** Si el principal atractivo del producto es que es ecol√≥gico o sostenible, clasif√≠calo como 'eco'.
    28. **Regla de Gourmet y Vinos:** Si son productos de alimentaci√≥n de alta gama (jam√≥n ib√©rico, vinos, aceites premium), clasif√≠calo como 'gourmet'.
    29. **Regla de Comida:** Si son productos de alimentaci√≥n general no gourmet, clasif√≠calo como 'comida'.
    30. **Regla de Hogar:** Si son objetos de decoraci√≥n o textiles para el hogar no incluidos antes, clasif√≠calo como 'hogar'.

    **--- NIVEL 5: CATEGOR√çA POR DEFECTO ---**
    31. **Regla Final:** Si ninguna de las reglas anteriores aplica, clasif√≠calo como 'otros'.
- **Confianza:** Eval√∫a tu certeza sobre la extracci√≥n de la FECHA (0.0 a 1.0). Si la fecha es expl√≠cita y clara, usa 1.0. Si es deducida o ambigua, usa un valor inferior.
</REGLAS_ADICIONALES_DE_EXTRACCION>

<EJEMPLOS_GUIADOS_DE_ALTA_PRECISION>
A continuaci√≥n se presentan ejemplos de an√°lisis para calibrar tu l√≥gica y asegurar la m√°xima precisi√≥n. La fecha de referencia para estos ejemplos es 28 de agosto de 2025.

<EJEMPLO_1: Prioridad 1 - Fecha con Hora Espec√≠fica y Prioritaria>
- Texto de entrada: "¬°Sorteamos un pack gaming! Para participar, sigue a @techstore y @gamerzone. Tienes hasta el 15 de septiembre a las 20:00h para apuntarte."
- JSON de salida esperado:
{
  "prize": "Pack gaming",
  "accounts": ["@techstore", "@gamerzone"],
  "date": "2025-09-15",
  "price": null,
  "ends_at_time": "20:00h",
  "is_priority_time": true,
  "status": "valid",
  "is_spanish": true,
  "prize_category": "gaming",
  "winner_count": 1,
  "confidence_score": 1.0
}
</EJEMPLO_1>

<EJEMPLO_2: Prioridad 1 - Fecha con Hora Est√°ndar de Fin de D√≠a>
- Texto de entrada: "Gana un viaje a Roma para dos personas. Sigue a @viajesporelmundo. El sorteo finaliza el 30 de agosto a las 23:59h."
- JSON de salida esperado:
{
  "prize": "Viaje a Roma para dos personas",
  "accounts": ["@viajesporelmundo"],
  "date": "2025-08-30",
  "price": null,
  "ends_at_time": "23:59h",
  "is_priority_time": false,
  "status": "valid",
  "is_spanish": true,
  "prize_category": "viajes",
  "winner_count": 1,
  "confidence_score": 1.0
}
</EJEMPLO_2>

<EJEMPLO_3: Prioridad 2 - Conflicto de Fechas (Cierre vs Anuncio)>
- Texto de entrada: "¬°Sorteo de una pala de p√°del Siux! Sigue a @padelpro. El plazo para participar termina el d√≠a 10 de octubre. Anunciaremos al ganador el 11 de octubre."
- JSON de salida esperado:
{
  "prize": "Pala de p√°del Siux",
  "accounts": ["@padelpro"],
  "date": "2025-10-10",
  "price": null,
  "ends_at_time": null,
  "is_priority_time": false,
  "status": "valid",
  "is_spanish": true,
  "prize_category": "padel",
  "winner_count": 1,
  "confidence_score": 1.0
}
</EJEMPLO_3>

<EJEMPLO_4: Prioridad 3 - Regla de Fecha √önica (D√≠a Anterior)>
- Texto de entrada: "¬°Ll√©vate a casa esta cesta de productos de belleza! Sigue a @cosmeticsymas. Los ganadores se anunciar√°n el d√≠a 25 de septiembre."
- JSON de salida esperado:
{
  "prize": "Cesta de productos de belleza",
  "accounts": ["@cosmeticsymas"],
  "date": "2025-09-24",
  "price": null,
  "ends_at_time": null,
  "is_priority_time": false,
  "status": "valid",
  "is_spanish": true,
  "prize_category": "belleza",
  "winner_count": 1,
  "confidence_score": 0.9
}
</EJEMPLO_4>

<EJEMPLO_5: Caso Especial - Sorteo Expirado>
- Texto de entrada: "Sorteo express: Gana un Funko Pop de Harry Potter. Sigue a @frikitienda. ¬°El sorteo finaliza el 27 de agosto!"
- JSON de salida esperado:
{
  "prize": "Funko Pop de Harry Potter",
  "accounts": ["@frikitienda"],
  "date": "2025-08-26",
  "price": null,
  "ends_at_time": null,
  "is_priority_time": false,
  "status": "expired",
  "is_spanish": true,
  "prize_category": "frikis",
  "winner_count": 1,
  "confidence_score": 0.9
}
</EJEMPLO_5>

<EJEMPLO_6: Prioridad 4 - Sin Fecha V√°lida>
- Texto de entrada: "Sorteamos un lote de productos para el hogar. Para participar solo tienes que seguir a @limpiohogar y mencionar a dos amigos. ¬°Mucha suerte!"
- JSON de salida esperado:
{
  "prize": "Lote de productos para el hogar",
  "accounts": ["@limpiohogar"],
  "date": null,
  "price": null,
  "ends_at_time": null,
  "is_priority_time": false,
  "status": "no_date",
  "is_spanish": true,
  "prize_category": "hogar",
  "winner_count": 1,
  "confidence_score": 0.0
}
</EJEMPLO_6>

<EJEMPLO_7: Caso Especial - No es un Sorteo>
- Texto de entrada: "¬°Nuevas zapatillas Nike ya en tienda! P√°sate por @streetwearshop y descubre la colecci√≥n."
- JSON de salida esperado:
{
  "status": "not_a_giveaway"
}
</EJEMPLO_7>

</EJEMPLOS_GUIADOS_DE_ALTA_PRECISION>

<FORMATO_DE_SALIDA_ESTRICTO>
Tu respuesta debe ser √∫nica y exclusivamente el siguiente objeto JSON, sin texto adicional ni formato Markdown.
{
  "prize": "string | null",
  "accounts": ["string"],
  "date": "string ('YYYY-MM-DD') | null",
  "price": "string | null",
  "ends_at_time": "string | null",
  "is_priority_time": boolean,
  "is_spanish": boolean,
  "status": "string ('valid', 'expired', 'no_date', 'not_a_giveaway')",
  "prize_category": "string ('padel', 'motor', 'mascotas', 'bebes', 'bodas', 'dinero', 'viajes', 'ocio', 'aventura', 'suscripciones', 'gaming', 'foto', 'musica', 'deporte', 'libros', 'frikis', 'joyeria', 'accesorios', 'moda', 'belleza', 'salud', 'electrodomesticos', 'cocina', 'bricolaje', 'jardineria', 'papeleria', 'arte', 'eco', 'gourmet', 'comida', 'hogar', 'otros')",
  "winner_count": integer (por defecto 1),
  "confidence_score": float
}
</FORMATO_DE_SALIDA_ESTRICTO>
`;
            
            let resultData;
            try {
                const aiData = await callGeminiAPI(base64Data, dynamicPrompt);
                
                // --- [NUEVA L√ìGICA DE DECISI√ìN CON DOBLE FILTRO] ---
                const accounts = (aiData.accounts || []).map(acc => `@${acc.replace('@', '')}`);

                // 1. Comprobamos tu cortafuegos manual primero
                const manuallyBlocked = accounts.some(acc => foreignAccounts.includes(acc));

                // 2. Tomamos la decisi√≥n final
                if (aiData.status === 'not_a_giveaway') {
                     resultData = { prize: 'No es un sorteo', status: 'not_a_giveaway', originalFile: file };
                
                } else if (aiData.is_spanish === false || manuallyBlocked) {
                    // Si la IA dice que no es v√°lido O si una cuenta est√° en tu lista negra, se descarta.
                    resultData = { ...aiData, accounts, status: 'foreign', originalFile: file };
                
                } else if (!aiData.date) {
                    resultData = { ...aiData, status: 'no_date', originalFile: file };
                
                } else {
                    // Si pasa ambos filtros, el sorteo es V√ÅLIDO. Procedemos con las comprobaciones de siempre.
                    const giveawayDate = new Date(aiData.date);
                    const isExpired = giveawayDate < new Date(new Date().toDateString());
                    const existingGiveaway = isDuplicateGiveaway({ ...aiData, accounts });
                    
                    let priceInfo = { prize: aiData.prize, value: aiData.price, url: null };
                    if (!aiData.price) {
                        priceInfo = await searchPrizeValue(aiData);
                    }

                    if (existingGiveaway) {
                        resultData = { ...aiData, price: priceInfo.value, url: priceInfo.url, prize: priceInfo.prize, accounts, status: 'duplicate', originalGiveaway: existingGiveaway, originalFile: file };
                    } else if (isExpired) {
                        resultData = { ...aiData, price: priceInfo.value, url: priceInfo.url, prize: priceInfo.prize, accounts, status: 'expired', originalFile: file };
                    } else {
                        resultData = { ...aiData, price: priceInfo.value, url: priceInfo.url, prize: priceInfo.prize, accounts, status: 'valid', originalFile: file };
                    }
                }
            } catch (error) {
                console.error(`Error al analizar la imagen ${file.name}:`, error);
                resultData = { prize: 'Error de an√°lisis', status: 'api_error', error: error.message, originalFile: file };
                if (file) {
                    giveawaysWithErrors.push(file);
                }
            }
            
            renderInteractiveCard(resultData);
        };
        reader.readAsDataURL(file);
    }

    function renderInteractiveCard(resultData) {
        liveResultsContainer.innerHTML = '';
        let cardHTML = '';
        let title = '';
        let cardStatusClass = '';
        let buttonsHTML = '';

        const prize = resultData.prize || '';
        const date = resultData.date || '';
        const accounts = (resultData.accounts || []).join(', ');
        const price = resultData.price || 'No encontrado';

        const categoryOptionsHTML = Object.keys(CATEGORY_INFO)
            .filter(key => key !== 'all') // Excluimos la opci√≥n "Todas"
            .map(key => {
                const category = CATEGORY_INFO[key];
                // Marcamos como seleccionada la categor√≠a que ha devuelto la IA
                const isSelected = key === resultData.prize_category ? 'selected' : '';
                return `<option value="${key}" ${isSelected}>${category.emoji} ${category.name}</option>`;
            })
            .join('');

        const formHTML = `
            <div class="interactive-card-form space-y-2">
                <div>
                    <label for="interactive-prize">Premio:</label>
                    <input type="text" id="interactive-prize" value="${prize}" disabled>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label for="interactive-date">Fecha:</label>
                        <input type="date" id="interactive-date" value="${date}" disabled>
                    </div>
                    <div>
                        <label for="interactive-price">Valor:</label>
                        <input type="text" id="interactive-price" value="${price}" disabled>
                    </div>
                </div>
                <div>
                    <label for="interactive-category">Categor√≠a:</label>
                    <select id="interactive-category" class="w-full p-2 rounded-lg bg-white border border-yellow-400" disabled>
                        ${categoryOptionsHTML}
                    </select>
                </div>
                <div>
                    <label for="interactive-accounts">Cuentas:</label>
                    <textarea id="interactive-accounts" rows="2" disabled>${accounts}</textarea>
                </div>
            </div>
        `;
        
        switch(resultData.status) {
            case 'valid':
                const confidenceEmoji = getConfidenceEmoji(resultData.confidence_score);
                title = `‚úÖ Sorteo V√°lido ${confidenceEmoji}`;
                cardStatusClass = 'card-status-valid';
                buttonsHTML = `<button id="btn-edit" class="btn-edit">Editar</button><button id="btn-save" class="btn-save">Guardar</button>`;
                cardHTML = `
                <div id="current-interactive-card" class="interactive-card ${cardStatusClass}">
                    <h3 class="card-title">${title}</h3>
                    ${formHTML}
                    <div class="interactive-card-actions">
                        ${buttonsHTML}
                    </div>
                </div>
            `;
                break;
            case 'duplicate':
                title = 'Comparar Sorteos Duplicados';
                cardStatusClass = 'card-status-duplicate';
                buttonsHTML = `<button id="btn-merge" class="btn-merge">Fusionar</button><button id="btn-add-new" class="btn-save">A√±adir como Nuevo</button><button id="btn-discard" class="btn-discard">Descartar</button>`;
                
                const analyzedGiveawayHTML = generateGiveawayDetailsHTML(resultData, "Sorteo Analizado (Nuevo)");
                const originalGiveawayHTML = generateGiveawayDetailsHTML(resultData.originalGiveaway, "Sorteo Original (Existente)");

                cardHTML = `
                    <div id="current-interactive-card" class="interactive-card ${cardStatusClass}">
                        <h3 class="card-title">${title}</h3>
                        <div class="space-y-4 mb-4">
                            ${analyzedGiveawayHTML}
                            ${originalGiveawayHTML}
                        </div>
                        <div class="interactive-card-actions">
                            ${buttonsHTML}
                        </div>
                    </div>
                `;
                break;
            case 'expired':
                const confidenceEmojiExpired = getConfidenceEmoji(resultData.confidence_score);
                title = `‚è≥ Sorteo Caducado ${confidenceEmojiExpired}`;
                cardStatusClass = 'card-status-expired';
                buttonsHTML = `<button id="btn-edit" class="btn-edit">Editar Fecha</button><button id="btn-trash" class="btn-trash">A la Papelera</button>`;
                cardHTML = `
                <div id="current-interactive-card" class="interactive-card ${cardStatusClass}">
                    <h3 class="card-title">${title}</h3>
                    ${formHTML}
                    <div class="interactive-card-actions">
                        ${buttonsHTML}
                    </div>
                </div>
            `;
                break;
            case 'foreign':
                const confidenceEmojiForeign = getConfidenceEmoji(resultData.confidence_score);
                title = `üëΩ Sorteo Extranjero ${confidenceEmojiForeign}`;
                cardStatusClass = 'card-status-foreign';
                buttonsHTML = `<button id="btn-edit" class="btn-edit">Editar</button><button id="btn-mark-foreign" class="btn-foreign">Marcar como Extranjero</button>`;
                cardHTML = `
                <div id="current-interactive-card" class="interactive-card ${cardStatusClass}">
                    <h3 class="card-title">${title}</h3>
                    ${formHTML}
                    <div class="interactive-card-actions">
                        ${buttonsHTML}
                    </div>
                </div>
            `;
                break;
            default:
                title = `‚ùå ${resultData.status === 'not_a_giveaway' ? 'No es un Sorteo' : resultData.status === 'no_date' ? 'Sin Fecha V√°lida' : 'Error de An√°lisis'}`;
                cardStatusClass = 'card-status-error';
                buttonsHTML = `<button id="btn-discard" class="btn-discard w-full">Descartar y Continuar</button>`;
                cardHTML = `
                <div id="current-interactive-card" class="interactive-card ${cardStatusClass}">
                    <h3 class="card-title">${title}</h3>
                    <p class="text-center p-4">${resultData.prize}</p>
                    <div class="interactive-card-actions">
                        ${buttonsHTML}
                    </div>
                </div>
            `;
                break;
        }

        liveResultsContainer.innerHTML = cardHTML;
        
        if (resultData.status !== 'not_a_giveaway' && resultData.status !== 'api_error' && resultData.status !== 'duplicate') {
            typewriterEffect(document.getElementById('interactive-prize'), prize);
            typewriterEffect(document.getElementById('interactive-accounts'), accounts);
        }

        const actionsContainer = liveResultsContainer.querySelector('.interactive-card-actions');
        if (actionsContainer) {
            actionsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                if (button.id === 'btn-edit') {
                    const card = button.closest('.interactive-card');
                    const inputs = card.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => input.disabled = false);
                    button.textContent = 'Guardar Cambios';
                    button.id = 'btn-save';
                    button.classList.remove('btn-edit');
                    button.classList.add('btn-save');
                    return; 
                }

                let action = '';
                switch(button.id) {
                    case 'btn-save': action = 'save'; break;
                    case 'btn-merge': action = 'merge'; break;
                    case 'btn-add-new': action = 'add-new'; break;
                    case 'btn-discard': action = 'discard'; break;
                    case 'btn-trash': action = 'trash'; break;
                    case 'btn-mark-foreign': action = 'mark-foreign'; break;
                }
                if (action) {
                    handleUserDecisionAndProceed(action, resultData);
                }
            });
        }
    }
    
    function handleUserDecisionAndProceed(action, data) {
        const card = document.getElementById('current-interactive-card');
        let editedData = { ...data };
        if (card && card.querySelector('.interactive-card-form')) {
            editedData.prize = document.getElementById('interactive-prize').value;
            editedData.date = document.getElementById('interactive-date').value;
            editedData.accounts = document.getElementById('interactive-accounts').value.split(',').map(acc => acc.trim()).filter(Boolean);
            editedData.price = document.getElementById('interactive-price').value;
            editedData.prize_category = document.getElementById('interactive-category').value;
        }
        
        switch(action){
            case 'save':
            case 'add-new':
                const newGiveaway = { 
                    id: Date.now().toString(), // Generamos el ID aqu√≠
                    date: editedData.date, 
                    prize: editedData.prize, 
                    accounts: editedData.accounts, 
                    price: editedData.price, 
                    url: editedData.url, 
                    addDate: new Date().toISOString().slice(0, 10),
                    ends_at_time: editedData.ends_at_time,
                    is_priority_time: editedData.is_priority_time,
                    prize_category: editedData.prize_category
                };
                
                // VALIDACI√ìN
                if (!newGiveaway.date || !newGiveaway.prize) {
                    showNotification('Error', 'Faltan la fecha o el premio para guardar el sorteo.');
                    return; // Detenemos la ejecuci√≥n aqu√≠
                }
                
                // Guardamos el sorteo con su nuevo ID en el array de resultados
                analysisResults.added.push(newGiveaway);

                // Y a√±adimos ESE MISMO sorteo al calendario
                addGiveaway(newGiveaway);

                addPoints(5, `Sorteo a√±adido con IA`);
                checkAchievements('add-ai');
                break;
            case 'trash':
                trashGiveaways.push({ ...editedData, id: Date.now().toString(), originalDate: editedData.date });
                analysisResults.expired.push(editedData);
                saveTrashGiveaways();
                break;
            case 'mark-foreign':
                discardedGiveaways.push({ ...editedData, id: Date.now().toString(), status: 'foreign' });
                analysisResults.foreign.push(editedData);
                editedData.accounts.forEach(acc => { if (acc && !foreignAccounts.includes(acc)) foreignAccounts.push(acc) });
                saveDiscardedGiveaways();
                saveForeignAccounts();
                checkAchievements('block-foreign');
                break;
            case 'merge':
                const original = Object.values(giveaways).flat().find(g => g.id === data.originalGiveaway.id);
                if (original) {
                    if (!original.price && editedData.price) original.price = editedData.price;
                    if (editedData.prize.length > original.prize.length) original.prize = editedData.prize;
                    saveGiveaways();
                    showNotification('Fusi√≥n completada', 'Se han actualizado los datos del sorteo original.');
                    checkAchievements('merge');
                }
                analysisResults.duplicate.push(editedData);
                break;
            case 'discard':
                if (data.status === 'no_date' || data.status === 'not_a_giveaway' || data.status === 'duplicate') {
                     discardedGiveaways.push({ ...data, id: Date.now().toString() });
                     analysisResults[data.status].push(editedData);
                     saveDiscardedGiveaways();
                } else if (data.status === 'api_error') {
                    analysisResults.api_error.push(editedData);
                }
                break;
        }
        
        updateAnalysisLegend();
        currentIndex++;
        processNextImage();
    }
    
    function showAISummary() {
        interactiveAnalysisContainer.style.display = 'none';
        aiSummaryView.style.display = 'flex';

        const totalAdded = analysisResults.added.length;
        const totalDuplicates = analysisResults.duplicate.length;
        const totalExpired = analysisResults.expired.length;
        const totalForeign = analysisResults.foreign.length;
        const totalErrors = analysisResults.api_error.length + analysisResults.no_date.length + analysisResults.not_a_giveaway.length;

        const historyEntry = {
            analysisDate: new Date().toISOString(),
            totalCaptures,
            addedGiveawaysCount: totalAdded,
            duplicateGiveawaysCount: totalDuplicates,
            expiredGiveawaysCount: totalExpired,
            foreignGiveawaysCount: totalForeign,
            noDateGiveawaysCount: analysisResults.no_date.length,
            addedGiveawaysDetails: analysisResults.added.map(g => ({ prize: g.prize, id: g.id })),
            failedFilesDetails: analysisResults.api_error.map(e => ({ filename: e.originalFile.name, error: e.error }))
        };
        analysisHistory.push(historyEntry);
        analysisHistory = analysisHistory.slice(-20);
        saveAnalysisHistory();
        
        // --- INICIO DE MODIFICACI√ìN PARA GUARDAR LOTE DE CAPTURA ---
        if (analysisResults.added.length > 0) {
            const now = new Date();
            const newBatch = {
                id: now.getTime(),
                name: `An√°lisis del ${now.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}`,
                giveawayIds: analysisResults.added.map(g => g.id)
            };

            captureBatches.push(newBatch); // <-- CORREGIDO
            
            // Limitamos el historial a los √∫ltimos 30 lotes para no sobrecargar
            if (captureBatches.length > 30) { // <-- CORREGIDO
                captureBatches = captureBatches.slice(-30); // <-- CORREGIDO
            }
            
            saveCaptureBatches(); // Guardamos el nuevo estado de los lotes
        }
        // --- FIN DE MODIFICACI√ìN ---

        let summaryHTML = `
            <div class="space-y-4 text-yellow-300 w-full">
                <h3 class="text-2xl font-bold text-center">‚ú® Resumen del An√°lisis</h3>
                <ul class="space-y-2 text-lg">
                    <li class="flex items-center gap-2"><i class="fa-solid fa-image text-yellow-500 w-6 text-center"></i> Im√°genes Procesadas: <strong>${totalCaptures}</strong></li>
                    <li class="flex items-center gap-2"><i class="fa-solid fa-circle-check text-green-500 w-6 text-center"></i> Sorteos A√±adidos: <strong>${totalAdded}</strong></li>
                    <li class="flex items-center gap-2"><i class="fa-solid fa-copy text-gray-400 w-6 text-center"></i> Duplicados: <strong>${totalDuplicates}</strong></li>
                    <li class="flex items-center gap-2"><i class="fa-solid fa-clock text-yellow-600 w-6 text-center"></i> Caducados: <strong>${totalExpired}</strong></li>
                    <li class="flex items-center gap-2"><i class="fa-solid fa-globe text-blue-400 w-6 text-center"></i> Extranjeros: <strong>${totalForeign}</strong></li>
                    <li class="flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation text-red-500 w-6 text-center"></i> Errores: <strong>${totalErrors}</strong></li>
                </ul>
            </div>
        `;
        
        aiSummaryResultsContainer.innerHTML = summaryHTML;
        
        if (giveawaysWithErrors.length > 0) {
             retryFailedBtn.style.display = 'block';
        } else {
             retryFailedBtn.style.display = 'none';
        }
        
        renderCalendar();
        
        // --- INICIO DE MODIFICACI√ìN PARA ENV√çO SEMI-AUTOM√ÅTICO DE LOTE ---
        if (totalAdded > 0) {
            // Retrasamos ligeramente el mensaje para que el usuario vea primero el resumen.
            setTimeout(() => {
                const confirmationMessage = `üîÆ ¬°El Or√°culo ha Hablado! üîÆ\n\n¬°An√°lisis completado! Has a√±adido con √©xito ${totalAdded} nuevo(s) tesoro(s) a tu mapa privado.\n\nTienes en tus manos un valioso bot√≠n. ¬øQuieres compartirlo con la comunidad de cazadores?\n\nSi pulsas 'Aceptar', se abrir√° tu correo para enviar este lote al Hechicero Mayor (admin) y que pueda hacerlo p√∫blico para todos. Si no, seguir√° siendo tu secreto.\n\n¬øEnviamos el informe al torre√≥n del Hechicero?`;
                
                if (confirm(confirmationMessage)) {
                    const subject = 'Sugerencia de Nuevo Lote de Sorteos';
                    // Usamos JSON.stringify con indentaci√≥n para que el correo sea legible
                    const body = `Hola, aqu√≠ tienes un nuevo lote de sorteos para a√±adir a la base de datos p√∫blica:\n\n${JSON.stringify(analysisResults.added, null, 2)}`;
                    
                    // Creamos y abrimos el enlace mailto:
                    window.location.href = `mailto:admin@misorteos.es?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                }
            }, 500); // 500ms de retraso
        }
        // --- FIN DE MODIFICACI√ìN ---
    }
    
    const generateErrorCardHTML = (errorData) => {
         return `
             <div class="giveaway-card bg-red-100/50 border-red-400">
                 <h3 class="text-red-800">‚ö†Ô∏è Error en el archivo: ${errorData.filename}</h3>
                 <p class="text-sm"><strong>Motivo:</strong> ${errorData.error}</p>
             </div>
         `;
    };

    const renderHistoryModal = () => {
        historyModalBody.innerHTML = '';
        if (analysisHistory.length === 0) {
            historyModalBody.innerHTML = '<p class="text-center">No hay an√°lisis guardados en el historial.</p>';
            return;
        }

        [...analysisHistory].reverse().forEach(summary => {
            const date = new Date(summary.analysisDate);
            const formattedDate = date.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const totalDiscarded = (summary.duplicateGiveawaysCount || 0) + (summary.expiredGiveawaysCount || 0) + (summary.foreignGiveawaysCount || 0) + (summary.noDateGiveawaysCount || 0);
            let summaryHTML = `<details class="mb-4"><summary class="font-bold text-lg cursor-pointer">An√°lisis del ${formattedDate}</summary>`;
            summaryHTML += `<div class="p-2 border-t border-yellow-600/20 mt-2">`;
            summaryHTML += `<h3 class="text-lg font-bold mb-2">‚ú® Resumen General</h3><ul><li>Im√°genes Enviadas: <strong>${summary.totalCaptures}</strong></li><li>‚úÖ Sorteos A√±adidos: <strong>${summary.addedGiveawaysCount}</strong></li><li>‚ùå Sorteos Descartados: <strong>${totalDiscarded}</strong></li><li>‚ö†Ô∏è Errores de An√°lisis: <strong>${(summary.failedFilesDetails || []).length}</strong></li></ul><hr class="border-yellow-500/20 my-4">`;
            if (summary.addedGiveawaysDetails && summary.addedGiveawaysDetails.length > 0) {
                summaryHTML += `<h4 class="text-md font-bold mb-2">‚úÖ Sorteos A√±adidos</h4><ul>${summary.addedGiveawaysDetails.map(g => `<li><strong>${g.prize}</strong></li>`).join('')}</ul><hr class="border-yellow-500/20 my-4">`;
            }
             if (totalDiscarded > 0) {
                summaryHTML += `<h4 class="text-md font-bold mb-2">‚ùå Desglose de Descartados</h4>`;
                if (summary.duplicateGiveawaysCount > 0) { summaryHTML += `<p><strong>üìã Duplicados:</strong> ${summary.duplicateGiveawaysCount}</p>`; }
                if (summary.expiredGiveawaysCount > 0) { summaryHTML += `<p><strong>üìÖ Caducados:</strong> ${summary.expiredGiveawaysCount}</p>`; }
                if (summary.foreignGiveawaysCount > 0) { summaryHTML += `<p><strong>üåê Extranjeros:</strong> ${summary.foreignGiveawaysCount}</p>`; }
                if ((summary.noDateGiveawaysCount || 0) > 0) { summaryHTML += `<p><strong>‚ùì Sin Fecha:</strong> ${summary.noDateGiveawaysCount}</p>`; }
            }
            summaryHTML += `</div></details>`;
            historyModalBody.innerHTML += summaryHTML;
        });
    };

    async function callGeminiAPI(base64Data, dynamicPrompt) {
        const functionUrl = '/.netlify/functions/gemini';
        const payload = { base64Data, dynamicPrompt };
        try {
            const response = await fetch(functionUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Error en la funci√≥n de Netlify');
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                const text = result.candidates[0].content.parts[0].text;
                const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(cleanText);
            } else {
                console.error("Respuesta inv√°lida de la API de Visi√≥n:", result);
                let errorMessage = "Respuesta incompleta o inv√°lida de la API de Visi√≥n.";
                if (result.promptFeedback && result.promptFeedback.blockReason) {
                    errorMessage = `Bloqueado por seguridad: ${result.promptFeedback.blockReason}`;
                }
                throw new Error(errorMessage);
            }
        } catch (error) {
            console.error("Error al llamar a la funci√≥n de Netlify:", error);
            showNotification('Error de An√°lisis', 'No se pudo conectar con el servicio de IA. Int√©ntalo de nuevo.');
            throw error;
        }
    }

    async function searchPrizeValue(aiData) {
    const cleanedPrize = aiData.prize ? aiData.prize.trim() : '';
    const accounts = (aiData.accounts || []).map(acc => acc.replace('@',''));
    if (!cleanedPrize) return { prize: aiData.prize, value: "No encontrado", url: null };
    
    const functionUrl = '/.netlify/functions/search';
    try {
        const response = await fetch(functionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: cleanedPrize, accounts: accounts })
        });
        if (!response.ok) {
            throw new Error('La respuesta de la funci√≥n de b√∫squeda no fue OK');
        }
        
        const data = await response.json();
        
        let prizeWithEmoji = aiData.prize;
        let numericValue = null;
        if (data.value && data.value !== "No encontrado") {
            numericValue = parseFloat(String(data.value).replace(/[^0-9,.]/g, '').replace(',', '.'));
        }
        
        const categoryMap = {
            'padel': 'ü•é', 'viajes': 'üõ©Ô∏è', 'frikis': 'üÉè', 'moda': 'üë†', 
            'belleza': 'üíÑ', 'hogar': 'üè†', 'tecnologia': 'üíª', 'comida': 'üçî',
            'ocio': 'üéüÔ∏è', 'deporte': 'üí™', 'infantil': 'üß∏', 'mascotas': 'üêæ',
            'dinero': 'üí∞', 'libros': 'üìö', 'motor': 'üöó'
        };

        if(categoryMap[aiData.prize_category]) {
            prizeWithEmoji += ` ${categoryMap[aiData.prize_category]}`;
        }

        if (!isNaN(numericValue) && numericValue > 500) {
            prizeWithEmoji += ' üí≤';
        }
        
        return { prize: prizeWithEmoji, value: data.value, url: data.url };

    } catch (error) {
        console.error("Error en la b√∫squeda del valor:", error);
        return { prize: aiData.prize, value: "No encontrado", url: null };
    }
}
    const deleteGiveawayFromCalendar = (dateStr, giveawayId) => { if (giveaways[dateStr]) { const giveawayToTrash = giveaways[dateStr].find(g => g.id === giveawayId); if (giveawayToTrash) { trashGiveaways.push({...giveawayToTrash, originalDate: dateStr}); saveTrashGiveaways(); giveaways[dateStr] = giveaways[dateStr].filter(g => g.id !== giveawayId); if (giveaways[dateStr].length === 0) delete giveaways[dateStr]; saveGiveaways(); renderCalendar(); closeModal(); } } };
    
    const deleteForeignGiveaway = (dateStr, giveawayId) => {
        if (giveaways[dateStr]) {
            const giveawayToDiscard = giveaways[dateStr].find(g => g.id === giveawayId);
            if (giveawayToDiscard) {
                discardedGiveaways.push({...giveawayToDiscard, status: 'foreign', originalDate: dateStr});
                const accountsToBlock = giveawayToDiscard.accounts;
                accountsToBlock.forEach(acc => {
                    if (acc && !foreignAccounts.includes(acc)) {
                        foreignAccounts.push(acc);
                    }
                });
                saveDiscardedGiveaways();
                saveForeignAccounts();
                giveaways[dateStr] = giveaways[dateStr].filter(g => g.id !== giveawayId);
                if (giveaways[dateStr].length === 0) {
                    delete giveaways[dateStr];
                }
                saveGiveaways();
                renderCalendar();
                closeModal();
                showNotification('Sorteo marcado como extranjero', 'Las cuentas asociadas se han a√±adido al cortafuegos.');
                checkAchievements('block-foreign');
            }
        }
    };

    const renderTrashModal = () => { trashModalBody.innerHTML = ''; if (trashGiveaways.length === 0) { trashModalBody.innerHTML = '<p>No hay sorteos en la papelera.</p>'; return; } trashGiveaways.forEach(giveaway => { const itemContainer = document.createElement('div'); itemContainer.className = 'p-3 bg-yellow-100/50 rounded-lg shadow-inner flex justify-between items-center border border-yellow-600/20'; itemContainer.innerHTML = `<div class="w-full"><p class="text-base sm:text-lg">${giveaway.prize}</p><p class="text-sm">Fecha original: ${giveaway.originalDate}</p></div><button class="restore-btn ml-4 bg-yellow-500 text-yellow-900 p-2 rounded-full hover:bg-yellow-400" data-giveaway-id="${giveaway.id}"><i class="fa-solid fa-rotate-left"></i></button>`; trashModalBody.appendChild(itemContainer); }); };
    const restoreGiveawayFromTrash = (giveawayId) => { const giveawayToRestore = trashGiveaways.find(g => g.id === giveawayId); if (giveawayToRestore) { trashGiveaways = trashGiveaways.filter(g => g.id !== giveawayId); openAddGiveawayModal({ date: giveawayToRestore.originalDate, prize: giveawayToRestore.prize, accounts: giveawayToRestore.accounts.join(', '), price: giveawayToRestore.price }); saveTrashGiveaways(); renderTrashModal(); checkAchievements('restore'); } };
    const deleteAllTrash = () => { if(confirm("¬øEst√°s seguro de que quieres vaciar la papelera? Esta acci√≥n no se puede deshacer.")) { trashGiveaways = []; saveTrashGiveaways(); renderTrashModal(); showNotification('Papelera vaciada', 'Se han eliminado todos los sorteos de la papelera.'); } }
    const deleteAllDiscarded = () => { if(confirm("¬øEst√°s seguro de que quieres eliminar todos los sorteos descartados?")) { discardedGiveaways = []; saveDiscardedGiveaways(); renderDiscardedModal(); showNotification('Sorteos descartados eliminados', 'Se han eliminado todos los sorteos de la lista de descartados.'); } }
    const deleteDiscardedGiveaway = (giveawayId) => { discardedGiveaways = discardedGiveaways.filter(g => g.id !== giveawayId); saveDiscardedGiveaways(); renderDiscardedModal(); }

    const showDuplicateComparisonModal = (discardedGiveaway) => {
        const originalGiveawayData = discardedGiveaway.originalGiveaway;
        if (!originalGiveawayData) {
            console.error("No se encontr√≥ el sorteo original para comparar.");
            return;
        }

        let originalGiveawayComplete = null;
        let originalDate = null;
        for (const date in giveaways) {
            const found = giveaways[date].find(g => g.id === originalGiveawayData.id);
            if (found) {
                originalGiveawayComplete = found;
                originalDate = date;
                break;
            }
        }
        
        if (!originalGiveawayComplete) {
            showNotification('Error', 'El sorteo original ya no existe en el calendario.');
            return;
        }

        const generateDetailsHTML = (giveaway, date) => {
             const accountsHTML = (giveaway.accounts || []).map(acc => `<a href="https://instagram.com/${acc.replace('@', '')}" target="_blank" class="hover:underline">${acc}</a>`).join(', ');
             return `
                <div class="detail-item mb-2"><strong>Premio:</strong> ${giveaway.prize || 'N/A'}</div>
                <div class="detail-item mb-2"><strong>Cuentas:</strong> ${accountsHTML || 'N/A'}</div>
                <div class="detail-item mb-2"><strong>Valor:</strong> ${giveaway.price || 'N/A'}</div>
                <div class="detail-item"><strong>Fecha del Sorteo:</strong> ${date || 'No encontrada'}</div>
             `;
        };

        originalGiveawayDetails.innerHTML = generateDetailsHTML(originalGiveawayComplete, originalDate);
        discardedGiveawayDetails.innerHTML = generateDetailsHTML(discardedGiveaway, discardedGiveaway.date);
        
        mergeGiveawayBtn.dataset.giveawayId = discardedGiveaway.id;
        addAsNewBtn.dataset.giveawayId = discardedGiveaway.id;
        document.getElementById('delete-discarded-comp-btn').dataset.giveawayId = discardedGiveaway.id;
        
        duplicateComparisonModal.classList.add('is-visible');
    };

    const generateGiveawayCardHTML = (giveaway) => {
        const statusClasses = {
            duplicate: 'status-duplicate',
            expired: 'status-expired',
            foreign: 'status-foreign',
            no_date: 'status-no_date',
            not_a_giveaway: 'status-not_a_giveaway',
            api_error: 'status-api_error',
        };
        const statusText = {
            duplicate: 'Duplicado',
            expired: 'Caducado',
            foreign: 'Extranjero',
            no_date: 'Sin Fecha',
            not_a_giveaway: 'No es Sorteo',
            api_error: 'Error API',
        };

        const accountsHTML = (giveaway.accounts || []).map(acc => `<a href="https://instagram.com/${acc.replace('@', '')}" target="_blank" class="hover:underline">${acc}</a>`).join(', ');

        return `
            <div class="giveaway-card text-left">
                <h3>${giveaway.prize || 'Premio no definido'}</h3>
                <div class="giveaway-card-details">
                    ${giveaway.date ? `
                    <div class="detail-item">
                        <i class="fa-solid fa-calendar-day"></i>
                        <span>Fecha: <strong>${giveaway.date}</strong></span>
                    </div>` : ''}
                    ${accountsHTML ? `
                    <div class="detail-item">
                        <i class="fa-solid fa-at"></i>
                        <span>Cuentas: ${accountsHTML}</span>
                    </div>` : ''}
                    ${giveaway.price ? `
                    <div class="detail-item">
                        <i class="fa-solid fa-coins"></i>
                        <span>Valor: <strong>${giveaway.price}</strong></span>
                    </div>` : ''}
                    ${giveaway.status ? `
                    <div class="detail-item">
                        <i class="fa-solid fa-tag"></i>
                        <span class="status-tag ${statusClasses[giveaway.status] || ''}">${statusText[giveaway.status] || giveaway.status}</span>
                    </div>` : ''}
                </div>
                <div class="flex justify-end gap-2 mt-3">
                    <button class="add-discarded-btn text-xs bg-green-500 text-white py-1 px-3 rounded-full hover:bg-green-600" data-giveaway-id="${giveaway.id}"><i class="fa-solid fa-plus mr-1"></i> Recuperar</button>
                    <button class="delete-discarded-btn text-xs bg-red-500 text-white py-1 px-3 rounded-full hover:bg-red-600" data-giveaway-id="${giveaway.id}"><i class="fa-solid fa-trash-can mr-1"></i> Eliminar</button>
                </div>
            </div>
        `;
    };

    const renderTrophyModal = () => {
        trophyModalBody.innerHTML = '';
        if (wonGiveaways.length === 0) {
            trophyModalBody.innerHTML = '<p class="text-center col-span-full">Tu vitrina de trofeos est√° vac√≠a. ¬°Sigue participando!</p>';
            return;
        }

        [...wonGiveaways].reverse().forEach(giveaway => {
            const accountsHTML = (giveaway.accounts || []).map(acc => `<a href="https://instagram.com/${acc.replace('@','')}" target="_blank" class="hover:underline">${acc}</a>`).join(', ');
            const wonDate = giveaway.wonDate ? new Date(giveaway.wonDate).toLocaleDateString('es-ES') : 'Fecha desconocida';
            const trophyCard = `
                <div class="trophy-card">
                    <button class="trophy-delete-btn" data-giveaway-id="${giveaway.id}" title="Eliminar de la vitrina">
                        <i class="fa-solid fa-times"></i>
                    </button>
                    <h3 class="mb-2">${giveaway.prize}</h3>
                    <div class="text-xs space-y-1 text-left">
                        <p><i class="fa-solid fa-coins w-4 mr-1"></i> <strong>Valor:</strong> ${giveaway.price || 'No especificado'}</p>
                        <p><i class="fa-solid fa-at w-4 mr-1"></i> ${accountsHTML}</p>
                        <p><i class="fa-solid fa-calendar-check w-4 mr-1"></i> <strong>Ganado el:</strong> ${wonDate}</p>
                    </div>
                </div>
            `;
            trophyModalBody.innerHTML += trophyCard;
        });
    };
    
    const renderDiscardedModal = () => { 
        discardedModalBody.innerHTML = ''; 
        const filteredGiveaways = discardedGiveaways.filter(g => discardedFilter === 'all' || g.status === discardedFilter); 
        
        if (filteredGiveaways.length === 0) { 
            discardedModalBody.innerHTML = '<p class="text-center">No hay sorteos descartados con este filtro.</p>'; 
            return; 
        } 
        
        [...filteredGiveaways].reverse().forEach(giveaway => { 
            const cardHTML = generateGiveawayCardHTML(giveaway);
            const itemContainer = document.createElement('div');
            itemContainer.className = `giveaway-item-discarded ${giveaway.status === 'duplicate' ? 'duplicate-item' : ''} mb-4`;
            itemContainer.dataset.giveawayId = giveaway.id;
            itemContainer.innerHTML = cardHTML;
            discardedModalBody.appendChild(itemContainer);
        }); 
    };
    
    const renderNewAdditionsModal = () => {
        const batchList = document.getElementById('batch-history-list');
        batchList.innerHTML = ''; // Limpiamos la lista

        if (captureBatches.length === 0) {
            batchList.innerHTML = '<p class="text-center text-yellow-700">A√∫n no has a√±adido sorteos con la IA.</p>';
            return;
        }

        // Mostramos los lotes del m√°s reciente al m√°s antiguo
        [...captureBatches].reverse().forEach(batch => {
            const isActive = batch.id === activeBatchFilterId;
            const item = document.createElement('div');
            item.className = `p-3 rounded-lg shadow-inner border cursor-pointer transition-all ${isActive ? 'bg-yellow-200 border-yellow-400' : 'bg-yellow-100/50 border-yellow-600/20 hover:bg-yellow-200/70'}`;
            item.dataset.batchId = batch.id;
            item.innerHTML = `
                <p class="font-bold text-yellow-900">${batch.name}</p>
                <p class="text-sm text-yellow-800">${batch.giveawayIds.length} sorteo(s) a√±adido(s)</p>
            `;
            batchList.appendChild(item);
        });
    };

    const openDuplicateModal = (discardedGiveaway, originalGiveaway) => {
        const previewContainer = document.getElementById('duplicate-giveaway-info');
        
        const originalCardHTML = generateGiveawayCardHTML({ ...originalGiveaway, date: originalGiveaway.date });
        const discardedCardHTML = generateGiveawayCardHTML(discardedGiveaway);

        previewContainer.innerHTML = `
            <div>
                <h4 class="font-bold text-lg mb-2 text-gray-700">Sorteo Original (Ya guardado)</h4>
                ${originalCardHTML}
            </div>
            <div>
                <h4 class="font-bold text-lg mb-2 text-red-800">Sorteo Descartado (Nuevo)</h4>
                ${discardedCardHTML}
            </div>
        `;
        
        confirmRestoreBtn.dataset.giveawayId = discardedGiveaway.id;
        duplicateModal.classList.add('is-visible');
    };
    const closeDuplicateModal = () => { duplicateModal.classList.remove('is-visible'); };
    const addDiscardedToCalendar = (giveawayId) => { const giveawayToAdd = discardedGiveaways.find(g => g.id === giveawayId); if (giveawayToAdd) { discardedGiveaways = discardedGiveaways.filter(g => g.id !== giveawayId); saveDiscardedGiveaways(); renderDiscardedModal(); openAddGiveawayModal({ date: giveawayToAdd.date || giveawayToAdd.originalDate, prize: giveawayToAdd.prize, accounts: (giveawayToAdd.accounts || []).join(', '), price: giveawayToAdd.price }); } };

    const calculateAndRenderStats = () => {
        const ONE_DAY_MS = 1000 * 60 * 60 * 24;
        const allGiveaways = Object.values(giveaways).flat();
        const allRegisteredGiveaways = [...allGiveaways, ...wonGiveaways];
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const totalRegistered = allRegisteredGiveaways.length;
        const totalCompleted = Object.keys(completedGiveaways).length;
        const totalWon = wonGiveaways.length;
        const totalValueWon = wonGiveaways.reduce((sum, g) => sum + parsePrice(g.price), 0);
        const participationRate = totalRegistered > 0 ? ((totalCompleted / totalRegistered) * 100).toFixed(1) : 0;
        const winRate = totalCompleted > 0 ? ((totalWon / totalCompleted) * 100).toFixed(2) : 0;
        const avgValuePerWin = totalWon > 0 ? (totalValueWon / totalWon).toFixed(2) : 0;
        const prizesWithValues = wonGiveaways.filter(g => parsePrice(g.price) > 0);
        const mostValuableWin = prizesWithValues.length ? prizesWithValues.reduce((max, g) => parsePrice(g.price) > parsePrice(max.price) ? g : max) : null;
        const leastValuableWin = prizesWithValues.length ? prizesWithValues.reduce((min, g) => parsePrice(g.price) < parsePrice(min.price) ? g : min) : null;
        const categoryWins = wonGiveaways.reduce((acc, g) => {
            const prize = g.prize || '';
            if (prize.includes('ü•é')) acc['P√°del ü•é'] = (acc['P√°del ü•é'] || 0) + 1;
            else if (prize.includes('üõ©Ô∏è')) acc['Viajes üõ©Ô∏è'] = (acc['Viajes üõ©Ô∏è'] || 0) + 1;
            else if (prize.includes('üÉè')) acc['Frikis üÉè'] = (acc['Frikis üÉè'] || 0) + 1;
            else acc['Otros'] = (acc['Otros'] || 0) + 1;
            return acc;
        }, {});

        const eficienciaParticipacion = totalWon > 0 ? (totalCompleted / totalWon).toFixed(1) : '‚àû';
        const valorPorParticipacion = totalCompleted > 0 ? (totalValueWon / totalCompleted).toFixed(2) : 0;
        let estiloCazador = "Equilibrado ‚öñÔ∏è";
        if (parseFloat(winRate) > 1.5 && parseFloat(participationRate) < 50) {
            estiloCazador = "Francotirador üéØ";
        } else if (parseFloat(winRate) < 1 && parseFloat(participationRate) > 75) {
            estiloCazador = "Ametralladora üí•";
        }

        const exitosPorValor = { modestos: { wins: 0, completed: 0 }, intermedios: { wins: 0, completed: 0 }, grandes: { wins: 0, completed: 0 } };
        const allCompletedGiveaways = allRegisteredGiveaways.filter(g => completedGiveaways[g.id]);
        allCompletedGiveaways.forEach(g => {
            const value = parsePrice(g.price);
            const isWon = wonGiveaways.some(wg => wg.id === g.id);
            if (value < 50) {
                exitosPorValor.modestos.completed++;
                if (isWon) exitosPorValor.modestos.wins++;
            } else if (value >= 50 && value <= 250) {
                exitosPorValor.intermedios.completed++;
                if (isWon) exitosPorValor.intermedios.wins++;
            } else {
                exitosPorValor.grandes.completed++;
                if (isWon) exitosPorValor.grandes.wins++;
            }
        });
        const tasaExitoModestos = exitosPorValor.modestos.completed > 0 ? ((exitosPorValor.modestos.wins / exitosPorValor.modestos.completed) * 100).toFixed(1) : 0;
        const tasaExitoIntermedios = exitosPorValor.intermedios.completed > 0 ? ((exitosPorValor.intermedios.wins / exitosPorValor.intermedios.completed) * 100).toFixed(1) : 0;
        const tasaExitoGrandes = exitosPorValor.grandes.completed > 0 ? ((exitosPorValor.grandes.wins / exitosPorValor.grandes.completed) * 100).toFixed(1) : 0;
        
        const sorteosCercanos = allRegisteredGiveaways.filter(g => { const diff = (new Date(g.date) - today) / ONE_DAY_MS; return diff >= 0 && diff <= 7; });
        const sorteosLejanos = allRegisteredGiveaways.filter(g => (new Date(g.date) - today) / ONE_DAY_MS > 30);
        const participacionCercanos = sorteosCercanos.filter(g => completedGiveaways[g.id]).length;
        const participacionLejanos = sorteosLejanos.filter(g => completedGiveaways[g.id]).length;
        const tasaParticipacionCercanos = sorteosCercanos.length > 0 ? ((participacionCercanos / sorteosCercanos.length) * 100).toFixed(1) : 0;
        const tasaParticipacionLejanos = sorteosLejanos.length > 0 ? ((participacionLejanos / sorteosLejanos.length) * 100).toFixed(1) : 0;

        const winsLast30Days = wonGiveaways.filter(g => (today - new Date(g.wonDate)) / ONE_DAY_MS <= 30).length;
        const totalDaysWithWins = new Set(wonGiveaways.map(g => new Date(g.wonDate).toDateString())).size;
        const historicalWinRatePerDay = totalDaysWithWins > 30 ? totalWon / totalDaysWithWins : 0;
        const currentWinRatePerDay = winsLast30Days / 30;
        const rachaCaliente = currentWinRatePerDay > historicalWinRatePerDay && winsLast30Days > 0;

        const talismanFrequency = wonGiveaways.flatMap(g => g.accounts || []).reduce((acc, account) => { acc[account] = (acc[account] || 0) + 1; return acc; }, {});
        const topTalismanes = Object.entries(talismanFrequency).sort((a, b) => b[1] - a[1]).slice(0, 3);
        const sorteosPendientesTalismanes = allGiveaways.filter(g => !completedGiveaways[g.id] && g.accounts.some(acc => topTalismanes.map(t => t[0]).includes(acc))).length;
        
        const colaboraciones = {};
        allRegisteredGiveaways.forEach(g => {
            if (g.accounts && g.accounts.length > 1) {
                for (let i = 0; i < g.accounts.length; i++) {
                    for (let j = i + 1; j < g.accounts.length; j++) {
                        const pair = [g.accounts[i], g.accounts[j]].sort().join('|');
                        colaboraciones[pair] = (colaboraciones[pair] || 0) + 1;
                    }
                }
            }
        });
        const topColaboradores = Object.entries(colaboraciones).sort((a, b) => b[1] - a[1]).slice(0, 3);

        const resumenTab = document.getElementById('tab-resumen');
        const rendimientoTab = document.getElementById('tab-rendimiento');
        const estrategiaTab = document.getElementById('tab-estrategia');
        const redesTab = document.getElementById('tab-redes');

        resumenTab.innerHTML = `
            <div class="space-y-4">
                <div>
                    <h3 class="text-xl font-bold text-yellow-700 mb-2 border-b-2 border-yellow-200 pb-1">üìä Resumen General</h3>
                    <ul class="space-y-1">
                        <li>Sorteos Totales Registrados: <strong>${totalRegistered}</strong></li>
                        <li>Sorteos Completados: <strong>${totalCompleted}</strong></li>
                        <li>Sorteos Ganados: <strong>${totalWon}</strong></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-yellow-700 mb-2 border-b-2 border-yellow-200 pb-1">üèÜ Victorias y Premios</h3>
                    <ul class="space-y-1">
                        <li>Valor Total de Premios: <strong>${totalValueWon.toFixed(2)}‚Ç¨</strong></li>
                        <li>Valor Medio por Premio: <strong>${avgValuePerWin}‚Ç¨</strong></li>
                        <li>Premio de M√°s Valor: <strong>${mostValuableWin ? `${mostValuableWin.prize} (${mostValuableWin.price})` : 'N/A'}</strong></li>
                        <li>Premio M√°s Humilde: <strong>${leastValuableWin ? `${leastValuableWin.prize} (${leastValuableWin.price})` : 'N/A'}</strong></li>
                        <li>Victorias por Categor√≠a: <ol class="list-disc list-inside pl-4 text-sm">${Object.entries(categoryWins).map(([cat, count]) => `<li>${cat}: ${count}</li>`).join('') || '<li>N/A</li>'}</ol></li>
                    </ul>
                </div>
            </div>
        `;

        rendimientoTab.innerHTML = `
             <div class="space-y-4">
                <div>
                    <h3 class="text-xl font-bold text-yellow-700 mb-2 border-b-2 border-yellow-200 pb-1">üìà An√°lisis de Rendimiento y Eficiencia</h3>
                    <ul class="space-y-1">
                        <li>Tasa de Participaci√≥n: <strong>${participationRate}%</strong></li>
                        <li>Porcentaje de √âxito (Win Rate): <strong>${winRate}%</strong></li>
                        <li>Eficiencia de Participaci√≥n: <strong>1 victoria cada ${eficienciaParticipacion} participaciones</strong></li>
                        <li>Valor por Participaci√≥n (VPP): <strong>${valorPorParticipacion}‚Ç¨ por cada sorteo completado</strong></li>
                        <li>√çndice de Estilo: <strong>${estiloCazador}</strong></li>
                    </ul>
                </div>
            </div>
        `;

        estrategiaTab.innerHTML = `
            <div class="space-y-4">
                <div>
                    <h3 class="text-xl font-bold text-yellow-700 mb-2 border-b-2 border-yellow-200 pb-1">üéØ An√°lisis Estrat√©gico y de Oportunidad</h3>
                    <ul class="space-y-1">
                        <li><strong>Tasa de √âxito por Valor:</strong>
                            <ol class="list-disc list-inside pl-4 text-sm">
                                <li>Premios < 50‚Ç¨: <strong>${tasaExitoModestos}%</strong></li>
                                <li>Premios 50‚Ç¨ - 250‚Ç¨: <strong>${tasaExitoIntermedios}%</strong></li>
                                <li>Premios > 250‚Ç¨: <strong>${tasaExitoGrandes}%</strong></li>
                            </ol>
                        </li>
                        <li class="pt-2"><strong>An√°lisis de "Fatiga de Calendario":</strong>
                             <ol class="list-disc list-inside pl-4 text-sm">
                                <li>Tasa de participaci√≥n (pr√≥ximos 7 d√≠as): <strong>${tasaParticipacionCercanos}%</strong></li>
                                <li>Tasa de participaci√≥n (> 30 d√≠as): <strong>${tasaParticipacionLejanos}%</strong></li>
                            </ol>
                        </li>
                    </ul>
                </div>
            </div>
        `;
        
        redesTab.innerHTML = `
            <div class="space-y-4">
                <div>
                    <h3 class="text-xl font-bold text-yellow-700 mb-2 border-b-2 border-yellow-200 pb-1">üîÆ An√°lisis Predictivo y de Redes</h3>
                    <ul class="space-y-1">
                        <li>Indicador de "Racha Caliente": <strong class="${rachaCaliente ? 'text-green-500' : 'text-red-500'}">${rachaCaliente ? 'ACTIVADO üî•' : 'INACTIVO'}</strong></li>
                        <li>Radar de "Talismanes Activos": <strong>${sorteosPendientesTalismanes} sorteos pendientes de tus 3 cuentas top</strong></li>
                        <li><strong>Top Colaboradores Frecuentes:</strong>
                             <ol class="list-decimal list-inside pl-4 text-sm">
                                ${topColaboradores.map(c => `<li>${c[0].replace('|', ' & ')} (${c[1]} veces)</li>`).join('') || '<li>N/A</li>'}
                            </ol>
                        </li>
                    </ul>
                </div>
            </div>
        `;
    };
    
    let categoryPieChart = null;
    let monthlyValueBarChart = null;
    let winsGrowthLineChart = null;
    let valueVsAnticipationScatterChart = null;
    let hunterStyleRadarChart = null;
    const renderCharts = () => {
        if (categoryPieChart) categoryPieChart.destroy();
        if (monthlyValueBarChart) monthlyValueBarChart.destroy();
        if (winsGrowthLineChart) winsGrowthLineChart.destroy();
        if (valueVsAnticipationScatterChart) valueVsAnticipationScatterChart.destroy();
        if (hunterStyleRadarChart) hunterStyleRadarChart.destroy();

        const categoryCtx = document.getElementById('category-pie-chart').getContext('2d');
        const categoryWins = wonGiveaways.reduce((acc, g) => {
            const category = g.prize.includes('ü•é') ? 'P√°del' : g.prize.includes('üõ©Ô∏è') ? 'Viajes' : g.prize.includes('üÉè') ? 'Frikis' : 'Otros';
            acc[category] = (acc[category] || 0) + 1;
            return acc;
        }, {});
        categoryPieChart = new Chart(categoryCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(categoryWins),
                datasets: [{
                    data: Object.values(categoryWins),
                    backgroundColor: ['#f59e0b', '#3b82f6', '#8b5cf6', '#6b7280'],
                    borderColor: '#fffbef',
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const monthlyCtx = document.getElementById('monthly-value-bar-chart').getContext('2d');
        const monthlyValues = wonGiveaways.reduce((acc, g) => {
            const month = new Date(g.wonDate).getMonth();
            acc[month] = (acc[month] || 0) + parsePrice(g.price);
            return acc;
        }, Array(12).fill(0));
        monthlyValueBarChart = new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                datasets: [{
                    label: 'Valor Total Ganado (‚Ç¨)',
                    data: monthlyValues,
                    backgroundColor: '#fde047',
                    borderColor: '#f59e0b',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });

        const winsGrowthCtx = document.getElementById('wins-growth-line-chart').getContext('2d');
        const sortedWins = [...wonGiveaways].sort((a,b) => new Date(a.wonDate) - new Date(b.wonDate));
        const cumulativeWins = [];
        const winLabels = [];
        sortedWins.forEach((win, index) => {
            cumulativeWins.push(index + 1);
            winLabels.push(new Date(win.wonDate).toLocaleDateString('es-ES'));
        });
        winsGrowthLineChart = new Chart(winsGrowthCtx, {
            type: 'line',
            data: {
                labels: winLabels,
                datasets: [{
                    label: 'Victorias Acumuladas',
                    data: cumulativeWins,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
        
        const scatterCtx = document.getElementById('value-vs-anticipation-scatter-chart').getContext('2d');
        const scatterData = wonGiveaways
            .filter(g => g.addDate && parsePrice(g.price) > 0)
            .map(g => ({
                x: (new Date(g.date) - new Date(g.addDate)) / (1000 * 60 * 60 * 24),
                y: parsePrice(g.price)
            }));
        valueVsAnticipationScatterChart = new Chart(scatterCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Victoria',
                    data: scatterData,
                    backgroundColor: 'rgba(239, 68, 68, 0.7)'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'D√≠as de Antelaci√≥n al A√±adir' } },
                    y: { title: { display: true, text: 'Valor del Premio (‚Ç¨)' } }
                }
            }
        });
        
        const radarCtx = document.getElementById('hunter-style-radar-chart').getContext('2d');
        const totalCompleted = Object.keys(completedGiveaways).length;
        const totalWon = wonGiveaways.length;
        const winRate = totalCompleted > 0 ? (totalWon / totalCompleted) * 100 : 0;
        const avgValue = totalWon > 0 ? (wonGiveaways.reduce((sum, g) => sum + parsePrice(g.price), 0) / totalWon) : 0;
        const participationRate = Object.values(giveaways).flat().length > 0 ? (totalCompleted / Object.values(giveaways).flat().length) * 100 : 0;
        const diversity = new Set(wonGiveaways.flatMap(g => g.accounts)).size;
        
        const normalizedWinRate = Math.min(winRate * 20, 100);
        const normalizedAvgValue = Math.min(avgValue / 2, 100);
        const normalizedParticipation = Math.min(participationRate, 100);
        const normalizedDiversity = Math.min(diversity * 2, 100);

        hunterStyleRadarChart = new Chart(radarCtx, {
            type: 'radar',
            data: {
                labels: ['Precisi√≥n (Tasa √âxito)', 'Valor Medio', 'Volumen (Participaci√≥n)', 'Diversidad de Cuentas'],
                datasets: [{
                    label: 'Tu Estilo',
                    data: [normalizedWinRate, normalizedAvgValue, normalizedParticipation, normalizedDiversity],
                    backgroundColor: 'rgba(253, 224, 71, 0.2)',
                    borderColor: '#f59e0b',
                    pointBackgroundColor: '#f59e0b'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { r: { beginAtZero: true, max: 100 } }
            }
        });

        const heatmapContainer = document.getElementById('luck-heatmap-container');
        heatmapContainer.innerHTML = '';
        const winsByDay = wonGiveaways.reduce((acc, g) => {
            const date = new Date(g.wonDate).toISOString().slice(0, 10);
            acc[date] = (acc[date] || 0) + 1;
            return acc;
        }, {});
        const maxWinsInADay = Math.max(0, ...Object.values(winsByDay));
        const currentYear = new Date().getFullYear();
        const firstDayOfYear = new Date(currentYear, 0, 1);
        const daysInYear = (new Date(currentYear, 11, 31) - firstDayOfYear) / (1000 * 60 * 60 * 24) + 1;
        
        const heatmap = document.createElement('div');
        heatmap.className = 'heatmap';
        
        ['D', 'L', 'M', 'X', 'J', 'V', 'S'].forEach(day => {
            const headerEl = document.createElement('div');
            headerEl.className = 'heatmap-header';
            headerEl.textContent = day;
            heatmap.appendChild(headerEl);
        });

        for (let i = 0; i < firstDayOfYear.getDay(); i++) {
            heatmap.innerHTML += '<div></div>';
        }

        for (let i = 0; i < daysInYear; i++) {
            const dayDate = new Date(firstDayOfYear);
            dayDate.setDate(firstDayOfYear.getDate() + i);
            const dateStr = dayDate.toISOString().slice(0, 10);
            const wins = winsByDay[dateStr] || 0;
            const dayEl = document.createElement('div');
            dayEl.className = 'heatmap-day';
            dayEl.title = `${dateStr}: ${wins} victoria(s)`;
            if (wins > 0) {
                const opacity = wins / (maxWinsInADay || 1);
                dayEl.style.backgroundColor = `rgba(34, 197, 94, ${opacity})`;
                dayEl.textContent = wins;
                dayEl.style.color = 'white';
            }
            heatmap.appendChild(dayEl);
        }
        heatmapContainer.appendChild(heatmap);
    };

    const renderAchievementsModal = (activeTab = 'logros') => {
        const unlockedIds = userAchievements.unlocked;
        
        const achievementGroups = {
            'Logros de Bronce ü•â': achievementList.bronze,
            'Logros de Plata ü•à': achievementList.silver,
            'Logros de Oro ü•á': achievementList.gold,
            'Logros de Platino üíé': achievementList.platinum,
            'Logros M√≠ticos üèÜ': achievementList.diamond,
        };
        let achievementsHTML = '';
        for (const groupName in achievementGroups) {
            achievementsHTML += `<h3 class="text-xl font-bold text-yellow-700 mt-4 mb-2">${groupName}</h3>`;
            achievementsHTML += '<div class="space-y-3">';
            achievementsHTML += achievementGroups[groupName].map(ach => {
                const isUnlocked = unlockedIds.includes(ach.id);
                return `
                <div class="achievement-item ${isUnlocked ? '' : 'locked'} bg-yellow-100/50 p-4 rounded-lg flex items-center gap-4">
                    <div class="ach-icon text-4xl">${ach.icon}</div>
                    <div class="flex-grow">
                        <h4 class="font-bold text-lg">${ach.name}</h4>
                        <p class="text-sm">${ach.desc}</p>
                    </div>
                    ${isUnlocked ? `<div class="text-right flex-shrink-0"><span class="font-bold text-green-600">+${ach.ps} PS</span></div>` : ''}
                </div>`;
            }).join('');
            achievementsHTML += '</div>';
        }

        const titlesHTML = achievementList.prestige.map(item => {
            const isUnlocked = unlockedIds.includes(item.id);
            const isSelected = userAchievements.title === item.title;
            return `
                <div class="title-item ${isUnlocked ? '' : 'locked'} ${isSelected ? 'selected' : ''} border-2 border-transparent p-4 rounded-lg flex flex-col items-center justify-center text-center gap-2 bg-yellow-100/50">
                    <div class="text-5xl">üëë</div>
                    <h4 class="font-bold text-lg">${item.title}</h4>
                    <p class="text-xs italic text-gray-600">${item.req}</p>
                    ${isUnlocked ? `<button data-title="${item.title}" class="select-title-btn mt-2 py-1 px-3 rounded-full text-xs font-bold ${isSelected ? 'bg-green-500 text-white cursor-default' : 'bg-yellow-500 text-yellow-900'}">${isSelected ? 'Seleccionado' : 'Seleccionar'}</button>` : ''}
                </div>
            `;
        }).join('');

        let meritsHTML = achievementList.merits.map(ach => {
             const isUnlocked = unlockedIds.includes(ach.id);
             return `
                <div class="achievement-item ${isUnlocked ? '' : 'locked'} bg-blue-100/50 p-4 rounded-lg flex items-center gap-4 border-l-4 border-blue-400">
                    <div class="ach-icon text-4xl">${ach.icon}</div>
                    <div class="flex-grow">
                        <h4 class="font-bold text-lg">${ach.name}</h4>
                        <p class="text-sm">${ach.desc}</p>
                    </div>
                    ${isUnlocked ? `<div class="text-right flex-shrink-0"><span class="font-bold text-green-600">+${ach.ps} PS</span></div>` : ''}
                </div>`;
        }).join('');

        const psInfoHTML = `
            <div class="p-4 bg-yellow-100/50 rounded-lg space-y-3">
                <h3 class="text-xl font-bold text-yellow-800">¬øC√≥mo funcionan los Puntos de Sorteo (PS)?</h3>
                <p class="text-sm">Los PS miden tu progreso y dedicaci√≥n. ¬°Acum√∫lalos para desbloquear t√≠tulos y demostrar tu maestr√≠a!</p>
                <ul class="list-disc list-inside text-sm space-y-2">
                    <li><strong>+1 PS</strong> por cada sorteo a√±adido manualmente.</li>
                    <li><strong>+2 PS</strong> por cada sorteo completado.</li>
                    <li><strong>+5 PS</strong> por cada sorteo a√±adido con la IA.</li>
                    <li><strong>+5 a 250 PS</strong> al desbloquear un logro, m√©rito o t√≠tulo.</li>
                    <li><strong>+100 PS</strong> por ganar un sorteo.</li>
                    <li><strong>+25 PS (Bonus)</strong> si el premio ganado es de categor√≠a (P√°del, Viajes o Friki).</li>
                    <li><strong>+250 PS (Bonus)</strong> si el premio ganado supera los 500‚Ç¨ de valor.</li>
                </ul>
            </div>
        `;

        achievementsModalBody.innerHTML = `
            <div class="achievement-tabs flex flex-wrap gap-x-4 border-b border-yellow-600/20 mb-4">
                <button data-tab="logros" class="py-2 px-4 font-bold ${activeTab === 'logros' ? 'active' : ''}">Logros</button>
                <button data-tab="titulos" class="py-2 px-4 font-bold ${activeTab === 'titulos' ? 'active' : ''}">T√≠tulos de Prestigio</button>
                <button data-tab="meritos" class="py-2 px-4 font-bold ${activeTab === 'meritos' ? 'active' : ''}">M√©ritos √önicos</button>
                <button data-tab="ps_info" class="py-2 px-4 font-bold ${activeTab === 'ps_info' ? 'active' : ''}">Sistema de Puntos</button>
            </div>
            <div id="achievements-content" class="space-y-3">
                <div class="tab-content ${activeTab === 'logros' ? '' : 'hidden'}" data-tab-content="logros">${achievementsHTML}</div>
                <div class="tab-content ${activeTab === 'titulos' ? '' : 'hidden'}" data-tab-content="titulos"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${titlesHTML}</div></div>
                <div class="tab-content ${activeTab === 'meritos' ? '' : 'hidden'}" data-tab-content="meritos"><div class="space-y-3">${meritsHTML}</div></div>
                <div class="tab-content ${activeTab === 'ps_info' ? '' : 'hidden'}" data-tab-content="ps_info">${psInfoHTML}</div>
            </div>
        `;

        achievementsModalBody.querySelectorAll('.achievement-tabs button').forEach(button => {
            button.addEventListener('click', () => {
                renderAchievementsModal(button.dataset.tab);
            });
        });

        achievementsModalBody.querySelectorAll('.select-title-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                userAchievements.title = button.dataset.title;
                saveUserAchievements();
                userTitleEl.textContent = userAchievements.title;
                renderAchievementsModal('titulos');
            });
        });
    };

    const renderPsSummaryModal = () => {
        psSummaryModalBody.innerHTML = '';
        const log = userPoints.log || [];
        if (log.length === 0) {
            psSummaryModalBody.innerHTML = '<p class="text-center">A√∫n no has ganado puntos. ¬°Empieza a participar!</p>';
            return;
        }

        const recentLogs = [...log].reverse().slice(0, 20);

        recentLogs.forEach(entry => {
            const entryDate = new Date(entry.date).toLocaleString('es-ES', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            const itemHTML = `
                <div class="p-3 bg-yellow-100/50 rounded-lg shadow-inner border border-yellow-600/20 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-green-600">+${entry.points} PS</p>
                        <p class="text-sm text-yellow-900 truncate" style="max-width: 250px;">${entry.reason}</p>
                    </div>
                    <span class="text-xs text-gray-500 flex-shrink-0">${entryDate}</span>
                </div>
            `;
            psSummaryModalBody.innerHTML += itemHTML;
        });
    };

    const renderRecentAddsModal = () => {
        recentAddsModalBody.innerHTML = '';
        const allGiveaways = Object.values(giveaways).flat();

        const sortedGiveaways = allGiveaways
            .filter(g => g.addDate)
            .sort((a, b) => new Date(b.addDate) - new Date(a.addDate));

        if (sortedGiveaways.length === 0) {
            recentAddsModalBody.innerHTML = '<p class="text-center">No hay sorteos con fecha de adici√≥n registrada.</p>';
            return;
        }

        const groupedByDate = sortedGiveaways.reduce((acc, g) => {
            const date = g.addDate;
            if (!acc[date]) {
                acc[date] = [];
            }
            acc[date].push(g);
            return acc;
        }, {});

        for (const date in groupedByDate) {
            const dayContainer = document.createElement('div');
            const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            let dayHTML = `<h3 class="text-xl font-bold text-yellow-700 mb-2 border-b-2 border-yellow-200 pb-1 text-left">${formattedDate}</h3>`;
            dayHTML += '<div class="space-y-2">';
            groupedByDate[date].forEach(giveaway => {
                 dayHTML += `
                    <div class="p-3 bg-yellow-100/50 rounded-lg shadow-inner border border-yellow-600/20 text-left">
                        <p class="font-bold text-yellow-900 truncate">${giveaway.prize}</p>
                        <p class="text-sm text-gray-600">Finaliza el: ${giveaway.date}</p>
                    </div>
                 `;
            });
            dayHTML += '</div>';
            dayContainer.innerHTML = dayHTML;
            recentAddsModalBody.appendChild(dayContainer);
        }
    };

    const downloadSourceCode = () => {
        showNotification('Preparando descarga...', 'Se est√° generando el archivo .zip con tus datos actualizados.');
        const zip = new JSZip();

        const giveawaysContent = `window.giveaways = ${JSON.stringify(giveaways, null, 4)};`;
        const discardedGiveawaysContent = `const initialDiscardedGiveaways = ${JSON.stringify(discardedGiveaways, null, 4)};\n\nif (localStorage.getItem('discardedGiveaways') === null) {\n    localStorage.setItem('discardedGiveaways', JSON.stringify(initialDiscardedGiveaways));\n}\n\nwindow.discardedGiveaways = JSON.parse(localStorage.getItem('discardedGiveaways')) || [];`;
        
        const foreignAccountsContent = `window.foreignAccounts = ${JSON.stringify(foreignAccounts, null, 4)};`;
        const captureBatchesContent = `window.captureBatches = ${JSON.stringify(captureBatches, null, 4)};`;
        
        const indexHtmlContent = document.documentElement.outerHTML;

        const netlifyTomlContent = `[build]
          command = "npm install"
          functions = "netlify/functions"`;

        const packageJsonContent = `{
          "name": "misorteos-functions",
          "version": "1.0.0",
          "description": "Dependencias para las funciones de Netlify",
          "dependencies": {
            "node-fetch": "^3.3.2"
          }
        }`;

        const geminiJsContent = `// netlify/functions/gemini.js
        exports.handler = async function (event, context) {
            const fetch = (await import('node-fetch')).default;
            const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
            const body = JSON.parse(event.body);
            const { base64Data, dynamicPrompt } = body;
            if (!base64Data || !dynamicPrompt) {
                return {
                    statusCode: 400,
                    body: JSON.stringify({ error: 'Faltan datos en la petici√≥n.' })
                };
            }
            const apiUrl = \`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=\${GEMINI_API_KEY}\`;
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: dynamicPrompt },
                        { inlineData: { mimeType: "image/jpeg", data: base64Data.split(',')[1] } }
                    ]
                }]
            };
            try {
                const geminiResponse = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!geminiResponse.ok) {
                    const errorBody = await geminiResponse.json();
                    console.error("Error desde la API de Gemini:", errorBody);
                    return {
                        statusCode: geminiResponse.status,
                        body: JSON.stringify({ error: 'La API de Gemini devolvi√≥ un error.', details: errorBody })
                    };
                }
                const data = await geminiResponse.json();
                return {
                    statusCode: 200,
                    body: JSON.stringify(data)
                };
            } catch (error) {
                console.error("Error en la funci√≥n de Netlify:", error);
                return {
                    statusCode: 500,
                    body: JSON.stringify({ error: 'Error al contactar la API de Gemini.' })
                };
            }
        };`;

        const searchJsContent = `// netlify/functions/search.js
        exports.handler = async function (event, context) {
            const fetch = (await import('node-fetch')).default;
            const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
            const { query, accounts } = JSON.parse(event.body);
            if (!query) {
                return {
                    statusCode: 400,
                    body: JSON.stringify({ error: 'Falta la consulta (query).' })
                };
            }
            const apiUrl = \`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=\${GEMINI_API_KEY}\`;
            const prompt = \`Act√∫a como un asistente de investigaci√≥n de mercado. Tu tarea es encontrar el precio y el enlace de un producto.
    
            1.  **Prioridad Principal:** Busca el producto en la p√°gina web oficial de la marca o cuenta del sorteo.
                * Producto: "\${query}"
                * Cuentas de Instagram: \${accounts.join(', ')}

            2.  **Si no se encuentra en la p√°gina oficial:** Busca el precio y el enlace del producto en Google.

            3.  **Formato de Salida:** Devuelve tu respuesta √∫nica y exclusivamente como un objeto JSON con la siguiente estructura:
                {
                  "value": "string del precio encontrado, e.g., '150‚Ç¨', 'No encontrado'",
                  "url": "string del enlace de la p√°gina web donde encontraste el precio, o null si no lo encontraste"
                }

            Tu respuesta debe ser solo el objeto JSON, sin ning√∫n texto adicional, explicaciones o formato Markdown como \`\`\`.\`;
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: prompt }]
                }]
            };
            try {
                const geminiResponse = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!geminiResponse.ok) {
                    const errorBody = await geminiResponse.json();
                    console.error("Error desde la API de Gemini (en search.js):", errorBody);
                    return {
                        statusCode: geminiResponse.status,
                        body: JSON.stringify({ error: 'La API de Gemini devolvi√≥ un error en la b√∫squeda.', details: errorBody })
                    };
                }
                const data = await geminiResponse.json();
                return {
                    statusCode: 200,
                    body: JSON.stringify(data)
                };
            } catch (error) {
                console.error("Error en la funci√≥n search.js:", error);
                return {
                    statusCode: 500,
                    body: JSON.stringify({ error: 'Error al contactar la API de Gemini.' })
                };
            }
        };`;

        zip.file("index.html", indexHtmlContent);
        zip.file("giveaways_new.js", giveawaysContent);
        zip.file("discardedGiveaways_new.js", discardedGiveawaysContent);
        zip.file("foreignAccounts.js", foreignAccountsContent);
        zip.file("capture_batches.js", captureBatchesContent);
        zip.file("netlify.toml", netlifyTomlContent);
        zip.file("package.json", packageJsonContent);

        const functionsFolder = zip.folder("netlify").folder("functions");
        functionsFolder.file("gemini.js", geminiJsContent);
        functionsFolder.file("search.js", searchJsContent);

        zip.generateAsync({ type: "blob" }).then(function(content) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            const today = new Date().toISOString().slice(0, 10);
            link.download = `Misorteos-Backup-Completo-${today}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    };
    
    const restoreFromBackup = (file) => { if (!file) return; const reader = new FileReader(); reader.onload = (e) => { JSZip.loadAsync(e.target.result).then(zip => { const giveawaysFile = zip.file("giveaways_new.js"); const discardedFile = zip.file("discardedGiveaways_new.js"); const foreignFile = zip.file("foreignAccounts.js"); const batchesFile = zip.file("capture_batches.js"); if (!giveawaysFile || !discardedFile || !foreignFile || !batchesFile) { showNotification('Error', 'El archivo .zip no parece una copia de seguridad v√°lida.'); return; } Promise.all([giveawaysFile.async("string"), discardedFile.async("string"), foreignFile.async("string"), batchesFile.async("string")]) .then(contents => { try { const giveawaysContent = contents[0].replace('window.giveaways = ', '').slice(0, -1); const discardedContent = contents[1].replace('window.discardedGiveaways = ', '').slice(0, -1); const foreignContent = contents[2].replace('window.foreignAccounts = ', '').slice(0, -1); const batchesContent = contents[3].replace('window.captureBatches = ', '').slice(0, -1); const parsedGiveaways = JSON.parse(giveawaysContent); const parsedDiscarded = JSON.parse(discardedContent); const parsedForeign = JSON.parse(foreignContent); const parsedBatches = JSON.parse(batchesContent); if (confirm("¬øSeguro que quieres restaurar esta copia? Se borrar√°n todos los datos actuales y se reemplazar√°n por los del archivo.")) { giveaways = parsedGiveaways; discardedGiveaways = parsedDiscarded; foreignAccounts = parsedForeign; captureBatches = parsedBatches; saveGiveaways(); saveDiscardedGiveaways(); saveForeignAccounts(); saveCaptureBatches(); renderCalendar(); showNotification('¬°√âxito!', 'La copia de seguridad se ha restaurado correctamente.'); } } catch (error) { showNotification('Error de formato', 'No se pudo leer el contenido del archivo .zip.'); console.error("Error al parsear la copia de seguridad:", error); } }); }); }; reader.readAsArrayBuffer(file); };

    const toggleNavMenu = () => {
        navMenu.classList.toggle('is-open');
        menuOverlay.style.display = navMenu.classList.contains('is-open') ? 'block' : 'none';
    };

    const renderForeignAccountsModal = () => {
         foreignAccountsModalBody.innerHTML = '';
         if (foreignAccounts.length === 0) {
             foreignAccountsModalBody.innerHTML = '<p class="text-center">No hay cuentas extranjeras bloqueadas.</p>';
             return;
         }
         foreignAccounts.forEach(account => {
             const itemContainer = document.createElement('div');
             itemContainer.className = 'flex justify-between items-center p-3 bg-red-100/50 rounded-lg shadow-inner border border-red-600/20';
             itemContainer.innerHTML = `
                 <span class="font-bold">${account}</span>
                 <button class="remove-foreign-account-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-400" data-account-name="${account}"><i class="fa-solid fa-trash-can"></i></button>
             `;
             foreignAccountsModalBody.appendChild(itemContainer);
         });
    };

    const removeForeignAccount = (accountName) => {
         foreignAccounts = foreignAccounts.filter(acc => acc !== accountName);
         saveForeignAccounts();
         renderForeignAccountsModal();
         showNotification('Cuenta eliminada', `La cuenta ${accountName} se ha eliminado de la lista de extranjeras.`);
    };

    const renderBlockManagementModal = () => {
        const ONE_DAY_MS = 1000 * 60 * 60 * 24;
        const likeBlocks = blockHistory.filter(b => b.type === 'like').sort((a, b) => new Date(a.date) - new Date(b.date));
        const commentBlocks = blockHistory.filter(b => b.type === 'comment').sort((a, b) => new Date(a.date) - new Date(b.date));

        let avgLikeGap = 'N/A';
        if (likeBlocks.length > 1) {
            let totalGap = 0;
            for (let i = 1; i < likeBlocks.length; i++) {
                totalGap += (new Date(likeBlocks[i].date) - new Date(likeBlocks[i-1].date));
            }
            avgLikeGap = (totalGap / (likeBlocks.length - 1) / ONE_DAY_MS).toFixed(1);
        }

        let avgCommentGap = 'N/A';
        if (commentBlocks.length > 1) {
            let totalGap = 0;
            for (let i = 1; i < commentBlocks.length; i++) {
                totalGap += (new Date(commentBlocks[i].date) - new Date(commentBlocks[i-1].date));
            }
            avgCommentGap = (totalGap / (commentBlocks.length - 1) / ONE_DAY_MS).toFixed(1);
        }
        
        blockStatsContainer.innerHTML = `
            <h3 class="text-xl font-bold text-yellow-700 mb-2 border-b-2 border-yellow-200 pb-1">Estad√≠sticas de Bloqueos</h3>
            <ul class="space-y-2">
                <li>Total Bloqueos de 'Me Gusta': <strong>${likeBlocks.length}</strong></li>
                <li>Tiempo medio entre bloqueos de 'Like': <strong>${avgLikeGap} d√≠as</strong></li>
                <li class="pt-2 border-t border-yellow-600/10">Total Bloqueos de Comentario: <strong>${commentBlocks.length}</strong></li>
                <li>Tiempo medio entre bloqueos de Comentario: <strong>${avgCommentGap} d√≠as</strong></li>
            </ul>
        `;
    };

    const consultarOraculo = (tipo) => {
        const proximosSorteos = Object.values(giveaways).flat().filter(g => new Date(g.date) >= new Date(new Date().toDateString()));
        
        if (proximosSorteos.length === 0) {
            showNotification('üîÆ Or√°culo Silencioso', 'No hay sorteos futuros para predecir.');
            return;
        }

        if (tipo === 'proximidad') {
            const mensajes = [
                "Las estrellas se alinean, una victoria est√° cerca.",
                "Siento una fuerte energ√≠a de suerte a tu alrededor.",
                "La fortuna favorece a los audaces. ¬°Tu momento llegar√°!",
                "Las constelaciones son esquivas hoy, pero no pierdas la fe.",
                "Un premio inesperado podr√≠a estar en tu camino."
            ];
            const veredicto = mensajes[Math.floor(Math.random() * mensajes.length)];
            showNotification('üîÆ Or√°culo de Proximidad', veredicto);
        }

        if (tipo === 'premio') {
            const sorteoElegido = proximosSorteos[Math.floor(Math.random() * proximosSorteos.length)];
            showNotification('‚ú® Or√°culo del Premio', `El cosmos susurra sobre... "${sorteoElegido.prize}"`);
        }
    };

    const shareStats = () => {
        const totalWon = wonGiveaways.length;
        const totalValueWon = wonGiveaways.reduce((sum, g) => sum + parsePrice(g.price), 0);
        const winRate = Object.keys(completedGiveaways).length > 0 ? ((totalWon / Object.keys(completedGiveaways).length) * 100).toFixed(2) : 0;
        const title = userAchievements.title;

        const summaryText = `
‚ú® Mi Resumen de Misorteos ‚ú®
- T√≠tulo Actual: ${title}
- Victorias Totales: ${totalWon} üèÜ
- Valor Acumulado: ${totalValueWon.toFixed(2)}‚Ç¨ üí∞
- Win Rate: ${winRate}% üéØ

¬°Generado desde mi app de sorteos!
        `.trim();

        navigator.clipboard.writeText(summaryText).then(() => {
            showNotification('üìã Resumen Copiado', '¬°Ya puedes pegarlo donde quieras!');
        }).catch(err => {
            console.error('Error al copiar: ', err);
            showNotification('‚ùå Error', 'No se pudo copiar el resumen.');
        });
    };

    const renderVisModal = () => {
        const visModalBody = document.getElementById('vis-modal-body');
        visModalBody.innerHTML = ''; // Limpiamos el contenido anterior

        if (visGiveaways.length === 0) {
            visModalBody.innerHTML = '<p class="text-gray-500">Tu sala de revisi√≥n est√° vac√≠a. Completa un sorteo y env√≠alo aqu√≠ para un seguimiento especial.</p>';
            return;
        }

        [...visGiveaways].reverse().forEach(giveaway => {
            const card = document.createElement('div');
            card.className = 'p-3 bg-yellow-100/50 rounded-lg shadow-inner flex flex-col sm:flex-row justify-between items-center border border-yellow-600/20 text-left gap-3';
            
            const accountsHTML = (giveaway.accounts || []).map(acc => `<a href="https://instagram.com/${acc.replace('@', '')}" target="_blank" class="hover:underline">${acc}</a>`).join(', ');

            card.innerHTML = `
                <div class="flex-grow w-full">
                    <p class="font-bold text-yellow-900">${giveaway.prize}</p>
                    <p class="text-sm">${accountsHTML}</p>
                    <p class="text-xs text-gray-600">Finaliza: ${giveaway.date} | Valor: ${giveaway.price || 'N/A'}</p>
                </div>
                <div class="flex-shrink-0 flex items-center gap-2 w-full sm:w-auto">
                    <button class="reviewed-vis-btn w-1/2 sm:w-auto bg-gray-500 text-white py-2 px-3 rounded-lg font-bold hover:bg-gray-600 transition-colors text-sm" data-giveaway-id="${giveaway.id}">Revisado</button>
                    <button class="won-vis-btn w-1/2 sm:w-auto bg-green-500 text-white py-2 px-3 rounded-lg font-bold hover:bg-green-600 transition-colors text-sm" data-giveaway-id="${giveaway.id}">Ganado üèÜ</button>
                </div>
            `;
            visModalBody.appendChild(card);
        });
    };

    const removeFromVIS = (giveawayId) => {
        visGiveaways = visGiveaways.filter(g => g.id !== giveawayId);
        saveVisGiveaways();
        renderVisModal();
    };

    const moveToNotInterested = (giveawayId, dateStr) => {
        if (!giveaways[dateStr]) return;

        const giveawayIndex = giveaways[dateStr].findIndex(g => g.id === giveawayId);
        if (giveawayIndex > -1) {
            const [giveawayToMove] = giveaways[dateStr].splice(giveawayIndex, 1);
            if (giveaways[dateStr].length === 0) {
                delete giveaways[dateStr];
            }

            if (!notInterestedGiveaways[dateStr]) {
                notInterestedGiveaways[dateStr] = [];
            }
            notInterestedGiveaways[dateStr].push(giveawayToMove);

            saveGiveaways();
            saveNotInterestedGiveaways();
            buildModal(dateStr); // Re-render the modal to reflect the change
            renderCalendar(); // Update the main calendar view
        }
    };

    const restoreFromNotInterested = (giveawayId, dateStr) => {
        if (!notInterestedGiveaways[dateStr]) return;

        const giveawayIndex = notInterestedGiveaways[dateStr].findIndex(g => g.id === giveawayId);
        if (giveawayIndex > -1) {
            const [giveawayToRestore] = notInterestedGiveaways[dateStr].splice(giveawayIndex, 1);
            if (notInterestedGiveaways[dateStr].length === 0) {
                delete notInterestedGiveaways[dateStr];
            }

            if (!giveaways[dateStr]) {
                giveaways[dateStr] = [];
            }
            giveaways[dateStr].push(giveawayToRestore);

            saveGiveaways();
            saveNotInterestedGiveaways();
            buildModal(dateStr);
            renderCalendar();
        }
    };

    // --- C√ìDIGO DE INICIALIZACI√ìN ---
    
    animateStarryBackground();
    animateTitle();
    populateCategoryDropdown('giveaway-category');
    renderCalendar();
    updatePointsDisplay();
    if (userTitleEl) {
        userTitleEl.textContent = userAchievements.title;
    }

    const setupModal = (button, modal, closeButton, onOpenCallback) => {
        const openAction = (e) => {
            e.preventDefault();
            if (navMenu.classList.contains('is-open')) {
                toggleNavMenu();
            }
            if (onOpenCallback) onOpenCallback();
            if (modal) modal.classList.add('is-visible');
        };

        if (button) button.addEventListener('click', openAction);
        if (closeButton) closeButton.addEventListener('click', () => { 
            if (modal) modal.classList.remove('is-visible'); 
        });
        if (modal) modal.addEventListener('click', (e) => { 
            if (e.target === modal) { 
                modal.classList.remove('is-visible'); 
            } 
        });
    };
    
    setupModal(statsBtn, statsModal, closeStatsModalBtn, () => {
        calculateAndRenderStats();
        setTimeout(renderCharts, 50); 
    });
    setupModal(historyBtn, historyModal, closeHistoryModalBtn, renderHistoryModal);
    setupModal(trophyBtn, trophyModal, closeTrophyModalBtn, renderTrophyModal);
    setupModal(achievementsBtn, achievementsModal, closeAchievementsModalBtn, () => renderAchievementsModal('logros'));
    setupModal(null, searchModal, closeSearchModalBtn);
    setupModal(trashBtn, trashModal, closeTrashModalBtn, renderTrashModal);
    setupModal(discardedBtn, discardedModal, closeDiscardedModalBtn, renderDiscardedModal);
    setupModal(manageForeignAccountsBtn, foreignAccountsModal, closeForeignAccountsModalBtn, renderForeignAccountsModal);
    setupModal(null, duplicateComparisonModal, closeDuplicateComparisonModalBtn);
    setupModal(null, psSummaryModal, closePsSummaryModalBtn);
    setupModal(null, recentAddsModal, closeRecentAddsModalBtn);
    setupModal(visReviewBtn, visModal, closeVisModalBtn, renderVisModal);
    setupModal(newAdditionsBtn, newAdditionsModal, closeNewAdditionsModalBtn, renderNewAdditionsModal);
    
    addManualBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const confirmationMessage = "‚ú® ¬°Un Momento, Cazador/a de Tesoros! ‚ú®\n\nEst√°s a punto de a√±adir un sorteo a tu mapa del tesoro personal.\n\nSe guardar√° de forma secreta solo en tu navegador, ¬°ser√° tu bot√≠n privado! Nadie m√°s lo ver√°.\n\nPara que aparezca en el mapa de todos, el Hechicero Mayor (admin) debe a√±adirlo al grimorio p√∫blico. Si quieres compartir tus hallazgos, puedes:\n- Enviarlos uno a uno a: admin@misorteos.es\n- O usar la Magia de la IA ‚ú®. Al finalizar un an√°lisis, tendr√°s la opci√≥n de enviar el lote completo con un solo clic.\n\n¬øA√±adimos este tesoro a tu colecci√≥n privada?";
        
        if (confirm(confirmationMessage)) {
            if (navMenu.classList.contains('is-open')) {
                toggleNavMenu();
            }
            openAddGiveawayModal();
        }
    });

    addAIBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const confirmationMessage = "‚ú® ¬°Un Momento, Cazador/a de Tesoros! ‚ú®\n\nEst√°s a punto de a√±adir un sorteo a tu mapa del tesoro personal.\n\nSe guardar√° de forma secreta solo en tu navegador, ¬°ser√° tu bot√≠n privado! Nadie m√°s lo ver√°.\n\nPara que aparezca en el mapa de todos, el Hechicero Mayor (admin) debe a√±adirlo al grimorio p√∫blico. Si quieres compartir tus hallazgos, puedes:\n- Enviarlos uno a uno a: admin@misorteos.es\n- O usar la Magia de la IA ‚ú®. Al finalizar un an√°lisis, tendr√°s la opci√≥n de enviar el lote completo con un solo clic.\n\n¬øA√±adimos este tesoro a tu colecci√≥n privada?";

        if (confirm(confirmationMessage)) {
            if (navMenu.classList.contains('is-open')) {
                toggleNavMenu();
            }
            resetAIView();
            aiFullscreenView.classList.add('is-visible');
        }
    });

    closeAiViewBtn.addEventListener('click', () => {
        aiFullscreenView.classList.remove('is-visible');
        resetAIView();
    });
    aiSummaryCloseBtn.addEventListener('click', () => {
        aiFullscreenView.classList.remove('is-visible');
        resetAIView();
    });

    const closeZoomModal = () => { if(zoomModal) zoomModal.classList.remove('is-visible'); };
    if (analysisImagePreview) {
        analysisImagePreview.addEventListener('click', () => {
            if (zoomedImage && zoomModal) {
                zoomedImage.src = analysisImagePreview.src;
                zoomModal.classList.add('is-visible');
            }
        });
    }
    if (zoomModal) {
        zoomModal.addEventListener('click', closeZoomModal);
    }
    
    openNavMenuBtn.addEventListener('click', toggleNavMenu);
    closeNavMenuBtn.addEventListener('click', toggleNavMenu);
    menuOverlay.addEventListener('click', toggleNavMenu);

    prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
    nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
    calendarDaysEl.addEventListener('click', (e) => { const dayEl = e.target.closest('.has-giveaway'); if (dayEl) openModal(dayEl.dataset.date); });

    closeModalBtn.addEventListener('click', closeModal);
    closeMoveGiveawayModalBtn.addEventListener('click', closeMoveGiveawayModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    document.getElementById('modal-content').addEventListener('click', (e) => {
        const dateStr = modal.dataset.date;
        if (!dateStr) return;

        const giveawayId = e.target.closest('[data-giveaway-id]')?.dataset.giveawayId;

        // --- ACCIONES PRINCIPALES ---
        const restoreBtn = e.target.closest('.restore-not-interested-btn');
        const notInterestedBtn = e.target.closest('.not-interested-btn');
        const checkbox = e.target.closest('input[type="checkbox"]');
        
        if (restoreBtn) {
            restoreFromNotInterested(restoreBtn.dataset.giveawayId, dateStr);
            return;
        }

        if (notInterestedBtn) {
            moveToNotInterested(notInterestedBtn.dataset.giveawayId, dateStr);
            return;
        }
        
        if (checkbox) {
            const itemContainer = checkbox.closest('.giveaway-item');
            const postCompleteActions = itemContainer.querySelector('.post-complete-actions');
            const notInterestedButton = itemContainer.querySelector('.not-interested-btn');
            
            if (checkbox.checked) {
                completedGiveaways[giveawayId] = true;
                if (postCompleteActions) postCompleteActions.style.display = 'flex';
                if (notInterestedButton) notInterestedButton.style.display = 'none';
                animateShootingStar(itemContainer, () => {
                    itemContainer.classList.add('completed');
                    buildModal(dateStr); 
                    renderCalendar();
                });
            } else {
                delete completedGiveaways[giveawayId];
                if (postCompleteActions) postCompleteActions.style.display = 'none';
                if (notInterestedButton) notInterestedButton.style.display = 'block';
                itemContainer.classList.remove('completed');
            }
            saveCompletedGiveaways();
            checkAchievements('complete', { giveawayDate: dateStr });
            return;
        }

        // --- OTRAS ACCIONES ---
        if (e.target.closest('.win-giveaway-btn')) {
            markAsWon(giveawayId, dateStr);
        } else if (e.target.closest('.vis-giveaway-btn')) {
            const giveaway = giveaways[dateStr]?.find(g => g.id === giveawayId);
            if(giveaway) {
                const isAlreadyInVIS = visGiveaways.some(vis => vis.id === giveawayId);
                if (!isAlreadyInVIS) {
                    visGiveaways.push(giveaway);
                    saveVisGiveaways();
                    showNotification('Sorteo VIP A√±adido', `"${giveaway.prize}" se ha enviado a tu sala de revisi√≥n.`);
                } else {
                    showNotification('Ya en la lista', 'Este sorteo ya est√° en tu sala de revisi√≥n.');
                }
            }
        } else if (e.target.closest('.move-giveaway-btn')) {
            const giveaway = giveaways[dateStr]?.find(g => g.id === giveawayId);
            if(giveaway) openMoveGiveawayModal(giveaway, dateStr);
        } else if (e.target.closest('.delete-giveaway-btn')) {
            if (confirm('¬øSeguro que quieres mover este sorteo a la papelera?')) {
                deleteGiveawayFromCalendar(dateStr, giveawayId);
            }
        } else if (e.target.closest('.delete-giveaway-foreign-btn')) {
            if (confirm('¬øMarcar como sorteo extranjero? Las cuentas se a√±adir√°n al cortafuegos.')) {
                deleteForeignGiveaway(dateStr, giveawayId);
            }
        }
    });

    visModal.addEventListener('click', (e) => {
        const giveawayId = e.target.dataset.giveawayId;
        if (!giveawayId) return;

        const giveaway = visGiveaways.find(g => g.id === giveawayId);
        if (!giveaway) return;

        if (e.target.closest('.reviewed-vis-btn')) {
            if (confirm(`¬øConfirmas que ya se han anunciado los ganadores de "${giveaway.prize}" y no has ganado?`)) {
                removeFromVIS(giveawayId);
                showNotification('Sorteo Revisado', 'Se ha quitado de tu lista de seguimiento.');
            }
        }

        if (e.target.closest('.won-vis-btn')) {
            markAsWon(giveaway.id, giveaway.date); 
            removeFromVIS(giveaway.id);
        }
    });

    trashModalBody.addEventListener('click', (e) => { const restoreBtn = e.target.closest('.restore-btn'); if (restoreBtn) { restoreGiveawayFromTrash(restoreBtn.dataset.giveawayId); } });
    
    discardedModal.addEventListener('click', (e) => {
        const filterBtn = e.target.closest('.filter-btn');
        if (filterBtn) {
            discardedFilter = filterBtn.dataset.filter;
            renderDiscardedModal();
        }
    });

    discardedModalBody.addEventListener('click', (e) => { 
        const item = e.target.closest('.giveaway-item-discarded'); 
        if (!item) return;
        const giveawayId = item.dataset.giveawayId;
        const giveaway = discardedGiveaways.find(g => g.id === giveawayId);
        if (!giveaway) return;

        if (giveaway.status === 'duplicate') {
            showDuplicateComparisonModal(giveaway);
            return;
        }

        if (e.target.closest('.add-discarded-btn')) {
            e.stopPropagation();
            openAddGiveawayModal({ date: giveaway.date || giveaway.originalDate, prize: giveaway.prize, accounts: (giveaway.accounts || []).join(', '), price: giveaway.price });
            deleteDiscardedGiveaway(giveawayId);
            closeDiscardedModalBtn.click();
        } else if (e.target.closest('.delete-discarded-btn')) {
            e.stopPropagation(); 
            deleteDiscardedGiveaway(giveawayId); 
        } else {
            openAddGiveawayModal({ date: giveaway.date || giveaway.originalDate, prize: giveaway.prize, accounts: (giveaway.accounts || []).join(', '), price: giveaway.price });
        }
    });

    foreignAccountsModalBody.addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.remove-foreign-account-btn');
        if (removeBtn) {
            const accountName = removeBtn.dataset.accountName;
            if (accountName) {
                removeForeignAccount(accountName);
            }
        }
    });

    trophyModalBody.addEventListener('click', (e) => { const deleteBtn = e.target.closest('.trophy-delete-btn'); if (deleteBtn) { deleteWonGiveaway(deleteBtn.dataset.giveawayId); } });
    selectAiImagesBtn.addEventListener('click', () => { aiImageInput.click(); });
    aiImageInput.addEventListener('change', handleFileSelection);
    startAiButton.addEventListener('click', () => startAnalysis(imageQueue));
    
    retryFailedBtn.addEventListener('click', () => {
         if (giveawaysWithErrors.length > 0) {
              startAnalysis(giveawaysWithErrors);
         } else {
              showNotification('No hay archivos para reintentar', 'Todos los errores se han procesado.');
         }
    });

    blockLikeBtn.addEventListener('click', (e) => { 
        e.preventDefault(); 
        blockHistory.push({ type: 'like', date: new Date().toISOString() }); 
        saveBlockHistory(); 
        showNotification('üëç Bloqueo Registrado', 'Se ha a√±adido un nuevo bloqueo de "Me gusta".'); 
        renderBlockManagementModal(); 
    });

    blockCommentBtn.addEventListener('click', (e) => { 
        e.preventDefault(); 
        blockHistory.push({ type: 'comment', date: new Date().toISOString() }); 
        saveBlockHistory(); 
        showNotification('üí¨ Bloqueo Registrado', 'Se ha a√±adido un nuevo bloqueo de comentarios.'); 
        renderBlockManagementModal(); 
    });

    addAsNewBtn.addEventListener('click', (e) => {
        const giveawayId = e.target.dataset.giveawayId;
        if (!giveawayId) return;
        const giveawayToAdd = discardedGiveaways.find(g => g.id === giveawayId);
        if (giveawayToAdd) {
            deleteDiscardedGiveaway(giveawayId);
            openAddGiveawayModal({ date: giveawayToAdd.date || giveawayToAdd.originalDate, prize: giveawayToAdd.prize, accounts: (giveawayToAdd.accounts || []).join(', '), price: giveawayToAdd.price });
            duplicateComparisonModal.classList.remove('is-visible');
        }
    });

    mergeGiveawayBtn.addEventListener('click', (e) => {
        const giveawayId = e.target.dataset.giveawayId;
        if (!giveawayId) return;
        const discarded = discardedGiveaways.find(g => g.id === giveawayId);
        if (discarded && discarded.originalGiveaway) {
            let original = null;
            for (const date in giveaways) {
                const found = giveaways[date].find(g => g.id === discarded.originalGiveaway.id);
                if (found) { original = found; break; }
            }
            if (original) {
                if (!original.price && discarded.price) original.price = discarded.price;
                if (discarded.prize.length > original.prize.length) original.prize = discarded.prize;
                deleteDiscardedGiveaway(giveawayId);
                saveGiveaways();
                renderCalendar();
                showNotification('Sorteo Fusionado', 'Se han actualizado los datos del sorteo original.');
                checkAchievements('merge');
                duplicateComparisonModal.classList.remove('is-visible');
            } else {
                showNotification('Error', 'No se encontr√≥ el sorteo original para fusionar.');
            }
        }
    });

    document.getElementById('delete-discarded-comp-btn').addEventListener('click', (e) => {
        const giveawayId = e.target.dataset.giveawayId;
        if (giveawayId) {
            if (confirm("¬øEst√°s seguro de que quieres eliminar este sorteo descartado permanentemente?")) {
                deleteDiscardedGiveaway(giveawayId);
                closeDuplicateComparisonModalBtn.click();
                showNotification('Sorteo Eliminado', 'El sorteo descartado ha sido eliminado permanentemente.');
            }
        }
    });

    addGiveawayForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newGiveaway = { id: Date.now().toString(), date: giveawayDateInput.value, prize: giveawayPrizeInput.value, accounts: giveawayAccountsInput.value.split(',').map(acc => acc.trim()), price: giveawayPriceInput.value, prize_category: document.getElementById('giveaway-category').value };
        addGiveaway(newGiveaway);
        closeAddGiveawayModal();
    });

    moveGiveawayForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (giveawayToMove && originalDateOfGiveaway) {
            moveGiveaway(giveawayToMove.id, originalDateOfGiveaway, newGiveawayDateInput.value);
            closeMoveGiveawayModal();
        }
    });

    totalPsContainer.addEventListener('click', () => {
        renderPsSummaryModal();
        psSummaryModal.classList.add('is-visible');
    });

    totalGiveawaysContainer.addEventListener('click', () => {
        renderRecentAddsModal();
        recentAddsModal.classList.add('is-visible');
    });
    
    const statsTabsContainer = document.querySelector('.stats-tabs');
    if (statsTabsContainer) {
        statsTabsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const tabId = button.dataset.tab;
            
            statsTabsContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            document.querySelectorAll('.stats-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');

            if (tabId === 'graficos') {
                setTimeout(renderCharts, 50);
            }
        });
    }

    document.querySelector('.modal-tabs').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-tab-btn')) {
            const tabId = e.target.dataset.tab;

            document.querySelectorAll('.modal-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.modal-tab-content').forEach(content => content.classList.remove('active'));

            e.target.classList.add('active');
            document.getElementById(`tab-content-${tabId}`).classList.add('active');
        }
    });

    document.getElementById('oracle-proximity-btn').addEventListener('click', () => consultarOraculo('proximidad'));
    document.getElementById('oracle-prize-btn').addEventListener('click', () => consultarOraculo('premio'));
    document.getElementById('share-stats-btn').addEventListener('click', shareStats);
    deleteAllTrashBtn.addEventListener('click', deleteAllTrash);
    deleteAllDiscardedBtn.addEventListener('click', deleteAllDiscarded);
    document.getElementById('batch-history-list').addEventListener('click', (e) => {
        const batchItem = e.target.closest('[data-batch-id]');
        if (batchItem) {
            searchQuery = '';
            currentFilter = 'all';
            if (document.getElementById('global-search-input')) document.getElementById('global-search-input').value = '';
            if (document.getElementById('global-category-filter')) document.getElementById('global-category-filter').value = 'all';

            activeBatchFilterId = Number(batchItem.dataset.batchId);
            renderCalendar();
            updateFilterBanner(); // <-- Llamada clave para mostrar el banner
            document.getElementById('close-new-additions-modal').click(); // Cerramos el modal
        }
    });

    document.getElementById('filter-banner-clear-btn').addEventListener('click', clearAllFilters);
    
    document.addEventListener('DOMContentLoaded', () => {
        setupCustomCategoryFilter();
    });

    // --- L√ìGICA PARA EL MEN√ö DESPLEGABLE DE CATEGOR√çAS ---
    const categoryFilterButton = document.getElementById('category-filter-button');
    const categoryFilterOptions = document.getElementById('category-filter-options');

    if (categoryFilterButton && categoryFilterOptions) {
        // Muestra u oculta el men√∫ al hacer clic en el bot√≥n
        categoryFilterButton.addEventListener('click', (e) => {
            e.stopPropagation();
            categoryFilterOptions.classList.toggle('hidden');
        });

        // Cierra el men√∫ si se hace clic en cualquier otro lugar
        document.addEventListener('click', () => {
            if (!categoryFilterOptions.classList.contains('hidden')) {
                categoryFilterOptions.classList.add('hidden');
            }
        });
    }

    // [NUEVO] L√ìGICA PARA EL AVISO DE ACTUALIZACI√ìN
    const refreshOverlay = document.getElementById('refreshOverlay');

    function showRefreshOverlay() {
        if (refreshOverlay) {
            const headlines = document.querySelectorAll('.dynamic-headline');
            
            // 1. Reiniciamos las frases a su estado inicial para que la animaci√≥n pueda repetirse
            headlines.forEach(headline => {
                headline.style.animation = 'none';
                headline.style.opacity = '0';
            });
            
            // 2. Forzamos al navegador a "ver" los cambios antes de volver a animar
            void refreshOverlay.offsetWidth;

            // 3. Aplicamos la animaci√≥n a cada frase con un retraso escalonado
            headlines.forEach((headline, index) => {
                headline.style.animation = ''; // Limpiamos para que se aplique la regla de CSS
                headline.style.animationDelay = `${index * 0.4}s`; // 0.4s de retraso entre cada frase
            });

            // Muestra el contenedor principal del aviso
            refreshOverlay.classList.add('is-visible');
            
            // Reinicia la animaci√≥n de la estrella fugaz
            const shootingStarRefresh = document.getElementById('shootingStarRefresh');
            if (shootingStarRefresh) {
                shootingStarRefresh.style.animation = 'none';
                void shootingStarRefresh.offsetWidth;
                shootingStarRefresh.style.animation = 'shoot-right-to-left 5s ease-in infinite 1.5s';
            }
        }
    }

    function hideOverlayAndRefresh() {
        if (refreshOverlay) {
            refreshOverlay.classList.remove('is-visible');
        }
        // Esperamos a que la transici√≥n de 1 segundo termine antes de recargar
        setTimeout(() => {
            location.reload();
        }, 1000);
    }

    if (refreshOverlay) {
        refreshOverlay.addEventListener('click', hideOverlayAndRefresh);
    }
    
    // Funci√≥n para comprobar si hay una nueva versi√≥n de los sorteos
    function checkForUpdates() {
        // El "?v=" + new Date().getTime() es un truco para evitar que el navegador use una versi√≥n antigua del archivo cacheada
        fetch('/version.json?v=' + new Date().getTime())
            .then(response => {
                if (!response.ok) {
                    throw new Error('No se pudo comprobar la versi√≥n.');
                }
                return response.json();
            })
            .then(data => {
                const serverVersion = data.version;
                const localVersion = parseInt(localStorage.getItem('appVersion')) || 0;

                console.log(`Versi√≥n del servidor: ${serverVersion}, Versi√≥n local: ${localVersion}`);

                if (serverVersion > localVersion) {
                    console.log('¬°Nueva versi√≥n detectada! Mostrando aviso de actualizaci√≥n.');
                    showRefreshOverlay();
                    localStorage.setItem('appVersion', serverVersion);
                }
            })
            .catch(error => {
                console.error('Error al comprobar actualizaciones:', error);
            });
    }

    // --- C√ìDIGO PARA ACTIVAR LA COMPROBACI√ìN ---

    // 1. Ejecuta la comprobaci√≥n EN CUANTO la p√°gina carga.
    checkForUpdates();

    // 2. Adem√°s, establece un temporizador para que se repita cada HORA.
    // (60 minutos * 60 segundos * 1000 milisegundos = 3600000)
    setInterval(checkForUpdates, 3600000);
    // --- [NUEVO] L√ìGICA PARA LOS FILTROS GLOBALES ---

const globalSearchInput = document.getElementById('global-search-input');
const globalCategoryFilter = document.getElementById('global-category-filter');

// 1. Funci√≥n para rellenar el desplegable de categor√≠as
function populateGlobalCategoryFilter() {
    if (!globalCategoryFilter) return;
    
    // Limpiamos por si acaso y a√±adimos la opci√≥n por defecto
    globalCategoryFilter.innerHTML = '';

    // Usamos el objeto CATEGORY_INFO que ya tienes
    for (const key in CATEGORY_INFO) {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = `${CATEGORY_INFO[key].emoji} ${CATEGORY_INFO[key].name}`;
        globalCategoryFilter.appendChild(option);
    }
}

// 2. Evento para el buscador de texto
if (globalSearchInput) {
    globalSearchInput.addEventListener('input', (e) => {
        searchQuery = e.target.value; // Actualizamos la variable global de b√∫squeda
        renderCalendar(); // Redibujamos el calendario con el filtro aplicado
        updateFilterBanner();
    });
}

// 3. Evento para el filtro de categor√≠a
if (globalCategoryFilter) {
    globalCategoryFilter.addEventListener('change', (e) => {
        setFilterAndRender(e.target.value);
        updateFilterBanner();
        toggleNavMenu(); // Cerramos el men√∫ para ver el resultado
    });
}

// 4. Llamamos a la funci√≥n para que el filtro se cree al cargar la p√°gina
populateGlobalCategoryFilter();

// [NUEVO] L√ìGICA PARA LOS BOTONES DE AYUDA
const HELP_CONTENT = {
    'modal': {
        title: 'üåü Gu√≠a del Cazador de Sorteos',
        content: `¬°Aqu√≠ es donde ocurre la magia! Gestiona los sorteos del d√≠a seleccionado.\n\n- B√∫squeda y Filtros: Usa el campo de b√∫squeda para encontrar un premio por su nombre o el filtro de categor√≠as para ver solo los que te interesan.\n- El Premio: El texto principal te dice qu√© se sortea. ¬°Haz clic sobre el precio para buscarlo directamente en Google!\n- Cuentas M√°gicas: Toca sobre cualquier cuenta @usuario para que te llevemos volando a su perfil de Instagram.\n- Checkbox de Realizado (‚úÖ): ¬°M√°rcalo cuando hayas participado! El sorteo se mover√° al final de la lista.\n- Botones de Acci√≥n (al completar):\n  - Trofeo (üèÜ): ¬°Has ganado! P√∫lsalo para mover el sorteo a tu Vitrina de Trofeos.\n  - Estrella (üåü): ¬øEs un sorteo muy importante (VIS)? P√∫lsalo para enviarlo a una lista especial de seguimiento.\n- Herramientas del Organizador:\n  - Calendario (üóìÔ∏è): Mueve el sorteo a una nueva fecha.\n  - Papelera (üóëÔ∏è): Env√≠a el sorteo a la papelera (puedes restaurarlo).\n  - Globo (üåç): Descarta el sorteo como extranjero y a√±ade las cuentas al cortafuegos.`
    },
    'add-giveaway-modal': {
        title: '‚úçÔ∏è ¬°A√±ade tu Tesoro!',
        content: 'Registra un nuevo sorteo manualmente.\n\n- Fecha: El d√≠a que finaliza el sorteo.\n- Premio: S√© descriptivo y usa los emojis para categorizar (ü•é, üõ©Ô∏è, üÉè, üí≤).\n- Cuentas: Escribe las cuentas de Instagram separadas por comas (ej: @cuenta1,@cuenta2).\n- Valor: El precio aproximado del premio.'
    },
    'ai-fullscreen-view': {
        title: 'ü§ñ El Asistente M√°gico de IA',
        content: '¬°Deja que la IA trabaje por ti!\n\n1. Selecciona Im√°genes: Pulsa el bot√≥n y sube hasta 100 capturas de pantalla de sorteos.\n2. Inicia el An√°lisis: La IA leer√° cada imagen, extraer√° toda la informaci√≥n y la clasificar√° por ti.\n3. Revisa y Confirma: Aparecer√° una tarjeta interactiva por cada imagen. Podr√°s editar cualquier dato o simplemente guardar si todo es correcto.'
    },
    'trash-modal': {
        title: 'üóëÔ∏è La Papelera de Oportunidades',
        content: 'Aqu√≠ descansan los sorteos que has eliminado.\n\n- Restaurar (‚Ü©Ô∏è): Pulsa este bot√≥n para devolver el sorteo a tu calendario.\n- Vaciar Papelera: ¬°Cuidado! Esta acci√≥n elimina permanentemente todos los sorteos de la papelera.'
    },
    'discarded-modal': {
        title: 'üóÇÔ∏è El Archivo de los Descartados',
        content: 'Aqu√≠ van los sorteos que la IA o t√∫ hab√©is filtrado por no ser v√°lidos (duplicados, caducados, extranjeros...).\n\n- Filtros: Usa los botones de arriba para navegar entre las distintas categor√≠as de descarte.\n- Recuperar (+): Si un sorteo se descart√≥ por error, pulsa para a√±adirlo manualmente.\n- Comparar (en Duplicados): Pulsa sobre un sorteo duplicado para ver una comparaci√≥n y decidir qu√© hacer.'
    },
    'trophy-modal': {
        title: 'üèÜ ¬°Tu Sal√≥n de la Fama!',
        content: '¬°Aqu√≠ brillan todos los premios que has ganado! Es el resultado de tu esfuerzo. Si a√±adiste un premio por error, puedes pulsar el icono (‚ùå) para eliminarlo.'
    },
    'stats-modal': {
        title: 'üìä Tu Centro de Estrategia',
        content: '¬°Los n√∫meros no mienten! Analiza tu rendimiento para optimizar tu estrategia.\n\n- Pesta√±as: Navega por las diferentes secciones para ver un resumen, tu rendimiento, consejos y gr√°ficos visuales.\n- Or√°culos: ¬øNecesitas inspiraci√≥n? Consulta a los or√°culos para ver qu√© te depara el futuro.\n- Compartir: ¬°Presume de tus logros! Copia un resumen de tus estad√≠sticas.'
    },
    'achievements-modal': {
        title: 'üèÖ Logros, T√≠tulos y M√©ritos',
        content: '¬°Demuestra tu maestr√≠a como cazador de sorteos!\n\n- Logros: Hitos que desbloqueas al usar la aplicaci√≥n. ¬°Dan Puntos de Sorteo (PS)!\n- T√≠tulos de Prestigio: Recompensas especiales por haza√±as legendarias. Puedes elegir cu√°l mostrar en la pantalla principal.\n- M√©ritos: Reconocimientos por ganar tipos espec√≠ficos de sorteos.'
    },
    'history-modal': {
        title: 'üïí Historial de An√°lisis de IA',
        content: 'Aqu√≠ puedes revisar los res√∫menes de tus √∫ltimas sesiones de an√°lisis con la IA. Despliega cada entrada para ver un desglose de los sorteos que se a√±adieron y los que se descartaron.'
    },
    'vis-modal': {
        title: 'üåü Revisi√≥n VIS (Very Important Sorteos)',
        content: 'Esta es tu sala de seguimiento personal para los sorteos m√°s importantes.\n\n- ¬øC√≥mo funciona?: Cuando participas en un sorteo, si pulsas el bot√≥n de la estrella (üåü), se a√±ade a esta lista.\n- Revisado: Cuando sepas que el sorteo ha finalizado y no has ganado, pulsa este bot√≥n para quitarlo de la lista.\n- Ganado: ¬°Si has ganado, pulsa aqu√≠ para moverlo a tu vitrina de trofeos!'
    }
};

document.addEventListener('click', function(e) {
    const helpBtn = e.target.closest('.help-btn');
    if (helpBtn) {
        const modalId = helpBtn.dataset.modalId;
        const helpData = HELP_CONTENT[modalId];
        if (helpData) {
            alert(`${helpData.title}\n\n${helpData.content}`);
        }
    }
});

// --- L√ìGICA DEL PANEL DE ADMINISTRADOR ---

// 1. Credenciales (cambia la contrase√±a aqu√≠ si lo necesitas en el futuro)
const ADMIN_USERNAME = "Misorteos";
const ADMIN_PASSWORD = "Saul31322";

// 2. Referencias a los nuevos elementos del modal de Admin
const adminPanelBtn = document.getElementById('admin-panel-btn');
const adminModal = document.getElementById('admin-modal');
const closeAdminModalBtn = document.getElementById('close-admin-modal');
const adminLoginForm = document.getElementById('admin-login-form');
const adminLoginView = document.getElementById('admin-login-view');
const adminActionsView = document.getElementById('admin-actions-view');
const adminUploadBtn = document.getElementById('admin-upload-btn');
const adminDownloadBtn = document.getElementById('admin-download-btn');

// 3. Configuraci√≥n del modal
setupModal(adminPanelBtn, adminModal, closeAdminModalBtn, () => {
    // Cada vez que se abre el modal, reseteamos a la vista de login
    adminLoginView.style.display = 'block';
    adminActionsView.style.display = 'none';
    adminLoginForm.reset();
});

// 4. L√≥gica de validaci√≥n de la contrase√±a
adminLoginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const usernameInput = document.getElementById('admin-username').value;
    const passwordInput = document.getElementById('admin-password').value;

    if (usernameInput === ADMIN_USERNAME && passwordInput === ADMIN_PASSWORD) {
        // Contrase√±a correcta: mostramos las acciones
        adminLoginView.style.display = 'none';
        adminActionsView.style.display = 'block';
        showNotification('Acceso Concedido', 'Bienvenido, Hechicero Mayor.');
    } else {
        // Contrase√±a incorrecta
        showNotification('Acceso Denegado', 'Las credenciales no son correctas.');
        adminLoginForm.reset();
    }
});

// 5. Conectar los botones de admin a las funciones existentes
adminUploadBtn.addEventListener('click', (e) => {
    e.preventDefault();
    zipUploadInput.click(); // Reutilizamos el input de archivo que ya existe
});

adminDownloadBtn.addEventListener('click', (e) => {
    e.preventDefault();
    downloadSourceCode(); // Reutilizamos la funci√≥n de descarga
});
</script>
</body>
</html>