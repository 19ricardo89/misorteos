<script id="animations-script">
    function animateStarryBackground() {
        const starsContainer = document.getElementById('magic-stars-container');
        if (!starsContainer) return;
        for (let i = 0; i < 100; i++) {
            let star = document.createElement('div');
            star.classList.add('star');
            let size = Math.random() * 3;
            star.style.width = `${size}px`; star.style.height = `${size}px`;
            star.style.top = `${Math.random() * 100}%`; star.style.left = `${Math.random() * 100}%`;
            star.style.animationDelay = `${Math.random() * 4}s`;
            if (Math.random() > 0.8) {
                star.classList.add('moving-star');
                star.style.animationDuration = `${Math.random() * 50 + 50}s`;
            }
            starsContainer.appendChild(star);
        }
    }

    function animateTitle() {
        const titleEl = document.getElementById('main-title');
        if (!titleEl) return;
        const titleText = "Misorteos";
        titleEl.innerHTML = titleText.split('').map(char => `<span class="letter" style="position: relative;">${char === ' ' ? '&nbsp;' : char}</span>`).join('');
        const letters = Array.from(titleEl.children);
        const revealDuration = letters.length * 150;

        letters.forEach((letter, index) => {
            setTimeout(() => {
                letter.style.opacity = '1'; letter.style.transform = 'translateY(0)';
                for (let i = 0; i < 3; i++) {
                    const sparkle = document.createElement('span');
                    sparkle.classList.add('sparkle');
                    sparkle.style.top = `${Math.random() * 80 - 40}%`;
                    sparkle.style.left = `${Math.random() * 80 - 40}%`;
                    sparkle.style.animation = `letter-reveal-sparkle 0.5s ${i * 0.1}s ease-out forwards`;
                    letter.appendChild(sparkle);
                    setTimeout(() => sparkle.remove(), 1000);
                }
            }, index * 150);
        });

        setTimeout(() => {
            setInterval(() => {
                const randomLetter = letters[Math.floor(Math.random() * letters.length)];
                if (randomLetter.innerText.trim() === '') return;
                const sparkle = document.createElement('span');
                sparkle.classList.add('fountain-sparkle');
                sparkle.style.left = `${Math.random() * 80 + 10}%`;
                randomLetter.appendChild(sparkle);
                setTimeout(() => sparkle.remove(), 1500);
            }, 100);
        }, revealDuration);
    }

    function animateShootingStar(itemContainer, callback) {
        const star = document.createElement('div');
        star.className = 'shooting-star';
        itemContainer.appendChild(star);

        star.addEventListener('animationend', () => {
            star.remove();
            if (callback) callback();
        }, { once: true });
    }
</script>

<script src="giveaways_new.js"></script>
<script src="discardedGiveaways_new.js"></script>
<script>
    let giveaways;
    const savedGiveaways = localStorage.getItem('giveaways');
    if (savedGiveaways) {
        giveaways = JSON.parse(savedGiveaways);
    } else {
        giveaways = window.giveaways || {};
    }

    let completedGiveaways = JSON.parse(localStorage.getItem(`completedGiveaways`)) || {};
    let wonGiveaways = JSON.parse(localStorage.getItem('wonGiveaways')) || [];
    let analysisHistory = JSON.parse(localStorage.getItem('analysisHistory')) || [];
    let userPoints = JSON.parse(localStorage.getItem('userPoints')) || { total: 0, monthly: 0, lastUpdatedMonth: new Date().getMonth() };

    const achievementList = {
        bronze: [{
            id: 'b_add_1',
            name: 'El Primer Paso',
            icon: 'üå±',
            desc: 'A√±ade tu primer sorteo manualmente.',
            ps: 5,
            condition: (c) => c.totalManualAdds >= 1
        }, {
            id: 'b_add_ia_1',
            name: 'Mirando al Futuro',
            icon: 'ü§ñ',
            desc: 'A√±ade tu primer sorteo usando la IA.',
            ps: 5,
            condition: (c) => c.totalGiveawaysAddedAI >= 1
        }, {
            id: 'b_complete_1',
            name: '¬°Manos a la Obra!',
            icon: '‚úÖ',
            desc: 'Marca tu primer sorteo como completado.',
            ps: 5,
            condition: (c) => c.totalGiveawaysCompleted >= 1
        }, {
            id: 'b_move_1',
            name: 'El Organizador',
            icon: 'üóìÔ∏è',
            desc: 'Mueve un sorteo de d√≠a por primera vez.',
            ps: 5,
            condition: (c) => c.firstMove
        }, {
            id: 'b_restore_1',
            name: 'Segunda Oportunidad',
            icon: '‚ôªÔ∏è',
            desc: 'Restaura un sorteo desde la papelera.',
            ps: 10,
            condition: (c) => c.restoredFromTrash >= 1
        }, {
            id: 'b_search_1',
            name: 'El Detective',
            icon: 'üïµÔ∏è',
            desc: 'Usa la b√∫squeda o un filtro por primera vez.',
            ps: 5,
            condition: (c) => c.searchesMade >= 1
        }, {
            id: 'b_win_1',
            name: '¬°Estoy en racha!',
            icon: 'üéâ',
            desc: 'Gana tu primer sorteo (de cualquier valor).',
            ps: 20,
            condition: (c) => c.totalGiveawaysWon >= 1
        }, ],
        silver: [{
            id: 's_add_100',
            name: 'Coleccionista Amateur',
            icon: 'üì¶',
            desc: 'Registra un total de 100 sorteos.',
            ps: 10,
            condition: (c) => c.totalGiveawaysAdded >= 100
        }, {
            id: 's_add_ia_50',
            name: 'Asistente de la IA',
            icon: 'üß†',
            desc: 'A√±ade 50 sorteos usando la IA.',
            ps: 15,
            condition: (c) => c.totalGiveawaysAddedAI >= 50
        }, {
            id: 's_complete_250',
            name: 'El Finalizador',
            icon: '‚úîÔ∏è',
            desc: 'Completa un total de 250 sorteos.',
            ps: 10,
            condition: (c) => c.totalGiveawaysCompleted >= 250
        }, {
            id: 's_firewall_1',
            name: 'El Inmun√≥logo',
            icon: 'üõ°Ô∏è',
            desc: 'A√±ade tu primera cuenta al cortafuegos de extranjeras.',
            ps: 15,
            condition: (c) => c.foreignAccountsBlocked >= 1
        }, {
            id: 's_win_value_100',
            name: 'Cazador de Tesoros',
            icon: 'üíé',
            desc: 'Gana un premio valorado en m√°s de 100‚Ç¨.',
            ps: 25,
            condition: (c) => c.winsOver100 >= 1
        }, {
            id: 's_win_5',
            name: 'Lluvia de Victorias',
            icon: 'üå¶Ô∏è',
            desc: 'Gana 5 sorteos en total.',
            ps: 25,
            condition: (c) => c.totalGiveawaysWon >= 5
        }, {
            id: 's_specialist_3',
            name: 'El Especialista',
            icon: '‚≠ê',
            desc: 'Gana 3 sorteos de la misma categor√≠a.',
            ps: 30,
            condition: (c) => Object.values(c.categoryWins).some(val => val >= 3)
        }, ],
        gold: [{
            id: 'g_add_500',
            name: 'Archivista Profesional',
            icon: 'üóÑÔ∏è',
            desc: 'Registra un total de 500 sorteos.',
            ps: 20,
            condition: (c) => c.totalGiveawaysAdded >= 500
        }, {
            id: 'g_ia_process_500',
            name: 'Conexi√≥n Neuronal',
            icon: 'üì°',
            desc: 'Procesa un total de 500 im√°genes con la IA.',
            ps: 25,
            condition: (c) => c.totalImagesProcessedAI >= 500
        }, {
            id: 'g_win_25',
            name: 'El Conquistador',
            icon: 'üè∞',
            desc: 'Gana 25 sorteos en total.',
            ps: 50,
            condition: (c) => c.totalGiveawaysWon >= 25
        }, {
            id: 'g_win_double',
            name: 'Doble Suerte',
            icon: '‚úåÔ∏è',
            desc: 'Gana dos sorteos en el mismo d√≠a.',
            ps: 75,
            condition: (c) => Object.values(c.sameDayWins).some(val => val >= 2)
        }, {
            id: 'g_value_2500',
            name: 'Acaparador',
            icon: 'üí∞',
            desc: 'Supera los 2.500‚Ç¨ en valor total de premios.',
            ps: 50,
            condition: (c) => c.totalValueWon >= 2500
        }, {
            id: 'g_merge_1',
            name: 'El Fusionador',
            icon: 'üß¨',
            desc: 'Fusiona un sorteo duplicado con su original.',
            ps: 20,
            condition: (c) => c.mergedDuplicates >= 1
        }, ],
        platinum: [{
            id: 'p_add_2000',
            name: 'Biblioteca de Sorteos',
            icon: 'üèõÔ∏è',
            desc: 'Registra 2.000 sorteos.',
            ps: 50,
            condition: (c) => c.totalGiveawaysAdded >= 2000
        }, {
            id: 'p_complete_1500',
            name: 'M√°quina de Completar',
            icon: 'üíØ',
            desc: 'Completa 1.500 sorteos.',
            ps: 40,
            condition: (c) => c.totalGiveawaysCompleted >= 1500
        }, {
            id: 'p_win_value_2000',
            name: 'El Toque de Midas',
            icon: '‚ú®',
            desc: 'Gana un premio valorado en m√°s de 2.000‚Ç¨.',
            ps: 100,
            condition: (c) => c.winsOver2000 >= 1
        }, {
            id: 'p_win_50',
            name: 'Im√°n de Premios',
            icon: 'üß≤',
            desc: 'Gana 50 sorteos en total.',
            ps: 100,
            condition: (c) => c.totalGiveawaysWon >= 50
        }, {
            id: 'p_talisman',
            name: 'Talism√°n Dorado',
            icon: 'üçÄ',
            desc: 'Gana 3 premios de la misma cuenta de Instagram.',
            ps: 75,
            condition: (c) => Object.values(c.winsFromSameAccount).some(val => val >= 3)
        }, ],
        diamond: [{
            id: 'd_win_100',
            name: 'Coleccionista Legendario',
            icon: 'üëë',
            desc: 'Gana 100 sorteos en total.',
            ps: 200,
            condition: (c) => c.totalGiveawaysWon >= 100
        }, {
            id: 'd_value_25000',
            name: 'Toque de Midas',
            icon: 'üëë',
            desc: 'Acumula 25.000‚Ç¨ en premios ganados.',
            ps: 250,
            condition: (c) => c.totalValueWon >= 25000
        }, {
            id: 'd_nostradamus',
            name: 'El Nostradamus',
            icon: 'üìú',
            desc: 'Gana un sorteo que a√±adiste m√°s de 6 meses antes.',
            ps: 150,
            condition: (c) => c.nostradamusWins >= 1
        }, {
            id: 'd_win_triple',
            name: 'Tr√©bol de Doce Hojas',
            icon: 'üçÄ',
            desc: 'Gana 3 sorteos en un mismo d√≠a.',
            ps: 200,
            condition: (c) => Object.values(c.sameDayWins).some(val => val >= 3)
        }, ],
        merits: [{
            id: 'm_photo',
            name: 'Victoria Fotogr√°fica',
            icon: 'üì∏',
            desc: 'Gana un sorteo cuyo premio sea una c√°mara.',
            ps: 20,
            condition: (c, u, p) => p && /c√°mara|instax/i.test(p.prize)
        }, {
            id: 'm_sweet',
            name: 'El Dulce Sabor de la Victoria',
            icon: 'üç¨',
            desc: 'Gana un sorteo de comida o dulces.',
            ps: 20,
            condition: (c, u, p) => p && /comida|dulces|jam√≥n|chocolate|tarta|lote de productos/i.test(p.prize)
        }, {
            id: 'm_tech',
            name: 'Victoria Tecnol√≥gica',
            icon: 'üíª',
            desc: 'Gana un premio de tecnolog√≠a (m√≥vil, tablet, consola, etc).',
            ps: 25,
            condition: (c, u, p) => p && /m√≥vil|consola|auriculares|tablet|port√°til|pc|ps5|nintendo|xbox/i.test(p.prize)
        }, {
            id: 'm_fashion',
            name: 'Icono de la Moda',
            icon: 'üë†',
            desc: 'Gana un premio de moda (ropa, zapatillas, bolso).',
            ps: 20,
            condition: (c, u, p) => p && /ropa|zapatillas|bolso|camiseta|sudadera|gafas de sol/i.test(p.prize)
        }, {
            id: 'm_beauty',
            name: 'Gur√∫ de Belleza',
            icon: 'üíÑ',
            desc: 'Gana un lote de productos de cosm√©tica o maquillaje.',
            ps: 20,
            condition: (c, u, p) => p && /belleza|maquillaje|cosm√©tica|perfume|lote de productos/i.test(p.prize)
        }, {
            id: 'm_experience',
            name: 'Coleccionista de Experiencias',
            icon: 'üé´',
            desc: 'Gana entradas, una cena o una experiencia.',
            ps: 30,
            condition: (c, u, p) => p && /entradas|cena|experiencia|abono|festival/i.test(p.prize)
        }, {
            id: 'm_fast',
            name: 'A Contrarreloj',
            icon: '‚è±Ô∏è',
            desc: 'A√±ade y completa un sorteo el mismo d√≠a que finaliza.',
            ps: 15,
            condition: (c) => c.lastMinuteCompletes >= 1
        }, {
            id: 'm_seer',
            name: 'El Adivino',
            icon: 'üëÅÔ∏è',
            desc: 'Gana un sorteo que previamente hab√≠as movido de fecha.',
            ps: 25,
            condition: (c) => c.movedGiveawayWins >= 1
        }, {
            id: 'm_repeat',
            name: 'El Reincidente',
            icon: 'üîÅ',
            desc: 'Gana un sorteo de una cuenta de la que ya ganaste antes.',
            ps: 30,
            condition: (c) => Object.values(c.winsFromSameAccount).some(val => val >= 2)
        }, {
            id: 'm_rival',
            name: 'Rival Eterno',
            icon: 'ü§∫',
            desc: 'Participa en m√°s de 50 sorteos de una misma cuenta sin ganar.',
            ps: 10,
            condition: (c) => Object.values(c.playsOnSameAccount).some(val => val >= 50)
        }, ],
        prestige: [{
            id: 't_padel',
            title: 'Maestro/a de la Pala',
            req: 'Gana 15 sorteos de P√°del.',
            condition: (c) => c.categoryWins.padel >= 15
        }, {
            id: 't_travel',
            title: 'N√≥mada Legendario/a',
            req: 'Gana 15 sorteos de Viajes.',
            condition: (c) => c.categoryWins.viajes >= 15
        }, {
            id: 't_friki',
            title: 'Se√±or/a de los Funkos',
            req: 'Gana 15 sorteos Frikis.',
            condition: (c) => c.categoryWins.frikis >= 15
        }, {
            id: 't_polymath',
            title: 'El/La Pol√≠mata',
            req: 'Consigue los 3 t√≠tulos de especialista (P√°del, Viajes, Frikis).',
            condition: (c, u) => u.includes('t_padel') && u.includes('t_travel') && u.includes('t_friki')
        }, {
            id: 't_oracle',
            title: 'Or√°culo de la IA',
            req: 'A√±ade 500 sorteos con la IA.',
            condition: (c) => c.totalGiveawaysAddedAI >= 500
        }, {
            id: 't_magnate',
            title: 'Fortuna Personificada',
            req: 'Supera los 10.000‚Ç¨ en premios.',
            condition: (c) => c.totalValueWon >= 10000
        }, {
            id: 't_consistency',
            title: 'El Metr√≥nomo',
            req: 'Gana al menos un sorteo al mes durante 12 meses seguidos.',
            condition: (c) => c.monthlyWinStreak >= 12
        }, {
            id: 't_allrounder',
            title: 'El/La Todoterreno',
            req: 'Gana al menos 5 premios en cada una de las 4 categor√≠as.',
            condition: (c) => c.categoryWins.padel >= 5 && c.categoryWins.viajes >= 5 && c.categoryWins.frikis >= 5 && c.categoryWins.otros >= 5
        }, {
            id: 't_monopolist',
            title: 'El/La Monopolista',
            req: 'Gana premios de 50 cuentas organizadoras diferentes.',
            condition: (c) => Object.keys(c.winsFromSameAccount).length >= 50
        }, {
            id: 't_perfectionist',
            title: 'El/La Perfeccionista',
            req: 'Completa todos los logros de Bronce, Plata y Oro.',
            condition: (c, u) => [...achievementList.bronze, ...achievementList.silver, ...achievementList.gold].every(ach => u.includes(ach.id))
        }, {
            id: 't_legend',
            title: 'Leyenda Viva',
            req: 'Desbloquea 10 T√≠tulos de Prestigio.',
            condition: (c, u) => u.filter(id => id.startsWith('t_')).length >= 10
        }, ]
    };

    const initialAchievements = {
        unlocked: [],
        title: 'Buscador/a de Tr√©boles üçÄ',
        counters: {
            totalGiveawaysAdded: 0,
            totalManualAdds: 0,
            totalGiveawaysAddedAI: 0,
            totalGiveawaysCompleted: 0,
            totalGiveawaysWon: 0,
            totalValueWon: 0,
            categoryWins: {
                padel: 0,
                viajes: 0,
                frikis: 0,
                otros: 0
            },
            firstMove: false,
            restoredFromTrash: 0,
            searchesMade: 0,
            winsOver100: 0,
            winsOver2000: 0,
            foreignAccountsBlocked: 0,
            sniperWins: 0,
            sameDayWins: {},
            mergedDuplicates: 0,
            totalImagesProcessedAI: 0,
            winsFromSameAccount: {},
            playsOnSameAccount: {},
            nostradamusWins: 0,
            monthlyWinStreak: 0,
            lastWinMonthYear: null,
            movedGiveawayWins: 0,
            lastMinuteCompletes: 0,
        }
    };

    let userAchievements = JSON.parse(localStorage.getItem('userAchievements')) || initialAchievements;

    let blockHistory = JSON.parse(localStorage.getItem('blockHistory')) || [];
    let completedGiveawayCount = Object.keys(completedGiveaways).length;
    let currentDate = new Date();
    let currentFilter = 'all';
    let searchQuery = '';
    const MAX_IMAGES = 100;
    let discardedFilter = 'all';
    let totalCaptures = 0;
    let addedGiveawaysCount = 0;
    let duplicateGiveawaysCount = 0;
    let expiredGiveawaysCount = 0;
    let foreignGiveawaysCount = 0;
    let noDateGiveawaysCount = 0;
    let addedGiveawaysDetails = [];
    let duplicateGiveawaysDetails = [];
    let expiredGiveawaysDetails = [];
    let foreignGiveawaysDetails = [];
    let noDateGiveawaysDetails = [];
    let failedFilesDetails = [];
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    let trashGiveaways = JSON.parse(localStorage.getItem('trashGiveaways')) || [];
    let foreignAccounts = JSON.parse(localStorage.getItem('foreignAccounts')) || [];
    let discardedGiveaways;
    const savedDiscarded = localStorage.getItem('discardedGiveaways');
    if (savedDiscarded) {
        discardedGiveaways = JSON.parse(savedDiscarded);
    } else {
        discardedGiveaways = window.discardedGiveaways || [];
    }

    const monthYearEl = document.getElementById('month-year');
    const calendarDaysEl = document.getElementById('calendar-days');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modal-body');
    const closeModalBtn = document.getElementById('close-modal');
    const addManualBtn = document.getElementById('add-manual-btn');
    const addGiveawayModal = document.getElementById('add-giveaway-modal');
    const closeAddGiveawayModalBtn = document.getElementById('close-add-giveaway-modal');
    const addGiveawayForm = document.getElementById('add-giveaway-form');
    const giveawayDateInput = document.getElementById('giveaway-date');
    const giveawayPrizeInput = document.getElementById('giveaway-prize');
    const giveawayAccountsInput = document.getElementById('giveaway-accounts');
    const giveawayPriceInput = document.getElementById('giveaway-price');
    const totalGiveawaysEl = document.getElementById('total-giveaways-count');
    const searchMenuBtn = document.getElementById('search-menu-btn');
    const searchModal = document.getElementById('search-modal');
    const closeSearchModalBtn = document.getElementById('close-search-modal');
    const searchInputModal = document.getElementById('search-input-modal');
    const selectAllBtn = document.getElementById('select-all-btn');
    const deselectAllBtn = document.getElementById('deselect-all-btn');
    const addAIBtn = document.getElementById('add-ai-btn');
    const addAIGiveawayModal = document.getElementById('add-ai-giveaway-modal');
    const closeAddAIGiveawayModalBtn = document.getElementById('close-add-ai-giveaway-modal');
    const selectAiImagesBtn = document.getElementById('select-ai-images-btn');
    const aiImageInput = document.getElementById('ai-image-upload');
    const aiQueueContainer = document.getElementById('ai-queue-container');
    const aiQueueList = document.getElementById('ai-image-queue');
    const aiQueueCount = document.getElementById('ai-queue-count');
    const startAiButton = document.getElementById('start-ai-button');
    const aiStatusContainer = document.getElementById('ai-status-container');
    const aiStatusMessage = document.getElementById('ai-status-message');
    const aiProgressBar = document.getElementById('ai-progress');
    const aiSummaryResults = document.getElementById('ai-summary-results');
    const aiSummaryCloseBtn = document.getElementById('ai-summary-close-btn');
    const trashBtn = document.getElementById('trash-btn');
    const discardedBtn = document.getElementById('discarded-btn');
    const statsBtn = document.getElementById('stats-btn');
    const historyBtn = document.getElementById('history-btn');
    const trophyBtn = document.getElementById('trophy-btn');
    const achievementsBtn = document.getElementById('achievements-btn');
    const navMenu = document.getElementById('nav-menu');
    const openNavMenuBtn = document.getElementById('open-nav-menu');
    const closeNavMenuBtn = document.getElementById('close-nav-menu');
    const menuOverlay = document.getElementById('menu-overlay');
    const userTitleEl = document.getElementById('user-title');
    const totalPsCountEl = document.getElementById('total-ps-count');
    const statsModal = document.getElementById('stats-modal');
    const historyModal = document.getElementById('history-modal');
    const trophyModal = document.getElementById('trophy-modal');
    const achievementsModal = document.getElementById('achievements-modal');
    const trophyModalBody = document.getElementById('trophy-modal-body');
    const historyModalBody = document.getElementById('history-modal-body');
    const achievementsModalBody = document.getElementById('achievements-modal-body');
    const closeStatsModalBtn = document.getElementById('close-stats-modal');
    const closeHistoryModalBtn = document.getElementById('close-history-modal');
    const closeTrophyModalBtn = document.getElementById('close-trophy-modal');
    const closeAchievementsModalBtn = document.getElementById('close-achievements-modal');
    const trashModal = document.getElementById('trash-modal');
    const closeTrashModalBtn = document.getElementById('close-trash-modal');
    const trashModalBody = document.getElementById('trash-modal-body');
    const deleteAllTrashBtn = document.getElementById('delete-all-trash-btn');
    const discardedModal = document.getElementById('discarded-modal');
    const closeDiscardedModalBtn = document.getElementById('close-discarded-modal');
    const discardedModalBody = document.getElementById('discarded-modal-body');
    const deleteAllDiscardedBtn = document.getElementById('delete-all-discarded-btn');
    const duplicateModal = document.getElementById('duplicate-modal');
    const closeDuplicateModalBtn = document.getElementById('close-duplicate-modal');
    const duplicateGiveawayInfo = document.getElementById('duplicate-giveaway-info');
    const confirmRestoreBtn = document.getElementById('confirm-restore-btn');
    const cancelRestoreBtn = document.getElementById('cancel-restore-btn');
    const moveGiveawayModal = document.getElementById('move-giveaway-modal');
    const closeMoveGiveawayModalBtn = document.getElementById('close-move-giveaway-modal');
    const moveGiveawayForm = document.getElementById('move-giveaway-form');
    const newGiveawayDateInput = document.getElementById('new-giveaway-date');
    const openChartsModalBtn = document.getElementById('open-charts-modal');
    const chartsModal = document.getElementById('charts-modal');
    const closeChartsModalBtn = document.getElementById('close-charts-modal');
    const duplicateComparisonModal = document.getElementById('duplicate-comparison-modal');
    const closeDuplicateComparisonModalBtn = document.getElementById('close-duplicate-comparison-modal');
    const originalGiveawayDetails = document.getElementById('original-giveaway-details');
    const discardedGiveawayDetails = document.getElementById('discarded-giveaway-details');
    const mergeGiveawayBtn = document.getElementById('merge-giveaway-btn');
    const addAsNewBtn = document.getElementById('add-as-new-btn');
    const manageForeignAccountsBtn = document.getElementById('manage-foreign-accounts-btn');
    const foreignAccountsModal = document.getElementById('foreign-accounts-modal');
    const closeForeignAccountsModalBtn = document.getElementById('close-foreign-accounts-modal');
    const foreignAccountsModalBody = document.getElementById('foreign-accounts-modal-body');
    const manageBlocksBtn = document.getElementById('manage-blocks-btn');
    const blockManagementModal = document.getElementById('block-management-modal');
    const closeBlockManagementModalBtn = document.getElementById('close-block-management-modal');
    const blockLikeBtn = document.getElementById('block-like-btn');
    const blockCommentBtn = document.getElementById('block-comment-btn');
    const blockStatsContainer = document.getElementById('block-stats-container');
    const errorDetailsModal = document.getElementById('error-details-modal');
    const closeErrorDetailsModalFunc = document.getElementById('close-error-details-modal');
    const errorDetailsFilename = document.getElementById('error-details-filename');
    const errorDetailsReason = document.getElementById('error-details-reason');
    const reanalyzeSingleBtn = document.getElementById('reanalyze-single-btn');

    let giveawayToMove = null;
    let originalDateOfGiveaway = null;
    let imageQueue = [];
    let isProcessing = false;
    let currentIndex = 0;

    const showNotification = (title, message) => {
        const notificationModal = document.getElementById('notification-modal');
        const notificationTitle = document.getElementById('notification-title');
        const notificationContent = document.getElementById('notification-content');
        notificationTitle.textContent = title;
        notificationContent.textContent = message;
        notificationModal.classList.remove('hidden');
        requestAnimationFrame(() => {
            notificationModal.classList.add('is-visible');
        });
        setTimeout(() => {
            notificationModal.classList.remove('is-visible');
            setTimeout(() => {
                notificationModal.classList.add('hidden');
            }, 300);
        }, 4000);
    };

    const saveGiveaways = () => localStorage.setItem('giveaways', JSON.stringify(giveaways));
    const saveCompletedGiveaways = () => localStorage.setItem(`completedGiveaways`, JSON.stringify(completedGiveaways));
    const saveTrashGiveaways = () => localStorage.setItem('trashGiveaways', JSON.stringify(trashGiveaways));
    const saveDiscardedGiveaways = () => localStorage.setItem('discardedGiveaways', JSON.stringify(discardedGiveaways));
    const saveForeignAccounts = () => localStorage.setItem('foreignAccounts', JSON.stringify(foreignAccounts));
    const saveWonGiveaways = () => localStorage.setItem('wonGiveaways', JSON.stringify(wonGiveaways));
    const saveAnalysisHistory = () => localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
    const saveUserPoints = () => localStorage.setItem('userPoints', JSON.stringify(userPoints));
    const saveUserAchievements = () => localStorage.setItem('userAchievements', JSON.stringify(userAchievements));
    const saveBlockHistory = () => localStorage.setItem('blockHistory', JSON.stringify(blockHistory));

    const updatePointsDisplay = () => {
        if (totalPsCountEl) {
            totalPsCountEl.textContent = userPoints.total;
        }
    };

    const addPoints = (pointsToAdd) => {
        userPoints.total += pointsToAdd;
        saveUserPoints();
        updatePointsDisplay();
    };

    const parsePrice = (priceString) => {
        if (!priceString || typeof priceString !== 'string') return 0;
        const cleanedString = priceString.replace(/[^0-9,.]/g, '').replace(',', '.');
        const numericValue = parseFloat(cleanedString);
        return isNaN(numericValue) ? 0 : numericValue;
    };

    const checkAchievements = (action, data = null) => {
        const today = new Date().toISOString().slice(0, 10);
        const counters = userAchievements.counters;

        counters.totalGiveawaysAdded = Object.values(giveaways).flat().length + wonGiveaways.length;
        counters.totalGiveawaysCompleted = Object.keys(completedGiveaways).length;
        counters.totalGiveawaysWon = wonGiveaways.length;
        counters.totalValueWon = wonGiveaways.reduce((sum, g) => sum + parsePrice(g.price), 0);

        if (action === 'add-manual') counters.totalManualAdds = (counters.totalManualAdds || 0) + 1;
        if (action === 'add-ai') counters.totalGiveawaysAddedAI = (counters.totalGiveawaysAddedAI || 0) + 1;
        if (action === 'move') counters.firstMove = true;
        if (action === 'restore') counters.restoredFromTrash = (counters.restoredFromTrash || 0) + 1;
        if (action === 'search') counters.searchesMade = (counters.searchesMade || 0) + 1;
        if (action === 'block-foreign') counters.foreignAccountsBlocked = (counters.foreignAccountsBlocked || 0) + 1;
        if (action === 'merge') counters.mergedDuplicates = (counters.mergedDuplicates || 0) + 1;
        if (action === 'complete' && data.giveawayDate === today) counters.lastMinuteCompletes = (counters.lastMinuteCompletes || 0) + 1;

        if (action === 'win') {
            const prizeValue = parsePrice(data.price);
            if (prizeValue > 100) counters.winsOver100 = (counters.winsOver100 || 0) + 1;
            if (prizeValue > 2000) counters.winsOver2000 = (counters.winsOver2000 || 0) + 1;

            const categoryMap = {
                'ü•é': 'padel',
                'üõ©Ô∏è': 'viajes',
                'üÉè': 'frikis'
            };
            let prizeCategory = 'otros';
            for (const emoji in categoryMap) {
                if (data.prize.includes(emoji)) {
                    prizeCategory = categoryMap[emoji];
                    break;
                }
            }
            counters.categoryWins[prizeCategory]++;

            counters.sameDayWins[today] = (counters.sameDayWins[today] || 0) + 1;

            data.accounts.forEach(acc => {
                counters.winsFromSameAccount[acc] = (counters.winsFromSameAccount[acc] || 0) + 1;
            });

            if (data.moved) counters.movedGiveawayWins = (counters.movedGiveawayWins || 0) + 1;

            if (data.addDate) {
                const addDate = new Date(data.addDate);
                const winDate = new Date(data.wonDate);
                const diffMonths = (winDate.getFullYear() - addDate.getFullYear()) * 12 + (winDate.getMonth() - addDate.getMonth());
                if (diffMonths >= 6) counters.nostradamusWins = (counters.nostradamusWins || 0) + 1;
            }
        }

        const allAchievementTypes = [...achievementList.bronze, ...achievementList.silver, ...achievementList.gold, ...achievementList.platinum, ...achievementList.diamond, ...achievementList.merits, ...achievementList.prestige];
        allAchievementTypes.forEach(ach => {
            if (!userAchievements.unlocked.includes(ach.id)) {
                const conditionData = action === 'win' ? data : null;
                if (ach.condition(counters, userAchievements.unlocked, conditionData)) {
                    userAchievements.unlocked.push(ach.id);
                    const title = ach.title || ach.name;
                    const isPrestige = ach.id.startsWith('t_');
                    showNotification(`üèÜ ${isPrestige ? 'T√≠tulo Desbloqueado' : 'Logro Desbloqueado'}!`, title);
                    if (ach.ps) addPoints(ach.ps);
                    if (isPrestige) {
                        userAchievements.title = ach.title;
                    }
                }
            }
        });

        saveUserAchievements();
        userTitleEl.textContent = userAchievements.title;
    };

    const isDuplicateGiveaway = (newGiveaway) => {
        return Object.values(giveaways).flat().find(g =>
            g.prize === newGiveaway.prize &&
            (g.accounts || []).join() === (newGiveaway.accounts || []).map(acc => `@${acc}`).join()
        ) || null;
    };

    const renderCalendar = () => {
        calendarDaysEl.innerHTML = '';
        const month = currentDate.getMonth();
        const year = currentDate.getFullYear();
        monthYearEl.textContent = `${currentDate.toLocaleDateString('es-ES', {
            month: 'long'
        }).toUpperCase()}`;
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const dayOffset = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;
        let totalGiveawaysCount = 0;
        for (let i = 0; i < dayOffset; i++) {
            calendarDaysEl.innerHTML += `<div></div>`;
        }
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayGiveaways = (giveaways[dateStr] || []).filter(g => {
                const prize = g.prize ? g.prize.toLowerCase() : '';
                const searchText = searchQuery.toLowerCase();
                let isMatch = true;
                if (currentFilter !== 'all') {
                    isMatch = (currentFilter === 'padel' && prize.includes('ü•é')) ||
                        (currentFilter === 'travel' && prize.includes('üõ©Ô∏è')) ||
                        (currentFilter === 'price' && prize.includes('üí≤')) ||
                        (currentFilter === 'frikis' && prize.includes('üÉè'));
                }
                if (searchQuery && !prize.includes(searchText)) isMatch = false;
                return isMatch;
            });
            totalGiveawaysCount += dayGiveaways.length;
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.draggable = true;
            dayEl.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', dateStr);
                e.dataTransfer.effectAllowed = 'move';
            });
            let dayNumberHTML = `<span class="day-number">${day}</span>`;
            if (dayGiveaways.length > 0) {
                dayEl.classList.add('has-giveaway');
                dayEl.dataset.date = dateStr;
                const remainingCount = dayGiveaways.filter(g => !completedGiveaways[g.id]).length;
                if (remainingCount > 0) {
                    dayNumberHTML += `<span class="giveaway-count rounded-full">${remainingCount}</span>`;
                } else {
                    dayEl.classList.add('all-done');
                    dayNumberHTML += `<span class="text-2xl mt-1">‚ú®</span>`;
                }
            }
            dayEl.innerHTML = dayNumberHTML;
            calendarDaysEl.appendChild(dayEl);
        }
        if (totalGiveawaysEl) totalGiveawaysEl.textContent = totalGiveawaysCount;
    };

    const buildModal = (dateStr) => {
        let dayGiveaways = (giveaways[dateStr] || []).filter(g => {
            const prize = g.prize ? g.prize.toLowerCase() : '';
            const searchText = searchQuery.toLowerCase();
            let isMatch = true;
            if (currentFilter !== 'all') {
                isMatch = (currentFilter === 'padel' && prize.includes('ü•é')) ||
                    (currentFilter === 'travel' && prize.includes('üõ©Ô∏è')) ||
                    (currentFilter === 'price' && prize.includes('üí≤')) ||
                    (currentFilter === 'frikis' && prize.includes('üÉè'));
            }
            if (searchQuery && !prize.includes(searchText)) isMatch = false;
            return isMatch;
        });

        dayGiveaways.sort((a, b) => {
            const aCompleted = completedGiveaways[a.id];
            const bCompleted = completedGiveaways[b.id];
            const aHasTime = a.ends_at_time != null;
            const bHasTime = b.ends_at_time != null;

            if (aCompleted !== bCompleted) {
                return aCompleted ? 1 : -1;
            }
            if (aHasTime !== bHasTime) {
                return aHasTime ? -1 : 1;
            }
            return 0;
        });

        document.getElementById('modal-title').textContent = `Sorteos del ${new Date(dateStr + 'T00:00:00').toLocaleDateString('es-ES', {
            day: 'numeric',
            month: 'long'
        })}`;
        modalBody.innerHTML = '';
        let hasPadel = false, hasTravel = false;
        dayGiveaways.forEach(giveaway => {
            const itemContainer = document.createElement('div');
            itemContainer.className = `giveaway-item p-3 rounded-lg shadow-inner flex justify-between items-center border border-yellow-600/20 relative ${completedGiveaways[giveaway.id] ? 'bg-green-100/30' : 'bg-yellow-100/50'}`;

            const leftSideContainer = document.createElement('div');
            leftSideContainer.className = 'flex items-center flex-1 overflow-hidden';

            const controlsContainer = document.createElement('div');
            controlsContainer.className = 'flex flex-col items-center mr-3 flex-shrink-0';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.dataset.giveawayId = giveaway.id;
            checkbox.className = 'h-5 w-5 sm:h-6 sm:w-6 rounded-md border-2 border-yellow-600 text-yellow-500 focus:ring-yellow-500';
            checkbox.checked = completedGiveaways[giveaway.id];
            controlsContainer.appendChild(checkbox);

            const winBtn = document.createElement('button');
            winBtn.className = 'win-giveaway-btn';
            winBtn.innerHTML = `üèÜ`;
            winBtn.dataset.giveawayId = giveaway.id;
            winBtn.dataset.giveawayDate = dateStr;
            controlsContainer.appendChild(winBtn);

            const prizeContainer = document.createElement('div');
            prizeContainer.className = 'overflow-hidden';

            let accountsHTML = (giveaway.accounts || []).map(acc => `<a href="https://instagram.com/${acc.replace('‚ö†Ô∏è', '').substring(1)}" target="_blank" class="underline">${acc}</a>`).join(', ');
            const timeEmoji = giveaway.ends_at_time ? '‚è∞' : '';
            prizeContainer.innerHTML = `<p class="text-base sm:text-lg text-yellow-900 truncate">${giveaway.prize} ${timeEmoji}</p><p class="text-sm truncate">${accountsHTML}</p>`;

            leftSideContainer.appendChild(controlsContainer);
            leftSideContainer.appendChild(prizeContainer);

            const detailsContainer = document.createElement('div');
            detailsContainer.className = 'text-right flex-shrink-0 ml-2';
            if (giveaway.price) {
                detailsContainer.innerHTML = `<a href="https://www.google.com/search?q=${encodeURIComponent(giveaway.prize)}" target="_blank" class="block font-bold">${giveaway.price}</a><span class="text-xs">Valor aprox.</span>`;
            }

            itemContainer.appendChild(leftSideContainer);
            itemContainer.appendChild(detailsContainer);

            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'flex flex-col items-center ml-2 space-y-2';
            const moveBtn = document.createElement('button');
            moveBtn.className = 'move-giveaway-btn p-1 rounded-full';
            moveBtn.innerHTML = `<i class="fa-solid fa-calendar-alt"></i>`;
            moveBtn.dataset.giveawayId = giveaway.id;
            moveBtn.dataset.giveawayDate = dateStr;
            actionsContainer.appendChild(moveBtn);
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-giveaway-btn p-1 rounded-full';
            deleteBtn.innerHTML = `<i class="fa-solid fa-trash-can"></i>`;
            deleteBtn.dataset.giveawayId = giveaway.id;
            deleteBtn.dataset.giveawayDate = dateStr;
            actionsContainer.appendChild(deleteBtn);
            const deleteForeignBtn = document.createElement('button');
            deleteForeignBtn.className = 'delete-giveaway-foreign-btn p-1 rounded-full';
            deleteForeignBtn.innerHTML = `<i class="fa-solid fa-earth-americas"></i>`;
            deleteForeignBtn.dataset.giveawayId = giveaway.id;
            deleteForeignBtn.dataset.giveawayDate = dateStr;
            actionsContainer.appendChild(deleteForeignBtn);

            itemContainer.appendChild(actionsContainer);
            modalBody.appendChild(itemContainer);

            if (giveaway.prize.includes('ü•é')) hasPadel = true;
            if (giveaway.prize.includes('üõ©Ô∏è')) hasTravel = true;
        });
        const modalContent = document.getElementById('modal-content');
        modalContent.classList.remove('modal-default-bg', 'modal-padel-bg', 'modal-travel-bg');
        if (hasPadel) modalContent.classList.add('modal-padel-bg');
        else if (hasTravel) modalContent.classList.add('modal-travel-bg');
        else modalContent.classList.add('modal-default-bg');
        modal.dataset.date = dateStr;
    };

    const openModal = (dateStr) => {
        buildModal(dateStr);
        modal.classList.remove('hidden');
        requestAnimationFrame(() => modal.classList.add('is-visible'));
    };
    const closeModal = () => {
        modal.classList.remove('is-visible');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    };

    const openAddGiveawayModal = (data = {}) => {
        addGiveawayForm.reset();
        addGiveawayModal.classList.remove('hidden');
        if (data.prize) giveawayPrizeInput.value = data.prize;
        if (data.accounts) giveawayAccountsInput.value = data.accounts;
        if (data.price) giveawayPriceInput.value = data.price;
        if (data.date) giveawayDateInput.value = data.date;
        requestAnimationFrame(() => addGiveawayModal.classList.add('is-visible'));
    };
    const closeAddGiveawayModal = () => {
        addGiveawayModal.classList.remove('is-visible');
        setTimeout(() => addGiveawayModal.classList.add('hidden'), 300);
    };

    const openSearchModal = () => {
        searchModal.classList.remove('hidden');
        requestAnimationFrame(() => searchModal.classList.add('is-visible'));
    };
    const closeSearchModal = () => {
        searchModal.classList.remove('is-visible');
        setTimeout(() => searchModal.classList.add('hidden'), 300);
    };

    const openMoveGiveawayModal = (giveaway, originalDate) => {
        giveawayToMove = giveaway;
        originalDateOfGiveaway = originalDate;
        newGiveawayDateInput.value = originalDate;
        moveGiveawayModal.classList.remove('hidden');
        requestAnimationFrame(() => moveGiveawayModal.classList.add('is-visible'));
    }
    const closeMoveGiveawayModal = () => {
        moveGiveawayModal.classList.remove('is-visible');
        setTimeout(() => moveGiveawayModal.classList.add('hidden'), 300);
    }

    const addGiveaway = (newGiveaway) => {
        const dateStr = newGiveaway.date;
        if (!giveaways[dateStr]) giveaways[dateStr] = [];
        giveaways[dateStr].push(newGiveaway);
        saveGiveaways();
        renderCalendar();
        addPoints(1);
        checkAchievements('add-manual');
    };

    const moveGiveaway = (giveawayId, oldDate, newDate) => {
        if (giveaways[oldDate]) {
            const giveawayToMove = giveaways[oldDate].find(g => g.id === giveawayId);
            if (giveawayToMove) {
                if (!giveawayToMove.date) giveawayToMove.date = newDate;
                if (!giveawayToMove.moved) giveawayToMove.moved = true;
                giveaways[oldDate] = giveaways[oldDate].filter(g => g.id !== giveawayId);
                if (giveaways[oldDate].length === 0) delete giveaways[oldDate];
                if (!giveaways[newDate]) giveaways[newDate] = [];
                giveaways[newDate].push(giveawayToMove);
                saveGiveaways();
                renderCalendar();
                closeModal();
                showNotification('Sorteo movido', `El sorteo se ha movido al ${newDate}.`);
                checkAchievements('move');
            }
        }
    };

    const setFilterAndRender = (filter) => {
        currentFilter = filter;
        renderCalendar();
        checkAchievements('search');
    }

    const markAsWon = (giveawayId, dateStr) => {
        if (!giveaways[dateStr]) return;
        const giveawayIndex = giveaways[dateStr].findIndex(g => g.id === giveawayId);
        if (giveawayIndex === -1) return;
        const [wonGiveaway] = giveaways[dateStr].splice(giveawayIndex, 1);

        let points = 100;
        if (wonGiveaway.prize.includes('ü•é') || wonGiveaway.prize.includes('üõ©Ô∏è') || wonGiveaway.prize.includes('üÉè')) points += 25;
        if (parsePrice(wonGiveaway.price) > 500) points += 250;
        addPoints(points);

        wonGiveaway.wonDate = new Date().toISOString().slice(0, 10);
        wonGiveaways.push(wonGiveaway);
        if (!completedGiveaways[giveawayId]) {
            completedGiveaways[giveawayId] = true;
            completedGiveawayCount++;
            addPoints(2);
            saveCompletedGiveaways();
        }
        if (giveaways[dateStr].length === 0) {
            delete giveaways[dateStr];
        }
        saveGiveaways();
        saveWonGiveaways();
        closeModal();
        renderCalendar();
        showNotification('¬°Enhorabuena!', `Has a√±adido "${wonGiveaway.prize}" a tu vitrina de trofeos.`);
        checkAchievements('win', wonGiveaway);
    };

    const deleteWonGiveaway = (giveawayId) => {
        if (confirm("¬øEst√°s seguro de que quieres eliminar este sorteo de la vitrina?")) {
            const wonGiveaway = wonGiveaways.find(g => g.id === giveawayId);
            if (wonGiveaway) {
                if (completedGiveaways[wonGiveaway.id]) {
                    delete completedGiveaways[wonGiveaway.id];
                    completedGiveawayCount--;
                    saveCompletedGiveaways();
                }
            }
            wonGiveaways = wonGiveaways.filter(g => g.id !== giveawayId);
            saveWonGiveaways();
            renderTrophyModal();
            showNotification('Sorteo eliminado', 'El sorteo se ha eliminado de tu vitrina.');
        }
    };

    const renderTrophyModal = () => {
        trophyModalBody.innerHTML = '';
        if (wonGiveaways.length === 0) {
            trophyModalBody.innerHTML = '<p class="text-center col-span-full">A√∫n no has ganado ning√∫n sorteo. ¬°Sigue participando!</p>';
            return;
        }
        wonGiveaways.sort((a, b) => new Date(b.wonDate) - new Date(a.wonDate)).forEach(giveaway => {
            const card = document.createElement('div');
            card.className = 'trophy-card';
            card.innerHTML = `
                    <h3 class="font-bold">${giveaway.prize}</h3>
                    <p class="text-sm">Valor: ${giveaway.price || 'No especificado'}</p>
                    <p class="text-xs mt-2">Ganado el: ${new Date(giveaway.wonDate + 'T00:00:00').toLocaleDateString('es-ES')}</p>
                    <button class="trophy-delete-btn" data-giveaway-id="${giveaway.id}"><i class="fa-solid fa-trash-can"></i></button>
                `;
            trophyModalBody.appendChild(card);
        });
    };

    const calculateStats = () => {
        const allGiveaways = Object.values(giveaways).flat();
        const totalRegistered = allGiveaways.length + wonGiveaways.length;
        const completedCount = Object.keys(completedGiveaways).length;
        const pendingCount = allGiveaways.length;
        const wonCount = wonGiveaways.length;
        const winRate = totalRegistered > 0 ? (completedCount > 0 ? (wonCount / completedCount) * 100 : 0) : 0;
        const participationRate = totalRegistered > 0 ? (completedCount / totalRegistered) * 100 : 0;
        const totalWonValue = wonGiveaways.reduce((sum, g) => sum + parsePrice(g.price), 0);
        const averageWonValue = wonCount > 0 ? totalWonValue / wonCount : 0;
        const categoryCounts = {
            'padel': 0,
            'viajes': 0,
            'frikis': 0,
            'otros': 0
        };
        wonGiveaways.forEach(g => {
            if (g.prize.includes('ü•é')) categoryCounts.padel++;
            else if (g.prize.includes('üõ©Ô∏è')) categoryCounts.viajes++;
            else if (g.prize.includes('üÉè')) categoryCounts.frikis++;
            else categoryCounts.otros++;
        });

        const accountCounts = {};
        [...allGiveaways, ...wonGiveaways].forEach(g => {
            (g.accounts || []).forEach(acc => {
                accountCounts[acc] = (accountCounts[acc] || 0) + 1;
            });
        });
        const topAccounts = Object.entries(accountCounts).sort(([, a], [, b]) => b - a).slice(0, 5);

        const wonAccountCounts = {};
        wonGiveaways.forEach(g => {
            (g.accounts || []).forEach(acc => {
                wonAccountCounts[acc] = (wonAccountCounts[acc] || 0) + 1;
            });
        });
        const talismanAccounts = Object.entries(wonAccountCounts).filter(([, count]) => count > 1);

        const discardCounts = {
            duplicate: 0,
            expired: 0,
            foreign: 0,
            no_date: 0
        };
        discardedGiveaways.forEach(g => {
            if (g.status && discardCounts.hasOwnProperty(g.status)) {
                discardCounts[g.status]++;
            }
        });

        const anticipationDays = [];
        [...allGiveaways, ...wonGiveaways].forEach(g => {
            if (g.addDate && g.date) {
                const add = new Date(g.addDate);
                const end = new Date(g.date);
                const diffTime = Math.abs(end - add);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                anticipationDays.push(diffDays);
            }
        });
        const averageAnticipation = anticipationDays.length > 0 ?
            (anticipationDays.reduce((a, b) => a + b, 0) / anticipationDays.length) :
            0;

        const mostValuablePrize = wonGiveaways.length > 0 ?
            wonGiveaways.reduce((max, g) => parsePrice(g.price) > parsePrice(max.price) ? g : max, wonGiveaways[0]) :
            null;

        const sortedWins = [...wonGiveaways].sort((a, b) => new Date(a.wonDate) - new Date(a.wonDate));
        let bestStreak = null;
        let longestDrySpell = null;
        let averageWinInterval = null;

        if (sortedWins.length >= 2) {
            const winIntervals = [];
            for (let i = 1; i < sortedWins.length; i++) {
                const diff = (new Date(sortedWins[i].wonDate) - new Date(sortedWins[i - 1].wonDate)) / (1000 * 3600 * 24);
                winIntervals.push(diff);
            }
            if (winIntervals.length > 0) {
                bestStreak = Math.min(...winIntervals);
                longestDrySpell = Math.max(...winIntervals);
                averageWinInterval = winIntervals.reduce((a, b) => a + b, 0) / winIntervals.length;
            }
        }

        const blockCounts = {
            like: 0,
            comment: 0
        };
        blockHistory.forEach(block => {
            blockCounts[block.type]++;
        });

        const completedPerBlock = blockHistory.length > 0 ? (completedGiveawayCount / blockHistory.length).toFixed(1) : 'N/A';

        return {
            totalRegistered,
            completedCount,
            pendingCount,
            wonCount,
            winRate: winRate.toFixed(1),
            totalWonValue: totalWonValue.toFixed(2),
            averageWonValue: averageWonValue.toFixed(2),
            categoryCounts,
            topAccounts,
            talismanAccounts,
            discardCounts,
            averageAnticipation: averageAnticipation.toFixed(1),
            participationRate: participationRate.toFixed(1),
            mostValuablePrize,
            bestStreak,
            longestDrySpell,
            lastWinDate: sortedWins.length > 0 ? new Date(sortedWins[sortedWins.length - 1].wonDate) : null,
            averageWinInterval,
            blockCounts,
            completedPerBlock
        };
    };

    const renderStatsModal = () => {
        const stats = calculateStats();
        const statsBody = document.getElementById('stats-modal-body');
        const blockStatsContainer = document.getElementById('block-stats-container');

        let topAccountsHTML = '<p>A√∫n no hay datos.</p>';
        if (stats.topAccounts.length > 0) {
            topAccountsHTML = `<ol>${stats.topAccounts.map(([acc, count]) => `<li>${acc} (${count} sorteos)</li>`).join('')}</ol>`;
        }

        let talismanAccountsHTML = '<p>A√∫n no hay cuentas con m√∫ltiples victorias.</p>';
        if (stats.talismanAccounts.length > 0) {
            talismanAccountsHTML = `<ul>${stats.talismanAccounts.map(([acc, count]) => `<li>${acc} (${count} victorias)</li>`).join('')}</ul>`;
        }

        const totalDiscards = stats.discardCounts.duplicate + stats.discardCounts.expired + stats.discardCounts.foreign + stats.discardCounts.no_date;
        const discardDuplicatePercent = totalDiscards > 0 ? ((stats.discardCounts.duplicate / totalDiscards) * 100).toFixed(0) : 0;
        const discardExpiredPercent = totalDiscards > 0 ? ((stats.discardCounts.expired / totalDiscards) * 100).toFixed(0) : 0;
        const discardForeignPercent = totalDiscards > 0 ? ((stats.discardCounts.foreign / totalDiscards) * 100).toFixed(0) : 0;

        let recordsHTML = '';
        if (stats.mostValuablePrize) {
            recordsHTML += `<li><strong>üíé Premio M√°s Valioso:</strong> ${stats.mostValuablePrize.prize} (${stats.mostValuablePrize.price})</li>`;
        }
        if (stats.bestStreak !== null) {
            recordsHTML += `<li><strong>üöÄ Mejor Racha:</strong> ${stats.bestStreak} d√≠as entre victorias.</li>`;
        }
        if (stats.longestDrySpell !== null) {
            recordsHTML += `<li><strong>‚è≥ Periodo de Sequ√≠a:</strong> ${stats.longestDrySpell} d√≠as entre victorias.</li>`;
        }
        if (stats.lastWinDate && stats.averageWinInterval !== null) {
            const nextWinDate = new Date(stats.lastWinDate.setDate(stats.lastWinDate.getDate() + stats.averageWinInterval));
            recordsHTML += `<li><strong>üîÆ Or√°culo de Victorias:</strong> Tu pr√≥xima victoria podr√≠a ser alrededor del ${nextWinDate.toLocaleDateString('es-ES')}.</li>`;
        }

        statsBody.innerHTML = `
                <h3 class="text-xl font-bold mb-2 text-yellow-700">Resumen General</h3>
                <ul class="space-y-2 mb-4">
                    <li><strong>Sorteos Totales Registrados:</strong> ${stats.totalRegistered}</li>
                    <li><strong>Participaciones Completadas:</strong> ${stats.completedCount}</li>
                    <li><strong>Sorteos Pendientes:</strong> ${stats.pendingCount}</li>
                </ul>
                <hr class="border-yellow-600/20 my-4">
                <h3 class="text-xl font-bold mb-2 text-yellow-700">An√°lisis de Comportamiento üìà</h3>
                <ul class="space-y-2 mb-4">
                    <li><strong>Anticipaci√≥n Media:</strong> A√±ades sorteos con ${stats.averageAnticipation} d√≠as de antelaci√≥n.</li>
                    <li><strong>Tasa de Participaci√≥n Real:</strong> Participas en el ${stats.participationRate}% de los sorteos que guardas.</li>
                </ul>
                <hr class="border-yellow-600/20 my-4">
                <h3 class="text-xl font-bold mb-2 text-yellow-700">Resumen de Victorias üèÜ</h3>
                <ul class="space-y-2 mb-4">
                    <li><strong>Sorteos Ganados:</strong> ${stats.wonCount}</li>
                    <li><strong>Tasa de Victoria:</strong> ${stats.winRate}% (sobre participaciones completadas)</li>
                </ul>
                 <hr class="border-yellow-600/20 my-4">
                <h3 class="text-xl font-bold mb-2 text-yellow-700">R√©cords y Rachas üöÄ</h3>
                <ul class="space-y-2 mb-4">
                    ${recordsHTML || '<p>Gana al menos dos premios para ver tus r√©cords.</p>'}
                </ul>
                <hr class="border-yellow-600/20 my-4">
                <h3 class="text-xl font-bold mb-2 text-yellow-700">An√°lisis por Cuentas üçÄ</h3>
                <div class="mb-4">
                    <h4 class="font-bold mb-1">Top 5 Cuentas Organizadoras:</h4>
                    ${topAccountsHTML}
                </div>
                <div>
                    <h4 class="font-bold mb-1">Tus Cuentas "Talism√°n":</h4>
                    ${talismanAccountsHTML}
                </div>
                <hr class="border-yellow-600/20 my-4">
                 <h3 class="text-xl font-bold mb-2 text-yellow-700">An√°lisis de la App ‚öôÔ∏è</h3>
                <ul class="space-y-2 mb-4">
                    <li><strong>Efectividad del Cortafuegos:</strong> ${stats.discardCounts.foreign} sorteos extranjeros bloqueados.</li>
                    <li><strong>Informe de Descarte (Total: ${totalDiscards}):</strong>
                        <ul class="text-sm pl-4">
                            <li>üìã Duplicados: ${stats.discardCounts.duplicate} (${discardDuplicatePercent}%)</li>
                            <li>üìÖ Caducados: ${stats.discardCounts.expired} (${discardExpiredPercent}%)</li>
                            <li>üåê Extranjeros: ${stats.discardCounts.foreign} (${discardForeignPercent}%)</li>
                        </ul>
                    </li>
                </ul>
                <hr class="border-yellow-600/20 my-4">
                <h3 class="text-xl font-bold mb-2 text-yellow-700">An√°lisis de Premios üí∞</h3>
                <ul class="space-y-2 mb-4">
                    <li><strong>Valor Total de Premios Ganados:</strong> ${stats.totalWonValue}‚Ç¨</li>
                    <li><strong>Valor Medio por Premio:</strong> ${stats.averageWonValue}‚Ç¨</li>
                </ul>
                <hr class="border-yellow-600/20 my-4">
                <h3 class="text-xl font-bold mb-2 text-yellow-700">Categor√≠as Ganadas</h3>
                <ul class="space-y-2 mb-4">
                    <li>ü•é <strong>P√°del:</strong> ${stats.categoryCounts.padel}</li>
                    <li>üõ©Ô∏è <strong>Viajes:</strong> ${stats.categoryCounts.viajes}</li>
                    <li>üÉè <strong>Frikis:</strong> ${stats.categoryCounts.frikis}</li>
                    <li>‚ú® <strong>Otros:</strong> ${stats.categoryCounts.otros}</li>
                </ul>
            `;

        blockStatsContainer.innerHTML = `
                <h4 class="font-bold mb-1">Estad√≠sticas de Bloqueos:</h4>
                <ul class="space-y-2 mb-4">
                    <li><strong>Bloqueos de 'Me gusta' totales:</strong> ${stats.blockCounts.like}</li>
                    <li><strong>Bloqueos de Comentarios totales:</strong> ${stats.blockCounts.comment}</li>
                    <li><strong>Sorteos completados por bloqueo (media):</strong> ${stats.completedPerBlock}</li>
                </ul>
            `;
    };

    const generateShareableSummary = () => {
        const stats = calculateStats();
        const monthName = new Date().toLocaleDateString('es-ES', {
            month: 'long'
        });
        const summaryText = `Resumen de ${monthName} en #Misorteos:\nüèÜ ${stats.wonCount} premios ganados\nüí∞ Valor total: ${stats.totalWonValue}‚Ç¨\n‚úÖ ${stats.completedCount} participaciones completadas\nüìà Tasa de victoria: ${stats.winRate}%`;

        navigator.clipboard.writeText(summaryText).then(() => {
            showNotification('¬°Copiado!', 'El resumen se ha copiado a tu portapapeles.');
        }).catch(err => {
            console.error('Error al copiar: ', err);
            showNotification('Error', 'No se pudo copiar el resumen.');
        });
    };

    const generateGiveawayHTML = (giveaway, isDiscarded = false) => {
        const accountsHtml = (giveaway.accounts || []).map(acc => `<a href="https://instagram.com/${acc.replace('‚ö†Ô∏è', '').replace('@', '')}" target="_blank" class="underline">${acc}</a>`).join(', ');
        const prizeCategory = giveaway.prize_category ? giveaway.prize_category.charAt(0).toUpperCase() + giveaway.prize_category.slice(1) : 'Otros';
        const prizeEmoji = giveaway.prize ? (giveaway.prize.includes('ü•é') ? 'ü•é' : giveaway.prize.includes('üõ©Ô∏è') ? 'üõ©Ô∏è' : giveaway.prize.includes('üÉè') ? 'üÉè' : '') : '';
        const timeEmoji = giveaway.ends_at_time ? '‚è∞' : '';
        return `
                 <p class="text-base sm:text-lg font-bold">${giveaway.prize || 'No especificado'} ${prizeEmoji} ${timeEmoji}</p>
                 <p class="text-sm"><strong>Cuentas:</strong> ${accountsHtml || 'No especificado'}</p>
                 <p class="text-sm"><strong>Fecha:</strong> ${giveaway.date || 'No especificada'}</p>
                 <p class="text-sm"><strong>Valor:</strong> ${giveaway.price || 'No especificado'}</p>
                 <p class="text-sm"><strong>Categor√≠a:</strong> ${prizeCategory}</p>
                 ${isDiscarded ? `<p class="text-sm mt-2"><strong>Motivo:</strong> ${giveaway.status || 'No especificado'}</p>` : ''}
             `;
    };

    const generateGiveawayCardHTML = (giveaway) => {
        if (!giveaway) return '<p>No hay informaci√≥n del sorteo.</p>';

        const formattedDate = giveaway.date ?
            new Date(giveaway.date + 'T00:00:00').toLocaleDateString('es-ES', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            }) :
            'No especificada';

        const accountsHtml = (giveaway.accounts && giveaway.accounts.length > 0) ?
            giveaway.accounts.map(acc => `<a href="https://instagram.com/${acc.replace('@', '')}" target="_blank" class="underline hover:text-amber-700">${acc}</a>`).join(', ') :
            'No especificadas';

        const statusMap = {
            duplicate: 'Duplicado',
            expired: 'Caducado',
            foreign: 'Extranjero',
            no_date: 'Sin Fecha'
        };

        return `
                <div class="giveaway-card">
                    <h3>${giveaway.prize || 'Premio no especificado'}</h3>
                    <div class="giveaway-card-details">
                        <div class="detail-item">
                            <i class="fa-solid fa-calendar-days"></i>
                            <span>${formattedDate}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fa-solid fa-at"></i>
                            <span>${accountsHtml}</span>
                        </div>
                        ${giveaway.price ? `
                        <div class="detail-item">
                            <i class="fa-solid fa-sack-dollar"></i>
                            <span>${giveaway.price}</span>
                        </div>` : ''}
                        ${giveaway.status ? `
                        <div class="detail-item">
                             <i class="fa-solid fa-circle-info"></i>
                             <span class="status-tag status-${giveaway.status}">${statusMap[giveaway.status] || giveaway.status}</span>
                        </div>` : ''}
                    </div>
                </div>
            `;
    };

    const openAddAIGiveawayModal = () => {
        addAIGiveawayModal.classList.remove('hidden');
        requestAnimationFrame(() => addAIGiveawayModal.classList.add('is-visible'));
    };
    const closeAddAIGiveawayModal = () => {
        addAIGiveawayModal.classList.remove('is-visible');
        aiImageInput.value = null;
        imageQueue = [];
        aiQueueContainer.style.display = 'none';
        aiQueueList.innerHTML = '';
        startAiButton.style.display = 'none';
        aiStatusContainer.style.display = 'none';
        aiSummaryResults.style.display = 'none';
        aiSummaryCloseBtn.style.display = 'none';
        setTimeout(() => addAIGiveawayModal.classList.add('hidden'), 300);
    };

    function handleFileSelection(event) {
        imageQueue = [];
        aiQueueList.innerHTML = '';
        const files = event.target.files;
        if (files.length > 0) {
            const filesToAdd = Array.from(files).slice(0, MAX_IMAGES);
            for (const file of filesToAdd) {
                if (file.type.startsWith('image/')) {
                    imageQueue.push({
                        file,
                        status: 'pending',
                        error: null
                    });
                    const listItem = document.createElement('li');
                    listItem.textContent = file.name;
                    listItem.classList.add('p-2', 'border-b', 'border-yellow-500/10', 'last:border-b-0');
                    aiQueueList.appendChild(listItem);
                }
            }
            aiQueueContainer.style.display = 'block';
            aiQueueCount.textContent = imageQueue.length;
            startAiButton.style.display = 'block';
        } else {
            startAiButton.style.display = 'none';
            aiQueueContainer.style.display = 'none';
        }
    }

    const reanalyzeAllFailed = () => {
        const failedImages = imageQueue.filter(img => img.status === 'failed');
        if (failedImages.length > 0) {
            imageQueue = failedImages.map(img => ({ ...img,
                status: 'pending',
                error: null
            }));
            currentIndex = 0;
            startAnalysis();
        } else {
            showNotification('No hay errores', 'No hay im√°genes fallidas para re-analizar.');
        }
    };

    const reanalyzeSingleFailed = (filename) => {
        const imageToReanalyze = imageQueue.find(img => img.file.name === filename);
        if (imageToReanalyze) {
            imageQueue = [{ ...imageToReanalyze,
                status: 'pending',
                error: null
            }];
            currentIndex = 0;
            startAnalysis();
        }
    };

    const updateAnalysisProgress = () => {
        const total = imageQueue.length;
        const processedCount = imageQueue.filter(img => img.status !== 'pending').length;
        aiProgressBar.style.width = `${(processedCount / total) * 100}%`;

        let statusMessage = `Analizando imagen ${currentIndex + 1} de ${total}`;
        if (currentIndex >= total) {
            statusMessage = 'An√°lisis completado';
        } else {
            statusMessage = `Analizando imagen ${currentIndex + 1} de ${total}: ${imageQueue[currentIndex].file.name}`;
        }
        aiStatusMessage.textContent = statusMessage;
    };

    async function startAnalysis() {
        if (imageQueue.length === 0 || isProcessing) return;
        isProcessing = true;
        currentIndex = 0;
        totalCaptures = imageQueue.length;
        addedGiveawaysCount = 0;
        duplicateGiveawaysCount = 0;
        expiredGiveawaysCount = 0;
        foreignGiveawaysCount = 0;
        noDateGiveawaysCount = 0;
        addedGiveawaysDetails = [];
        duplicateGiveawaysDetails = [];
        expiredGiveawaysDetails = [];
        foreignGiveawaysDetails = [];
        noDateGiveawaysDetails = [];
        failedFilesDetails = [];
        startAiButton.disabled = true;
        startAiButton.textContent = "Procesando...";
        aiStatusContainer.style.display = 'block';
        aiSummaryResults.style.display = 'none';
        aiSummaryCloseBtn.style.display = 'none';
        await processNextImage();
    }

    function processNextImage() {
        if (currentIndex >= imageQueue.length) {
            showAISummary();
            isProcessing = false;
            startAiButton.disabled = false;
            startAiButton.textContent = "Empezar de nuevo";
            return;
        }

        updateAnalysisProgress();
        const currentImage = imageQueue[currentIndex];
        const file = currentImage.file;
        const delay = currentIndex === 0 ? 0 : 2000;

        setTimeout(() => {
            const reader = new FileReader();
            reader.onload = (event) => {
                handleImageProcessing(event.target.result, file, currentImage);
            };
            reader.readAsDataURL(file);
        }, delay);
    }

    async function handleImageProcessing(base64Data, file, currentImage) {
        const hoy = new Date();
        const fechaFormateada = hoy.toLocaleDateString('es-ES', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
        const dynamicPrompt = `<ROL_Y_CONTEXTO>Actuar√°s como un Analista de Datos experto y extremadamente meticuloso. Tu √∫nica funci√≥n es analizar im√°genes de sorteos de redes sociales y extraer informaci√≥n en un formato JSON estricto. CONTEXTO CR√çTICO: La fecha actual es ${fechaFormateada}. Usa esta fecha como referencia para todas las evaluaciones de tiempo.</ROL_Y_CONTEXTO><TAREA_PRINCIPAL>Analiza la imagen proporcionada y extrae la informaci√≥n solicitada. Tu respuesta debe ser √öNICAMENTE un objeto JSON v√°lido, sin ning√∫n texto, explicaci√≥n o markdown adicional como \`\`\`json.</TAREA_PRINCIPAL><DEFINICION_FORMATO_JSON>El objeto JSON debe tener la siguiente estructura y reglas:{"prize": "string | null","accounts": ["string"],"date": "string | null","ends_at_time": "string | null", "status": "string","is_spanish": boolean,"prize_category": "string"}**REGLA DE ORO PARA LA FECHA:** Si el texto menciona "anuncio de ganadores el d√≠a X", la fecha de finalizaci√≥n del sorteo ("date") es el d√≠a ANTERIOR (X-1). Esta regla tiene m√°xima prioridad.</DEFINICION_FORMATO_JSON><PROCESO_DE_RAZONAMIENTO_INTERNO>Antes de generar el JSON, sigue estos pasos mentalmente: 1. Lee todo el texto. 2. Identifica el premio y las cuentas. 3. Analiza CUIDADOSAMENTE la fecha y la hora. Aplica la REGLA DE ORO. Compara con la fecha de contexto. 4. Si no hay fecha, \`date\` es \`null\` y \`status\` es \`discard_no_date\`. 5. Si hay fecha, \`status\` es \`valid\`. Si hay hora espec√≠fica, rellena \`ends_at_time\`. 6. Construye el objeto JSON final.</PROCESO_DE_RAZONAMIENTO_INTERNO><REGLAS_CRITICAS_FINALES>- Tu respuesta final debe ser solo el objeto JSON.- La precisi√≥n en la fecha, hora y status es la m√°xima prioridad.</REGLAS_CRITICAS_FINALES>`;

        try {
            const aiData = await callGeminiAPI(base64Data, dynamicPrompt);

            if (aiData.status === 'discard_no_date') {
                noDateGiveawaysCount++;
                noDateGiveawaysDetails.push({
                    prize: aiData.prize,
                    file
                });
                discardedGiveaways.push({ ...aiData,
                    id: Date.now().toString() + 'nd',
                    status: 'no_date'
                });
                currentImage.status = 'discarded';
            } else {
                const accounts = aiData.accounts || [];
                const isForeign = accounts.some(acc => foreignAccounts.includes(`@${acc}`));
                const isExpired = aiData.date && new Date(aiData.date) < new Date(new Date().toDateString());
                const existingGiveaway = isDuplicateGiveaway(aiData);

                if (isForeign) {
                    foreignGiveawaysCount++;
                    foreignGiveawaysDetails.push({
                        prize: aiData.prize,
                        accounts: accounts.join(', '),
                        file
                    });
                    discardedGiveaways.push({ ...aiData,
                        status: 'foreign',
                        id: Date.now().toString() + 'f'
                    });
                    currentImage.status = 'discarded';
                } else if (existingGiveaway) {
                    duplicateGiveawaysCount++;
                    duplicateGiveawaysDetails.push({
                        prize: aiData.prize,
                        file
                    });
                    discardedGiveaways.push({ ...aiData,
                        id: Date.now().toString() + 'd',
                        status: 'duplicate',
                        originalGiveaway: existingGiveaway
                    });
                    currentImage.status = 'discarded';
                } else if (isExpired) {
                    expiredGiveawaysCount++;
                    expiredGiveawaysDetails.push({
                        prize: aiData.prize,
                        date: aiData.date,
                        file
                    });
                    discardedGiveaways.push({ ...aiData,
                        status: 'expired',
                        id: Date.now().toString() + 'e'
                    });
                    currentImage.status = 'discarded';
                } else {
                    const priceInfo = await searchPrizeValue(aiData);
                    const newGiveaway = {
                        id: Date.now().toString(),
                        date: aiData.date,
                        prize: priceInfo.prize,
                        accounts: aiData.accounts.map(acc => `@${acc}`),
                        price: priceInfo.value,
                        url: priceInfo.url,
                        addDate: new Date().toISOString().slice(0, 10),
                        ends_at_time: aiData.ends_at_time
                    };
                    addGiveaway(newGiveaway);

                    addedGiveawaysCount++;
                    addedGiveawaysDetails.push({
                        prize: newGiveaway.prize,
                        date: newGiveaway.date,
                        file
                    });
                    currentImage.status = 'added';

                    addPoints(5);
                    checkAchievements('add-ai');
                }
            }
            saveDiscardedGiveaways();
        } catch (error) {
            console.error(`Error al analizar la imagen ${file.name}:`, error);
            const errorText = error.message || 'Error desconocido al procesar la imagen.';
            failedFilesDetails.push({
                filename: file.name,
                error: errorText
            });
            currentImage.status = 'failed';
            currentImage.error = errorText;
        }
        currentIndex++;
        processNextImage();
    }

    const showAISummary = () => {
        const summaryData = {
            analysisDate: new Date().toISOString(),
            totalCaptures: totalCaptures,
            addedGiveawaysCount: addedGiveawaysDetails.length,
            duplicateGiveawaysCount: duplicateGiveawaysDetails.length,
            expiredGiveawaysCount: expiredGiveawaysDetails.length,
            foreignGiveawaysCount: foreignGiveawaysDetails.length,
            noDateGiveawaysCount: noDateGiveawaysDetails.length,
            addedGiveawaysDetails,
            duplicateGiveawaysDetails,
            expiredGiveawaysDetails,
            foreignGiveawaysDetails,
            noDateGiveawaysDetails,
            failedFilesDetails
        };
        analysisHistory.push(summaryData);
        analysisHistory = analysisHistory.slice(-20);
        saveAnalysisHistory();

        document.getElementById('ai-modal-title').textContent = 'An√°lisis de Sorteos Finalizado';
        document.getElementById('ai-modal-info').style.display = 'none';
        aiQueueContainer.style.display = 'none';
        startAiButton.style.display = 'none';
        aiStatusContainer.style.display = 'none';
        const summaryContainer = document.getElementById('ai-summary-results');
        summaryContainer.innerHTML = '';

        let summaryHTML = `<h3 class="text-xl font-bold mb-4">‚ú® Resumen General</h3>
                <ul class="space-y-2">
                    <li>Im√°genes Enviadas: <strong>${summaryData.totalCaptures}</strong></li>
                    <li>‚úÖ Sorteos A√±adidos: <strong>${summaryData.addedGiveawaysCount}</strong></li>
                    <li>‚ùå Sorteos Descartados: <strong>${summaryData.duplicateGiveawaysCount + summaryData.expiredGiveawaysCount + summaryData.foreignGiveawaysCount + summaryData.noDateGiveawaysCount}</strong></li>
                    <li>‚ö†Ô∏è Errores de An√°lisis: <strong>${summaryData.failedFilesDetails.length}</strong></li>
                </ul>
                <hr class="border-yellow-500/20 my-4">`;

        if (summaryData.addedGiveawaysDetails.length > 0) {
            summaryHTML += `<h4 class="text-lg font-bold mb-2">‚úÖ Sorteos A√±adidos al Calendario</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    ${summaryData.addedGiveawaysDetails.map(g => `<div class="p-3 bg-green-100/30 rounded-lg shadow-inner"><p class="font-bold">${g.prize}</p><p class="text-sm">Fecha: ${new Date(g.date+'T00:00:00').toLocaleDateString('es-ES')}</p><p class="text-xs text-gray-600 truncate">Imagen: ${g.file.name}</p></div>`).join('')}
                </div>
                <hr class="border-yellow-500/20 my-4">`;
        }

        if (summaryData.duplicateGiveawaysCount > 0 || summaryData.expiredGiveawaysCount > 0 || summaryData.foreignGiveawaysCount > 0 || summaryData.noDateGiveawaysCount > 0) {
            summaryHTML += `<h4 class="text-lg font-bold mb-2">‚ùå Desglose de Sorteos Descartados</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">`;
            summaryHTML += summaryData.duplicateGiveawaysDetails.map(g => `<div class="p-3 bg-yellow-100/50 rounded-lg shadow-inner"><p class="font-bold">${g.prize}</p><p class="text-xs">Motivo: Duplicado</p><p class="text-xs text-gray-600 truncate">Imagen: ${g.file.name}</p></div>`).join('');
            summaryHTML += summaryData.expiredGiveawaysDetails.map(g => `<div class="p-3 bg-gray-100/50 rounded-lg shadow-inner"><p class="font-bold">${g.prize}</p><p class="text-xs">Motivo: Caducado</p><p class="text-xs text-gray-600 truncate">Imagen: ${g.file.name}</p></div>`).join('');
            summaryHTML += summaryData.foreignGiveawaysDetails.map(g => `<div class="p-3 bg-blue-100/50 rounded-lg shadow-inner"><p class="font-bold">${g.prize}</p><p class="text-xs">Motivo: Extranjero</p><p class="text-xs text-gray-600 truncate">Imagen: ${g.file.name}</p></div>`).join('');
            summaryHTML += summaryData.noDateGiveawaysDetails.map(g => `<div class="p-3 bg-purple-100/50 rounded-lg shadow-inner"><p class="font-bold">${g.prize}</p><p class="text-xs">Motivo: Sin Fecha</p><p class="text-xs text-gray-600 truncate">Imagen: ${g.file.name}</p></div>`).join('');
            summaryHTML += `</div><hr class="border-yellow-500/20 my-4">`;
        }

        if (summaryData.failedFilesDetails.length > 0) {
            summaryHTML += `<h4 class="text-lg font-bold mb-2">‚ö†Ô∏è Informe de Errores</h4>
                <div class="space-y-2">`;
            summaryHTML += summaryData.failedFilesDetails.map(f => `
                    <div class="flex justify-between items-center bg-red-100/50 p-3 rounded-lg shadow-inner">
                        <span class="font-bold cursor-pointer underline view-error-details-btn" data-filename="${f.filename}">${f.filename}</span>
                        <div class="flex items-center gap-2">
                            <button class="reanalyze-single-error-btn text-yellow-900 bg-yellow-500 hover:bg-yellow-400 p-1 rounded-full text-xs font-bold" data-filename="${f.filename}">üîÑ Re-analizar</button>
                        </div>
                    </div>
                `).join('');
            summaryHTML += `</div>
                <div class="mt-4 text-center">
                    <button id="reanalyze-all-failed-btn" class="bg-red-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-red-400 transition-colors">Re-analizar todos los errores</button>
                </div>
                <hr class="border-yellow-500/20 my-4">`;
        }

        summaryContainer.innerHTML = summaryHTML;
        summaryContainer.style.display = 'block';
        aiSummaryCloseBtn.style.display = 'block';

        summaryContainer.querySelectorAll('.view-error-details-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const filename = btn.dataset.filename;
                const errorDetails = failedFilesDetails.find(f => f.filename === filename);
                if (errorDetails) {
                    openErrorDetailsModal(errorDetails.filename, errorDetails.error);
                }
            });
        });

        summaryContainer.querySelectorAll('.reanalyze-single-error-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const filename = btn.dataset.filename;
                const fileToReanalyze = imageQueue.find(img => img.file.name === filename).file;

                imageQueue = [{
                    file: fileToReanalyze,
                    status: 'pending',
                    error: null
                }];
                currentIndex = 0;
                startAnalysis();
            });
        });

        document.getElementById('reanalyze-all-failed-btn')?.addEventListener('click', reanalyzeAllFailed);
    };

    const openErrorDetailsModal = (filename, reason) => {
        errorDetailsFilename.textContent = filename;
        errorDetailsReason.textContent = reason;
        reanalyzeSingleBtn.dataset.filename = filename;
        errorDetailsModal.classList.remove('hidden');
        requestAnimationFrame(() => errorDetailsModal.classList.add('is-visible'));
    };

    const closeErrorDetailsModalFunc = () => {
        errorDetailsModal.classList.remove('is-visible');
        setTimeout(() => errorDetailsModal.classList.add('hidden'), 300);
    };

    async function callGeminiAPI(base64Data, dynamicPrompt) {
        const functionUrl = '/.netlify/functions/gemini';
        const payload = {
            base64Data,
            dynamicPrompt
        };
        try {
            const response = await fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || errorData.details?.error?.message || 'Error en la funci√≥n de Netlify');
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                const text = result.candidates[0].content.parts[0].text;
                return JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());
            } else {
                console.error("Respuesta inv√°lida de la API de Visi√≥n:", result);
                throw new Error("Respuesta incompleta o inv√°lida de la API de Visi√≥n.");
            }
        } catch (error) {
            console.error("Error al llamar a la funci√≥n de Netlify:", error);
            throw error;
        }
    }

    async function searchPrizeValue(aiData) {
        const cleanedPrize = aiData.prize ? aiData.prize.trim() : '';
        if (!cleanedPrize) return {
            prize: aiData.prize,
            value: "No encontrado",
            url: null
        };
        const query = `valor aproximado ${cleanedPrize}`;
        const functionUrl = '/.netlify/functions/search';
        try {
            const response = await fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query
                })
            });
            if (!response.ok) {
                throw new Error('La respuesta de la funci√≥n de b√∫squeda no fue OK');
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                const text = result.candidates[0].content.parts[0].text;
                const parsedResult = JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());
                let prizeWithEmoji = aiData.prize;
                let numericValue = null;
                if (parsedResult.value && parsedResult.value !== "No encontrado") {
                    numericValue = parseFloat(parsedResult.value.replace(/[^0-9,.]/g, '').replace(',', '.'));
                }
                if (aiData.prize_category === 'padel') prizeWithEmoji += ' ü•é';
                if (aiData.prize_category === 'viajes') prizeWithEmoji += ' üõ©Ô∏è';
                if (aiData.prize_category === 'frikis') prizeWithEmoji += ' üÉè';
                if (!isNaN(numericValue) && numericValue > 500) prizeWithEmoji += ' üí≤';
                return {
                    prize: prizeWithEmoji,
                    value: parsedResult.value,
                    url: parsedResult.url
                };
            } else {
                throw new Error("Respuesta incompleta de la API de texto.");
            }
        } catch (error) {
            console.error("Error en la b√∫squeda del valor:", error);
            return {
                prize: aiData.prize,
                value: "No encontrado",
                url: null
            };
        }
    }

    const deleteGiveawayFromCalendar = (dateStr, giveawayId) => {
        if (giveaways[dateStr]) {
            const giveawayToTrash = giveaways[dateStr].find(g => g.id === giveawayId);
            if (giveawayToTrash) {
                trashGiveaways.push({ ...giveawayToTrash,
                    originalDate: dateStr
                });
                saveTrashGiveaways();
                giveaways[dateStr] = giveaways[dateStr].filter(g => g.id !== giveawayId);
                if (giveaways[dateStr].length === 0) delete giveaways[dateStr];
                saveGiveaways();
                renderCalendar();
                closeModal();
            }
        }
    };

    const deleteForeignGiveaway = (dateStr, giveawayId) => {
        if (giveaways[dateStr]) {
            const giveawayToDiscard = giveaways[dateStr].find(g => g.id === giveawayId);
            if (giveawayToDiscard) {
                discardedGiveaways.push({ ...giveawayToDiscard,
                    status: 'foreign',
                    originalDate: dateStr
                });
                const accountsToBlock = giveawayToDiscard.accounts;
                accountsToBlock.forEach(acc => {
                    if (!foreignAccounts.includes(acc)) {
                        foreignAccounts.push(acc);
                    }
                });
                saveDiscardedGiveaways();
                saveForeignAccounts();
                giveaways[dateStr] = giveaways[dateStr].filter(g => g.id !== giveawayId);
                if (giveaways[dateStr].length === 0) {
                    delete giveaways[dateStr];
                }
                saveGiveaways();
                renderCalendar();
                closeModal();
                showNotification('Sorteo marcado como extranjero', 'Las cuentas asociadas se han a√±adido al cortafuegos.');
                checkAchievements('block-foreign');
            }
        }
    };

    const renderTrashModal = () => {
        trashModalBody.innerHTML = '';
        if (trashGiveaways.length === 0) {
            trashModalBody.innerHTML = '<p>No hay sorteos en la papelera.</p>';
            return;
        }
        trashGiveaways.forEach(giveaway => {
            const itemContainer = document.createElement('div');
            itemContainer.className = 'p-3 bg-yellow-100/50 rounded-lg shadow-inner flex justify-between items-center border border-yellow-600/20';
            itemContainer.innerHTML = `<div class="w-full"><p class="text-base sm:text-lg">${giveaway.prize}</p><p class="text-sm">Fecha original: ${giveaway.originalDate}</p></div><button class="restore-btn ml-4 bg-yellow-500 text-yellow-900 p-2 rounded-full hover:bg-yellow-400" data-giveaway-id="${giveaway.id}"><i class="fa-solid fa-rotate-left"></i></button>`;
            trashModalBody.appendChild(itemContainer);
        });
    };
    const restoreGiveawayFromTrash = (giveawayId) => {
        const giveawayToRestore = trashGiveaways.find(g => g.id === giveawayId);
        if (giveawayToRestore) {
            trashGiveaways = trashGiveaways.filter(g => g.id !== giveawayId);
            openAddGiveawayModal({
                date: giveawayToRestore.originalDate,
                prize: giveawayToRestore.prize,
                accounts: giveawayToRestore.accounts.join(', '),
                price: giveawayToRestore.price
            });
            saveTrashGiveaways();
            renderTrashModal();
            checkAchievements('restore');
        }
    };
    const deleteAllTrash = () => {
        if (confirm("¬øEst√°s seguro de que quieres vaciar la papelera? Esta acci√≥n no se puede deshacer.")) {
            trashGiveaways = [];
            saveTrashGiveaways();
            renderTrashModal();
            showNotification('Papelera vaciada', 'Se han eliminado todos los sorteos de la papelera.');
        }
    }
    const deleteAllDiscarded = () => {
        if (confirm("¬øEst√°s seguro de que quieres eliminar todos los sorteos descartados?")) {
            discardedGiveaways = [];
            saveDiscardedGiveaways();
            renderDiscardedModal();
            showNotification('Sorteos descartados eliminados', 'Se han eliminado todos los sorteos de la lista de descartados.');
        }
    }
    const deleteDiscardedGiveaway = (giveawayId) => {
        discardedGiveaways = discardedGiveaways.filter(g => g.id !== giveawayId);
        saveDiscardedGiveaways();
        renderDiscardedModal();
    }

    const showDuplicateComparisonModal = (discardedGiveaway) => {
        const originalGiveawayData = discardedGiveaways.find(g => g.id === discardedGiveaway.id)?.originalGiveaway;
        if (!originalGiveawayData) {
            console.error("No se encontr√≥ el sorteo original para comparar.");
            return;
        }

        let originalDate = null;
        for (const date in giveaways) {
            if (giveaways[date].find(g => g.id === originalGiveawayData.id)) {
                originalDate = date;
                break;
            }
        }

        const originalGiveawayWithDate = { ...originalGiveawayData,
            date: originalDate
        };

        originalGiveawayDetails.innerHTML = generateGiveawayHTML(originalGiveawayWithDate);
        discardedGiveawayDetails.innerHTML = generateGiveawayHTML(discardedGiveaway);

        mergeGiveawayBtn.dataset.giveawayId = discardedGiveaway.id;
        addAsNewBtn.dataset.giveawayId = discardedGiveaway.id;

        duplicateComparisonModal.classList.remove('hidden');
        requestAnimationFrame(() => duplicateComparisonModal.classList.add('is-visible'));
    };

    const renderDiscardedModal = () => {
        const discardedModalBody = document.getElementById('discarded-modal-body');
        discardedModalBody.innerHTML = '';
        const filteredGiveaways = discardedGiveaways.filter(g => discardedFilter === 'all' || g.status === discardedFilter);
        if (filteredGiveaways.length === 0) {
            discardedModalBody.innerHTML = '<p>No hay sorteos descartados con este filtro.</p>';
            return;
        }
        filteredGiveaways.forEach(giveaway => {
            const cardHTML = generateGiveawayCardHTML(giveaway);
            const itemContainer = document.createElement('div');
            itemContainer.className = `giveaway-item-discarded ${giveaway.status === 'duplicate' ? 'duplicate-item' : ''} mb-4`;
            itemContainer.dataset.giveawayId = giveaway.id;
            itemContainer.innerHTML = cardHTML;
            discardedModalBody.appendChild(itemContainer);
        });
    };

    const openDuplicateModal = (discardedGiveaway, originalGiveaway) => {
        const previewContainer = document.getElementById('duplicate-giveaway-info');

        const originalCardHTML = generateGiveawayCardHTML({ ...originalGiveaway,
            date: originalGiveaway.date
        });
        const discardedCardHTML = generateGiveawayCardHTML(discardedGiveaway);

        previewContainer.innerHTML = `
                <div>
                    <h4 class="font-bold text-lg mb-2 text-gray-700">Sorteo Original (Ya guardado)</h4>
                    ${originalCardHTML}
                </div>
                <div>
                    <h4 class="font-bold text-lg mb-2 text-red-800">Sorteo Descartado (Nuevo)</h4>
                    ${discardedCardHTML}
                </div>
            `;

        confirmRestoreBtn.dataset.giveawayId = discardedGiveaway.id;
        duplicateModal.classList.remove('hidden');
        requestAnimationFrame(() => duplicateModal.classList.add('is-visible'));
    };
    const closeDuplicateModal = () => {
        duplicateModal.classList.remove('is-visible');
        setTimeout(() => duplicateModal.classList.add('hidden'), 300);
    };
    const addDiscardedToCalendar = (giveawayId) => {
        const giveawayToAdd = discardedGiveaways.find(g => g.id === giveawayId);
        if (giveawayToAdd) {
            discardedGiveaways = discardedGiveaways.filter(g => g.id !== giveawayId);
            saveDiscardedGiveaways();
            renderDiscardedModal();
            openAddGiveawayModal({
                date: giveawayToAdd.date,
                prize: giveawayToAdd.prize,
                accounts: giveawayToAdd.accounts.join(', '),
                price: giveawayToAdd.price
            });
        }
    };

    const renderAchievementsModal = (activeTab = 'logros') => {
        const unlockedIds = userAchievements.unlocked;

        const achievementGroups = {
            'Logros de Bronce ü•â': achievementList.bronze,
            'Logros de Plata ü•à': achievementList.silver,
            'Logros de Oro ü•á': achievementList.gold,
            'Logros de Platino üíé': achievementList.platinum,
            'Logros M√≠ticos üèÜ': achievementList.diamond,
        };
        let achievementsHTML = '';
        for (const groupName in achievementGroups) {
            achievementsHTML += `<h3 class="text-xl font-bold text-yellow-700 mt-4 mb-2">${groupName}</h3>`;
            achievementsHTML += '<div class="space-y-3">';
            achievementsHTML += achievementGroups[groupName].map(ach => {
                const isUnlocked = unlockedIds.includes(ach.id);
                return `
                    <div class="achievement-item ${isUnlocked ? '' : 'locked'} bg-yellow-100/50 p-4 rounded-lg flex items-center gap-4">
                        <div class="ach-icon text-4xl">${ach.icon}</div>
                        <div class="flex-grow">
                            <h4 class="font-bold text-lg">${ach.name}</h4>
                            <p class="text-sm">${ach.desc}</p>
                        </div>
                        ${isUnlocked ? `<div class="text-right flex-shrink-0"><span class="font-bold text-green-600">+${ach.ps} PS</span></div>` : ''}
                    </div>`;
            }).join('');
            achievementsHTML += '</div>';
        }

        const titlesHTML = achievementList.prestige.map(item => {
            const isUnlocked = unlockedIds.includes(item.id);
            const isSelected = userAchievements.title === item.title;
            return `
                    <div class="title-item ${isUnlocked ? '' : 'locked'} ${isSelected ? 'selected' : ''} border-2 border-transparent p-4 rounded-lg flex flex-col items-center justify-center text-center gap-2 bg-yellow-100/50">
                        <div class="text-5xl">üëë</div>
                        <h4 class="font-bold text-lg">${item.title}</h4>
                        <p class="text-xs italic text-gray-600">${item.req}</p>
                        ${isUnlocked ? `<button data-title="${item.title}" class="select-title-btn mt-2 py-1 px-3 rounded-full text-xs font-bold ${isSelected ? 'bg-green-500 text-white cursor-default' : 'bg-yellow-500 text-yellow-900'}">${isSelected ? 'Seleccionado' : 'Seleccionar'}</button>` : ''}
                    </div>
                `;
        }).join('');

        let meritsHTML = achievementList.merits.map(ach => {
            const isUnlocked = unlockedIds.includes(ach.id);
            return `
                    <div class="achievement-item ${isUnlocked ? '' : 'locked'} bg-blue-100/50 p-4 rounded-lg flex items-center gap-4 border-l-4 border-blue-400">
                        <div class="ach-icon text-4xl">${ach.icon}</div>
                        <div class="flex-grow">
                            <h4 class="font-bold text-lg">${ach.name}</h4>
                            <p class="text-sm">${ach.desc}</p>
                        </div>
                        ${isUnlocked ? `<div class="text-right flex-shrink-0"><span class="font-bold text-green-600">+${ach.ps} PS</span></div>` : ''}
                    </div>`;
        }).join('');

        const psInfoHTML = `
                <div class="p-4 bg-yellow-100/50 rounded-lg space-y-3">
                    <h3 class="text-xl font-bold text-yellow-800">¬øC√≥mo funcionan los Puntos de Sorteo (PS)?</h3>
                    <p class="text-sm">Los PS miden tu progreso y dedicaci√≥n. ¬°Acum√∫lalos para desbloquear t√≠tulos y demostrar tu maestr√≠a!</p>
                    <ul class="list-disc list-inside text-sm space-y-2">
                        <li><strong>+1 PS</strong> por cada sorteo a√±adido manualmente.</li>
                        <li><strong>+2 PS</strong> por cada sorteo completado.</li>
                        <li><strong>+5 PS</strong> por cada sorteo a√±adido con la IA.</li>
                        <li><strong>+5 a 250 PS</strong> al desbloquear un logro, m√©rito o t√≠tulo.</li>
                        <li><strong>+100 PS</strong> por ganar un sorteo.</li>
                        <li><strong>+25 PS (Bonus)</strong> si el premio ganado es de categor√≠a (P√°del, Viajes o Friki).</li>
                        <li><strong>+250 PS (Bonus)</strong> si el premio ganado supera los 500‚Ç¨ de valor.</li>
                    </ul>
                </div>
            `;

        achievementsModalBody.innerHTML = `
                <div class="achievement-tabs flex flex-wrap gap-x-4 border-b border-yellow-600/20 mb-4">
                    <button data-tab="logros" class="py-2 px-4 font-bold ${activeTab === 'logros' ? 'active' : ''}">Logros</button>
                    <button data-tab="titulos" class="py-2 px-4 font-bold ${activeTab === 'titulos' ? 'active' : ''}">T√≠tulos de Prestigio</button>
                    <button data-tab="meritos" class="py-2 px-4 font-bold ${activeTab === 'meritos' ? 'active' : ''}">M√©ritos √önicos</button>
                    <button data-tab="ps_info" class="py-2 px-4 font-bold ${activeTab === 'ps_info' ? 'active' : ''}">Sistema de Puntos</button>
                </div>
                <div id="achievements-content" class="space-y-3">
                    <div class="tab-content ${activeTab === 'logros' ? '' : 'hidden'}" data-tab-content="logros">${achievementsHTML}</div>
                    <div class="tab-content ${activeTab === 'titulos' ? '' : 'hidden'}" data-tab-content="titulos"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${titlesHTML}</div></div>
                    <div class="tab-content ${activeTab === 'meritos' ? '' : 'hidden'}" data-tab-content="meritos"><div class="space-y-3">${meritsHTML}</div></div>
                    <div class="tab-content ${activeTab === 'ps_info' ? '' : 'hidden'}" data-tab-content="ps_info">${psInfoHTML}</div>
                </div>
            `;

        achievementsModalBody.querySelectorAll('.achievement-tabs button').forEach(button => {
            button.addEventListener('click', () => {
                renderAchievementsModal(button.dataset.tab);
            });
        });

        achievementsModalBody.querySelectorAll('.select-title-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                userAchievements.title = button.dataset.title;
                saveUserAchievements();
                userTitleEl.textContent = userAchievements.title;
                renderAchievementsModal('titulos');
            });
        });
    };

    const downloadSourceCode = () => {
        showNotification('Preparando descarga...', 'Se est√° generando el archivo .zip con tus datos actualizados.');
        const zip = new JSZip();
        const giveawaysContent = `window.giveaways = ${JSON.stringify(giveaways, null, 4)};`;
        const discardedGiveawaysContent = `const initialDiscardedGiveaways = ${JSON.stringify(discardedGiveaways, null, 4)};\n\nif (localStorage.getItem('discardedGiveaways') === null) {\n    localStorage.setItem('discardedGiveaways', JSON.stringify(initialDiscardedGiveaways));\n}\n\nwindow.discardedGiveaways = JSON.parse(localStorage.getItem('discardedGiveaways')) || [];`;
        const indexHtmlContent = document.documentElement.outerHTML;
        const netlifyTomlContent = `[build]\n  command = "npm install"\n  functions = "netlify/functions"`;
        const packageJsonContent = `{\n  "name": "misorteos-functions",\n  "version": "1.0.0",\n  "description": "Dependencias para las funciones de Netlify",\n  "dependencies": {\n    "node-fetch": "^3.3.2"\n  }\n}`;
        const geminiJsContent = `// netlify/functions/gemini.js\n            exports.handler = async function (event, context) {\n                const fetch = (await import('node-fetch')).default;\n                const GEMINI_API_KEY = process.env.GEMINI_API_KEY;\n                const body = JSON.parse(event.body);\n                const { base64Data, dynamicPrompt } = body;\n                if (!base64Data || !dynamicPrompt) {\n                    return {\n                        statusCode: 400,\n                        body: JSON.stringify({ error: 'Faltan datos en la petici√≥n.' })\n                    };\n                }\n                const apiUrl = \\\`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=\\\${GEMINI_API_KEY}\\\`;\n                const payload = {\n                    contents: [{\n                        role: "user",\n                        parts: [\n                            { text: dynamicPrompt },\n                            { inlineData: { mimeType: "image/jpeg", data: base64Data.split(',')[1] } }\n                        ]\n                    }]\n                };\n                try {\n                    const geminiResponse = await fetch(apiUrl, {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(payload)\n                    });\n                    if (!geminiResponse.ok) {\n                        const errorBody = await geminiResponse.json();\n                        console.error("Error desde la API de Gemini:", errorBody);\n                        return {\n                            statusCode: geminiResponse.status,\n                            body: JSON.stringify({ error: 'La API de Gemini devolvi√≥ un error.', details: errorBody })\n                        };\n                    }\n                    const data = await geminiResponse.json();\n                    return {\n                        statusCode: 200,\n                        body: JSON.stringify(data)\n                    };\n                } catch (error) {\n                    console.error("Error en la funci√≥n de Netlify:", error);\n                    return {\n                        statusCode: 500,\n                        body: JSON.stringify({ error: 'Error al contactar la API de Gemini.' })\n                    };\n                }\n            };`;
        const searchJsContent = `// netlify/functions/search.js\nexports.handler = async function (event, context) {\n    const fetch = (await import('node-fetch')).default;\n    const GEMINI_API_KEY = process.env.GEMINI_API_KEY;\n    const { query } = JSON.parse(event.body);\n    if (!query) {\n        return {\n            statusCode: 400,\n            body: JSON.stringify({ error: 'Falta la consulta (query).' })\n        };\n    }\n    const apiUrl = \\\`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=\\\${GEMINI_API_KEY}\\\`;\n    const prompt = \\\`Busca en internet el precio aproximado del siguiente producto: "\\\${query}". Devu√©lveme el precio encontrado y la URL de la fuente en un objeto JSON. Por ejemplo: {"value": "150‚Ç¨", "url": "https://example.com"}. Si no encuentras un precio, usa "No encontrado" para la clave "value" y null para "url". Tu respuesta debe ser √∫nicamente el objeto JSON, sin texto adicional ni markdown.\\\`;\n    const payload = {\n        contents: [{\n            role: "user",\n            parts: [{ text: prompt }]\n        }]\n    };\n    try {\n        const geminiResponse = await fetch(apiUrl, {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify(payload)\n        });\n        if (!geminiResponse.ok) {\n            const errorBody = await geminiResponse.json();\n            console.error("Error desde la API de Gemini (en search.js):", errorBody);\n            return {\n                statusCode: geminiResponse.status,\n                body: JSON.stringify({ error: 'La API de Gemini devolvi√≥ un error en la b√∫squeda.', details: errorBody })\n            };\n        }\n        const data = await geminiResponse.json();\n        return {\n            statusCode: 200,\n            body: JSON.stringify(data)\n        };\n    } catch (error) {\n        console.error("Error en la funci√≥n search.js:", error);\n        return {\n            statusCode: 500,\n            body: JSON.stringify({ error: 'Error al contactar la API de Gemini.' })\n        };\n    }\n};`;

        zip.file("index.html", indexHtmlContent);
        zip.file("giveaways_new.js", giveawaysContent);
        zip.file("discardedGiveaways_new.js", discardedGiveawaysContent);
        zip.file("netlify.toml", netlifyTomlContent);
        zip.file("package.json", packageJsonContent);

        const functionsFolder = zip.folder("netlify").folder("functions");
        functionsFolder.file("gemini.js", geminiJsContent);
        functionsFolder.file("search.js", searchJsContent);

        zip.generateAsync({
            type: "blob"
        }).then(function(content) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            const today = new Date().toISOString().slice(0, 10);
            link.download = `Misorteos-Backup-Completo-${today}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    };

    const restoreFromBackup = (file) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            JSZip.loadAsync(e.target.result).then(zip => {
                const giveawaysFile = zip.file("giveaways_new.js");
                const discardedFile = zip.file("discardedGiveaways_new.js");
                const foreignFile = zip.file("foreignAccounts.js");
                if (!giveawaysFile || !discardedFile || !foreignFile) {
                    showNotification('Error', 'El archivo .zip no parece una copia de seguridad v√°lida.');
                    return;
                }
                Promise.all([giveawaysFile.async("string"), discardedFile.async("string"), foreignFile.async("string")])
                    .then(contents => {
                        try {
                            const giveawaysContent = contents[0].replace('window.giveaways = ', '').slice(0, -1);
                            const discardedContent = contents[1].replace('window.discardedGiveaways = ', '').slice(0, -1);
                            const foreignContent = contents[2].replace('window.foreignAccounts = ', '').slice(0, -1);
                            const parsedGiveaways = JSON.parse(giveawaysContent);
                            const parsedDiscarded = JSON.parse(discardedContent);
                            const parsedForeign = JSON.parse(foreignContent);
                            if (confirm("¬øSeguro que quieres restaurar esta copia? Se borrar√°n todos los datos actuales y se reemplazar√°n por los del archivo.")) {
                                giveaways = parsedGiveaways;
                                discardedGiveaways = parsedDiscarded;
                                foreignAccounts = parsedForeign;
                                saveGiveaways();
                                saveDiscardedGiveaways();
                                saveForeignAccounts();
                                renderCalendar();
                                showNotification('¬°√âxito!', 'La copia de seguridad se ha restaurado correctamente.');
                            }
                        } catch (error) {
                            showNotification('Error de formato', 'No se pudo leer el contenido del archivo .zip.');
                            console.error("Error al parsear la copia de seguridad:", error);
                        }
                    });
            });
        };
        reader.readAsArrayBuffer(file);
    };

    const toggleNavMenu = () => {
        navMenu.classList.toggle('is-open');
        menuOverlay.style.display = navMenu.classList.contains('is-open') ? 'block' : 'none';
    };

    const renderForeignAccountsModal = () => {
        foreignAccountsModalBody.innerHTML = '';
        if (foreignAccounts.length === 0) {
            foreignAccountsModalBody.innerHTML = '<p class="text-center">No hay cuentas extranjeras bloqueadas.</p>';
            return;
        }
        foreignAccounts.forEach(account => {
            const itemContainer = document.createElement('div');
            itemContainer.className = 'flex justify-between items-center p-3 bg-red-100/50 rounded-lg shadow-inner border border-red-600/20';
            itemContainer.innerHTML = `
                     <span class="font-bold">${account}</span>
                     <button class="remove-foreign-account-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-400" data-account-name="${account}"><i class="fa-solid fa-trash-can"></i></button>
                 `;
            foreignAccountsModalBody.appendChild(itemContainer);
        });
    };

    const removeForeignAccount = (accountName) => {
        foreignAccounts = foreignAccounts.filter(acc => acc !== accountName);
        saveForeignAccounts();
        renderForeignAccountsModal();
        showNotification('Cuenta eliminada', `La cuenta ${accountName} se ha eliminado de la lista de extranjeras.`);
    };

    document.addEventListener('DOMContentLoaded', () => {
        animateStarryBackground();
        animateTitle();
        renderCalendar();
        updatePointsDisplay();
        userTitleEl.textContent = userAchievements.title;

        const setupModal = (button, modal, closeButton, onOpenCallback) => {
            if (button) button.addEventListener('click', (e) => {
                e.preventDefault();
                if (onOpenCallback) onOpenCallback();
                modal.classList.remove('hidden');
                requestAnimationFrame(() => modal.classList.add('is-visible'));
            });
            if (closeButton) closeButton.addEventListener('click', () => {
                modal.classList.remove('is-visible');
                setTimeout(() => modal.classList.add('hidden'), 300);
            });
            if (modal) modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('is-visible');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            });
        };

        setupModal(statsBtn, statsModal, closeStatsModalBtn, renderStatsModal);
        setupModal(historyBtn, historyModal, closeHistoryModalBtn, renderHistoryModal);
        setupModal(trophyBtn, trophyModal, closeTrophyModalBtn, renderTrophyModal);
        setupModal(achievementsBtn, achievementsModal, closeAchievementsModalBtn, () => renderAchievementsModal('logros'));
        setupModal(addManualBtn, addGiveawayModal, closeAddGiveawayModalBtn);
        setupModal(addAIBtn, addAIGiveawayModal, closeAddAIGiveawayModalBtn);
        setupModal(searchMenuBtn, searchModal, closeSearchModalBtn);
        setupModal(trashBtn, trashModal, closeTrashModalBtn, renderTrashModal);
        setupModal(discardedBtn, discardedModal, closeDiscardedModalBtn, renderDiscardedModal);
        setupModal(null, foreignAccountsModal, closeForeignAccountsModalBtn);
        setupModal(manageBlocksBtn, blockManagementModal, closeBlockManagementModalBtn);
        setupModal(null, duplicateComparisonModal, closeDuplicateComparisonModalBtn);
        setupModal(null, errorDetailsModal, closeErrorDetailsModalFunc);

        openNavMenuBtn.addEventListener('click', toggleNavMenu);
        closeNavMenuBtn.addEventListener('click', toggleNavMenu);
        menuOverlay.addEventListener('click', toggleNavMenu);

        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });
        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });
        calendarDaysEl.addEventListener('click', (e) => {
            const dayEl = e.target.closest('.has-giveaway');
            if (dayEl) openModal(dayEl.dataset.date);
        });

        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        modalBody.addEventListener('click', (e) => {
            const giveawayId = e.target.dataset.giveawayId || e.target.closest('[data-giveaway-id]') ?.dataset.giveawayId;
            if (!giveawayId) return;
            const dateStr = modal.dataset.date;
            const giveaway = giveaways[dateStr].find(g => g.id === giveawayId);

            if (e.target.type === 'checkbox') {
                const itemContainer = e.target.closest('.giveaway-item');
                if (e.target.checked) {
                    completedGiveaways[giveawayId] = true;
                    animateShootingStar(itemContainer, () => {
                        itemContainer.classList.add('completed');
                        buildModal(dateStr);
                        renderCalendar();
                    });
                    addPoints(2);
                } else {
                    delete completedGiveaways[giveawayId];
                    itemContainer.classList.remove('completed');
                    buildModal(dateStr);
                    renderCalendar();
                }
                saveCompletedGiveaways();
                checkAchievements('complete', {
                    giveawayDate: dateStr
                });
            } else if (e.target.closest('.win-giveaway-btn')) {
                markAsWon(giveawayId, dateStr);
            } else if (e.target.closest('.move-giveaway-btn')) {
                openMoveGiveawayModal(giveaway, dateStr);
            } else if (e.target.closest('.delete-giveaway-btn')) {
                if (confirm('¬øSeguro que quieres mover este sorteo a la papelera?')) {
                    deleteGiveawayFromCalendar(dateStr, giveawayId);
                }
            } else if (e.target.closest('.delete-giveaway-foreign-btn')) {
                if (confirm('¬øMarcar como sorteo extranjero? Las cuentas se a√±adir√°n al cortafuegos.')) {
                    deleteForeignGiveaway(dateStr, giveawayId);
                }
            }
        });

        trashModalBody.addEventListener('click', (e) => {
            const restoreBtn = e.target.closest('.restore-btn');
            if (restoreBtn) {
                restoreGiveawayFromTrash(restoreBtn.dataset.giveawayId);
            }
        });
        manageForeignAccountsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            renderForeignAccountsModal();
            foreignAccountsModal.classList.remove('hidden');
            requestAnimationFrame(() => foreignAccountsModal.classList.add('is-visible'));
        });

        discardedModal.addEventListener('click', (e) => {
            const filterBtn = e.target.closest('.filter-btn');
            if (filterBtn) {
                discardedFilter = filterBtn.dataset.filter;
                renderDiscardedModal();
            }
        });

        discardedModalBody.addEventListener('click', (e) => {
            const item = e.target.closest('.giveaway-item-discarded');
            if (!item) return;
            const giveawayId = item.dataset.giveawayId;
            const giveaway = discardedGiveaways.find(g => g.id === giveawayId);
            if (!giveaway) return;
            if (e.target.closest('.add-discarded-btn')) {
                e.stopPropagation();
                openAddGiveawayModal({
                    date: giveaway.date || giveaway.originalDate,
                    prize: giveaway.prize,
                    accounts: (giveaway.accounts || []).join(', '),
                    price: giveaway.price
                });
                deleteDiscardedGiveaway(giveawayId);
                closeDiscardedModalBtn.click();
            } else if (e.target.closest('.delete-discarded-btn')) {
                e.stopPropagation();
                deleteDiscardedGiveaway(giveawayId);
            } else if (giveaway.status === 'duplicate' && giveaway.originalGiveaway) {
                showDuplicateComparisonModal(giveaway);
            } else {
                openAddGiveawayModal({
                    date: giveaway.date || giveaway.originalDate,
                    prize: giveaway.prize,
                    accounts: (giveaway.accounts || []).join(', '),
                    price: giveaway.price
                });
            }
        });

        trophyModalBody.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.trophy-delete-btn');
            if (deleteBtn) {
                deleteWonGiveaway(deleteBtn.dataset.giveawayId);
            }
        });
        selectAiImagesBtn.addEventListener('click', () => {
            aiImageInput.click();
        });
        aiImageInput.addEventListener('change', handleFileSelection);
        startAiButton.addEventListener('click', startAnalysis);
        aiSummaryCloseBtn.addEventListener('click', closeAddAIGiveawayModal);

        reanalyzeSingleBtn.addEventListener('click', () => {
            const filename = reanalyzeSingleBtn.dataset.filename;
            closeErrorDetailsModalFunc();
            const imageToReanalyze = imageQueue.find(img => img.file.name === filename).file;

            imageQueue = [{
                file: imageToReanalyze,
                status: 'pending',
                error: null
            }];
            currentIndex = 0;
            startAnalysis();
        });

        blockLikeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            blockHistory.push({
                type: 'like',
                date: new Date().toISOString()
            });
            saveBlockHistory();
            showNotification('Bloqueo registrado', 'Se ha a√±adido un nuevo bloqueo de "Me gusta".');
            renderStatsModal();
        });
        blockCommentBtn.addEventListener('click', (e) => {
            e.preventDefault();
            blockHistory.push({
                type: 'comment',
                date: new Date().toISOString()
            });
            saveBlockHistory();
            showNotification('Bloqueo registrado', 'Se ha a√±adido un nuevo bloqueo de comentarios.');
            renderStatsModal();
        });

        addAsNewBtn.addEventListener('click', (e) => {
            const giveawayId = e.target.dataset.giveawayId;
            if (!giveawayId) return;
            const giveawayToAdd = discardedGiveaways.find(g => g.id === giveawayId);
            if (giveawayToAdd) {
                deleteDiscardedGiveaway(giveawayId);
                openAddGiveawayModal({
                    date: giveawayToAdd.date || giveawayToAdd.originalDate,
                    prize: giveawayToAdd.prize,
                    accounts: (giveawayToAdd.accounts || []).join(', '),
                    price: giveawayToAdd.price
                });
                duplicateComparisonModal.classList.remove('is-visible');
                setTimeout(() => duplicateComparisonModal.classList.add('hidden'), 300);
            }
        });

        mergeGiveawayBtn.addEventListener('click', (e) => {
            const giveawayId = e.target.dataset.giveawayId;
            if (!giveawayId) return;
            const discarded = discardedGiveaways.find(g => g.id === giveawayId);
            if (discarded && discarded.originalGiveaway) {
                let original = null;
                for (const date in giveaways) {
                    const found = giveaways[date].find(g => g.id === discarded.originalGiveaway.id);
                    if (found) {
                        original = found;
                        break;
                    }
                }
                if (original) {
                    if (!original.price && discarded.price) original.price = discarded.price;
                    if (!original.date && discarded.date) original.date = discarded.date;
                    deleteDiscardedGiveaway(giveawayId);
                    saveGiveaways();
                    renderCalendar();
                    showNotification('Sorteo Fusionado', 'Se han actualizado los datos del sorteo original.');
                    checkAchievements('merge');
                    duplicateComparisonModal.classList.remove('is-visible');
                    setTimeout(() => duplicateComparisonModal.classList.add('hidden'), 300);
                } else {
                    showNotification('Error', 'No se encontr√≥ el sorteo original para fusionar.');
                }
            }
        });

        addGiveawayForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newGiveaway = {
                id: Date.now().toString(),
                date: giveawayDateInput.value,
                prize: giveawayPrizeInput.value,
                accounts: giveawayAccountsInput.value.split(',').map(acc => acc.trim()),
                price: giveawayPriceInput.value,
                addDate: new Date().toISOString().slice(0, 10)
            };
            addGiveaway(newGiveaway);
            closeAddGiveawayModal();
        });

        moveGiveawayForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (giveawayToMove && originalDateOfGiveaway) {
                moveGiveaway(giveawayToMove.id, originalDateOfGiveaway, newGiveawayDateInput.value);
                closeMoveGiveawayModal();
            }
        });

        const allNavButtons = document.querySelectorAll('#nav-menu a');
        allNavButtons.forEach(btn => {
            btn.addEventListener('click', () => toggleNavMenu());
        });

        const downloadBtn = document.getElementById('download-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const zipUploadInput = document.getElementById('zip-upload');
        if (downloadBtn) downloadBtn.addEventListener('click', (e) => {
            e.preventDefault();
            downloadSourceCode();
        });
        if (uploadBtn) uploadBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (zipUploadInput) zipUploadInput.click();
        });
        if (zipUploadInput) zipUploadInput.addEventListener('change', (e) => {
            restoreFromBackup(e.target.files[0]);
        });
    });
</script>
</body>
</html>